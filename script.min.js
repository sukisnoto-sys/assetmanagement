const firebaseConfig={apiKey:"AIzaSyBxEBA92uOfGeobPa-vtfac9DOuvh1k2eI",authDomain:"monitoring-f6347.firebaseapp.com",projectId:"monitoring-f6347",messagingSenderId:"299367981985",appId:"1:299367981985:web:9a93492e42bc4651fd61e0",measurementId:"G-0N22LKVQ7F"},APP_META={VERSION:"3.7.0",BUILD_DATE:"22 Februari 2026",BUILD_CODE:370},SAFE_CONFIG={MAX_PHOTO_SIZE:5242880,MAX_ASSETS:1e3,MAX_PHOTOS_PER_ASSET:20,MAX_TOTAL_PHOTOS:1e4,COMPRESSION_MAX_WIDTH:1280,COMPRESSION_QUALITY:.7};let db,indexedDBInstance,firebaseAuthLoaded=!1,firebaseFirestoreLoaded=!1,assets=[],currentUser=null,isFirebaseConnected=!1,isCloudinaryEnabled=!0,pendingSyncAssets=[],pendingCloudinaryUploads=[],theme=localStorage.getItem("theme")||"light",lastSyncTime=null,memoryWarningShown=!1,isSyncRunning=!1,syncStartTime=null,userStatusUnsubscribe=null,conditionChart=null,typeChart=null;const MAX_WA_LENGTH=3800;let currentWaMessage="",backgroundCache=null,lastCheckTimestamp=0;const CHECK_INTERVAL=6048e5;let importDraftData=[],selectedImportFile=null,selectedImportType=null,zipPreviewCache=null,currentZipFile=null,currentPreviewData=null,currentProgressType="",progressSteps=[],progressInterval=null;const _intervals=[];let photoCountMap=new Map,isPhotoCacheLoaded=!1;function waitForFirebase(){return new Promise(e=>{if(window.firebase&&"function"==typeof firebase.app)return void e();let t=0;const a=setInterval(()=>{t++,window.firebase&&"function"==typeof firebase.app?(clearInterval(a),e()):t>50&&(clearInterval(a),console.warn("Firebase load timeout"),e())},100)})}function updateSplashStatus(e,t=""){const a=document.getElementById("splashStatus"),n=document.getElementById("splashDetail");a&&(a.textContent=e),n&&t&&(n.textContent=t)}function hideSplashScreen(){const e=document.getElementById("splashScreen");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500))}function showSplashScreen(){const e=document.getElementById("splashScreen");e&&(e.style.display="flex",e.style.opacity="1")}function setSafeInterval(e,t){const a=setInterval(e,t);return _intervals.push(a),a}function clearSafeInterval(e){const t=_intervals.indexOf(e);t>-1&&(_intervals.splice(t,1),clearInterval(e))}function normalizeValue(e,t={}){const{trim:a=!0,removeSpaces:n=!0,toUpper:s=!0,toLower:i=!1}=t;let o=(e||"").toString();return a&&(o=o.trim()),n&&(o=o.replace(/\s+/g,"")),s&&(o=o.toUpperCase()),i&&(o=o.toLowerCase()),o}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function base64ToBlob(e){const t=e.split(";base64,");if(2!==t.length)throw new Error("Format base64 tidak valid");const a=t[0].split(":")[1],n=atob(t[1]),s=new Array(n.length);for(let e=0;e<n.length;e++)s[e]=n.charCodeAt(e);const i=new Uint8Array(s);return new Blob([i],{type:a})}async function compressImage(e,t={}){const{maxWidth:a=SAFE_CONFIG.COMPRESSION_MAX_WIDTH,quality:n=SAFE_CONFIG.COMPRESSION_QUALITY,forThumbnail:s=!1}=t;return new Promise((t,i)=>{const o=s?300:a,r=s?.6:n,l=new FileReader;l.readAsDataURL(e),l.onload=function(e){const a=new Image;a.src=e.target.result,a.onload=function(){const e=document.createElement("canvas");let n=a.width,s=a.height;n>o&&(s=Math.round(s*o/n),n=o),e.width=n,e.height=s;const i=e.getContext("2d");i.imageSmoothingEnabled=!0,i.drawImage(a,0,0,n,s),e.toBlob(e=>{const a=new FileReader;a.readAsDataURL(e),a.onloadend=()=>{t({base64:a.result,blob:e,size:e.size,width:n,height:s})}},"image/jpeg",r)},a.onerror=i},l.onerror=i})}function showAlert(e,t,a="info"){const n=document.getElementById(e),s=document.createElement("div");s.className=`alert alert-${a}`,s.innerHTML=t,n.appendChild(s),setTimeout(()=>{s.style.opacity="0",setTimeout(()=>s.remove(),300)},4e3)}function showToastNotification(e,t="info"){const a=document.createElement("div");a.className="toast-notification",a.dataset.type=t,a.innerHTML=`\n        <div class="toast-content">\n            <div class="toast-message">${e}</div>\n            <button class="toast-close" onclick="this.closest('.toast-notification').remove()">‚úï</button>\n        </div>\n    `,document.body.appendChild(a),setTimeout(()=>{a.parentElement&&a.remove()},5e3)}function showError(e,t){e.innerHTML=`<i class="fas fa-exclamation-circle"></i> ${t}`,e.style.display="flex",setTimeout(()=>{e.style.display="none"},5e3)}function showSuccess(e,t){e.innerHTML=`<i class="fas fa-check-circle"></i> ${t}`,e.style.display="flex",setTimeout(()=>{e.style.display="none"},5e3)}function requireInternet(e){if(!navigator.onLine){showToastNotification(`‚ùå ${e} membutuhkan koneksi internet!`,"danger");const t=document.getElementById("globalAlertContainer");if(t){const a=document.createElement("div");a.className="alert alert-danger",a.innerHTML=`<i class="fas fa-exclamation-triangle"></i> ${e} membutuhkan koneksi internet. Silakan online terlebih dahulu.`,t.appendChild(a),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},4e3)}return!1}return!0}async function getClientIP(){try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch(e){return"unknown"}}function initTheme(){document.documentElement.setAttribute("data-theme",theme);const e=document.querySelector("#themeToggle i");e.className="dark"===theme?"fas fa-sun":"fas fa-moon",document.getElementById("themeToggle").addEventListener("click",toggleTheme)}function toggleTheme(){theme="light"===theme?"dark":"light",document.documentElement.setAttribute("data-theme",theme),localStorage.setItem("theme",theme);const e=document.querySelector("#themeToggle i");e.className="dark"===theme?"fas fa-sun":"fas fa-moon"}async function initBackground(){try{if(await checkIfNeedUpdate()&&navigator.onLine)return void await syncBackgroundFromFirestore();if(backgroundCache)return void applyBackground(backgroundCache);const e=await getBackgroundFromDB();if(e)return backgroundCache=e,void applyBackground(e);navigator.onLine&&await syncBackgroundFromFirestore()}catch(e){console.error("‚ùå Background error:",e)}}async function checkIfNeedUpdate(){try{const e=await getLastCheckTimestamp();if(!e)return!0;return Date.now()-e>6048e5}catch{return!0}}function getLastCheckTimestamp(){return new Promise(e=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["settings"],"readonly"),a=t.objectStore("settings").get("background_last_check");a.onsuccess=()=>{e(a.result?.value||null)},a.onerror=()=>{e(null)}}catch{e(null)}else e(null)})}function saveLastCheckTimestamp(){return new Promise(e=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["settings"],"readwrite");t.objectStore("settings").put({key:"background_last_check",value:Date.now()}),t.oncomplete=e}catch{e()}else e()})}async function syncBackgroundFromFirestore(){try{if(!navigator.onLine||!db||!isFirebaseConnected)return void await saveLastCheckTimestamp();let e;try{e=await db.collection("app_config").doc("background").get()}catch(e){console.log("Trying alternative path...")}if(!e.exists)return void await saveLastCheckTimestamp();const t=e.data(),a=t.url||t.imageUrl||t.image;if(!a)return void await saveLastCheckTimestamp();await downloadAndSaveBackground(a),await saveLastCheckTimestamp()}catch(e){console.error("‚ùå Firestore sync error:",e),await saveLastCheckTimestamp()}}async function downloadAndSaveBackground(e){try{const t=await fetch(e,{cache:"force-cache",headers:{"Cache-Control":"max-age=604800"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.blob(),n=new FileReader;n.onloadend=async function(){const e=n.result;await deleteOldBackground(),await saveBackgroundToDB(e),backgroundCache=e,applyBackground(e)},n.readAsDataURL(a)}catch(e){throw console.error("‚ùå Download failed:",e),e}}function deleteOldBackground(){return new Promise(e=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["settings"],"readwrite");t.objectStore("settings").delete("background_image"),t.oncomplete=e,t.onerror=e}catch{e()}else e()})}function getBackgroundFromDB(){return new Promise(e=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["settings"],"readonly"),a=t.objectStore("settings").get("background_image");a.onsuccess=()=>{e(a.result?.value||null)},a.onerror=()=>{e(null)}}catch{e(null)}else e(null)})}function saveBackgroundToDB(e){return new Promise(t=>{if(indexedDBInstance)try{const a=indexedDBInstance.transaction(["settings"],"readwrite");a.objectStore("settings").put({key:"background_image",value:e}),a.oncomplete=t,a.onerror=t}catch{t()}else t()})}function applyBackground(e){const t=document.querySelector(".header");t&&requestAnimationFrame(()=>{t.setAttribute("data-bg-ready","true"),t.style.backgroundImage=`url('${e}')`,t.style.backgroundSize="cover",t.style.backgroundPosition="center"})}function cleanupBackground(){const e=document.querySelector(".header");e&&document.hidden&&(e.style.backgroundImage="none")}function startBackgroundScheduler(){setSafeInterval(async()=>{navigator.onLine&&await syncBackgroundFromFirestore()},6048e5)}async function initFirebase(){try{if(await waitForFirebase(),firebase.apps.length||firebase.initializeApp(firebaseConfig),"function"!=typeof firebase.auth&&await loadFirebaseAuth(),"function"!=typeof firebase.firestore)throw new Error("Firestore SDK tidak tersedia");return db=firebase.firestore(),monitorFirestoreConnection(),!0}catch(e){return console.error("‚ùå Firebase init error:",e),isFirebaseConnected=!1,updateConnectionStatus(!1),!1}}function monitorFirestoreConnection(){db&&db.collection("app_config").limit(1).onSnapshot({includeMetadataChanges:!0},e=>{e.metadata.fromCache||(isFirebaseConnected=!0,updateConnectionStatus(!0))},e=>{console.warn("‚ö†Ô∏è Firestore connection error:",e),isFirebaseConnected=!1,updateConnectionStatus(!1)})}function loadFirebaseAuth(){return new Promise((e,t)=>{if("function"==typeof firebase.auth)return void e();if(document.querySelector('script[src*="firebase-auth"]')){const t=setSafeInterval(()=>{"function"==typeof firebase.auth&&(clearInterval(t),e())},100);return}const a=document.createElement("script");a.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js",a.onload=()=>{e()},a.onerror=e=>{console.error("‚ùå Failed to load Firebase Auth SDK:",e),t(new Error("Failed to load Firebase Auth SDK"))},document.head.appendChild(a)})}document.addEventListener("visibilitychange",()=>{document.hidden?cleanupBackground():backgroundCache?applyBackground(backgroundCache):initBackground()});let CLOUDINARY_CONFIG=null;async function getCloudinaryConfig(){if(CLOUDINARY_CONFIG)return CLOUDINARY_CONFIG;const e=await db.collection("app_config").doc("cloudinary").get();if(!e.exists)throw new Error("Cloudinary config tidak ditemukan");const t=e.data();if(!t.cloud_name||!t.upload_preset||!t.api_url)throw new Error("Cloudinary config tidak lengkap");return CLOUDINARY_CONFIG=t,CLOUDINARY_CONFIG}async function loadCloudinarySettings(){isCloudinaryEnabled=!0,updateCloudinaryStatus()}async function uploadWithRetry(e,t,a,n=3){let s=null;for(let i=0;i<n;i++)try{if(i>0){const e=1e3*Math.pow(2,i-1);await new Promise(t=>setTimeout(t,e))}return await uploadToCloudinary(e,t,a)}catch(e){if(s=e,console.warn(`‚ö†Ô∏è Upload attempt ${i+1} failed:`,e.message),i===n-1)throw console.error(`‚ùå All ${n} attempts failed`),new Error(`Upload gagal setelah ${n} kali: ${e.message}`)}throw s}async function uploadToCloudinary(e,t,a){if(!requireInternet("Upload ke Cloudinary"))throw new Error("Tidak dapat upload: offline");const n=await getCloudinaryConfig();return new Promise((t,a)=>{if(!n.enabled)return void a(new Error("Cloudinary tidak diaktifkan"));if(!navigator.onLine)return void a(new Error("Tidak terhubung ke internet"));if(!(e&&e instanceof File))return void a(new Error("File tidak valid"));if(e.size>5242880)return void a(new Error(`File terlalu besar (${(e.size/1048576).toFixed(2)}MB). Maksimal 5MB.`));const s=new FormData;s.append("file",e),s.append("upload_preset",n.upload_preset),s.append("folder",n.folder);const i=document.getElementById("cloudinaryUploadModal"),o=document.getElementById("uploadProgressBar"),r=document.getElementById("uploadStatus");i.classList.add("active"),o.style.width="10%",r.textContent="Mempersiapkan upload...";const l=setTimeout(()=>{i.classList.remove("active"),a(new Error("Upload timeout (30 detik)"))},3e4);let d=10;const c=setSafeInterval(()=>{d<80&&(d+=10,o.style.width=d+"%")},500);fetch(n.api_url,{method:"POST",body:s}).then(e=>{if(clearInterval(c),clearTimeout(l),!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}).then(e=>{if(e.error)throw new Error(e.error.message||"Cloudinary error");o.style.width="100%",r.textContent="Upload berhasil!",setTimeout(()=>{i.classList.remove("active"),t({public_id:e.public_id,secure_url:e.secure_url,created_at:e.created_at,width:e.width,height:e.height,bytes:e.bytes,format:e.format,resource_type:e.resource_type,url:e.url})},1e3)}).catch(e=>{clearInterval(c),clearTimeout(l),i.classList.remove("active"),console.error("Cloudinary upload error:",e);let t=e.message;t.includes("Failed to fetch")?t="Gagal terhubung ke Cloudinary. Cek koneksi internet.":t.includes("NetworkError")&&(t="Masalah jaringan. Coba lagi nanti."),a(new Error(t))})})}function updateCloudinaryStatus(){const e=document.getElementById("cloudinaryStatus");navigator.onLine?(e.innerHTML='<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Siap</span>',e.className="status-badge status-online"):(e.innerHTML='<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Diblokir</span>',e.className="status-badge status-offline")}function initIndexedDB(){return new Promise((e,t)=>{const a=window.indexedDB.open("assetDB",5);a.onerror=function(e){console.error("‚ùå IndexedDB error:",e.target.error),document.getElementById("indexeddbStatus").innerHTML='<i class="fas fa-database"></i> <span>Database Lokal: Error</span>',document.getElementById("indexeddbStatus").className="status-badge status-offline",t(e.target.error)},a.onsuccess=function(t){indexedDBInstance=t.target.result,document.getElementById("indexeddbStatus").innerHTML='<i class="fas fa-database"></i> <span>Database Lokal: Siap</span>',e(indexedDBInstance)},a.onupgradeneeded=function(e){const t=e.target.result,a=e.target.transaction;if(!t.objectStoreNames.contains("users")){const e=t.createObjectStore("users",{keyPath:"uid"});e.createIndex("email","email",{unique:!0}),e.createIndex("nik","nik",{unique:!0}),e.createIndex("role","role",{unique:!1})}if(!t.objectStoreNames.contains("assets")){const e=t.createObjectStore("assets",{keyPath:"id"});e.createIndex("syncStatus","syncStatus",{unique:!1}),e.createIndex("kondisi","kondisi",{unique:!1}),e.createIndex("lokasi","lokasi",{unique:!1}),e.createIndex("jenis_item","jenis_item",{unique:!1})}let n;if(t.objectStoreNames.contains("photos")?(n=a.objectStore("photos"),n.indexNames.contains("thumbnailStatus")||n.createIndex("thumbnailStatus","thumbnailStatus",{unique:!1})):(n=t.createObjectStore("photos",{keyPath:"id",autoIncrement:!0}),n.createIndex("assetId","assetId",{unique:!1}),n.createIndex("type","type",{unique:!1}),n.createIndex("uploadStatus","uploadStatus",{unique:!1}),n.createIndex("timestamp","timestamp",{unique:!1}),n.createIndex("thumbnailStatus","thumbnailStatus",{unique:!1})),t.objectStoreNames.contains("backups")||t.createObjectStore("backups",{keyPath:"timestamp"}),t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"}),!t.objectStoreNames.contains("syncQueue")){const e=t.createObjectStore("syncQueue",{keyPath:"id"});e.createIndex("type","type",{unique:!1}),e.createIndex("status","status",{unique:!1})}if(!t.objectStoreNames.contains("user_activities")){const e=t.createObjectStore("user_activities",{keyPath:"timestamp"});e.createIndex("user","user.uid",{unique:!1}),e.createIndex("action","action",{unique:!1}),e.createIndex("date","date",{unique:!1})}t.objectStoreNames.contains("sync_metadata")||t.createObjectStore("sync_metadata",{keyPath:"key"})},a.onblocked=function(){alert("‚ö†Ô∏è Tutup tab lain yang menggunakan aplikasi ini, lalu refresh halaman.")}})}async function saveAssetToIndexedDB(e,t="pending"){return new Promise((a,n)=>{const s=indexedDBInstance.transaction(["assets"],"readwrite").objectStore("assets"),i={...e,syncStatus:t,lastUpdated:Date.now()};if(!i.id)return void n(new Error("Asset ID is required"));const o=s.put(i);o.onsuccess=function(){a(i)},o.onerror=function(e){console.error("‚ùå Error saving to IndexedDB:",e.target.error),n(e.target.error)}})}async function getAssetFromIndexedDB(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["assets"],"readonly").objectStore("assets").get(e);n.onsuccess=function(){t(n.result)},n.onerror=a})}async function loadAssetsFromIndexedDB(){return new Promise((e,t)=>{const a=indexedDBInstance.transaction(["assets"],"readonly").objectStore("assets").getAll();a.onsuccess=function(){e(a.result||[])},a.onerror=t})}async function getAssetsCountFromIndexedDB(){return new Promise(e=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["assets"],"readonly"),a=t.objectStore("assets").count();a.onsuccess=()=>{e(a.result||0)},a.onerror=()=>{e(0)}}catch(t){e(0)}else e(0)})}async function getPendingAssets(){return new Promise((e,t)=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["assets"],"readonly").objectStore("assets");if(t.indexNames.contains("syncStatus")){const a=t.index("syncStatus").getAll("pending");a.onsuccess=()=>{e(a.result||[])},a.onerror=a=>{console.error("Error getting pending assets from index:",a);const n=t.getAll();n.onsuccess=()=>{const t=n.result||[];e(t.filter(e=>"pending"===e.syncStatus))}}}else{const a=t.getAll();a.onsuccess=()=>{const t=a.result||[];e(t.filter(e=>"pending"===e.syncStatus))}}}catch(t){console.error("Exception in getPendingAssets:",t),e([])}else e([])})}async function saveAssetBatchToIndexedDB(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["assets"],"readwrite"),s=n.objectStore("assets");let i=0,o=!1;e.forEach(n=>{const r=s.put(n);r.onsuccess=()=>{i++,i!==e.length||o||t()},r.onerror=e=>{o=!0,console.error("Error saving asset batch:",e),a(e.target.error)}}),n.onerror=e=>{o||a(e.target.error)}})}async function updateAssetSyncStatus(e,t){return new Promise((a,n)=>{const s=indexedDBInstance.transaction(["assets"],"readwrite").objectStore("assets"),i=s.get(e);i.onsuccess=function(){const e=i.result;if(!e)return void n(new Error("Asset not found in IndexedDB"));e.syncStatus=t,e.lastUpdated=Date.now(),"conflict"===t&&(e.conflictDetected=Date.now(),e.conflictResolved=!1);const o=s.put(e);o.onsuccess=function(){a()},o.onerror=n},i.onerror=n})}async function deleteAssetFromIndexedDB(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["assets"],"readwrite").objectStore("assets").delete(e);n.onsuccess=t,n.onerror=e=>a(e.target.error)})}async function savePhotoWithCloudinary(e,t,a,n=null,s=null){let i=null;if(a&&a.startsWith("data:image"))try{const e=base64ToBlob(a),t=new File([e],"thumb.jpg",{type:"image/jpeg"});i=(await compressImage(t,{forThumbnail:!0})).base64}catch(e){console.warn("Failed to create thumbnail:",e)}const o={assetId:e,type:t,thumbnail:i,tanggal:(new Date).toISOString(),timestamp:Date.now(),uploadStatus:"PENDING",uploaded_by:s,retryCount:0,maxRetries:3,meta:{hasThumbnail:!!i,originalSize:a?.length||0,thumbSize:i?.length||0}};if(navigator.onLine)try{if(!n){const t=base64ToBlob(a);n=new File([t],`photo_${e}_${Date.now()}.jpg`,{type:"image/jpeg"})}const s=await uploadWithRetry(n,e,t,3);o.cloudinary=s,o.uploadStatus="UPLOADED",o.uploadedAt=(new Date).toISOString(),o.image=null,o.cloudinaryOnly=!1,o.hasLocalThumbnail=!0}catch(e){console.error("Cloudinary upload failed after retries:",e),o.uploadStatus="PENDING",o.uploadError=e.message,o.image=a,o.thumbnail=i}else o.image=a,o.thumbnail=i;return new Promise((e,t)=>{const a=indexedDBInstance.transaction(["photos"],"readwrite").objectStore("photos").add(o);a.onsuccess=function(){o.id=a.result,e(o)},a.onerror=function(e){console.error("‚ùå Error saving photo:",e.target.error),t(e.target.error)}})}async function getAssetPhotos(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["photos"],"readonly").objectStore("photos").index("assetId").getAll(e);n.onsuccess=function(){const e=(n.result||[]).map(e=>{let t=null,a="local",n=!1;return e.image?(t=e.image,a="local"):e.thumbnail?(t=e.thumbnail,a="local",n=!0):e.cloudinary&&e.cloudinary.secure_url&&navigator.onLine?(t=e.cloudinary.secure_url,a="cloudinary"):(t="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E",a="placeholder"),{...e,displayUrl:t,source:a,isThumbnail:n,hasCloudinary:!!e.cloudinary,hasLocal:!(!e.image&&!e.thumbnail),canLoadFull:!(!e.cloudinary&&!e.image)}});t(e)},n.onerror=function(e){console.error("Error getting photos:",e.target.error),t([])}})}async function getAllPhotos(){return new Promise((e,t)=>{if(!indexedDB)return console.error("IndexedDB not initialized"),void e([]);try{const a=indexedDBInstance.transaction(["photos"],"readonly"),n=a.objectStore("photos").getAll();n.onsuccess=function(){const t=n.result||[];e(t)},n.onerror=function(e){console.error("Error getting photos:",e.target.error),t(e.target.error)},a.onerror=function(e){console.error("Transaction error:",e.target.error),t(e.target.error)}}catch(t){console.error("Exception in getAllPhotos:",t),e([])}})}async function getPendingPhotos(){return new Promise((e,t)=>{if(indexedDBInstance)try{const a=indexedDBInstance.transaction(["photos"],"readonly").objectStore("photos");if(!a.indexNames.contains("uploadStatus"))return console.error("uploadStatus index not found in IndexedDB"),void e([]);const n=a.index("uploadStatus").getAll("PENDING");n.onsuccess=function(){e(n.result||[])},n.onerror=function(e){console.error("Error getting pending photos:",e.target.error),t(e.target.error)}}catch(e){console.error("Exception in getPendingPhotos:",e),t(e)}else e([])})}async function deletePhoto(e){if(indexedDBInstance)return new Promise((t,a)=>{try{const n=indexedDBInstance.transaction(["photos"],"readwrite"),s=n.objectStore("photos").delete(e);s.onsuccess=t,s.onerror=e=>{console.error("Error deleting photo:",e),a(e.target.error)}}catch(e){console.error("Error in deletePhoto:",e),a(e)}});console.warn("‚ö†Ô∏è Cannot delete photo: IndexedDB not ready")}async function deletePhotoFromIndexedDB(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["photos"],"readwrite").objectStore("photos").delete(e);n.onsuccess=t,n.onerror=e=>a(e.target.error)})}async function updatePhoto(e,t){if(indexedDBInstance)return new Promise((a,n)=>{try{const s=indexedDBInstance.transaction(["photos"],"readwrite").objectStore("photos"),i=s.get(e);i.onsuccess=function(){const e=i.result;if(!e)return void a();const o={...e,...t},r=s.put(o);r.onsuccess=()=>a(),r.onerror=e=>n(e.target.error)},i.onerror=e=>n(e.target.error)}catch(e){console.error("Error in updatePhoto:",e),n(e)}});console.warn("‚ö†Ô∏è Cannot update photo: IndexedDB not ready")}async function getLastPullTimestamp(){return new Promise(e=>{if(indexedDBInstance)try{const t=indexedDBInstance.transaction(["sync_metadata"],"readonly"),a=t.objectStore("sync_metadata").get("lastPullTimestamp");a.onsuccess=()=>{e(a.result?.value||0)},a.onerror=()=>e(0)}catch{e(0)}else e(0)})}async function saveLastPullTimestamp(e){return new Promise(t=>{if(indexedDBInstance)try{const a=indexedDBInstance.transaction(["sync_metadata"],"readwrite");a.objectStore("sync_metadata").put({key:"lastPullTimestamp",value:e,updatedAt:Date.now()}),a.oncomplete=()=>{t()},a.onerror=e=>{console.warn("Error saving last pull timestamp:",e),t()}}catch(e){console.warn("Error in saveLastPullTimestamp:",e),t()}else t()})}async function saveSetting(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["settings"],"readwrite").objectStore("settings").put(e);n.onsuccess=function(){t()},n.onerror=a})}async function getSetting(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["settings"],"readonly").objectStore("settings").get(e);n.onsuccess=function(){t(n.result)},n.onerror=a})}async function getAllSettings(){return new Promise((e,t)=>{if(indexedDBInstance)try{const a=indexedDBInstance.transaction(["settings"],"readonly"),n=a.objectStore("settings").getAll();n.onsuccess=function(){const t=n.result||[],a={};t.forEach(e=>{e.key&&(a[e.key]=e)}),e(a)},n.onerror=function(e){t(e.target.error)}}catch(t){console.error("Error getting settings:",t),e({})}else e({})})}async function logUserActivity(e,t={}){if(!currentUser)return;const a={timestamp:Date.now(),date:(new Date).toISOString(),user:{uid:currentUser.uid,nama:currentUser.nama||currentUser.email,email:currentUser.email,jabatan:currentUser.jabatan||""},action:e,data:t,ip:await getClientIP(),userAgent:navigator.userAgent};try{await new Promise((e,t)=>{const n=indexedDBInstance.transaction(["user_activities"],"readwrite").objectStore("user_activities").add(a);n.onsuccess=function(){e()},n.onerror=t})}catch(e){console.error("Error logging activity:",e)}if(isFirebaseConnected&&navigator.onLine)try{await db.collection("user_activities").add(a)}catch(e){console.error("Error sending activity to Firestore:",e)}}async function getAllUserActivities(){return new Promise((e,t)=>{if(indexedDBInstance)try{const a=indexedDBInstance.transaction(["user_activities"],"readonly"),n=a.objectStore("user_activities").getAll();n.onsuccess=function(){const t=n.result||[];t.sort((e,t)=>t.timestamp-e.timestamp),e(t)},n.onerror=function(e){t(e.target.error)}}catch(t){console.error("Error getting activities:",t),e([])}else e([])})}const SYNC_META_COLLECTION="sync_meta",SYNC_META_DOC="assets_changelog";async function getCloudSyncMetadata(){if(!navigator.onLine||!isFirebaseConnected||!db)return null;try{const e=db.collection("sync_meta").doc(SYNC_META_DOC),t=await e.get();if(t.exists)return t.data();{const t={lastGlobalUpdate:0,changedAssets:[],changedCount:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()};return await e.set(t),t}}catch(e){return console.error("Error getting cloud sync metadata:",e),null}}async function updateCloudSyncMetadata(e=[]){if(navigator.onLine&&isFirebaseConnected&&db)try{const t=db.collection("sync_meta").doc(SYNC_META_DOC),a=Date.now();if(0===e.length)await t.set({lastGlobalUpdate:a,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0});else{const n=db.batch();n.set(t,{lastGlobalUpdate:a,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),e.forEach(e=>{n.update(t,{changedAssets:firebase.firestore.FieldValue.arrayUnion(e),changedCount:firebase.firestore.FieldValue.increment(1)})}),await n.commit()}}catch(e){console.error("‚ùå Error updating sync metadata:",e)}}async function resetCloudSyncMetadata(){if(navigator.onLine&&isFirebaseConnected&&db)try{const e=db.collection("sync_meta").doc("assets_changelog");await e.update({changedAssets:[],changedCount:0,lastReset:firebase.firestore.FieldValue.serverTimestamp()})}catch(e){console.error("Error resetting sync metadata:",e)}}let isOwner=!1,authInitialized=!1;async function initFirebaseAuth(){try{"function"!=typeof firebase.auth&&await loadFirebaseAuth(),firebase.auth().onAuthStateChanged(async e=>{e?await handleUserSignedIn(e):handleUserSignedOut()}),authInitialized=!0}catch(e){console.error("‚ùå Auth init error:",e),authInitialized=!1}}async function handleUserSignedIn(e){try{if(!db)throw new Error("Database belum siap");const t=await db.collection("users").doc(e.uid).get();if(!t.exists)return await firebase.auth().signOut(),showLoginOverlay(),showToastNotification("Data user tidak ditemukan. Hubungi admin.","danger"),void hideLoadingOverlay();const a=t.data();if(!a.isActive)return await firebase.auth().signOut(),showLoginOverlay(),showToastNotification("Akun Anda dinonaktifkan. Hubungi admin.","danger"),void hideLoadingOverlay();currentUser={uid:e.uid,email:e.email,...a},isOwner="owner"===currentUser.role,userStatusUnsubscribe&&(userStatusUnsubscribe(),userStatusUnsubscribe=null),userStatusUnsubscribe=db.collection("users").doc(currentUser.uid).onSnapshot(e=>{const t=e.data();t&&!1===t.isActive&&(showToastNotification("Akun Anda dinonaktifkan oleh owner.","danger"),firebase.auth().signOut(),handleUserSignedOut(),hideLoadingOverlay())}),db.collection("users").doc(e.uid).update({lastLogin:firebase.firestore.FieldValue.serverTimestamp()}).catch(console.warn),await loadAssetsFromIndexedDBOnly(),hideLoginOverlay(),showMainApp(),updateUserUI(),hideSplashScreen(),hideLoadingOverlay(),showToastNotification(`Selamat datang, ${currentUser.nama||currentUser.email}!`,"success");0===await getAssetsCountFromIndexedDB()?(await firstTimeSyncFromCloud(),await loadAssetsFromIndexedDBOnly()):setTimeout(()=>{isSyncRunning||runSyncNow()},1500)}catch(e){console.error("‚ùå SignedIn error:",e),await firebase.auth().signOut(),hideLoadingOverlay(),showLoginOverlay()}}function handleUserSignedOut(){userStatusUnsubscribe&&(userStatusUnsubscribe(),userStatusUnsubscribe=null),currentUser=null,isOwner=!1,isSyncRunning=!1,assets=[],hideMainApp(),showLoginOverlay();const e=document.getElementById("userDropdown");e&&e.classList.remove("active")}async function saveUserToIndexedDB(e){return new Promise((t,a)=>{if(!indexedDBInstance)return console.warn("IndexedDB not initialized, skipping user save"),void t();try{const n=indexedDBInstance.transaction(["users"],"readwrite").objectStore("users"),s={...e,createdAt:e.createdAt&&"object"==typeof e.createdAt&&e.createdAt.toDate?e.createdAt.toDate().toISOString():e.createdAt||(new Date).toISOString(),lastLogin:e.lastLogin&&"object"==typeof e.lastLogin&&e.lastLogin.toDate?e.lastLogin.toDate().toISOString():e.lastLogin||(new Date).toISOString(),lastSaved:(new Date).toISOString()},i=n.put(s);i.onsuccess=function(){t()},i.onerror=function(e){console.error("‚ùå Error saving user to IndexedDB:",e.target.error),a(e.target.error)}}catch(e){console.error("‚ùå Exception saving user to IndexedDB:",e),a(e)}})}function showLoginOverlay(){const e=document.getElementById("loginOverlay");e.classList.remove("hidden"),document.getElementById("loginForm").reset(),document.getElementById("registerForm").reset(),document.getElementById("loginError").classList.add("hidden"),document.getElementById("loginSuccess").classList.add("hidden"),document.getElementById("registerError").classList.add("hidden"),document.getElementById("registerSuccess").classList.add("hidden"),document.querySelectorAll(".login-tab").forEach(e=>e.classList.remove("active")),document.querySelector('.login-tab[data-form="login"]').classList.add("active"),document.querySelectorAll(".login-form").forEach(e=>e.classList.remove("active")),document.getElementById("loginForm").classList.add("active"),e.offsetWidth}function hideLoginOverlay(){const e=document.getElementById("loginOverlay");e.classList.contains("hidden")||(e.classList.add("hiding"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("hiding")},300))}function showMainApp(){document.querySelector(".container").classList.remove("hidden");const e=document.getElementById("userProfile");e.classList.remove("hidden"),e.classList.add("flex")}function hideMainApp(){document.querySelector(".container").classList.add("hidden");const e=document.getElementById("userProfile");e.classList.add("hidden"),e.classList.remove("flex")}function showLoadingOverlay(e="Memproses..."){document.getElementById("loadingText").textContent=e,document.getElementById("loadingOverlay").classList.add("active")}function hideLoadingOverlay(){document.getElementById("loadingOverlay").classList.remove("active")}async function loginUser(){if(!requireInternet("Login"))return;const e=document.getElementById("loginEmail").value.trim(),t=document.getElementById("loginPassword").value,a=document.getElementById("rememberMe").checked,n=document.getElementById("loginError"),s=document.getElementById("btnLogin");if(e&&t){showLoadingOverlay("Login...");try{s.disabled=!0,s.innerHTML='<div class="loading"></div> Login...',await firebase.auth().setPersistence(a?firebase.auth.Auth.Persistence.LOCAL:firebase.auth.Auth.Persistence.SESSION),await firebase.auth().signInWithEmailAndPassword(e,t),s.disabled=!1,s.innerHTML='<i class="fas fa-sign-in-alt"></i> Login'}catch(e){hideLoadingOverlay();let t="Login gagal. ";t+=e.message,showError(n,t),s.disabled=!1,s.innerHTML='<i class="fas fa-sign-in-alt"></i> Login'}}else showError(n,"Harap isi email dan password")}async function registerUser(){if(!requireInternet("Registrasi"))return;const e=document.getElementById("registerNama").value.trim(),t=document.getElementById("registerJabatan").value.trim(),a=document.getElementById("registerNIK").value.trim(),n=document.getElementById("registerEmail").value.trim(),s=document.getElementById("registerPassword").value,i=document.getElementById("registerConfirmPassword").value,o=document.getElementById("rememberMe")?.checked||!1,r=document.getElementById("registerError"),l=document.getElementById("btnRegister");if(e&&t&&a&&n&&s&&i)if(s===i){showLoadingOverlay("Mendaftarkan akun...");try{l.disabled=!0,await firebase.auth().setPersistence(o?firebase.auth.Auth.Persistence.LOCAL:firebase.auth.Auth.Persistence.SESSION);const i=(await firebase.auth().createUserWithEmailAndPassword(n,s)).user,r={uid:i.uid,email:n,nama:e,jabatan:t,nik:a,role:"user",isActive:!0,createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastLogin:firebase.firestore.FieldValue.serverTimestamp(),profileComplete:!0};await db.collection("users").doc(i.uid).set(r)}catch(e){hideLoadingOverlay(),showError(r,e.message)}finally{l.disabled=!1}}else showError(r,"Password tidak cocok");else showError(r,"Harap lengkapi semua field")}async function forgotPassword(){if(!requireInternet("Reset password"))return;const e=prompt("Masukkan email Anda untuk reset password:");if(e){showLoadingOverlay("Mengirim email reset password...");try{await firebase.auth().sendPasswordResetEmail(e),alert(`Email reset password telah dikirim ke ${e}. Silakan cek inbox Anda.`)}catch(e){console.error("‚ùå Password reset error:",e),alert("Gagal mengirim email reset password: "+e.message)}finally{hideLoadingOverlay()}}}function updateUserUI(){if(!currentUser)return void console.warn("‚ö†Ô∏è No current user to update UI");try{document.getElementById("userName").textContent=currentUser.nama||currentUser.email,document.getElementById("userRole").textContent="owner"===currentUser.role?"Owner":"User";const e=document.getElementById("userAvatar"),t=currentUser.nama?currentUser.nama.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):currentUser.email.substring(0,2).toUpperCase();e.textContent=t,document.getElementById("dropdownName").textContent=currentUser.nama||currentUser.email,document.getElementById("dropdownEmail").textContent=currentUser.email,document.getElementById("dropdownJabatan").textContent=currentUser.jabatan||"-",document.getElementById("dropdownNIK").textContent=currentUser.nik||"-",document.getElementById("dropdownRole").textContent="owner"===currentUser.role?"Owner":"User";const a=document.getElementById("dropdownAvatar");a.textContent=t;const n="owner"===currentUser.role?"#ef4444":"#3b82f6";e.style.backgroundColor=n,a.style.backgroundColor=n}catch(e){console.error("‚ùå Error updating UI:",e)}const e=document.getElementById("btnUserManagement");e&&(e.style.display="owner"===currentUser.role?"block":"none")}function showUserProfile(){if(!currentUser)return void console.error("‚ùå No current user found");const e=e=>{if(!e)return"Tidak tersedia";try{let t;if(e&&"object"==typeof e&&e.toDate&&"function"==typeof e.toDate)t=e.toDate();else if("string"==typeof e){if(t=new Date(e),isNaN(t.getTime()))return console.warn("Invalid date string:",e),"Tanggal tidak valid"}else if("number"==typeof e)t=new Date(e);else if(e instanceof Date)t=e;else if(e&&"object"==typeof e&&e.seconds)t=new Date(1e3*e.seconds);else{if(!e||"object"!=typeof e||!e._seconds)return console.warn("Unknown date format:",e),"Format tanggal tidak dikenali";t=new Date(1e3*e._seconds)}if(!t||isNaN(t.getTime()))return"Tanggal tidak valid";try{return t.toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return console.error("Error formatting date:",e),"Error format tanggal"}}catch(t){return console.error("Error in formatDate:",t,e),"Error format tanggal"}},t="owner"===currentUser.role?"Owner (Admin)":"User",a="owner"===currentUser.role?"badge-danger":"badge-info",n=currentUser.nama?currentUser.nama.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"U",s=`\n        <div class="modal active" id="profileModal">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <div class="modal-title">\n                        <i class="fas fa-user-circle"></i> Profil Saya\n                    </div>\n                    <div class="close-modal" id="closeProfileModal">&times;</div>\n                </div>\n                <div style="padding: 20px;">\n                    <div style="text-align: center; margin-bottom: 30px;">\n                        <div style="width: 100px; height: 100px; border-radius: 50%; background: ${"owner"===currentUser.role?"#ef4444":"#3b82f6"}; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">\n                            ${n}\n                        </div>\n                        <h3 style="margin: 10px 0 5px 0; color: var(--text-color);">${currentUser.nama||currentUser.email}</h3>\n                        <div class="badge ${a}" style="display: inline-block; font-size: 14px; padding: 8px 16px;">\n                            ${t}\n                        </div>\n                    </div>\n                    \n                    <div class="form-row">\n                        <div class="form-col">\n                            <label><i class="fas fa-envelope"></i> Email</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${currentUser.email||"Tidak tersedia"}\n                            </div>\n                        </div>\n                        <div class="form-col">\n                            <label><i class="fas fa-briefcase"></i> Jabatan</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${currentUser.jabatan||"Tidak tersedia"}\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="form-row" style="margin-top: 15px;">\n                        <div class="form-col">\n                            <label><i class="fas fa-id-card"></i> NIK</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${currentUser.nik||"Tidak tersedia"}\n                            </div>\n                        </div>\n                        <div class="form-col">\n                            <label><i class="fas fa-user-tag"></i> Role</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${t}\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="form-row" style="margin-top: 15px;">\n                        <div class="form-col">\n                            <label><i class="fas fa-calendar-plus"></i> Akun Dibuat</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${e(currentUser.createdAt)}\n                            </div>\n                        </div>\n                        <div class="form-col">\n                            <label><i class="fas fa-clock"></i> Terakhir Login</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${e(currentUser.lastLogin)}\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="form-row" style="margin-top: 15px;">\n                        <div class="form-col">\n                            <label><i class="fas fa-user-check"></i> Status Akun</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">\n                                ${currentUser.isActive?"üü¢ Aktif":"üî¥ Nonaktif"}\n                                ${currentUser.profileComplete?" ‚Ä¢ ‚úÖ Profil Lengkap":" ‚Ä¢ ‚ö†Ô∏è Profil Belum Lengkap"}\n                            </div>\n                        </div>\n                        <div class="form-col">\n                            <label><i class="fas fa-key"></i> User ID</label>\n                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color); font-size: 12px; font-family: monospace;">\n                                ${currentUser.uid||"Tidak tersedia"}\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center;">\n                        <div style="display: flex; gap: 10px; justify-content: center;">\n                            <button class="btn btn-primary" id="btnEditProfile">\n                                <i class="fas fa-edit"></i> Edit Profil\n                            </button>\n                            <button class="btn btn-outline" id="closeProfileBtn">\n                                <i class="fas fa-times"></i> Tutup\n                            </button>\n                        </div>\n                        <div style="margin-top: 15px; font-size: 12px; color: var(--secondary);">\n                            <i class="fas fa-info-circle"></i> Untuk mengubah email atau role, hubungi administrator\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `,i=document.createElement("div");i.innerHTML=s,document.body.appendChild(i),document.getElementById("closeProfileModal").addEventListener("click",function(){document.getElementById("profileModal").remove()}),document.getElementById("closeProfileBtn").addEventListener("click",function(){document.getElementById("profileModal").remove()}),document.getElementById("btnEditProfile").addEventListener("click",function(){document.getElementById("profileModal").remove(),showEditProfileModal()}),document.getElementById("profileModal").addEventListener("click",function(e){"profileModal"===e.target.id&&this.remove()}),document.addEventListener("keydown",function e(t){if("Escape"===t.key){const t=document.getElementById("profileModal");t&&t.remove(),document.removeEventListener("keydown",e)}})}function showEditProfileModal(){if(!currentUser)return;const e=`\n        <div class="modal active" id="editProfileModal">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <div class="modal-title">\n                        <i class="fas fa-user-edit"></i> Edit Profil\n                    </div>\n                    <div class="close-modal" id="closeEditProfileModal">&times;</div>\n                </div>\n                <div style="padding: 20px;">\n                    <form id="editProfileForm">\n                        <div class="form-group">\n                            <label for="editNama">Nama Lengkap</label>\n                            <input type="text" id="editNama" value="${currentUser.nama||""}" required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="editJabatan">Jabatan</label>\n                            <input type="text" id="editJabatan" value="${currentUser.jabatan||""}" required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="editNIK">NIK</label>\n                            <input type="text" id="editNIK" value="${currentUser.nik||""}">\n                        </div>\n                        \n                        <div id="editProfileError" class="alert alert-danger" style="display: none;"></div>\n                        <div id="editProfileSuccess" class="alert alert-success" style="display: none;"></div>\n                        \n                        <div class="form-group" style="margin-top: 30px; display: flex; gap: 10px;">\n                            <button type="submit" class="btn btn-primary" id="btnSaveProfile">\n                                <i class="fas fa-save"></i> Simpan Perubahan\n                            </button>\n                            <button type="button" class="btn btn-outline" id="cancelEditProfile">\n                                <i class="fas fa-times"></i> Batal\n                            </button>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>\n    `,t=document.createElement("div");t.innerHTML=e,document.body.appendChild(t),document.getElementById("closeEditProfileModal").addEventListener("click",function(){document.getElementById("editProfileModal").remove()}),document.getElementById("cancelEditProfile").addEventListener("click",function(){document.getElementById("editProfileModal").remove()}),document.getElementById("editProfileForm").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("editNama").value.trim(),a=document.getElementById("editJabatan").value.trim(),n=document.getElementById("editNIK").value.trim(),s=document.getElementById("editProfileError"),i=document.getElementById("editProfileSuccess"),o=document.getElementById("btnSaveProfile");if(t&&a){o.disabled=!0,o.innerHTML='<div class="loading"></div> Menyimpan...';try{if(currentUser.nama=t,currentUser.jabatan=a,currentUser.nik=n,navigator.onLine&&db&&isFirebaseConnected)try{await db.collection("users").doc(currentUser.uid).update({nama:t,jabatan:a,nik:n})}catch(e){console.error("‚ùå Error updating in Firestore:",e)}try{await saveUserToIndexedDB(currentUser)}catch(e){console.error("‚ùå Error updating in IndexedDB:",e)}localStorage.setItem("cachedUser",JSON.stringify(currentUser)),updateUserUI(),showSuccess(i,"Profil berhasil diperbarui!"),setTimeout(()=>{document.getElementById("editProfileModal").remove(),showUserProfile()},1500)}catch(e){console.error("‚ùå Error updating profile:",e),showError(s,"Gagal memperbarui profil: "+e.message)}finally{o.disabled=!1,o.innerHTML='<i class="fas fa-save"></i> Simpan Perubahan'}}else showError(s,"Nama dan jabatan wajib diisi")}),document.getElementById("editProfileModal").addEventListener("click",function(e){"editProfileModal"===e.target.id&&this.remove()}),document.addEventListener("keydown",function e(t){if("Escape"===t.key){const t=document.getElementById("editProfileModal");t&&t.remove(),document.removeEventListener("keydown",e)}})}function changePassword(){const e=document.createElement("div");e.innerHTML='\n        <div class="modal active" id="changePasswordModal">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <div class="modal-title">Ubah Password</div>\n                    <div class="close-modal" id="closeChangePasswordModal">&times;</div>\n                </div>\n                <div style="padding: 20px;">\n                    <div class="alert alert-info">\n                        <i class="fas fa-info-circle"></i> Password baru minimal 6 karakter\n                    </div>\n                    \n                    <form id="changePasswordForm">\n                        <div class="form-group">\n                            <label for="currentPassword">Password Saat Ini</label>\n                            <input type="password" id="currentPassword" required>\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="newPassword">Password Baru</label>\n                            <input type="password" id="newPassword" required minlength="6">\n                        </div>\n                        \n                        <div class="form-group">\n                            <label for="confirmNewPassword">Konfirmasi Password Baru</label>\n                            <input type="password" id="confirmNewPassword" required>\n                        </div>\n                        \n                        <div id="changePasswordError" class="alert alert-danger" style="display: none;"></div>\n                        <div id="changePasswordSuccess" class="alert alert-success" style="display: none;"></div>\n                        \n                        <div class="form-group" style="margin-top: 20px;">\n                            <button type="submit" class="btn btn-warning" id="btnChangePasswordSubmit">\n                                <i class="fas fa-key"></i> Ubah Password\n                            </button>\n                            <button type="button" class="btn btn-outline" id="cancelChangePassword">\n                                <i class="fas fa-times"></i> Batal\n                            </button>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(e),document.getElementById("closeChangePasswordModal").addEventListener("click",function(){document.getElementById("changePasswordModal").remove()}),document.getElementById("cancelChangePassword").addEventListener("click",function(){document.getElementById("changePasswordModal").remove()}),document.getElementById("changePasswordForm").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("currentPassword").value,a=document.getElementById("newPassword").value,n=document.getElementById("confirmNewPassword").value,s=document.getElementById("changePasswordError"),i=document.getElementById("changePasswordSuccess"),o=document.getElementById("btnChangePasswordSubmit");if(a===n)if(a.length<6)showError(s,"Password baru minimal 6 karakter");else{showLoadingOverlay("Mengubah password..."),o.disabled=!0,o.innerHTML='<div class="loading"></div> Memproses...';try{const e=firebase.auth().currentUser,n=firebase.auth.EmailAuthProvider.credential(e.email,t);await e.reauthenticateWithCredential(n),await e.updatePassword(a),hideLoadingOverlay(),showSuccess(i,"Password berhasil diubah!"),o.disabled=!1,o.innerHTML='<i class="fas fa-key"></i> Ubah Password',document.getElementById("changePasswordForm").reset(),setTimeout(()=>{document.getElementById("changePasswordModal").remove()},2e3)}catch(e){console.error("Change password error:",e),hideLoadingOverlay(),o.disabled=!1,o.innerHTML='<i class="fas fa-key"></i> Ubah Password';let t="Gagal mengubah password. ";switch(e.code){case"auth/wrong-password":t="Password saat ini salah";break;case"auth/weak-password":t="Password baru terlalu lemah";break;default:t+=e.message}showError(s,t)}}else showError(s,"Password baru dan konfirmasi tidak cocok")}),document.getElementById("changePasswordModal").addEventListener("click",function(e){"changePasswordModal"===e.target.id&&this.remove()}),document.addEventListener("touchmove",function(e){1!==e.scale&&e.preventDefault()},{passive:!1})}function setupUserDropdown(){const e=document.getElementById("userProfile"),t=document.getElementById("userDropdown");e.addEventListener("click",function(e){e.stopPropagation(),t.classList.toggle("active")}),document.addEventListener("click",function(a){e.contains(a.target)||t.contains(a.target)||t.classList.remove("active")}),document.getElementById("btnUserManagement").addEventListener("click",function(e){e.preventDefault(),t.classList.remove("active"),showUserManagementModal()}),document.getElementById("btnLogout").addEventListener("click",async function(e){if(e.preventDefault(),confirm("Apakah Anda yakin ingin logout?")){showLoadingOverlay("Logout...");try{if(await firebase.auth().signOut(),localStorage.removeItem("cachedUser"),localStorage.removeItem("userToken"),localStorage.removeItem("userPassword"),localStorage.removeItem("rememberMe"),sessionStorage.removeItem("cachedUser"),sessionStorage.removeItem("userToken"),indexedDBInstance)try{const e=indexedDBInstance.transaction(["users"],"readwrite");e.objectStore("users").clear()}catch(e){console.warn("‚ö†Ô∏è Error clearing IndexedDB users:",e)}hideLoadingOverlay(),t.classList.remove("active"),handleUserSignedOut()}catch(e){console.error("‚ùå Logout error:",e),hideLoadingOverlay(),alert("Logout gagal: "+e.message)}}}),document.getElementById("btnProfile").addEventListener("click",function(e){e.preventDefault(),t.classList.remove("active"),showUserProfile()}),document.getElementById("btnChangePassword").addEventListener("click",function(e){e.preventDefault(),t.classList.remove("active"),changePassword()})}function setupAuthForms(){document.querySelectorAll(".login-tab").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-form");document.querySelectorAll(".login-tab").forEach(e=>{e.classList.remove("active")}),this.classList.add("active"),document.querySelectorAll(".login-form").forEach(e=>{e.classList.remove("active")}),document.getElementById(`${e}Form`).classList.add("active");const t=document.getElementById(`${e}Error`),a=document.getElementById(`${e}Success`);t&&(t.style.display="none"),a&&(a.style.display="none")})}),document.querySelectorAll(".switch-form a").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("data-form");document.querySelector(`.login-tab[data-form="${t}"]`).click()})}),document.getElementById("loginForm").addEventListener("submit",async function(e){e.preventDefault(),await loginUser()}),document.getElementById("registerForm").addEventListener("submit",async function(e){e.preventDefault(),await registerUser()}),document.getElementById("forgotPassword").addEventListener("click",async function(e){e.preventDefault(),await forgotPassword()})}async function showUserManagementModal(){if(currentUser&&"owner"===currentUser.role){showLoadingOverlay("Memuat daftar user...");try{const e=await db.collection("users").get(),t=[];e.forEach(e=>{t.push({uid:e.id,...e.data()})}),hideLoadingOverlay();let a="";t.forEach(e=>{const t=e.uid===currentUser.uid;a+=`\n                <tr>\n                    <td>${e.nama||"-"}</td>\n                    <td>${e.email}</td>\n                    <td>${e.role}</td>\n                    <td>\n                        <span class="badge ${e.isActive?"badge-success":"badge-danger"}">\n                            ${e.isActive?"Aktif":"Nonaktif"}\n                        </span>\n                    </td>\n                    <td>\n                        ${t?"<i>Tidak bisa ubah diri sendiri</i>":`\n                                <button class="btn btn-sm ${e.isActive?"btn-warning":"btn-success"}"\n                                    onclick="toggleUserStatus('${e.uid}', ${e.isActive})">\n                                    ${e.isActive?"Nonaktifkan":"Aktifkan"}\n                                </button>\n                              `}\n                    </td>\n                </tr>\n            `});const n=`\n            <div class="modal active" id="userManagementModal">\n                <div class="modal-content" style="max-width:900px;">\n                    <div class="modal-header">\n                        <div class="modal-title">\n                            <i class="fas fa-users-cog"></i> Manajemen User\n                        </div>\n                        <div class="close-modal" id="closeUserManagementModal">&times;</div>\n                    </div>\n                    <div style="padding:20px; overflow-x:auto;">\n                        <table class="table">\n                            <thead>\n                                <tr>\n                                    <th>Nama</th>\n                                    <th>Email</th>\n                                    <th>Role</th>\n                                    <th>Status</th>\n                                    <th>Aksi</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${a}\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            </div>\n        `,s=document.createElement("div");s.innerHTML=n,document.body.appendChild(s),document.getElementById("closeUserManagementModal").addEventListener("click",()=>{document.getElementById("userManagementModal").remove()}),document.getElementById("userManagementModal").addEventListener("click",function(e){"userManagementModal"===e.target.id&&this.remove()})}catch(e){hideLoadingOverlay(),console.error("‚ùå Gagal load user:",e),showToastNotification("Gagal memuat user","danger")}}else showToastNotification("Tidak punya akses","danger")}async function toggleUserStatus(e,t){if(currentUser&&"owner"===currentUser.role){showLoadingOverlay("Memproses...");try{await db.collection("users").doc(e).update({isActive:!t,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}),hideLoadingOverlay(),showToastNotification("User berhasil "+(t?"dinonaktifkan":"diaktifkan"),"success"),document.getElementById("userManagementModal")?.remove(),showUserManagementModal()}catch(e){hideLoadingOverlay(),console.error("‚ùå Update gagal:",e),showToastNotification("Gagal update user","danger")}}else showToastNotification("Tidak punya akses","danger")}function showSyncProgress(e=!0,t="Menyinkronkan...",a=null){const n=document.getElementById("syncProgressIndicator"),s=document.getElementById("syncProgressText"),i=document.getElementById("syncProgressPercent"),o=document.getElementById("btnSyncNow");n&&(e?(n.style.display="flex",s&&(s.textContent=t),null!==a&&i?(i.textContent=`${a}%`,i.style.display="inline"):i&&(i.style.display="none"),n.classList.remove("sync-complete","sync-error"),n.classList.add("sync-active"),o&&(o.disabled=!0,o.innerHTML='<div class="loading" style="width: 16px; height: 16px;"></div> Syncing...')):(n.style.display="none",n.classList.remove("sync-active","sync-complete","sync-error"),o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-sync"></i> Sync Now')))}function updateSyncStatus(e){const t=document.getElementById("syncStatus");t&&(e?(t.className="status-badge status-info",t.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> <span>Sinkronisasi: Berjalan</span>'):(t.className=isFirebaseConnected?"status-badge status-online":"status-badge status-offline",t.innerHTML=isFirebaseConnected?'<i class="fas fa-check-circle"></i> <span>Sinkronisasi: Siap</span>':'<i class="fas fa-times-circle"></i> <span>Sinkronisasi: Offline</span>'))}async function runSyncNow(){if(navigator.onLine&&isFirebaseConnected&&!isSyncRunning){isSyncRunning=!0,syncStartTime=Date.now(),showSyncProgress(!0,"Memulai sinkronisasi...",0),updateSyncStatus(!0);try{await getCloudSyncMetadata();const e=await getLastPullTimestamp();let t=!1,a=!1;const n=await getPendingAssets();if(n.length>0){t=!0;for(const e of n)try{const{syncStatus:t,...a}=e;await db.collection("assets").doc(e.id).set(a,{merge:!0}),await updateAssetSyncStatus(e.id,"synced")}catch(t){console.error("Upload gagal:",e.id,t)}await updateCloudSyncMetadata(n.map(e=>e.id))}const s=await getCloudSyncMetadata();let i=[];if(s&&s.lastGlobalUpdate>e){if(i=await pullChangesFromCloud(e),i.length>0){a=!0,await processCloudChanges(i);const e=Math.max(...i.map(e=>e.updatedAt||e.lastUpdated||0));e>0&&await saveLastPullTimestamp(e)}await resetCloudSyncMetadata()}(t||a)&&(await loadAssetsFromIndexedDBOnly(),updateDashboard());showSyncProgress(!0,`Selesai (${((Date.now()-syncStartTime)/1e3).toFixed(1)}s)`,100),setTimeout(()=>{showSyncProgress(!1)},1200),lastSyncTime=new Date;const o=document.getElementById("lastSyncTime");o&&(o.textContent=lastSyncTime.toLocaleString())}catch(e){console.error("‚ùå Sync error:",e),showSyncProgress(!0,"Sync gagal",0),setTimeout(()=>showSyncProgress(!1),1500)}finally{isSyncRunning=!1,updateSyncStatus(!1)}}}async function retryPendingThumbnails(){if(!indexedDBInstance||!navigator.onLine)return;const e=indexedDBInstance.transaction(["photos"],"readonly").objectStore("photos");if(!e.indexNames.contains("thumbnailStatus"))return;const t=e.index("thumbnailStatus").getAll("pending_download");t.onsuccess=async()=>{const e=t.result||[];if(0!==e.length)for(const t of e)if(t.cloudinary?.secure_url)try{const e=await fetch(t.cloudinary.secure_url),a=await e.blob(),n=new File([a],"thumb_retry.jpg",{type:"image/jpeg"}),s=await compressImage(n,{forThumbnail:!0});t.thumbnail=s.base64,t.hasLocalThumbnail=!0,t.thumbnailStatus="ready",await new Promise((e,a)=>{const n=indexedDBInstance.transaction(["photos"],"readwrite").objectStore("photos").put(t);n.onsuccess=e,n.onerror=a})}catch(e){console.warn("Retry gagal:",e)}}}async function fetchWithRetry(e,t={},a=3,n=1e4){for(let s=0;s<a;s++)try{const a=new AbortController,s=setTimeout(()=>a.abort(),n),i=await fetch(e,{...t,signal:a.signal});if(clearTimeout(s),!i.ok)throw new Error("Network response not ok");return i}catch(e){if(s===a-1)throw e;await new Promise(e=>setTimeout(e,1e3))}}async function firstTimeSyncFromCloud(){if(!navigator.onLine||!isFirebaseConnected)return[];showProgressOverlay("first_sync",{title:"Sinkronisasi Awal",subtitle:"Mengunduh semua data dari cloud..."});try{updateProgressStep("fetch_assets","active"),updateProgressText("Mengunduh data asset..."),updateProgressBar(10);const e=(await db.collection("assets").get()).docs.map(e=>({id:e.id,...e.data(),syncStatus:"synced"}));updateProgressStep("fetch_assets","completed"),updateProgressStep("save_assets","active"),updateProgressText(`Menyimpan ${e.length} asset...`),updateProgressBar(30),await saveAssetBatchToIndexedDB(e),updateProgressStep("save_assets","completed"),updateProgressStep("process_photos","active"),updateProgressText("Memproses foto dan membuat thumbnail..."),updateProgressBar(50);let t=0,a=0;const n=10;for(let s=0;s<e.length;s++){const i=e[s];if(s%n===0){updateProgressBar(50+(s+1)/e.length*30),updateProgressText(`Memproses foto asset ${s+1}/${e.length}...`)}if(i.photos&&Array.isArray(i.photos)&&i.photos.length>0)for(const e of i.photos)try{const n={assetId:i.id,type:e.type||"utama",timestamp:e.timestamp||Date.now(),tanggal:e.tanggal||(new Date).toISOString(),uploadStatus:"UPLOADED",cloudinary:e.cloudinary||null,source:"firestore_sync"};if(e.cloudinary?.secure_url)try{const t=await fetchWithRetry(e.cloudinary.secure_url,{cache:"force-cache"},3,1e4),a=await t.blob(),s=new File([a],`thumb_${Date.now()}.jpg`,{type:"image/jpeg"}),i=await compressImage(s,{forThumbnail:!0});n.thumbnail=i.base64,n.hasLocalThumbnail=!0,n.thumbnailStatus="ready"}catch(e){console.error("Thumbnail download error:",e),n.thumbnailStatus="pending_download",n.hasLocalThumbnail=!1,a++}await new Promise(e=>{const t=indexedDBInstance.transaction(["photos"],"readwrite");t.objectStore("photos").add(n),t.oncomplete=e}),t++}catch(e){console.error("Failed to process photo:",e),a++}}updateProgressStep("process_photos","completed"),updateProgressBar(80),updateProgressStep("update_metadata","active"),updateProgressText("Memperbarui metadata...");let s=0;e.forEach(e=>{const t=e.updatedAt||e.lastUpdated||0;t>s&&(s=t)}),s>0&&await saveLastPullTimestamp(s),await updateCloudSyncMetadata([]),updateProgressStep("update_metadata","completed"),updateProgressBar(95),updateProgressStep("finalize","active"),updateProgressText("Menyelesaikan..."),await initPhotoCache(),updateProgressStep("finalize","completed"),updateProgressBar(100),setTimeout(()=>{retryPendingThumbnails()},3e3);return showToastNotification(a>0?`‚úÖ Sinkronisasi awal: ${e.length} asset, ${t} foto (${a} pending)`:`‚úÖ Sinkronisasi awal selesai: ${e.length} asset, ${t} foto`,a>0?"warning":"success"),e}catch(e){throw console.error("‚ùå First time sync error:",e),showToastNotification("‚ùå Gagal sinkronisasi awal","danger"),e}finally{hideProgressOverlay()}}async function pullChangesFromCloud(e){if(!navigator.onLine||!isFirebaseConnected)return[];try{const t=(await db.collection("assets").where("updatedAt",">",e).get()).docs.map(e=>{const t=e.data();return{id:e.id,...t,updatedAt:t.updatedAt||t.lastUpdated||0,lastUpdated:t.lastUpdated||t.updatedAt||0,syncStatus:"synced"}});return t.length>0&&await downloadThumbnailsForAssets(t),t}catch(e){console.error("Error pulling changes:",e);try{const e=await getCloudSyncMetadata();if(e&&e.changedAssets&&e.changedAssets.length>0){const t=[];for(const a of e.changedAssets.slice(0,50)){const e=await db.collection("assets").doc(a).get();if(e.exists){const a=e.data();t.push({id:e.id,...a,updatedAt:a.updatedAt||a.lastUpdated||0,lastUpdated:a.lastUpdated||a.updatedAt||0,syncStatus:"synced"})}}return await downloadThumbnailsForAssets(t),t}}catch(e){console.error("Fallback also failed:",e)}return[]}}async function downloadThumbnailsForAssets(e){let t=0;for(const a of e){if(!a.photos||!Array.isArray(a.photos)||0===a.photos.length)continue;const e=await getAssetPhotos(a.id);for(const n of a.photos)if(n.cloudinary&&n.cloudinary.secure_url)try{if(e.some(e=>e.cloudinary&&e.cloudinary.public_id===n.cloudinary.public_id))continue;const s=await fetch(n.cloudinary.secure_url);if(!s.ok){console.warn(`‚ö†Ô∏è HTTP error ${s.status}`);continue}const i=await s.blob(),o=new File([i],`thumb_${Date.now()}.jpg`,{type:"image/jpeg"}),r=await compressImage(o,{forThumbnail:!0}),l={assetId:a.id,type:n.type||"utama",timestamp:n.timestamp||Date.now(),tanggal:n.tanggal||(new Date).toISOString(),uploadStatus:"UPLOADED",cloudinary:n.cloudinary,thumbnail:r.base64,hasLocalThumbnail:!0,source:"sync_download"};await new Promise((e,a)=>{const n=indexedDBInstance.transaction(["photos"],"readwrite").objectStore("photos").add(l);n.onsuccess=()=>{t++,e()},n.onerror=a})}catch(e){console.warn(`‚ö†Ô∏è Gagal download thumbnail untuk ${a.id}:`,e)}}return t}async function processCloudChanges(e){let t=0,a=0,n=0;for(const s of e){const e=assets.find(e=>e.id===s.id);if(e){if((s.updatedAt||s.lastUpdated||0)>(e.updatedAt||e.lastUpdated||0))if("pending"===e.syncStatus){console.warn(`‚ö†Ô∏è Conflict: asset ${s.id} changed in both places`);"useCloud"===await showSimpleConflictModal(e,s)&&(await saveAssetToIndexedDB({...s,syncStatus:"synced"},"synced"),s.photos&&s.photos.length>0&&await downloadThumbnailsForAssets([s]),n++)}else await saveAssetToIndexedDB({...s,syncStatus:"synced"},"synced"),s.photos&&s.photos.length>0&&await downloadThumbnailsForAssets([s]),a++}else await saveAssetToIndexedDB(s,"synced"),s.photos&&s.photos.length>0&&await downloadThumbnailsForAssets([s]),t++}return{newCount:t,updateCount:a,conflictCount:n}}async function showSimpleConflictModal(e,t){return new Promise(a=>{const n="conflictModal_"+Date.now()+"_"+Math.random().toString(36).substr(2,5),s=`resolveConflict_${n}`,i=e=>{if(!e)return"Tidak diketahui";try{return new Date(e).toLocaleString("id-ID")}catch{return String(e)}},o=i(e.updatedAt||e.lastUpdated),r=i(t.updatedAt||t.lastUpdated),l=e.updated_by?.nama||e.updatedByName||"Anda",d=t.updated_by?.nama||t.updatedByName||"User lain",c=`\n            <div class="modal active" id="${n}">\n                <div class="modal-content" style="max-width: 500px;">\n                    <div class="modal-header">\n                        <div class="modal-title">‚ö†Ô∏è Konflik Data</div>\n                        <span class="close-modal" onclick="document.getElementById('${n}').remove(); window.${s}('cancel')">&times;</span>\n                    </div>\n                    \n                    <div style="padding: 20px;">\n                        <p><strong>${e.nama_asset||"Item"}</strong> telah diubah di dua tempat:</p>\n                        \n                        <div style="background: var(--light); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--warning);">\n                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                                <span><i class="fas fa-database"></i> <strong>Versi Lokal (Anda)</strong></span>\n                                <span class="badge badge-warning">Pending</span>\n                            </div>\n                            <div>üïê ${o}</div>\n                            <div>üë§ ${l}</div>\n                            <div>üìä Kondisi: ${e.kondisi||"-"}</div>\n                            <div>üìç Lokasi: ${e.lokasi||"-"}</div>\n                        </div>\n                        \n                        <div style="background: var(--light); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--info);">\n                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">\n                                <span><i class="fas fa-cloud"></i> <strong>Versi Cloud</strong></span>\n                                <span class="badge badge-info">Terbaru</span>\n                            </div>\n                            <div>üïê ${r}</div>\n                            <div>üë§ ${d}</div>\n                            <div>üìä Kondisi: ${t.kondisi||"-"}</div>\n                            <div>üìç Lokasi: ${t.lokasi||"-"}</div>\n                        </div>\n                        \n                        <div style="display: flex; gap: 10px; margin-top: 20px;">\n                            <button class="btn btn-info" style="flex:1" onclick="${s}('useCloud')">\n                                <i class="fas fa-cloud"></i> Pakai Cloud\n                            </button>\n                            <button class="btn btn-warning" style="flex:1" onclick="${s}('useLocal')">\n                                <i class="fas fa-database"></i> Pakai Lokal\n                            </button>\n                        </div>\n                        \n                        <p style="margin-top: 15px; font-size: 12px; color: var(--secondary);">\n                            <i class="fas fa-info-circle"></i> Memilih Cloud akan MENIMPA data lokal Anda.\n                            Memilih Lokal akan MENGUPDATE data cloud.\n                        </p>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",c),window[s]=e=>{const t=document.getElementById(n);t&&t.remove(),delete window[s],a(e)};const u=setSafeInterval(()=>{document.getElementById(n)||(clearInterval(u),window[s]&&(delete window[s],a("cancel")))},500)})}async function detectConflict(e,t){if(!navigator.onLine||!isFirebaseConnected||!db)return{hasConflict:!1,canProceed:!0,reason:"offline"};try{const a=await db.collection("assets").doc(e).get();if(!a.exists)return{hasConflict:!1,canProceed:!0};const n=a.data(),s=t.updatedAt||t.lastUpdated||0,i=n.updatedAt||n.lastUpdated||0;if(i>s){const e=n.updatedByName||n.updated_by?.nama||n.updated_by?.email||"User tidak dikenal",a=n.updatedBy||n.updated_by?.uid||"unknown",o=n.updatedAtISO||n.updated_at||new Date(i).toISOString(),r=t.updatedByName||t.updated_by?.nama||currentUser?.nama||"Anda";return{hasConflict:!0,canProceed:!1,cloudData:n,localData:t,conflictInfo:{cloudUpdatedAt:o,cloudUpdatedBy:e,cloudUpdatedById:a,cloudTimestamp:i,localUpdatedAt:t.updatedAtISO||t.updated_at||new Date(s).toISOString(),localUpdatedBy:r,localTimestamp:s}}}return{hasConflict:!1,canProceed:!0}}catch(e){return console.error("‚ùå Error detecting conflict:",e),{hasConflict:!1,canProceed:!0,error:e.message,warning:"Gagal mengecek konflik, lanjutkan dengan hati-hati"}}}async function preparePhotosForFirestore(e){try{return(await getAssetPhotos(e)).map(e=>{const t={type:e.type,tanggal:e.tanggal,timestamp:e.timestamp,uploadStatus:e.uploadStatus||"LOCAL"};return e.cloudinary&&(t.cloudinary={secure_url:e.cloudinary.secure_url,public_id:e.cloudinary.public_id,created_at:e.cloudinary.created_at}),e.uploaded_by&&(t.uploaded_by=e.uploaded_by),t})}catch(e){return console.error("Error preparing photos for Firestore:",e),[]}}function normalizeAssetData(e,t={}){const{userInfo:a=currentUser,isImport:n=!1,source:s="unknown",timestamp:i=null}=t,o=e.jenis_item||"asset";if(!e.material_kode||!e.no_rs)throw new Error("Material code dan No RS wajib ada");const r=e.material_kode.toString().replace(/\s+/g,"").toUpperCase(),l=e.no_rs.toString().replace(/\s+/g,"").toUpperCase();let d=e.id;const c=i||Date.now(),u=Math.random().toString(36).substring(2,8).toUpperCase();if(!d||n){d=`${"asset"===o?"A":"N"}-${r}-${c}-${u}-1`}const m={id:d,jenis_item:o,nama_asset:(e.nama_asset||"").trim(),material_kode:r,no_rs:l,no_po:e.no_po||null,lokasi:(e.lokasi||"").trim(),catatan_awal:e.catatan_awal||null,created_at:e.created_at||(new Date).toISOString(),updated_at:(new Date).toISOString(),updatedAt:Date.now(),syncStatus:"pending"},p=a?{uid:a.uid||"system",nama:a.nama||a.email||"System",email:a.email||"system@local",jabatan:a.jabatan||"",timestamp:Date.now()}:{uid:"system",nama:"System",email:"system@local",jabatan:"",timestamp:Date.now()};if(e.created_by&&!n?m.created_by=e.created_by:m.created_by=p,m.updated_by=p,m.updatedByName=p.nama,"asset"===o)m.kondisi=e.kondisi||"baik",m.kondisi_detail=null,m.total_jumlah=1,m.no_asset=e.no_asset||null;else{if(m.kondisi=null,e.kondisi_detail&&"object"==typeof e.kondisi_detail)m.kondisi_detail={baik:parseInt(e.kondisi_detail.baik)||0,rusak:parseInt(e.kondisi_detail.rusak)||0,Mutasi:parseInt(e.kondisi_detail.Mutasi)||0};else{const t=parseInt(e.jumlah||e.total_jumlah||1),a=(e.kondisi||"baik").toLowerCase();m.kondisi_detail={baik:"baik"===a?t:0,rusak:"rusak"===a?t:0,Mutasi:"Mutasi"===a?t:0}}m.total_jumlah=(m.kondisi_detail.baik||0)+(m.kondisi_detail.rusak||0)+(m.kondisi_detail.Mutasi||0),m.no_asset=null}if(e.riwayat&&Array.isArray(e.riwayat)&&0!==e.riwayat.length)m.riwayat=e.riwayat;else{const e={tanggal:(new Date).toISOString(),tipe:n?"import":"create",user:p,catatan:n?`Import dari ${s}`:"Item dibuat"};"asset"===o?(e.old_kondisi=null,e.new_kondisi=m.kondisi,e.old_lokasi=null,e.new_lokasi=m.lokasi,e.old_jumlah=null,e.new_jumlah=1):(e.old_kondisi_detail=null,e.new_kondisi_detail=m.kondisi_detail,e.old_lokasi=null,e.new_lokasi=m.lokasi,e.old_jumlah=null,e.new_jumlah=m.total_jumlah),m.riwayat=[e]}return n&&(m.imported_at=(new Date).toISOString(),m.imported_by=a?{uid:a.uid,nama:a.nama,email:a.email}:null,m.import_source=s),m}async function loadAssetsFromIndexedDBOnly(){updateSplashStatus("Memuat data dari penyimpanan lokal...");try{return assets=await loadAssetsFromIndexedDB(),pendingSyncAssets=assets.filter(e=>"pending"===e.syncStatus),updateAssetSelects(),displayAssets(),updateDashboard(),updateSplashStatus(`Berhasil memuat ${assets.length} item`,"Menampilkan data..."),assets}catch(e){return console.error("Error loading from IndexedDB:",e),updateSplashStatus("Gagal memuat data lokal","Menggunakan mode baru"),[]}}async function loadAssets(){return await loadAssetsFromIndexedDBOnly(),navigator.onLine&&isFirebaseConnected&&!isSyncRunning&&setTimeout(()=>{runSyncNow().catch(e=>{console.warn("Background sync error:",e)})},2e3),assets}function getEffectiveCondition(e){if(!e)return null;if("asset"===e.jenis_item)return e.kondisi||null;if("non-asset"===e.jenis_item){if(!e.kondisi_detail||"object"!=typeof e.kondisi_detail)return null;const t=e.kondisi_detail;let a=0,n=null;for(const e of["baik","rusak","Mutasi"]){const s=t[e]||0;s>a&&(a=s,n=e)}return n}return null}function checkDuplicateAsset(e,t){const a=normalizeValue(e),n=normalizeValue(t);return assets.find(e=>normalizeValue(e.material_kode)===a&&normalizeValue(e.no_rs)===n)}function toggleJumlahField(){const e=document.getElementById("jenis_item").value,t=document.getElementById("jumlahContainer"),a=document.getElementById("jumlah"),n=document.getElementById("jenis_item").value,s=document.getElementById("noAssetGroup");"asset"===n?s.style.display="block":(s.style.display="none",document.getElementById("no_asset").value=""),"non-asset"===e?(t.style.display="block",a.required=!0,a.value=1):(t.style.display="none",a.required=!1,a.value=1)}function previewPhotos(e){const t=document.getElementById("photoPreview");if(t.innerHTML="",e.files&&e.files.length>0)for(let a=0;a<e.files.length;a++){const n=e.files[a],s=new FileReader;s.onload=function(e){const s=document.createElement("img");s.src=e.target.result,s.className="photo-thumb",s.style.width="80px",s.style.height="80px",s.title=`Foto ${a+1}: ${n.name}`;const i=document.createElement("div");i.style.position="relative",i.style.display="inline-block",i.style.margin="5px";const o=document.createElement("div");o.style.position="absolute",o.style.top="5px",o.style.left="5px",o.style.background="rgba(0,0,0,0.7)",o.style.color="white",o.style.borderRadius="50%",o.style.width="20px",o.style.height="20px",o.style.textAlign="center",o.style.lineHeight="20px",o.style.fontSize="12px",o.textContent=a+1,i.appendChild(s),i.appendChild(o),t.appendChild(i)},s.readAsDataURL(n)}}function showDataPreview(){const e=document.getElementById("jenis_item").value,t=document.getElementById("nama_asset").value,a=document.getElementById("material_kode").value,n=document.getElementById("no_rs").value,s=document.getElementById("no_po").value,i=document.getElementById("no_asset").value,o=document.getElementById("lokasi").value,r=document.getElementById("kondisi").value,l=document.getElementById("catatan_awal").value,d=document.getElementById("jumlah").value||"1",c=document.getElementById("foto_utama").files;if(!(e&&t&&a&&n&&o&&r&&0!==c.length))return void showAlert("addAssetAlert","Harap lengkapi semua field wajib!","danger");const u=checkDuplicateAsset(a,n);if(u)return void showAlert("addAssetAlert",`\n            ‚ùå ASSET SUDAH ADA , CHECK DI DETAIL ITEM!<br><br>\n            <strong>Material Code:</strong> ${u.material_kode}<br>\n            <strong>No RS:</strong> ${u.no_rs}<br>\n            <strong>Nama:</strong> ${u.nama_asset}<br>\n            <strong>Lokasi:</strong> ${u.lokasi}<br>\n            <strong>ID:</strong> ${u.id}\n            `,"danger");const m=document.getElementById("previewContent"),p=document.getElementById("finalPhotoPreview");if(m.innerHTML=`\n        <div class="alert alert-info">\n            <i class="fas fa-info-circle"></i> Preview data yang akan disimpan:\n        </div>\n        \n        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">\n            <div>\n                <strong>Jenis Item:</strong><br>\n                <span style="color: ${"asset"===e?"var(--success)":"var(--primary)"}; font-weight: bold;">\n                    ${"asset"===e?"ASSET":"NON-ASSET"}\n                </span>\n            </div>\n            <div>\n                <strong>Jumlah:</strong><br>\n                ${"non-asset"===e?d:"1 (auto untuk asset)"}\n            </div>\n            <div>\n                <strong>Nama Item:</strong><br>\n                ${t}\n            </div>\n            <div>\n                <strong>Kode Material:</strong><br>\n                ${a}\n            </div>\n            <div>\n                <strong>No. Reservation Slip:</strong><br>\n                ${n}\n            </div>\n            <div>\n                <strong>No. PO/POA:</strong><br>\n                ${s||"(tidak diisi)"}\n            </div>\n            <div> <strong>No. Asset:</strong><br>\n                ${i||"(tidak diisi)"}\n            </div>\n            <div>\n                <strong>Lokasi:</strong><br>\n                ${o}\n            </div>\n            <div>\n                <strong>Kondisi:</strong><br>\n                <span class="badge ${"baik"===r?"badge-success":"rusak"===r?"badge-danger":"badge-warning"}">\n                    ${"baik"===r?"Baik":"rusak"===r?"Rusak":"Mutasi"}\n                </span>\n            </div>\n            ${l?`\n            <div style="grid-column: span 2;">\n                <strong>Catatan:</strong><br>\n                ${l}\n            </div>\n            `:""}\n        </div>\n        \n        <div style="margin-top: 15px; padding: 10px; background: var(--light); border-radius: 5px;">\n            <small><i class="fas fa-camera"></i> Total foto: ${c.length} file</small>\n        </div>\n    `,p.innerHTML="",c&&c.length>0)for(let e=0;e<c.length;e++){const t=c[e],a=new FileReader;a.onload=function(t){const a=document.createElement("img");a.src=t.target.result,a.className="photo-thumb",a.style.width="100px",a.style.height="100px",a.title=`Foto ${e+1}`;const n=document.createElement("div");n.style.position="relative",n.style.display="inline-block",n.style.margin="5px";const s=document.createElement("div");s.style.position="absolute",s.style.bottom="0",s.style.left="0",s.style.right="0",s.style.background="rgba(0,0,0,0.7)",s.style.color="white",s.style.textAlign="center",s.style.padding="2px",s.style.fontSize="11px",s.textContent=`Foto ${e+1}`,n.appendChild(a),n.appendChild(s),p.appendChild(n)},a.readAsDataURL(t)}document.getElementById("previewModal").classList.add("active")}async function saveItemData(){if(!currentUser)return showAlert("addAssetAlert","Anda harus login untuk menambahkan item","danger"),!1;showProgressOverlay("save",{title:"Menyimpan Item",subtitle:"Sedang memproses data..."});try{const e=document.getElementById("jenis_item").value,t=document.getElementById("nama_asset").value,a=document.getElementById("material_kode").value,n=document.getElementById("no_rs").value,s=document.getElementById("no_po").value;let i=null;"asset"===e&&(i=document.getElementById("no_asset")?.value.trim()||null);const o=document.getElementById("lokasi").value;let r=o;if("other"===o&&(r=document.getElementById("customLokasi").value.trim(),!r))return hideProgressOverlay(),showAlert("addAssetAlert","Harap isi lokasi custom","danger"),!1;const l=checkDuplicateAsset(a,n);if(l)return hideProgressOverlay(),showAlert("addAssetAlert",`‚ùå Kombinasi Material Code + No RS sudah ada.<br><strong>ID:</strong> ${l.id}`,"danger"),!1;const d=document.getElementById("kondisi").value,c=document.getElementById("catatan_awal").value,u="non-asset"===e?parseInt(document.getElementById("jumlah").value):1,m=document.getElementById("foto_utama").files;if(0===m.length)return hideProgressOverlay(),showAlert("addAssetAlert","Foto wajib diisi","danger"),!1;updateProgressStep("validate","completed"),updateProgressStep("prepare","active"),updateProgressBar(20);const p=Date.now(),g=Math.random().toString(36).substring(2,8).toUpperCase(),f={uid:currentUser.uid,nama:currentUser.nama||currentUser.email,email:currentUser.email,jabatan:currentUser.jabatan||"",timestamp:p};updateProgressStep("prepare","completed"),updateProgressStep("create_items","active"),updateProgressBar(40);let h=[];if("asset"===e){const e=`A-${a}-${p}-${g}-1`;h.push({id:e,jenis_item:"asset",nama_asset:t,material_kode:a,no_rs:n,no_po:s||null,no_asset:i,lokasi:r,kondisi:d,kondisi_detail:null,total_jumlah:1,catatan_awal:c||null,created_at:(new Date).toISOString(),created_by:f,updated_at:(new Date).toISOString(),updated_by:f,riwayat:[{tanggal:(new Date).toISOString(),tipe:"create",user:f,old_kondisi:null,new_kondisi:d,old_lokasi:null,new_lokasi:r,old_jumlah:null,new_jumlah:1,catatan:"Item dibuat",detail:`Dibuat oleh ${f.nama}`}],syncStatus:"pending"})}else{const e=`N-${a}-${p}-${g}-1`,i={baik:"baik"===d?u:0,rusak:"rusak"===d?u:0,Mutasi:"Mutasi"===d?u:0};h.push({id:e,jenis_item:"non-asset",nama_asset:t,material_kode:a,no_rs:n,no_po:s||null,lokasi:r,kondisi:null,kondisi_detail:i,total_jumlah:u,catatan_awal:c||null,created_at:(new Date).toISOString(),created_by:f,updated_at:(new Date).toISOString(),updated_by:f,riwayat:[{tanggal:(new Date).toISOString(),tipe:"create",user:f,old_kondisi_detail:null,new_kondisi_detail:i,old_lokasi:null,new_lokasi:r,old_jumlah:null,new_jumlah:u,catatan:"Item dibuat",detail:`Dibuat oleh ${f.nama}`}],syncStatus:"pending"})}updateProgressStep("create_items","completed"),updateProgressStep("save_photos","active"),updateProgressBar(60);const y=h[0].id;let v=[];for(let e=0;e<m.length;e++){const t=m[e];updateProgressText(`Mengolah foto ${e+1}...`);const a=await compressImage(t),n=await savePhotoWithCloudinary(y,"utama",a,t,f);v.push(n),updateProgressBar(60+(e+1)/m.length*20)}updateProgressStep("save_photos","completed"),updateProgressStep("save_items","active"),updateProgressBar(85);for(const e of h)await saveAssetToIndexedDB(e,"pending"),await logUserActivity("create_asset",{assetId:e.id,assetName:e.nama_asset,jenis:e.jenis_item,jumlah:e.total_jumlah});if(assets.push(...h),updateProgressStep("save_items","completed"),navigator.onLine&&isFirebaseConnected){const e=h.map(e=>e.id);await updateCloudSyncMetadata(e)}return updateProgressStep("finalize","active"),updateProgressBar(100),updateAssetSelects(),displayAssets(),updateDashboard(),document.getElementById("addAssetForm").reset(),document.getElementById("customLokasi").style.display="none",document.getElementById("photoPreview").innerHTML="",toggleJumlahField(),hideProgressOverlay(),showAlert("addAssetAlert",`‚úÖ ${"asset"===e?"Asset":"Non-asset"} berhasil disimpan!`,"success"),document.getElementById("previewModal").classList.remove("active"),navigator.onLine&&isFirebaseConnected&&!isSyncRunning?setTimeout(runSyncNow,1e3):switchTab("daftar"),!0}catch(e){return console.error("Error saving item:",e),showProgressError(`Gagal menyimpan item: ${e.message}`),!1}}async function updateAssetCondition(e,t,a,n,s,i,o=null){if(window._isUpdating)return showToastNotification("‚è≥ Update sedang berlangsung...","info"),null;window._isUpdating=!0;try{const r=assets.findIndex(t=>t.id===e);if(-1===r)throw new Error("Item tidak ditemukan di data lokal");const l=assets[r];if(!currentUser)throw new Error("Anda harus login untuk memperbarui item");const d={uid:currentUser.uid,nama:currentUser.nama||currentUser.email,email:currentUser.email,jabatan:currentUser.jabatan||"",timestamp:Date.now()},c=l.kondisi,u=l.lokasi,m=i||u,p={...JSON.parse(JSON.stringify(l)),lokasi:m,updated_at:(new Date).toISOString(),updated_by:d,updatedAt:Date.now(),updatedAtISO:(new Date).toISOString(),updatedByName:d.nama,syncStatus:"pending"};let g=1,f=1;if("asset"===p.jenis_item)p.kondisi=t,p.total_jumlah=1;else if(o){p.kondisi_detail||(p.kondisi_detail={baik:p.total_jumlah||0,rusak:0,Mutasi:0});const e={...p.kondisi_detail},{from:t,to:a,qty:n}=o;if(n>(e[t]||0))throw new Error(`Jumlah melebihi stok kondisi ${t}. Tersedia: ${e[t]||0}`);if(n<=0)throw new Error("Jumlah perubahan harus lebih dari 0");const s={...e};e[t]-=n,e[a]=(e[a]||0)+n,p.kondisi_detail=e,p.kondisi=null,g=s,f={...e}}p.riwayat||(p.riwayat=[]);const h={id:generateUUID(),tanggal:(new Date).toISOString(),tipe:"update",user:d,old_kondisi:c,new_kondisi:p.kondisi,old_lokasi:u,new_lokasi:m,old_jumlah:g,new_jumlah:f,catatan:a,source:"update"};if(p.riwayat.push(h),navigator.onLine&&isFirebaseConnected){const t=await detectConflict(e,p);if(t.hasConflict){const a=await showConflictModal(t,l.nama_asset);if("refresh"===a)return showToastNotification("üîÑ Memuat data terbaru...","info"),await runSyncNow(),await loadAssetForUpdate(e),await updateDashboard(),showToastNotification("‚úÖ Data telah diperbarui dari cloud","success"),window._isUpdating=!1,null;if("cancel"===a)return showToastNotification("Update dibatalkan","info"),window._isUpdating=!1,null}}if(n){const t=p.kondisi,a="rusak"===t?"rusak":"Mutasi"===t?"Mutasi":"update";await savePhotoWithCloudinary(e,a,n,s,d)}const y=await saveAssetToIndexedDB(p,"pending");if(assets[r]=y,"pending"===y.syncStatus&&(pendingSyncAssets=pendingSyncAssets.filter(t=>t.id!==e),pendingSyncAssets.push(y)),navigator.onLine&&isFirebaseConnected&&await updateCloudSyncMetadata([e]),navigator.onLine&&isFirebaseConnected)try{await db.runTransaction(async t=>{const a=db.collection("assets").doc(e),n=await t.get(a);if(n.exists){const e=n.data();if((e.updatedAt||e.lastUpdated||0)>p.updatedAt)throw new Error("CONFLICT_IN_TRANSACTION")}const{syncStatus:s,...i}=p,o=await preparePhotosForFirestore(e),r=Date.now();t.set(a,{...i,photos:o,lastPhotoSync:r,updatedAt:r,updatedAtISO:new Date(r).toISOString()},{merge:!0})}),await updateAssetSyncStatus(e,"synced"),assets[r].syncStatus="synced"}catch(t){if("CONFLICT_IN_TRANSACTION"===t.message)return showToastNotification("‚ö†Ô∏è Terjadi konflik saat menyimpan. Memuat data terbaru...","warning"),await runSyncNow(),await loadAssetForUpdate(e),window._isUpdating=!1,null;console.warn("‚ö†Ô∏è Firestore sync failed, will retry later:",t),showToastNotification("‚ö†Ô∏è Gagal sync ke cloud, data tersimpan lokal","warning")}return await logUserActivity("update_asset",{assetId:e,assetName:l.nama_asset,old_kondisi:c,new_kondisi:t,old_lokasi:u,new_lokasi:m}),!isSyncRunning&&navigator.onLine&&setTimeout(runSyncNow,1e3),showToastNotification("‚úÖ Update berhasil disimpan","success"),window._isUpdating=!1,y}catch(e){if(window._isUpdating=!1,"REFRESH_DONE"===e.message||"UPDATE_CANCELLED"===e.message)return null;throw console.error("‚ùå Error updating asset:",e),e}}function showConflictModal(e,t="Item"){return new Promise(a=>{const{cloudData:n,conflictInfo:s}=e,i=e=>{try{const t=new Date(e);return isNaN(t.getTime())?e:t.toLocaleString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch{return e}},o=i(s.cloudUpdatedAt),r=i(s.localUpdatedAt),l="conflictModal_"+Date.now(),d=`\n            <div class="modal active" id="${l}">\n                <div class="modal-content" style="max-width: 600px;">\n                    <div class="modal-header">\n                        <div class="modal-title">\n                            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> \n                            Konflik Data Terdeteksi\n                        </div>\n                        <span class="close-modal" onclick="document.getElementById('${l}').remove()">&times;</span>\n                    </div>\n                    \n                    <div style="padding: 20px;">\n                        <div class="alert alert-warning" style="margin-bottom: 20px;">\n                            <i class="fas fa-info-circle"></i>\n                            <strong>${t}</strong> sudah diubah oleh user lain.\n                        </div>\n                        \n                        <div class="conflict-version">\n                            <div class="conflict-cloud">\n                                <h4 style="margin-bottom: 10px; color: var(--info);">\n                                    <i class="fas fa-cloud"></i> Versi Cloud (Terbaru)\n                                </h4>\n                                <div class="conflict-user">\n                                    <i class="fas fa-user-circle"></i>\n                                    <strong>${s.cloudUpdatedBy}</strong>\n                                </div>\n                                <div class="conflict-timestamp">\n                                    <i class="fas fa-clock"></i> ${o}\n                                </div>\n                                ${"unknown"!==s.cloudUpdatedById?`<div style="font-size: 11px; margin-top: 5px; color: var(--secondary);">\n                                        ID: ${s.cloudUpdatedById.substring(0,8)}...\n                                    </div>`:""}\n                            </div>\n                            \n                            <div class="conflict-local">\n                                <h4 style="margin-bottom: 10px; color: var(--secondary);">\n                                    <i class="fas fa-database"></i> Versi Lokal (Anda)\n                                </h4>\n                                <div class="conflict-user">\n                                    <i class="fas fa-user-circle"></i>\n                                    <strong>${s.localUpdatedBy}</strong>\n                                </div>\n                                <div class="conflict-timestamp">\n                                    <i class="fas fa-clock"></i> ${r}\n                                </div>\n                            </div>\n                        </div>\n                        \n                        <div class="conflict-actions">\n                            <button class="btn btn-conflict-refresh" id="refreshBtn_${l}">\n                                <i class="fas fa-sync-alt"></i> Refresh & Muat Data Cloud\n                            </button>\n                            <button class="btn btn-conflict-override" id="overrideBtn_${l}">\n                                <i class="fas fa-exclamation-circle"></i> Tetap Simpan (Override)\n                            </button>\n                            <button class="btn btn-conflict-cancel" id="cancelBtn_${l}">\n                                <i class="fas fa-times"></i> Batal\n                            </button>\n                        </div>\n                        \n                        <div style="margin-top: 15px; font-size: 12px; color: var(--secondary); text-align: center; padding: 10px; background: var(--light); border-radius: 6px;">\n                            <i class="fas fa-info-circle"></i> \n                            <strong>Refresh:</strong> Muat data terbaru dari cloud (perubahan Anda akan hilang)<br>\n                            <strong>Override:</strong> Timpa data cloud dengan versi Anda (data cloud akan hilang)\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,c=document.createElement("div");c.innerHTML=d,document.body.appendChild(c),document.getElementById(`refreshBtn_${l}`).addEventListener("click",()=>{document.getElementById(l).remove(),a("refresh")}),document.getElementById(`overrideBtn_${l}`).addEventListener("click",()=>{document.getElementById(l).remove(),a("override")}),document.getElementById(`cancelBtn_${l}`).addEventListener("click",()=>{document.getElementById(l).remove(),a("cancel")}),document.querySelector(`#${l} .close-modal`).addEventListener("click",()=>{document.getElementById(l).remove(),a("cancel")});const u=e=>{if("Escape"===e.key){const e=document.getElementById(l);e&&(e.remove(),document.removeEventListener("keydown",u),a("cancel"))}};document.addEventListener("keydown",u);const m=new MutationObserver(e=>{e.forEach(e=>{e.removedNodes.forEach(e=>{e.id===l&&(document.removeEventListener("keydown",u),m.disconnect())})})});m.observe(document.body,{childList:!0})})}async function loadAssetForUpdate(e){const t=assets.find(t=>t.id===e);if(!t)return;const a=await getAssetPhotos(e);document.getElementById("updateAssetName").textContent=t.nama_asset,document.getElementById("updateAssetCode").textContent=t.material_kode,document.getElementById("updateAssetCodeRs").textContent=t.no_rs,document.getElementById("updateAssetLocation").textContent=t.lokasi,document.getElementById("updateAssetNo").textContent=t.no_asset||"-",document.getElementById("updateAssetJenis").textContent="asset"===t.jenis_item?"Asset":"Non-Asset";const n=getEffectiveCondition(t);document.getElementById("updateAssetCondition").textContent=n||"-";const s="baik"===n?"badge-success":"rusak"===n?"badge-danger":"Mutasi"===n?"badge-warning":"badge-info",i="baik"===n?"Baik":"rusak"===n?"Rusak":"Mutasi"===n?"Mutasi":"Distribusi";document.getElementById("updateAssetBadge").innerHTML=`<div class="badge ${s}">${i}</div>`;const o=document.getElementById("updateAssetPhotos");o.innerHTML="",a.length>0?a.forEach(e=>{const t=e.isThumbnail?'<span class="badge badge-info" style="font-size: 10px; position: absolute; top: 5px; right: 5px; z-index: 10;"><i class="fas fa-compress"></i> Thumb</span>':"cloudinary"===e.source?'<span class="cloudinary-badge" style="position: absolute; top: 5px; right: 5px; z-index: 10;"><i class="fas fa-cloud"></i> HD</span>':'<span class="sync-badge" style="position: absolute; top: 5px; right: 5px; z-index: 10;"><i class="fas fa-database"></i> HD</span>',a=document.createElement("div");a.style.position="relative",a.style.display="inline-block",a.style.margin="5px";const n=document.createElement("img");n.src=e.displayUrl,n.className="photo-thumb",n.alt=`Foto ${e.type}`,n.setAttribute("data-image",e.displayUrl),n.setAttribute("data-date",new Date(e.tanggal).toLocaleDateString("id-ID")),n.setAttribute("data-type",e.type),n.setAttribute("data-source",e.source),n.setAttribute("data-is-thumbnail",e.isThumbnail||!1),n.addEventListener("click",function(){const e=this.getAttribute("data-image"),t=this.getAttribute("data-date"),a=this.getAttribute("data-type"),n=this.getAttribute("data-source");document.getElementById("largePhoto").src=e,document.getElementById("photoInfo").innerHTML=`\n                    <p><strong>Tipe:</strong> ${"utama"===a?"Foto Utama":"rusak"===a?"Foto Rusak":"Foto Perbaikan"}</p>\n                    <p><strong>Sumber:</strong> ${"cloudinary"===n?"Cloudinary":"Lokal"}</p>\n                    <p><strong>Kualitas:</strong> ${"true"===this.getAttribute("data-is-thumbnail")?"Thumbnail":"Full HD"}</p>\n                    <p><strong>Tanggal:</strong> ${t}</p>\n                `,document.getElementById("photoModal").classList.add("active")}),a.appendChild(n),a.innerHTML+=t,o.appendChild(a)}):o.innerHTML="<p>Belum ada foto untuk item ini.</p>";const r=document.getElementById("newCondition"),l=document.getElementById("nonAssetMutationBox");"non-asset"===t.jenis_item?(r.parentElement.style.display="none",r.removeAttribute("required"),l.style.display="block"):(r.parentElement.style.display="block",r.setAttribute("required","required"),l.style.display="none"),document.getElementById("assetInfo").style.display="block"}function updateAssetSelects(){const e=document.getElementById("assetSelect"),t=document.getElementById("galeriAssetSelect");for(;e.options.length>1;)e.remove(1);for(;t.options.length>1;)t.remove(1);assets.forEach(a=>{const n="pending"===a.syncStatus?" (Pending Sync)":"",s="asset"===a.jenis_item?"[A]":"[NA]",i=document.createElement("option");i.value=a.id;const o=getEffectiveCondition(a)||"-";i.textContent=`${s} ${a.nama_asset} (${a.material_kode}) - ${o}${n}`,e.appendChild(i);const r=document.createElement("option");r.value=a.id,r.textContent=`${s} ${a.nama_asset} (${a.material_kode})`,t.appendChild(r)})}async function handleUpdate(e){e.preventDefault();let t=!1;try{const e=document.getElementById("assetSelect").value,a=document.getElementById("updateCatatan").value.trim(),n=document.getElementById("updateFoto");if(!e)return void showAlert("updateAlert","Pilih item terlebih dahulu","danger");const s=assets.find(t=>t.id===e);if(!s)return void showAlert("updateAlert","Data tidak ditemukan","danger");if(!a)return void showAlert("updateAlert","Catatan wajib diisi","danger");let i=null,o=null;if("asset"===s.jenis_item){if(i=document.getElementById("newCondition").value,!i)return void showAlert("updateAlert","Pilih kondisi baru","danger");if(s.kondisi!==i&&0===n.files.length)return void showAlert("updateAlert","Foto wajib jika kondisi berubah","danger")}if("non-asset"===s.jenis_item){const e=document.getElementById("mutationFrom").value,t=document.getElementById("mutationTo").value,a=parseInt(document.getElementById("mutationQty").value);if(a&&a>0){if(!e||!t||e===t)return void showAlert("updateAlert","Mutasi tidak valid","danger");if(a>(s.kondisi_detail?.[e]||0))return void showAlert("updateAlert","Jumlah melebihi stok","danger");o={from:e,to:t,qty:a}}}showProgressOverlay("update",{title:"Memperbarui Item",subtitle:"Sedang memproses update..."}),t=!0,await new Promise(e=>setTimeout(e,50)),updateProgressStep("validate","completed"),updateProgressStep("prepare","active"),updateProgressBar(20);let r=null,l=null;n.files.length>0?(updateProgressStep("prepare","completed"),updateProgressStep("process_photo","active"),updateProgressBar(40),l=n.files[0],r=await compressImage(l),updateProgressStep("process_photo","completed"),updateProgressStep("save_update","active"),updateProgressBar(60)):(updateProgressStep("prepare","completed"),updateProgressStep("save_update","active"),updateProgressBar(50)),await updateAssetCondition(e,i,a,r,l,null,o),updateProgressStep("save_update","completed"),updateProgressStep("sync","active"),updateProgressBar(75),await loadAssetsFromIndexedDBOnly(),updateDashboard(),updateAssetSelects(),loadAssetForUpdate(e),updateProgressStep("sync","completed"),updateProgressStep("finalize","active"),updateProgressBar(95),updateProgressStep("finalize","completed"),updateProgressBar(100),updateProgressText("Update berhasil!"),setTimeout(()=>{hideProgressOverlay(),showAlert("updateAlert","‚úÖ Update berhasil","success")},600)}catch(e){console.error(e),t&&hideProgressOverlay(),showAlert("updateAlert",e.message||"Terjadi kesalahan","danger")}}async function initPhotoCache(){try{const e=await getAllPhotos();photoCountMap.clear(),e.forEach(e=>{const t=photoCountMap.get(e.assetId)||0;photoCountMap.set(e.assetId,t+1)}),isPhotoCacheLoaded=!0}catch(e){console.error("‚ùå Error initializing photo cache:",e),isPhotoCacheLoaded=!1}}function getPhotoCountFromCache(e){return photoCountMap.get(e)||0}async function runFullCleanup(e=!0){e&&showToastNotification("üßπ Membersihkan database...","info");const t={orphans:0,fullImages:0,deleted:0};try{t.orphans=await cleanupOrphanPhotos();const a=await cleanupOldFullImages();if(t.fullImages=a.updatedCount,t.deleted=a.deletedCount,e){showToastNotification(t.orphans+t.fullImages+t.deleted>0?`‚úÖ Cleanup: ${t.orphans} orphan, ${t.fullImages} full image, ${t.deleted} dihapus`:"‚úÖ Database sudah bersih","success")}return t}catch(a){return console.error("Cleanup error:",a),e&&showToastNotification("‚ùå Gagal cleanup","danger"),t}}async function cleanupOldFullImages(){if(!indexedDBInstance)return{updatedCount:0,deletedCount:0};const e=Date.now();try{const t=await getAllPhotos();let a=0,n=0;for(const s of t){if(s.image&&s.cloudinary&&"UPLOADED"===s.uploadStatus){e-(s.timestamp||0)>2592e6&&(await updatePhoto(s.id,{image:null,cloudinaryOnly:!0,fullImageDeletedAt:e}),a++)}if(s.image&&!s.cloudinary){e-(s.timestamp||0)>7776e6&&(await deletePhoto(s.id),n++)}}return{updatedCount:a,deletedCount:n}}catch(e){return console.error("Error in cleanupOldFullImages:",e),{updatedCount:0,deletedCount:0}}}async function cleanupOrphanPhotos(){if(!indexedDBInstance)return 0;try{const e=await getAllPhotos(),t=new Set(assets.map(e=>e.id));let a=0;for(const n of e)t.has(n.assetId)||(await deletePhoto(n.id),a++);return a}catch(e){return console.error("Error in cleanupOrphanPhotos:",e),0}}async function updateDashboard(){try{let e=0,t=0,a=[];if(!navigator.onLine){const e=document.getElementById("firebaseStatus"),t=document.getElementById("syncStatus"),a=document.getElementById("cloudinaryStatus");e&&(e.innerHTML='<i class="fas fa-cloud"></i> <span>Firebase: Offline</span>',e.className="status-badge status-offline"),t&&(t.innerHTML='<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Diblokir</span>',t.className="status-badge status-offline"),a&&(a.innerHTML='<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Diblokir</span>',a.className="status-badge status-offline")}assets&&0!==assets.length||(await loadAssets(),await cleanupOrphanPhotos());const n=assets.length,s=assets.filter(e=>"asset"===e.jenis_item).length,i=assets.filter(e=>"non-asset"===e.jenis_item).length,o=assets.filter(e=>"baik"===getEffectiveCondition(e)).length,r=assets.filter(e=>"rusak"===getEffectiveCondition(e)).length,l=assets.filter(e=>"Mutasi"===getEffectiveCondition(e)).length,d=assets.filter(e=>"pending"===e.syncStatus).length,c=n-d;try{a=await getAllPhotos(),t=a.length,e=a.filter(e=>"PENDING"===e.uploadStatus).length}catch(n){console.error("Error getting photos:",n),a=[],t=0,e=0}const u=assets.reduce((e,t)=>e+(t.total_jumlah||1),0),m=[...new Set(assets.filter(e=>e.lokasi).map(e=>e.lokasi))],p=m.length,g=(e,t)=>{const a=document.getElementById(e);a&&(a.textContent=t)};g("totalAssets",n),g("assetCount",s),g("nonAssetCount",i),g("totalJumlah",u),g("baikCount",o),g("rusakCount",r),g("MutasiCount",l),g("totalPhotos",t),g("syncedAssets",c),g("pendingSync",d);const f=document.getElementById("pendingPhotosCount");f&&(f.textContent=e),g("totalLokasi",p);const h=document.getElementById("lastSync");h&&lastSyncTime?h.textContent=lastSyncTime.toLocaleTimeString():h&&(h.textContent="Belum pernah");const y=document.getElementById("lokasiStats");if(y&&m.length>0){let e="";m.slice(0,3).forEach(t=>{const a=assets.filter(e=>e.lokasi===t).length;e+=`\n                    <div style="margin-bottom: 5px; font-size: 12px;">\n                        <strong>${t}:</strong> ${a} item\n                    </div>\n                `}),m.length>3&&(e+=`<div style="font-size: 11px; color: var(--secondary);">+${m.length-3} lokasi lainnya</div>`),y.innerHTML=e}const v=document.getElementById("typeChart"),b=document.getElementById("conditionChart");v&&b&&n>0&&updateCharts(),updateRecentActivity()}catch(e){console.error("‚ùå Error updating dashboard:",e);const t=(e,t)=>{const a=document.getElementById(e);a&&(a.textContent=t)};t("totalAssets","0"),t("assetCount","0"),t("nonAssetCount","0"),t("totalJumlah","0"),t("baikCount","0"),t("rusakCount","0"),t("MutasiCount","0"),t("totalPhotos","0"),t("syncedAssets","0"),t("pendingSync","0"),t("pendingPhotosCount","0"),t("totalLokasi","0")}}async function updateCharts(){if(!window.Chart)try{await AssetLoader.chartjs()}catch(e){return void console.warn("Gagal load Chart.js:",e)}const e=document.getElementById("typeChart").getContext("2d"),t=assets.filter(e=>"asset"===e.jenis_item).length,a=assets.filter(e=>"non-asset"===e.jenis_item).length;typeChart&&typeChart.destroy(),typeChart=new Chart(e,{type:"pie",data:{labels:["Asset","Non-Asset"],datasets:[{data:[t,a],backgroundColor:["rgba(59, 130, 246, 0.8)","rgba(245, 158, 11, 0.8)"],borderColor:["rgb(59, 130, 246)","rgb(245, 158, 11)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:getComputedStyle(document.documentElement).getPropertyValue("--text-color")}}}}});const n=document.getElementById("conditionChart").getContext("2d"),s=assets.filter(e=>"baik"===getEffectiveCondition(e)).length,i=assets.filter(e=>"rusak"===getEffectiveCondition(e)).length,o=assets.filter(e=>"Mutasi"===getEffectiveCondition(e)).length;conditionChart&&conditionChart.destroy(),conditionChart=new Chart(n,{type:"doughnut",data:{labels:["Baik","Rusak","Mutasi"],datasets:[{data:[s,i,o],backgroundColor:["rgba(16, 185, 129, 0.8)","rgba(239, 68, 68, 0.8)","rgba(245, 158, 11, 0.8)"],borderColor:["rgb(16, 185, 129)","rgb(239, 68, 68)","rgb(245, 158, 11)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:getComputedStyle(document.documentElement).getPropertyValue("--text-color")}}}}})}function updateRecentActivity(){const e=document.getElementById("recentActivity"),t=[];assets.forEach(e=>{e.riwayat&&Array.isArray(e.riwayat)&&e.riwayat.length>0&&e.riwayat.forEach((a,n)=>{const s=n===e.riwayat.length-1;let i="",o="",r="",l="";if("asset"===e.jenis_item)a.old_kondisi&&a.new_kondisi&&a.old_kondisi!==a.new_kondisi?(o="baik"===a.new_kondisi?"‚úÖ":"rusak"===a.new_kondisi?"‚ö†Ô∏è":"üîÑ",i=`Perubahan Kondisi: ${a.old_kondisi||"-"} ‚Üí ${a.new_kondisi||"-"}`,r="baik"===a.new_kondisi?"#10b981":"rusak"===a.new_kondisi?"#ef4444":"#f59e0b",l=`Kondisi berubah dari ${a.old_kondisi||"awal"} menjadi ${a.new_kondisi}`):a.old_lokasi&&a.new_lokasi&&a.old_lokasi!==a.new_lokasi?(o="üìç",i=`Perpindahan Lokasi: ${a.old_lokasi||"-"} ‚Üí ${a.new_lokasi||"-"}`,r="#3b82f6",l=`Item dipindahkan dari ${a.old_lokasi||"awal"} ke ${a.new_lokasi}`):"create"===a.tipe?(o="‚ûï",i="Item Baru Ditambahkan",r="#10b981",l=`Kondisi awal: ${a.new_kondisi||e.kondisi||"-"}`):(o="üìù",i="Data Diperbarui",r="#6b7280",l=a.catatan||"Update data asset");else if("non-asset"===e.jenis_item)if(a.old_jumlah&&a.new_jumlah){let e={},t={};"object"==typeof a.old_jumlah&&(e={baik:parseInt(a.old_jumlah.baik)||0,rusak:parseInt(a.old_jumlah.rusak)||0,Mutasi:parseInt(a.old_jumlah.Mutasi)||0}),"object"==typeof a.new_jumlah&&(t={baik:parseInt(a.new_jumlah.baik)||0,rusak:parseInt(a.new_jumlah.rusak)||0,Mutasi:parseInt(a.new_jumlah.Mutasi)||0});const n=[];if(e.baik!==t.baik){const a=t.baik-e.baik;n.push(`Baik: ${a>0?"+":""}${a}`)}if(e.rusak!==t.rusak){const a=t.rusak-e.rusak;n.push(`Rusak: ${a>0?"+":""}${a}`)}if(e.Mutasi!==t.Mutasi){const a=t.Mutasi-e.Mutasi;n.push(`Mutasi: ${a>0?"+":""}${a}`)}n.length>0?(o="üìä",i="Distribusi Berubah",r="#8b5cf6",l=n.join(" | ")):(o="üìù",i="Data Diperbarui",r="#6b7280",l=a.catatan||"Update data non-asset")}else if(a.old_lokasi&&a.new_lokasi&&a.old_lokasi!==a.new_lokasi)o="üìç",i=`Perpindahan Lokasi: ${a.old_lokasi||"-"} ‚Üí ${a.new_lokasi||"-"}`,r="#3b82f6",l=`Item dipindahkan dari ${a.old_lokasi||"awal"} ke ${a.new_lokasi}`;else if("create"===a.tipe){o="‚ûï",i="Item Baru Ditambahkan",r="#10b981";let t=0,n=0,s=0;a.new_jumlah&&"object"==typeof a.new_jumlah?(t=parseInt(a.new_jumlah.baik)||0,n=parseInt(a.new_jumlah.rusak)||0,s=parseInt(a.new_jumlah.Mutasi)||0):a.new_kondisi_detail&&"object"==typeof a.new_kondisi_detail?(t=parseInt(a.new_kondisi_detail.baik)||0,n=parseInt(a.new_kondisi_detail.rusak)||0,s=parseInt(a.new_kondisi_detail.Mutasi)||0):e.kondisi_detail&&"object"==typeof e.kondisi_detail&&(t=parseInt(e.kondisi_detail.baik)||0,n=parseInt(e.kondisi_detail.rusak)||0,s=parseInt(e.kondisi_detail.Mutasi)||0);l=`Total ${t+n+s} unit`,t>0&&(l+=` (Baik: ${t}`),n>0&&(l+=`${t>0?", ":" ("}Rusak: ${n}`),s>0&&(l+=`${t>0||n>0?", ":" ("}Mutasi: ${s}`),(t>0||n>0||s>0)&&(l+=")")}else o="üìù",i="Data Diperbarui",r="#6b7280",l=a.catatan||"Update data non-asset";if(!i)return;const d=a.user?.nama||a.user?.email||e.updated_by?.nama||"System",c=d.charAt(0).toUpperCase();let u="";try{const e=new Date(a.tanggal),t=new Date,n=Math.abs(t-e),s=Math.floor(n/6e4);if(s<1)u="Baru saja";else if(s<60)u=`${s} menit yang lalu`;else if(s<1440){u=`${Math.floor(s/60)} jam yang lalu`}else u=e.toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){u=a.tanggal?new Date(a.tanggal).toLocaleString():"-"}t.push({assetId:e.id,assetName:e.nama_asset,assetJenis:"asset"===e.jenis_item?"Asset":"Non-Asset",tanggal:a.tanggal,timestamp:new Date(a.tanggal).getTime(),dateDisplay:u,actionMessage:i,actionIcon:o,actionColor:r,detailInfo:l,userName:d,userInitial:c,catatan:a.catatan||"-",isLatest:s})})}),t.sort((e,t)=>t.timestamp-e.timestamp);const a=t.slice(0,10);if(0===a.length)return void(e.innerHTML='\n            <div class="empty-state" style="padding: 30px 20px;">\n                <i class="fas fa-history" style="font-size: 48px; color: var(--gray-light);"></i>\n                <h3 style="margin-top: 15px;">Belum ada aktivitas</h3>\n                <p style="color: var(--secondary);">Aktivitas akan muncul setelah Anda menambah atau mengupdate item</p>\n            </div>\n        ');let n='<div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">';a.forEach((e,t)=>{let a=e.actionColor;n+=`\n            <div class="activity-item" style="\n                background: var(--card-bg);\n                border-left: 4px solid ${a};\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 12px;\n                box-shadow: var(--shadow);\n                transition: transform 0.2s ease;\n                position: relative;\n                ${e.isLatest?"border: 2px solid "+a+";":""}\n            ">\n                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">\n                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">\n                        <span style="\n                            background: ${a}20;\n                            color: ${a};\n                            width: 32px;\n                            height: 32px;\n                            border-radius: 50%;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            font-size: 18px;\n                        ">\n                            ${e.actionIcon}\n                        </span>\n                        <div>\n                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">\n                                <span style="font-weight: 600; color: var(--text-color);">\n                                    ${e.assetName}\n                                </span>\n                                <span class="badge ${"Asset"===e.assetJenis?"badge-info":"badge-warning"}" style="font-size: 10px;">\n                                    ${e.assetJenis}\n                                </span>\n                                ${e.isLatest?'<span class="badge badge-success" style="font-size: 10px;"><i class="fas fa-star"></i> Terbaru</span>':""}\n                            </div>\n                            <div style="font-size: 13px; color: var(--secondary); margin-top: 3px;">\n                                ${e.actionMessage}\n                            </div>\n                        </div>\n                    </div>\n                    <div style="text-align: right;">\n                        <div style="font-size: 12px; color: var(--secondary); background: var(--light); padding: 4px 8px; border-radius: 12px;">\n                            <i class="far fa-clock"></i> ${e.dateDisplay}\n                        </div>\n                    </div>\n                </div>\n                \n                <div style="margin: 10px 0 8px 42px; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 13px; color: var(--text-color);">\n                    <i class="fas fa-info-circle" style="color: ${a}; margin-right: 5px;"></i>\n                    ${e.detailInfo}\n                </div>\n                \n                <div style="margin-left: 42px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">\n                    <div style="display: flex; align-items: center; gap: 8px;">\n                        <div style="\n                            width: 24px;\n                            height: 24px;\n                            border-radius: 50%;\n                            background: ${a};\n                            color: white;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            font-size: 12px;\n                            font-weight: bold;\n                        ">\n                            ${e.userInitial}\n                        </div>\n                        <span style="font-size: 12px; color: var(--secondary);">\n                            ${e.userName}\n                        </span>\n                    </div>\n                    \n                    ${e.catatan&&"-"!==e.catatan?`\n                        <div style="font-size: 12px; color: var(--secondary); max-width: 60%;" title="${e.catatan}">\n                            <i class="fas fa-quote-right" style="opacity: 0.5;"></i> \n                            ${e.catatan.length>40?e.catatan.substring(0,40)+"...":e.catatan}\n                        </div>\n                    `:""}\n                </div>\n                \n                <div style="margin-top: 12px; margin-left: 42px; display: flex; gap: 8px;">\n                    <button class="btn btn-outline btn-small" onclick="showAssetDetail('${e.assetId}')" style="font-size: 11px; padding: 4px 10px;">\n                        <i class="fas fa-eye"></i> Lihat Detail Item\n                    </button>\n                </div>\n            </div>\n        `}),t.length>10&&(n+=`\n            <div style="text-align: center; margin-top: 15px; padding: 10px; background: var(--light); border-radius: 8px;">\n                <span style="font-size: 13px; color: var(--secondary);">\n                    <i class="fas fa-list"></i> Total ${t.length} aktivitas\n                </span>\n                <button class="btn btn-outline btn-small" onclick="showAllActivities()" style="margin-left: 10px;">\n                    Lihat Semua\n                </button>\n            </div>\n        `),n+="</div>",e.innerHTML=n}function showAllActivities(){const e=[];assets.forEach(t=>{t.riwayat&&Array.isArray(t.riwayat)&&t.riwayat.forEach(a=>{e.push({asset:t,history:a,tanggal:a.tanggal})})}),e.sort((e,t)=>new Date(t.tanggal)-new Date(e.tanggal));const t=`\n        <div class="modal active" id="allActivitiesModal">\n            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">\n                <div class="modal-header">\n                    <div class="modal-title">\n                        <i class="fas fa-history"></i> Semua Aktivitas (${e.length})\n                    </div>\n                    <span class="close-modal" onclick="document.getElementById('allActivitiesModal').remove()">&times;</span>\n                </div>\n                <div style="padding: 20px;" id="allActivitiesContent">\n                </div>\n            </div>\n        </div>\n    `;document.body.insertAdjacentHTML("beforeend",t);const a=document.getElementById("allActivitiesContent");let n="";e.forEach((e,t)=>{const a=e.asset,s=e.history,i=new Date(s.tanggal).toLocaleString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});n+=`\n            <div class="asset-card" style="margin-bottom: 10px;">\n                <div class="asset-header">\n                    <div>\n                        <div class="asset-title">${a.nama_asset}</div>\n                        <div class="asset-subtitle">\n                            ${i} | ${s.user?.nama||"System"}\n                        </div>\n                    </div>\n                </div>\n                <div style="padding: 10px; background: var(--light); border-radius: 5px;">\n                    <pre style="white-space: pre-wrap; font-family: inherit;">${JSON.stringify(s,null,2)}</pre>\n                </div>\n            </div>\n        `}),a.innerHTML=n}async function displayAssets(e=assets){const t=document.getElementById("assetsList"),a=document.getElementById("filterJenis").value,n=document.getElementById("filterKondisi").value,s=document.getElementById("filterLokasi").value,i=document.getElementById("filterFoto").value;isPhotoCacheLoaded||(t.innerHTML='\n            <div class="empty-state">\n                <i class="fas fa-spinner fa-spin"></i>\n                <h3>Memuat data foto...</h3>\n                <p>Mohon tunggu sebentar</p>\n            </div>\n        ',await initPhotoCache()),a&&(e=e.filter(e=>e.jenis_item===a)),n&&(e=e.filter(e=>getEffectiveCondition(e)===n)),s&&(e=e.filter(e=>e.lokasi===s)),i&&(e=e.filter(e=>{const t=getPhotoCountFromCache(e.id);return"with-photos"===i?t>0:"without-photos"!==i||0===t}));const o=document.getElementById("searchAsset").value.toLowerCase();if(o&&(e=e.filter(e=>e.nama_asset.toLowerCase().includes(o)||e.material_kode.toLowerCase().includes(o)||e.no_rs&&e.no_rs.toLowerCase().includes(o)||e.no_po&&e.no_po.toLowerCase().includes(o)||e.lokasi.toLowerCase().includes(o))),!e||0===e.length)return void(t.innerHTML='\n            <div class="empty-state">\n                <i class="fas fa-cubes"></i>\n                <h3>Tidak ada item</h3>\n                <p>Tidak ada item yang sesuai dengan filter</p>\n            </div>\n        ');const r=await getAllPhotos(),l=new Map;r.forEach(e=>{l.has(e.assetId)||l.set(e.assetId,[]),l.get(e.assetId).push(e)});let d="";for(const t of e){const e=getEffectiveCondition(t),a=l.get(t.id)||[],n=a.length,s="baik"===e?"badge-success":"rusak"===e?"badge-danger":"Mutasi"===e?"badge-warning":"badge-info",i="baik"===e?"Baik":"rusak"===e?"Rusak":"Mutasi"===e?"Mutasi":"Distribusi",o="asset"===t.jenis_item?'<span class="badge badge-info" style="margin-right: 5px;"><i class="fas fa-cube"></i> Asset</span>':'<span class="badge badge-warning" style="margin-right: 5px;"><i class="fas fa-boxes"></i> Non-Asset</span>',r="pending"===t.syncStatus?'<span class="sync-badge"><i class="fas fa-clock"></i> Pending</span>':'<span class="sync-badge" style="background-color: rgba(16, 185, 129, 0.15); color: var(--success);"><i class="fas fa-check"></i> Synced</span>';let c='<div class="asset-thumbnail-container">';if(n>0){const e=Math.min(n,3);for(let n=0;n<e;n++){const e=a[n];let s=e.displayUrl||e.image||e.thumbnail||(e.cloudinary?.secure_url&&navigator.onLine?e.cloudinary.secure_url:null);c+=s?`\n                        <div class="asset-thumb-badge" style="position: relative;">\n                            <img src="${s}" \n                                 class="asset-thumb" \n                                 data-asset-id="${t.id}"\n                                 data-photo-index="${n}"\n                                 onclick="showPhotoFromThumb('${t.id}', ${n})"\n                                 title="${"utama"===e.type?"Foto Utama":"Foto "+e.type}"\n                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23f0f0f0'/%3E%3Ctext x='30' y='35' font-size='12' text-anchor='middle' fill='%23999'%3Eüì∏%3C/text%3E%3C/svg%3E';">\n                            ${"utama"===e.type?'<span class="badge badge-info" style="position: absolute; top: -5px; right: -5px; font-size: 8px; padding: 2px 4px;">‚òÖ</span>':""}\n                        </div>\n                    `:`\n                        <div class="asset-thumb-placeholder" onclick="showAssetDetail('${t.id}')">\n                            <i class="fas fa-image"></i>\n                        </div>\n                    `}n>3&&(c+=`\n                    <div class="asset-thumb-more" onclick="showAssetDetail('${t.id}')" title="${n-3} foto lainnya">\n                        +${n-3}\n                    </div>\n                `)}else c+=`\n                <div class="asset-thumb-placeholder" onclick="showAssetDetail('${t.id}')" title="Tidak ada foto">\n                    <i class="fas fa-camera"></i>\n                </div>\n            `;c+="</div>",d+=`\n            <div class="asset-card" data-asset-id="${t.id}">\n                <div class="asset-header">\n                    <div style="flex: 1;">\n                        <div class="asset-title">\n                            ${o} ${t.nama_asset} ${r}\n                        </div>\n                        <div class="asset-subtitle">\n                            <i class="fas fa-barcode"></i> ${t.material_kode} | \n                            <i class="fas fa-file-alt"></i> RS: ${t.no_rs||"-"} | \n                            <i class="fas fa-map-pin"></i> ${t.lokasi}\n                            ${"asset"===t.jenis_item?` | <i class="fas fa-tag"></i> No Asset: ${t.no_asset||"-"}`:""}\n                        </div>\n                    </div>\n                    <div>\n                        <div class="badge ${s}">${i}</div>\n                        <div style="margin-top: 5px; text-align: right;">\n                            <small><i class="fas fa-camera"></i> ${n} foto</small>\n                        </div>\n                    </div>\n                </div>\n                \n                ${c}\n                \n                <div class="form-row" style="margin-top: 15px;">\n                    <div class="form-col">\n                        <button class="btn btn-outline btn-small view-detail" data-asset-id="${t.id}">\n                            <i class="fas fa-eye"></i> Detail\n                        </button>\n                        <button class="btn btn-outline btn-small update-condition-btn" data-asset-id="${t.id}">\n                            <i class="fas fa-edit"></i> Update\n                        </button>\n                        <button class="btn btn-outline btn-small view-photos" data-asset-id="${t.id}">\n                            <i class="fas fa-images"></i> Galeri\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}t.innerHTML=d,document.querySelectorAll(".view-detail").forEach(e=>{e.addEventListener("click",function(){showAssetDetail(this.getAttribute("data-asset-id"))})}),document.querySelectorAll(".update-condition-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-asset-id");switchTab("update"),setTimeout(()=>{document.getElementById("assetSelect").value=e,loadAssetForUpdate(e)},100)})}),document.querySelectorAll(".view-photos").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-asset-id");switchTab("galeri"),setTimeout(()=>{document.getElementById("galeriAssetSelect").value=e,loadGallery(e)},100)})})}async function showAssetDetail(e){try{if(!e)return void showToastNotification("ID asset tidak valid","danger");const t=assets.find(t=>t.id===e);if(!t)return void showToastNotification("Item tidak ditemukan","danger");let a=[];try{a=await getAssetPhotos(e)}catch(e){console.error("Error loading photos for asset detail:",e),a=[]}const n=document.getElementById("assetDetailModal"),s=document.getElementById("assetDetailContent");if(!n||!s)return void console.error("Modal elements not found");const i=e=>{if(!e)return"Tidak tersedia";try{const t=new Date(e);return isNaN(t.getTime())?"Tanggal tidak valid":t.toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return String(e)}},o=e=>{if(!e||"object"!=typeof e)return"";try{return`\n                    <div style="font-size:13px;">\n                        Baik: ${e.baik||0} |\n                        Rusak: ${e.rusak||0} |\n                        Mutasi: ${e.Mutasi||0}\n                    </div>\n                `}catch{return""}};let r=null;try{r=getEffectiveCondition(t)}catch(e){console.warn("Error getting effective condition:",e)}const l=r?"baik"===r?"badge-success":"rusak"===r?"badge-danger":"Mutasi"===r?"badge-warning":"badge-info":"badge-info",d=r?"baik"===r?"Baik":"rusak"===r?"Rusak":"Mutasi"===r?"Mutasi":"Distribusi":"Unknown",c="asset"===t.jenis_item?"Asset":"Non-Asset",u="asset"===t.jenis_item?"badge-info":"badge-warning",m="pending"===t.syncStatus?'<span class="sync-badge"><i class="fas fa-clock"></i> Pending Sync</span>':'<span class="sync-badge" style="background-color: rgba(16,185,129,0.15); color: var(--success);"><i class="fas fa-check"></i> Synced</span>';let p='<h3 style="margin-top:20px;"><i class="fas fa-images"></i> Foto Item</h3>';a.length>0?(p+='<div class="photo-preview" style="margin-top:10px;">',a.forEach((e,t)=>{try{let a=e.displayUrl;navigator.onLine||"cloudinary"!==e.source||(a=e.image?e.image:e.thumbnail?e.thumbnail:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3EOffline%3C/text%3E%3C/svg%3E"),a&&"null"!==a&&"undefined"!==a||(a="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E");const n=e.isThumbnail?'<span class="badge badge-info" style="font-size: 10px;"><i class="fas fa-compress"></i> Thumb</span>':"cloudinary"===e.source?'<span class="cloudinary-badge"><i class="fas fa-cloud"></i> HD</span>':'<span class="sync-badge"><i class="fas fa-database"></i> HD</span>',s=`data-photo-index="${t}" data-photo-id="${e.id||""}" data-has-local="${!!e.image}" data-has-cloudinary="${!!e.cloudinary}" data-local-src="${e.image||e.thumbnail||""}" data-cloudinary-src="${e.cloudinary?.secure_url||""}"`;p+=`\n                        <div style="position: relative; display: inline-block; margin: 5px;">\n                            <img src="${a}" \n                                 class="photo-thumb safe-detail-image" \n                                 ${s}\n                                 data-type="${e.type||"utama"}"\n                                 data-date="${e.tanggal||""}"\n                                 data-source="${e.source||"local"}"\n                                 style="width:100px; height:100px; object-fit:cover; border-radius:8px; border:2px solid var(--border-color); cursor:pointer;"\n                                 loading="lazy"\n                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3ELoad Error%3C/text%3E%3C/svg%3E'">\n                            <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 5;">\n                                ${n}\n                            </div>\n                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; text-align: center; font-size: 11px; padding: 2px; border-radius: 0 0 8px 8px; z-index: 5;">\n                                ${"utama"===e.type?"Utama":"rusak"===e.type?"Rusak":"Perbaikan"}\n                            </div>\n                        </div>\n                    `}catch(e){console.warn("Error rendering photo:",e)}}),p+="</div>"):p+='<p style="color: var(--secondary);">Belum ada foto untuk item ini.</p>';let g='<h3 style="margin-top:20px;"><i class="fas fa-history"></i> Riwayat Perubahan</h3>';if(t.riwayat&&Array.isArray(t.riwayat)&&t.riwayat.length>0){g+='<div class="timeline">';try{[...t.riwayat].sort((e,t)=>{try{return new Date(t.tanggal)-new Date(e.tanggal)}catch{return 0}}).forEach(e=>{try{const a=i(e.tanggal);let n="";if("create"===e.tipe&&(n+="<div><strong>Item Dibuat</strong></div>","asset"===t.jenis_item&&(n+=`\n                                    <div><strong>Kondisi Awal:</strong> ${e.new_kondisi||"-"}</div>\n                                `),"non-asset"===t.jenis_item&&(n+=`\n                                    <div><strong>Distribusi Awal:</strong>\n                                        ${o(e.new_kondisi_detail)}\n                                    </div>\n                                `),n+=`\n                                <div><strong>Lokasi Awal:</strong> ${e.new_lokasi||"-"}</div>\n                            `),"update"===e.tipe){if("asset"===t.jenis_item&&e.old_kondisi!==e.new_kondisi&&(n+=`\n                                    <div><strong>Kondisi:</strong>\n                                    ${e.old_kondisi||"-"} ‚Üí ${e.new_kondisi||"-"}</div>\n                                `),"non-asset"===t.jenis_item&&e.old_jumlah&&e.new_jumlah)try{JSON.stringify(e.old_jumlah)!==JSON.stringify(e.new_jumlah)&&(n+=`\n                                            <div><strong>Distribusi Jumlah:</strong></div>\n                                            <div style="margin-left:10px;">\n                                                <div>Sebelum:</div>\n                                                ${o(e.old_jumlah)}\n                                                <div>Sesudah:</div>\n                                                ${o(e.new_jumlah)}\n                                            </div>\n                                        `)}catch(e){}e.old_lokasi!==e.new_lokasi&&(n+=`\n                                    <div><strong>Lokasi:</strong>\n                                    ${e.old_lokasi||"-"} ‚Üí ${e.new_lokasi||"-"}</div>\n                                `)}g+=`\n                            <div class="timeline-item">\n                                <div class="timeline-date">\n                                    ${a}\n                                </div>\n                                <div class="timeline-content">\n                                    ${n||"<em>Tidak ada perubahan utama</em>"}\n                                    ${e.catatan?`<p style="margin-top:6px;">${e.catatan}</p>`:""}\n                                    <div style="font-size:12px; color:var(--secondary);">\n                                        ${e.user?.nama||"System"}\n                                    </div>\n                                </div>\n                            </div>\n                        `}catch(e){console.warn("Error rendering timeline item:",e)}})}catch(e){console.warn("Error processing timeline:",e),g+='<p style="color: var(--secondary);">Error memuat riwayat</p>'}g+="</div>"}else g+='<p style="color: var(--secondary);">Belum ada riwayat perubahan.</p>';s.innerHTML=`\n            <div class="asset-card" style="margin-bottom:20px;">\n                <div class="asset-header">\n                    <div>\n                        <div class="asset-title">${t.nama_asset||"Tanpa Nama"} ${m}</div>\n                        <div class="asset-subtitle">\n                            <span class="badge ${u}">${c}</span> |\n                            Kode: ${t.material_kode||"-"} | \n                            ${t.no_rs?`No RS: ${t.no_rs} | `:""}\n                            ${t.no_po?`No PO: ${t.no_po} | `:""}\n                            No Asset: ${"asset"===t.jenis_item&&t.no_asset||"-"} |\n                            Lokasi: ${t.lokasi||"-"}\n                        </div>\n                    </div>\n                    <div class="badge ${l}">${d}</div>\n                </div>\n\n                <div style="margin-top:15px;">\n                    <strong>Jumlah Total:</strong>\n                    ${"non-asset"===t.jenis_item?t.total_jumlah||0:"1"} unit\n                </div>\n\n                ${"non-asset"===t.jenis_item&&t.kondisi_detail?`\n                        <div style="margin-top:10px;">\n                            <strong>Distribusi Saat Ini:</strong>\n                            ${o(t.kondisi_detail)}\n                        </div>\n                        `:""}\n            </div>\n\n            ${p}\n            ${g}\n        `,n.classList.add("active"),setTimeout(()=>{try{document.querySelectorAll("#assetDetailModal .safe-detail-image").forEach((e,t)=>{e.addEventListener("click",function(e){try{e.preventDefault(),e.stopPropagation();this.dataset.photoId,this.dataset.hasLocal;const t="true"===this.dataset.hasCloudinary,a=this.dataset.localSrc,n=this.dataset.cloudinarySrc,s=this.dataset.type||"utama",i=this.dataset.date||"",o=this.dataset.source||"local";let r=this.src,l=r.includes("thumb")||r===a?.includes("thumb");if(!r||r.includes("No Image")||r.includes("Load Error")||r.includes("Offline")||r.includes("svg"))if(a&&"null"!==a&&"undefined"!==a)r=a;else{if(!navigator.onLine||!n||"null"===n||"undefined"===n)return void showToastNotification("Foto tidak tersedia","warning");r=n,l=!1}if(!r||r.includes("undefined")||r.includes("null"))return void showToastNotification("Sumber foto tidak valid","warning");const d=document.getElementById("largePhoto"),c=document.getElementById("photoInfo");if(d&&(d.src=r,d.onerror=function(){this.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3Ctext x='200' y='150' font-size='20' text-anchor='middle' dy='.3em' fill='%23999'%3EGagal Memuat%3C/text%3E%3C/svg%3E"}),c){const e=i?new Date(i).toLocaleString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Tidak diketahui",a=t,d=l||"thumbnail"===o||r.includes("thumb");let u="";a&&d&&navigator.onLine?u='\n                                        <button class="btn btn-primary btn-small" id="loadHdFromDetail" style="margin-top: 15px; width: 100%;">\n                                            <i class="fas fa-cloud-upload-alt"></i> Load HD Version\n                                        </button>\n                                    ':a&&!navigator.onLine&&(u='\n                                        <p class="text-warning" style="margin-top: 10px;">\n                                            <i class="fas fa-exclamation-triangle"></i> HD tersedia saat online\n                                        </p>\n                                    '),c.innerHTML=`\n                                    <div style="text-align: left; padding: 10px;">\n                                        <p><strong><i class="fas fa-tag"></i> Tipe:</strong> ${"utama"===s?"Foto Utama":s}</p>\n                                        <p><strong><i class="fas fa-calendar"></i> Tanggal:</strong> ${e}</p>\n                                        <p><strong><i class="fas fa-cloud"></i> Kualitas:</strong> ${d?"Thumbnail (Cepat)":"HD (Kualitas Tinggi)"}</p>\n                                        <p><strong><i class="fas fa-database"></i> Sumber:</strong> ${"cloudinary"===o?"Cloudinary":"Lokal"}</p>\n                                        ${a?'<p><i class="fas fa-check-circle" style="color: var(--success);"></i> HD Tersedia</p>':""}\n                                        ${u}\n                                    </div>\n                                `,a&&d&&navigator.onLine&&setTimeout(()=>{const t=document.getElementById("loadHdFromDetail");t&&n&&t.addEventListener("click",function(){n&&navigator.onLine&&(document.getElementById("largePhoto").src=n,c.innerHTML=`\n                                                        <div style="text-align: left; padding: 10px;">\n                                                            <p><strong><i class="fas fa-tag"></i> Tipe:</strong> ${"utama"===s?"Foto Utama":s}</p>\n                                                            <p><strong><i class="fas fa-calendar"></i> Tanggal:</strong> ${e}</p>\n                                                            <p><strong><i class="fas fa-cloud"></i> Kualitas:</strong> HD (Kualitas Tinggi) - Cloudinary</p>\n                                                            <p><strong><i class="fas fa-database"></i> Sumber:</strong> Cloudinary</p>\n                                                            <p><i class="fas fa-check-circle" style="color: var(--success);"></i> HD Version Loaded</p>\n                                                        </div>\n                                                    `,showToastNotification("‚úÖ HD version loaded","success"))})},100)}const u=document.getElementById("photoModal");u&&u.classList.add("active")}catch(e){console.error("Error handling photo click:",e),showToastNotification("Gagal membuka foto","warning")}})})}catch(e){console.error("Error setting up photo listeners:",e)}},100),setTimeout(()=>{try{const t=document.getElementById("printAssetDetail");if(t){t.replaceWith(t.cloneNode(!0));document.getElementById("printAssetDetail").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),window.print()})}else console.warn("‚ö†Ô∏è Print button not found in DOM");const a=document.getElementById("shareAssetDetail");if(a){a.replaceWith(a.cloneNode(!0));document.getElementById("shareAssetDetail").addEventListener("click",function(t){t.preventDefault(),t.stopPropagation();const a=assets.find(t=>t.id===e);if(!a)return void showToastNotification("Data asset tidak ditemukan","danger");const n=getEffectiveCondition(a),s="baik"===n?"Baik":"rusak"===n?"Rusak":"Mutasi"===n?"Mutasi":"Distribusi",i=`Detail Asset: ${a.nama_asset}`,o=`üì¶ *ASSET MANAGEMENT SYSTEM*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüè∑Ô∏è *Nama Asset:* ${a.nama_asset}\nüî¢ *Kode Material:* ${a.material_kode}\nüìã *No. RS:* ${a.no_rs||"-"}\nüìé *No. PO:* ${a.no_po||"-"}\nüîñ *No. Asset:* ${"asset"===a.jenis_item&&a.no_asset||"-"}\nüìç *Lokasi:* ${a.lokasi}\nüìä *Jenis:* ${"asset"===a.jenis_item?"ASSET":"NON-ASSET"}\nüìà *Kondisi:* ${s}\nüî¢ *Jumlah:* ${"non-asset"===a.jenis_item?a.total_jumlah:"1"} unit\n\n${"non-asset"===a.jenis_item&&a.kondisi_detail?`üìä *Detail Distribusi:*\n   ‚Ä¢ Baik   : ${a.kondisi_detail.baik||0}\n   ‚Ä¢ Rusak  : ${a.kondisi_detail.rusak||0}\n   ‚Ä¢ Mutasi : ${a.kondisi_detail.Mutasi||0}`:""}\n\nüïí *Update Terakhir:* ${a.updated_at?new Date(a.updated_at).toLocaleString("id-ID"):"-"}\nüë§ *Diupdate oleh:* ${a.updated_by?.nama||"-"}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nID: ${a.id}`;navigator.share?navigator.share({title:i,text:o,url:window.location.href}).catch(e=>{"AbortError"!==e.name&&(console.warn("Share failed:",e),showToastNotification("Gagal membagikan","warning"))}):navigator.clipboard.writeText(o).then(()=>{showToastNotification("‚úÖ Data asset disalin ke clipboard","success")}).catch(()=>{alert(o)})})}else console.warn("‚ö†Ô∏è Share button not found in DOM")}catch(e){console.error("Error setting up button listeners:",e)}},200)}catch(e){console.error("‚ùå Fatal error in showAssetDetail:",e),showToastNotification("Gagal memuat detail item","danger")}}async function showPhotoFromThumb(e,t){const a=await getAssetPhotos(e);if(!a||0===a.length||t>=a.length)return;const n=a[t];let s=n.thumbnail||n.displayUrl||n.image,i=!!n.thumbnail,o=!!n.cloudinary;if(!s&&o&&navigator.onLine&&(s=n.cloudinary.secure_url,i=!1),!s)return void showToastNotification("Foto tidak tersedia","warning");document.getElementById("largePhoto").src=s;const r=document.getElementById("photoInfo");if(r){const e=n.tanggal?new Date(n.tanggal).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):"Tidak diketahui",t="utama"===n.type?"Foto Utama":`Foto ${n.type}`;let a="";o&&i&&navigator.onLine?a='\n                <button class="btn btn-primary btn-small" id="loadHdFromThumb" style="margin-top: 15px; width: 100%;">\n                    <i class="fas fa-cloud-upload-alt"></i> Load HD Version\n                </button>\n            ':o&&!navigator.onLine&&(a='\n                <p class="text-warning" style="margin-top: 10px;">\n                    <i class="fas fa-exclamation-triangle"></i> HD tersedia saat online\n                </p>\n            '),r.innerHTML=`\n            <p><strong>${t}</strong></p>\n            <p><i class="fas fa-calendar"></i> ${e}</p>\n            <p><i class="fas fa-cloud"></i> Kualitas: ${i?"Thumbnail (Cepat)":"HD (Kualitas Tinggi)"}</p>\n            ${o?'<p><i class="fas fa-check-circle" style="color: var(--success);"></i> HD Tersedia di Cloudinary</p>':""}\n            ${a}\n        `,o&&i&&navigator.onLine&&setTimeout(()=>{const a=document.getElementById("loadHdFromThumb");a&&a.addEventListener("click",function(){n.cloudinary?.secure_url&&(document.getElementById("largePhoto").src=n.cloudinary.secure_url,r.innerHTML=`\n                                <p><strong>${t}</strong></p>\n                                <p><i class="fas fa-calendar"></i> ${e}</p>\n                                <p><i class="fas fa-cloud"></i> Kualitas: HD (Kualitas Tinggi) - Cloudinary</p>\n                                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> HD Version Loaded</p>\n                            `,showToastNotification("‚úÖ HD version loaded","success"))})},100)}document.getElementById("photoModal").classList.add("active")}async function loadGallery(e=""){try{const t=document.getElementById("galleryContainer");let a=[];try{a=await getAllPhotos()}catch(e){console.error("Error loading photos:",error),a=[]}const n=document.getElementById("filterPhotoSource").value;let s=a;e&&(s=a.filter(t=>t.assetId===e)),n&&("cloudinary"===n?s=s.filter(e=>e.cloudinary):"local"===n?s=s.filter(e=>!e.cloudinary):"thumbnail"===n&&(s=s.filter(e=>e.thumbnail)));const i={};assets.forEach(e=>{i[e.id]={nama:e.nama_asset,jenis:e.jenis_item}});const o=new Map;for(const e of s){const t=assets.find(t=>t.id===e.assetId);if(!t)continue;let a="tidak diketahui",n=e.timestamp||new Date(e.tanggal).getTime();if("rusak"===e.type)a="rusak";else if("Mutasi"===e.type)a="Mutasi";else if("baik"===e.type)a="baik";else{if(t.riwayat&&Array.isArray(t.riwayat)&&t.riwayat.length>0){const e=[...t.riwayat].sort((e,t)=>new Date(t.tanggal)-new Date(e.tanggal)),s=new Date(t.created_at).getTime();if(Math.abs(n-s)<5e3)if("asset"===t.jenis_item)a=t.kondisi||"tidak diketahui";else{const e=t.kondisi_detail;if(e){const t=e.baik||0,n=e.rusak||0,s=e.Mutasi||0;a=t>0&&0===n&&0===s?"baik":n>0&&0===t&&0===s?"rusak":s>0&&0===t&&0===n?"Mutasi":"distribusi"}}else for(const s of e){if(new Date(s.tanggal).getTime()<=n+1e3)if("asset"===t.jenis_item){if(s.new_kondisi){a=s.new_kondisi;break}}else{const e=s.new_jumlah||s.new_kondisi_detail;if(e){const t=e.baik||0,n=e.rusak||0,s=e.Mutasi||0;t>n&&t>s?a="baik":n>t&&n>s?a="rusak":s>t&&s>n?a="Mutasi":(t>0||n>0||s>0)&&(a="distribusi");break}}}}if("tidak diketahui"===a)if("asset"===t.jenis_item)a=t.kondisi||"tidak diketahui";else{const e=t.kondisi_detail;if(e){const t=e.baik||0,n=e.rusak||0,s=e.Mutasi||0;t>n&&t>s?a="baik":n>t&&n>s?a="rusak":s>t&&s>n?a="Mutasi":(t>0||n>0||s>0)&&(a="distribusi")}}}o.set(e.id||`${e.assetId}_${e.timestamp}`,a)}if(!s||0===s.length)return void(t.innerHTML=`\n                <div class="empty-state">\n                    <i class="fas fa-images"></i>\n                    <h3>Belum ada foto</h3>\n                    <p>${navigator.onLine?"Foto akan ditampilkan setelah item ditambahkan":"Mode offline - foto cloudinary tidak tersedia"}</p>\n                </div>\n            `);s.sort((e,t)=>{const a=e.timestamp||new Date(e.tanggal).getTime();return(t.timestamp||new Date(t.tanggal).getTime())-a});let r='<div class="gallery-grid">';s.forEach((e,t)=>{let a=null,n="local",s=!1;e.thumbnail?(a=e.thumbnail,n="thumbnail",s=!0):e.image?(a=e.image,n="local"):e.cloudinary&&e.cloudinary.secure_url&&navigator.onLine?(a=e.cloudinary.secure_url,n="cloudinary"):(a="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150' viewBox='0 0 200 150'%3E%3Crect width='200' height='150' fill='%23f0f0f0'/%3E%3Ctext x='100' y='75' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3EImage Unavailable%3C/text%3E%3C/svg%3E",n="unavailable");const l=e.id||`${e.assetId}_${e.timestamp}`;let d=o.get(l)||"tidak diketahui",c="",u="",m="";switch(d){case"baik":c='<span class="badge badge-success"><i class="fas fa-check-circle"></i> Baik</span>',u="gallery-condition-baik",m="‚úÖ";break;case"rusak":c='<span class="badge badge-danger"><i class="fas fa-exclamation-triangle"></i> Rusak</span>',u="gallery-condition-rusak",m="‚ö†Ô∏è";break;case"Mutasi":c='<span class="badge badge-warning"><i class="fas fa-exchange-alt"></i> Mutasi</span>',u="gallery-condition-mutasi",m="üîÑ";break;case"distribusi":c='<span class="badge badge-info"><i class="fas fa-chart-pie"></i> Distribusi</span>',u="gallery-condition-distribusi",m="üìä";break;default:c='<span class="badge badge-secondary"><i class="fas fa-question"></i> Tidak Diketahui</span>',u="gallery-condition-unknown",m="‚ùì"}const p="utama"===e.type?"Utama":"rusak"===e.type?"Rusak":"Mutasi"===e.type?"Mutasi":"baik"===e.type?"Baik":"Perbaikan",g="utama"===e.type?"badge-info":"rusak"===e.type?"badge-danger":"Mutasi"===e.type?"badge-warning":"baik"===e.type?"badge-success":"badge-secondary";let f="";f="cloudinary"===n?'<span class="cloudinary-badge"><i class="fas fa-cloud"></i> Cloudinary</span>':"thumbnail"===n?'<span class="sync-badge"><i class="fas fa-compress"></i> Thumb</span>':"local"===n?'<span class="sync-badge"><i class="fas fa-database"></i> Lokal</span>':'<span class="badge badge-secondary">Tidak Tersedia</span>';const h=e.cloudinary?'<span class="badge badge-primary" style="margin-left: 5px;" title="HD Version Available"><i class="fas fa-star"></i> HD</span>':"",y=e.tanggal?new Date(e.tanggal).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",v=i[e.assetId]?.nama||e.assetId;r+=`\n                <div class="gallery-item gallery-item-${u}" data-photo-index="${t}" data-kondisi="${d}">\n                    <div style="position: relative;">\n                        <img src="${a}" \n                             alt="Foto ${v}" \n                             class="gallery-image safe-gallery-image" \n                             data-photo-id="${e.id||""}"\n                             data-asset-id="${e.assetId}"\n                             data-kondisi="${d}"\n                             data-type="${e.type}"\n                             data-tanggal="${e.tanggal}"\n                             data-has-cloudinary="${!!e.cloudinary}"\n                             data-has-thumbnail="${!!e.thumbnail}"\n                             data-has-local="${!!e.image}"\n                             data-local-src="${e.image||""}"\n                             data-thumb-src="${e.thumbnail||""}"\n                             data-cloudinary-src="${e.cloudinary?.secure_url||""}"\n                             data-is-thumbnail="${s}"\n                             loading="lazy"\n                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150' viewBox='0 0 200 150'%3E%3Crect width='200' height='150' fill='%23f0f0f0'/%3E%3Ctext x='100' y='75' font-size='14' text-anchor='middle' dy='.3em' fill='%23999'%3E${m} ${d}%3C/text%3E%3C/svg%3E'">\n                        \n                        <div style="position: absolute; top: 10px; left: 10px; z-index: 10;">\n                            ${c}\n                        </div>\n                        \n                        <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">\n                            <span class="badge ${g}">${p}</span>\n                        </div>\n                        \n                        ${s?'\n                            <div style="position: absolute; bottom: 10px; left: 10px; z-index: 10;">\n                                <span class="badge badge-info" style="font-size: 10px;"><i class="fas fa-compress"></i> Thumb</span>\n                            </div>\n                        ':""}\n                    </div>\n                    \n                    <div class="gallery-info">\n                        <div class="gallery-asset" title="${v}">\n                            <i class="fas fa-cube"></i> ${v.length>30?v.substring(0,30)+"...":v}\n                        </div>\n                        \n                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin: 8px 0;">\n                            ${f}\n                            ${h}\n                        </div>\n                        \n                        <div class="gallery-date">\n                            <i class="fas fa-calendar-alt"></i> ${y}\n                        </div>\n                        \n                        <div style="margin-top: 10px; display: flex; gap: 5px;">\n                            <button class="btn btn-outline btn-small" style="flex:1; padding: 4px;" onclick="showAssetDetail('${e.assetId}')">\n                                <i class="fas fa-eye"></i> Detail\n                            </button>\n                            <button class="btn btn-outline btn-small" style="flex:1; padding: 4px;" onclick="downloadPhoto('${e.assetId}', ${t})">\n                                <i class="fas fa-download"></i>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `}),r+="</div>",t.innerHTML=r;const l=document.createElement("style");l.textContent="\n            .gallery-condition-baik { border-top: 4px solid #10b981; }\n            .gallery-condition-rusak { border-top: 4px solid #ef4444; }\n            .gallery-condition-mutasi { border-top: 4px solid #f59e0b; }\n            .gallery-condition-distribusi { border-top: 4px solid #3b82f6; }\n            .gallery-condition-unknown { border-top: 4px solid #9ca3af; }\n            \n            .gallery-item {\n                transition: transform 0.2s ease, box-shadow 0.2s ease;\n            }\n            .gallery-item:hover {\n                transform: translateY(-5px);\n                box-shadow: 0 10px 25px rgba(0,0,0,0.2);\n            }\n        ",document.head.appendChild(l),document.querySelectorAll(".safe-gallery-image").forEach(e=>{e.addEventListener("click",function(e){try{const e=this.closest(".gallery-item")?.dataset.photoIndex,t=s[parseInt(e)];if(!t)return void showToastNotification("Data foto tidak ditemukan","warning");let a=t.thumbnail||t.image,n=!1;!a&&t.cloudinary?.secure_url&&navigator.onLine&&(a=t.cloudinary.secure_url,n=!0),a||(a="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3Ctext x='200' y='150' font-size='20' text-anchor='middle' dy='.3em' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E"),document.getElementById("largePhoto").src=a;const o=document.getElementById("photoInfo");if(o){const e=t.tanggal?new Date(t.tanggal).toLocaleString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Tidak diketahui",a=this.dataset.kondisi||"tidak diketahui",s="baik"===a?"Baik":"rusak"===a?"Rusak":"Mutasi"===a?"Mutasi":"distribusi"===a?"Distribusi":"Tidak Diketahui",r=!!t.cloudinary,l=!!t.thumbnail&&!n;let d="";r&&l&&navigator.onLine?d='\n                                <button class="btn btn-primary btn-small" id="loadHdVersion" style="margin-top: 15px; width: 100%;">\n                                    <i class="fas fa-cloud-upload-alt"></i> Load HD Version (Kualitas Tinggi)\n                                </button>\n                            ':r&&!navigator.onLine&&(d='\n                                <p class="text-warning" style="margin-top: 10px;">\n                                    <i class="fas fa-exclamation-triangle"></i> HD tersedia saat online\n                                </p>\n                            '),o.innerHTML=`\n                            <div style="text-align: left; padding: 10px;">\n                                <p><strong><i class="fas fa-cube"></i> Item:</strong> ${i[t.assetId]?.nama||t.assetId}</p>\n                                <p><strong><i class="fas fa-tag"></i> Tipe Foto:</strong> ${"utama"===t.type?"Foto Utama":t.type}</p>\n                                <p><strong><i class="fas fa-clipboard-check"></i> Kondisi Saat Foto:</strong> \n                                    <span class="badge ${"baik"===a?"badge-success":"rusak"===a?"badge-danger":"Mutasi"===a?"badge-warning":"distribusi"===a?"badge-info":"badge-secondary"}">${s}</span>\n                                </p>\n                                <p><strong><i class="fas fa-calendar"></i> Tanggal:</strong> ${e}</p>\n                                <p><strong><i class="fas fa-cloud"></i> Kualitas:</strong> ${l?"Thumbnail (Cepat)":n?"HD (Kualitas Tinggi)":"Lokal"}</p>\n                                ${d}\n                            </div>\n                        `,r&&l&&navigator.onLine&&setTimeout(()=>{const n=document.getElementById("loadHdVersion");n&&n.addEventListener("click",function(){t.cloudinary?.secure_url&&(document.getElementById("largePhoto").src=t.cloudinary.secure_url,o.innerHTML=`\n                                                <div style="text-align: left; padding: 10px;">\n                                                    <p><strong><i class="fas fa-cube"></i> Item:</strong> ${i[t.assetId]?.nama||t.assetId}</p>\n                                                    <p><strong><i class="fas fa-tag"></i> Tipe Foto:</strong> ${"utama"===t.type?"Foto Utama":t.type}</p>\n                                                    <p><strong><i class="fas fa-clipboard-check"></i> Kondisi Saat Foto:</strong> \n                                                        <span class="badge ${"baik"===a?"badge-success":"rusak"===a?"badge-danger":"Mutasi"===a?"badge-warning":"distribusi"===a?"badge-info":"badge-secondary"}">${s}</span>\n                                                    </p>\n                                                    <p><strong><i class="fas fa-calendar"></i> Tanggal:</strong> ${e}</p>\n                                                    <p><strong><i class="fas fa-cloud"></i> Kualitas:</strong> HD (Kualitas Tinggi) - Cloudinary</p>\n                                                    <p><i class="fas fa-check-circle" style="color: var(--success);"></i> HD Version Loaded</p>\n                                                </div>\n                                            `,showToastNotification("‚úÖ HD version loaded","success"))})},100)}document.getElementById("photoModal").classList.add("active")}catch(e){console.error("Gallery click error:",e),showToastNotification("Gagal membuka foto","warning")}})})}catch(e){console.error("Gallery load error:",e),document.getElementById("galleryContainer").innerHTML=`\n            <div class="empty-state">\n                <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>\n                <h3>Gagal memuat galeri</h3>\n                <p>${e.message||"Terjadi kesalahan"}</p>\n                <button class="btn btn-outline btn-small" onclick="loadGallery()">\n                    <i class="fas fa-redo-alt"></i> Coba Lagi\n                </button>\n            </div>\n        `}}async function downloadPhoto(e,t){const a=await getAssetPhotos(e);if(!a||0===a.length||t>=a.length)return;const n=a[t];let s=null,i="",o=`foto_${e}_${Date.now()}.jpg`;if(navigator.onLine&&n.cloudinary?.secure_url?(s=n.cloudinary.secure_url,i="HD (Cloudinary)"):n.image?(s=n.image,i="HD (Lokal)"):n.thumbnail&&(s=n.thumbnail,i="Thumbnail",o=`thumbnail_${e}_${Date.now()}.jpg`),s)try{showToastNotification(`üì• Mendownload ${i}...`,"info");const e=await fetch(s),t=await e.blob(),a=window.URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=o,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(a),showToastNotification(`‚úÖ ${i} downloaded`,"success")}catch(e){console.error("Download error:",e),showToastNotification("‚ùå Gagal download foto","danger")}else showToastNotification("Tidak ada sumber foto untuk didownload","warning")}function openImportPreview(){document.getElementById("importPreviewModal").classList.add("active")}function closeImportPreview(){document.getElementById("importPreviewModal").classList.remove("active"),importDraftData=[]}function closeZipPreview(){document.getElementById("zipImportModal").classList.remove("active"),currentPreviewData=null,currentZipFile=null}function normalizeRow(e){return{nama_asset:(e.nama_asset||"").trim(),material_kode:(e.material_kode||"").replace(/\s+/g,"").toUpperCase(),no_rs:(e.no_rs||"").replace(/\s+/g,"").toUpperCase(),no_po:e.no_po||"",no_asset:e.no_asset||"",lokasi:(e.lokasi||"").trim(),kondisi:(e.kondisi||"baik").toLowerCase(),jumlah:parseInt(e.jumlah||1),catatan_awal:e.catatan_awal||"",photos:[],valid:!0,errors:[],conflict:!1}}async function previewExcelImport(e){if(await AssetLoader.xlsx(),!requireInternet("Import Excel"))return;if(!currentUser)return void showAlert("importAlert","Harus login dulu","danger");const t=new FileReader;t.onload=async function(e){try{const t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"});importDraftData=[];const n=a.Sheets.ASSET;if(n){XLSX.utils.sheet_to_json(n).forEach(e=>{importDraftData.push({...normalizeRow(e),jenis_item:"asset"})})}const s=a.Sheets.NON_ASSET;if(s){XLSX.utils.sheet_to_json(s).forEach(e=>{importDraftData.push({...normalizeRow(e),jenis_item:"non-asset"})})}if(0===importDraftData.length)return void showAlert("importAlert","‚ùå Tidak ada data yang ditemukan","danger");validateImportDraft(),renderImportPreview()}catch(e){console.error("Import error:",e),showAlert("importAlert",`‚ùå Gagal membaca file: ${e.message}`,"danger")}},t.readAsArrayBuffer(e)}function validateImportDraft(){importDraftData.forEach(e=>{e.valid=!0,e.errors=[],e.conflict=!1,e.nama_asset||e.errors.push("Nama kosong"),e.material_kode||e.errors.push("Material kosong"),e.no_rs||e.errors.push("No RS kosong"),e.lokasi||e.errors.push("Lokasi kosong"),"non-asset"===e.jenis_item&&(!e.jumlah||e.jumlah<=0)&&e.errors.push("Jumlah tidak valid");checkDuplicateAsset(e.material_kode,e.no_rs)&&(e.conflict=!0,e.errors.push("Konflik data sudah ada")),e.errors.length>0&&(e.valid=!1)})}function renderImportPreview(){const e=document.getElementById("importPreviewContainer");e.innerHTML="",importDraftData.forEach((t,a)=>{const n=document.createElement("div");n.className="import-row "+(t.valid?"import-valid":"import-invalid");const s=t.conflict?'<span class="badge badge-danger" style="margin-left: 5px;"><i class="fas fa-exclamation-triangle"></i> Konflik</span>':"";n.innerHTML=`\n            <div style="display: flex; justify-content: space-between; align-items: center;">\n                <div>\n                    <strong>${t.nama_asset||"(Tanpa Nama)"}</strong> ${s}\n                    <div style="font-size: 12px; color: var(--secondary);">\n                        ${t.material_kode} | ${t.no_rs} | ${t.lokasi}\n                    </div>\n                </div>\n                <span class="badge ${"asset"===t.jenis_item?"badge-info":"badge-warning"}">\n                    ${"asset"===t.jenis_item?"Asset":"Non-Asset"}\n                </span>\n            </div>\n            \n            ${t.errors.length>0?`\n                <div style="margin-top: 8px; padding: 5px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; font-size: 12px; color: var(--danger);">\n                    <i class="fas fa-exclamation-circle"></i> ${t.errors.join(", ")}\n                </div>\n            `:""}\n            \n            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">\n                <input type="file" \n                       accept="image/*" \n                       onchange="handleImportPhoto(${a}, this)"\n                       style="flex: 1; padding: 5px; font-size: 12px;">\n                <button onclick="removeImportRow(${a})" class="btn btn-danger btn-small">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </div>\n            \n            ${t.photos&&t.photos.length>0?`\n                <div style="margin-top: 5px; font-size: 11px; color: var(--success);">\n                    <i class="fas fa-check"></i> ${t.photos.length} foto terpilih\n                </div>\n            `:""}\n        `,e.appendChild(n)}),openImportPreview()}function handleImportPhoto(e,t){const a=t.files[0];if(!a)return;if(a.size>5242880)return showAlert("importAlert",`‚ùå File terlalu besar: ${(a.size/1024/1024).toFixed(2)}MB (max 5MB)`,"danger"),void(t.value="");const n=new FileReader;n.onload=function(t){importDraftData[e].photos||(importDraftData[e].photos=[]),importDraftData[e].photos.push(t.target.result),renderImportPreview(),showAlert("importAlert",`‚úÖ Foto ${a.name} ditambahkan`,"success")},n.onerror=function(){showAlert("importAlert","‚ùå Gagal membaca file foto","danger")},n.readAsDataURL(a)}function removeImportRow(e){importDraftData.splice(e,1),renderImportPreview()}async function saveImportedData(){if(await AssetLoader.xlsx(),!currentUser)return void showAlert("importAlert","Harus login","danger");validateImportDraft();if(importDraftData.filter(e=>!e.valid).length>0)showAlert("importAlert","‚ùå Masih ada data tidak valid","danger");else{showProgressOverlay("import",{title:"Mengimpor Data Excel",subtitle:"Menyimpan data ke database..."});try{let e=0,t=0,a=0,n=0;const s=importDraftData.length;let i=0;const o=[];importDraftData.forEach(e=>{i+=e.photos?.length||0}),updateProgressStep("read_zip","completed"),updateProgressStep("import_assets","active"),updateProgressBar(10),updateProgressText(`Mengimport 0 dari ${s} item...`);for(let a=0;a<importDraftData.length;a++){const n=importDraftData[a];try{updateProgressBar(10+a/s*40),updateProgressText(`Mengimport item ${a+1} dari ${s}: ${n.nama_asset}`);const t=normalizeAssetData({...n,jenis_item:n.jenis_item,kondisi:n.kondisi,jumlah:n.jumlah},{userInfo:currentUser,isImport:!0,source:"excel",timestamp:Date.now()+a});await saveAssetToIndexedDB(t,"pending"),o.push(t.id),e++}catch(e){console.error("Error saving row:",e),t++}}if(i>0){updateProgressStep("import_assets","completed"),updateProgressStep("import_photos","active"),updateProgressBar(60),updateProgressText(`Mengimport ${i} foto...`);let e=0;for(let t=0;t<importDraftData.length;t++){const s=importDraftData[t];if(s.photos&&s.photos.length>0){const o=Date.now()+t,r=Math.random().toString(36).substring(2,8).toUpperCase(),l="asset"===s.jenis_item?"A":"N",d=`${l}-${s.material_kode.toString().replace(/\s+/g,"").toUpperCase()}-${o}-${r}-1`;for(let t=0;t<s.photos.length;t++){const o=s.photos[t];try{updateProgressText(`Mengimport foto ${e+1} dari ${i}...`),await savePhotoWithCloudinary(d,"utama",o,null,{uid:currentUser.uid,nama:currentUser.nama||currentUser.email,email:currentUser.email}),a++}catch(e){console.error("Error saving photo:",e),n++}e++;updateProgressBar(60+e/i*20)}}}}updateProgressStep("import_photos","completed"),updateProgressStep("reload_data","active"),updateProgressBar(85),updateProgressText("Memuat ulang data..."),await loadAssets(),await cleanupOrphanPhotos(),updateAssetSelects(),displayAssets(),updateDashboard(),navigator.onLine&&isFirebaseConnected&&o.length>0&&(updateProgressText("Mengupdate metadata cloud..."),await updateCloudSyncMetadata(o)),updateProgressStep("reload_data","completed"),updateProgressStep("finalize","active"),updateProgressBar(95),updateProgressText("Menyelesaikan..."),navigator.onLine&&!isSyncRunning&&setTimeout(runSyncNow,2e3),updateProgressStep("finalize","completed"),updateProgressBar(100),updateProgressText("Import selesai!"),setTimeout(()=>{hideProgressOverlay(),closeImportPreview();showAlert("importAlert",`‚úÖ Import Excel berhasil!\nüì¶ Asset: ${e} (${t} gagal)\nüì∏ Foto: ${a} (${n} gagal)`,t+n>0?"warning":"success")},1e3),importDraftData=[],document.getElementById("importFile").value="",document.getElementById("btnImport").style.display="none",document.getElementById("importAlert").style.display="none"}catch(e){console.error("Import error:",e),showProgressError(`Gagal import: ${e.message}`),setTimeout(()=>{hideProgressOverlay(),showAlert("importAlert",`‚ùå Gagal import: ${e.message}`,"danger")},2e3)}}}async function previewZipImport(e){if(await AssetLoader.jszip(),requireInternet("Import ZIP"))if(currentUser){showProgressOverlay("import",{title:"Menganalisis File Backup",subtitle:"Membaca struktur ZIP..."});try{updateProgressStep("read_zip","active"),updateProgressBar(10),updateProgressText("Membaca file ZIP...");const t=await JSZip.loadAsync(e);updateProgressBar(30),updateProgressText("Membaca data JSON...");const a=t.file("assets_data.json"),n=t.file("photos_meta.json"),s=t.file("backup_info.json");if(!a)throw new Error("File ZIP tidak valid: tidak ditemukan assets_data.json");const i=JSON.parse(await a.async("text")),o=n?JSON.parse(await n.async("text")):[],r=s?JSON.parse(await s.async("text")):null;updateProgressBar(50),updateProgressText("Membaca file foto...");const l=[],d=t.folder("photos");d&&d.forEach((e,t)=>{l.push({name:e,file:t})}),updateProgressBar(70),updateProgressText("Menganalisis konflik data...");const c=await loadAssetsFromIndexedDB(),u=new Map;c.forEach(e=>{const t=`${normalizeValue(e.material_kode)}|${normalizeValue(e.no_rs)}`;u.set(t,e)});const m={assets:[],photos:o,photoFiles:l,backupInfo:r,stats:{total:i.length,new:0,conflict:0,same:0,photos_in_zip:l.length,photos_in_meta:o.length}};for(let e=0;e<i.length;e++){const t=i[e];e%10==0&&updateProgressText(`Menganalisis asset ${e+1} dari ${i.length}...`);const a=`${normalizeValue(t.material_kode)}|${normalizeValue(t.no_rs)}`,n=u.get(a),s={...t,conflict:!!n,existingId:n?.id||null,existingData:n||null,selected:!n,keepExisting:!1};m.assets.push(s),n?(m.stats.conflict++,JSON.stringify(t)===JSON.stringify(n)&&m.stats.same++):m.stats.new++}m.assets.forEach(e=>{e.conflict?(e.importAction=e.existingData?"update":"conflict",e.warning="Data akan DIUPDATE (pakai ID lama) - TIDAK membuat duplikat"):(e.importAction="insert",e.warning="Data akan diINSERT (ID baru)")});const p=new Map;m.assets.forEach(e=>{p.set(e.id,e),e.existingId&&p.set(e.existingId,e)}),m.assetIdMap=p,updateProgressStep("read_zip","completed"),updateProgressStep("finalize","active"),updateProgressBar(100),updateProgressText("Analisis selesai!"),setTimeout(()=>{hideProgressOverlay(),showZipImportPreview(m,t)},500)}catch(e){console.error("Preview error:",e),showProgressError(`Gagal membaca ZIP: ${e.message}`),setTimeout(()=>{hideProgressOverlay(),showAlert("importAlert",`‚ùå Gagal membaca ZIP: ${e.message}`,"danger")},2e3)}}else showAlert("importAlert","Harus login dulu","danger")}async function confirmZipImport(){if(await AssetLoader.jszip(),!currentPreviewData||!currentZipFile)return void showAlert("importAlert","Tidak ada data untuk diimport","danger");const e=currentPreviewData.assets.filter(e=>e.selected);if(0!==e.length){showProgressOverlay("import",{title:"Mengimport Data ZIP",subtitle:`Mengimport ${e.length} asset...`});try{let t=0,a=0,n=0,s=0;const i=[],o=currentPreviewData.assets.filter(e=>e.selected&&e.conflict),r=new Map;currentPreviewData.assets.forEach(e=>{e.id&&r.set(e.id,e),e.existingId&&r.set(e.existingId,e);const t=`${e.material_kode}|${e.no_rs}`;r.set(t,e)}),updateProgressStep("import_assets","active"),updateProgressBar(5);for(let n=0;n<e.length;n++)try{const a=e[n];updateProgressText(`Memproses asset ${n+1} dari ${e.length}: ${a.nama_asset}`),updateProgressBar(5+n/e.length*30);const s={...a};let o;if(delete s.conflict,delete s.existingId,delete s.existingData,delete s.selected,delete s.keepExisting,delete s.importAction,delete s.warning,a.conflict&&!a.keepExisting){const e=a.existingData||await getAssetFromIndexedDB(a.existingId);o=normalizeAssetData(s,{userInfo:currentUser,isImport:!0,source:"zip",timestamp:null}),o.id=a.existingId,o.updatedAt=Date.now(),o.updatedAtISO=(new Date).toISOString(),o.riwayat=o.riwayat||[],o.riwayat.push({tanggal:(new Date).toISOString(),tipe:"import_override",user:{uid:currentUser.uid,nama:currentUser.nama||currentUser.email,email:currentUser.email},catatan:"Data ditimpa dari backup ZIP (konflik)",old_data_summary:{kondisi:e?.kondisi,lokasi:e?.lokasi,total_jumlah:e?.total_jumlah}}),i.push(a.existingId)}else o=normalizeAssetData(s,{userInfo:currentUser,isImport:!0,source:"zip",timestamp:Date.now()+n}),i.push(o.id);await saveAssetToIndexedDB(o,"pending"),t++}catch(e){console.error("Error saving asset:",e),a++}if(currentPreviewData.photoFiles.length>0){updateProgressStep("import_photos","active"),updateProgressBar(40);const t=new Set;e.forEach(e=>{if(e.conflict&&!e.keepExisting)t.add(e.existingId);else{const a=e.material_kode.replace(/\s+/g,"").toUpperCase(),n=`${"asset"===e.jenis_item?"A":"N"}-${a}-${Date.now()}-${Math.random().toString(36).substring(2,8).toUpperCase()}-1`;t.add(n),e.id&&t.add(e.id)}});for(let e=0;e<currentPreviewData.photoFiles.length;e++)try{const a=currentPreviewData.photoFiles[e];updateProgressText(`Mengimport foto ${e+1} dari ${currentPreviewData.photoFiles.length}...`),updateProgressBar(40+e/currentPreviewData.photoFiles.length*40);const i=await a.file.async("base64"),o=a.name;let l=extractAssetIdFromFilename(o);if(!l){console.warn(`‚ùå Gagal ekstrak ID dari filename: ${o}`),s++;continue}let d=null;if(t.has(l))d=l;else{const e=r.get(l);if(!e){console.warn(`‚ö†Ô∏è Asset ID ${l} tidak ditemukan dalam daftar import`),s++;continue}d=e.conflict&&!e.keepExisting?e.existingId:e.id}if(!d){s++;continue}const c=await getAssetPhotos(d),u=o.match(/_(\d+)_/),m=u?parseInt(u[1]):null;if(c.some(e=>!(!m||!e.timestamp)&&Math.abs(e.timestamp-m)<1e3)){n++;continue}const p=`data:image/jpeg;base64,${i}`;let g=p;try{const e=await fetch(p),t=await e.blob(),a=new File([t],o,{type:"image/jpeg"});g=(await compressImage(a)).base64}catch(e){console.warn("Compression failed, using original:",e)}const f=u?parseInt(u[1]):Date.now()+e;let h="utama";o.includes("rusak")?h="rusak":o.includes("mutasi")?h="Mutasi":o.includes("baik")&&(h="baik");const y={assetId:d,type:h,image:g,tanggal:(new Date).toISOString(),timestamp:f,uploadStatus:"PENDING",imported_from_backup:!0,imported_at:(new Date).toISOString(),source_file:o};if(currentPreviewData.photos&&currentPreviewData.photos.length>0){const e=currentPreviewData.photos.find(e=>e.timestamp&&Math.abs(e.timestamp-f)<1e3);e&&(e.type&&(y.type=e.type),e.tanggal&&(y.tanggal=e.tanggal),e.cloudinary&&(y.cloudinary=e.cloudinary))}await new Promise((e,t)=>{const a=indexedDBInstance.transaction(["photos"],"readwrite").objectStore("photos").add(y);a.onsuccess=()=>{e()},a.onerror=e=>{console.error("   ‚ùå Gagal simpan foto:",e.target.error),t(e.target.error)}}),n++}catch(e){console.error("Error saving photo:",e),s++}}updateProgressStep("reload_data","active"),updateProgressBar(85),updateProgressText("Memuat ulang data..."),await loadAssets(),await cleanupOrphanPhotos(),updateAssetSelects(),displayAssets(),updateDashboard(),navigator.onLine&&isFirebaseConnected&&i.length>0&&(updateProgressText("Mengupdate metadata cloud..."),await updateCloudSyncMetadata(i),await resetCloudSyncMetadata(!0)),updateProgressStep("finalize","active"),updateProgressBar(95),updateProgressText("Menyelesaikan..."),navigator.onLine&&!isSyncRunning&&setTimeout(runSyncNow,2e3),updateProgressStep("finalize","completed"),updateProgressBar(100),updateProgressText("Import selesai!"),setTimeout(()=>{hideProgressOverlay(),closeZipPreview();const e=a+s;let i=`‚úÖ Import ZIP berhasil!\nüì¶ Asset: ${t} (${a} gagal)\nüì∏ Foto: ${n} (${s} gagal)`;o.length>0&&(i+=`\n\nüîÑ ${o.length} asset diupdate (TIMPA DATA LAMA) - TIDAK ADA DUPLIKAT`),showAlert("importAlert",i,e>0?"warning":"success"),setTimeout(checkForDuplicatesAfterImport,2e3)},1e3),currentPreviewData=null,currentZipFile=null,selectedImportFile=null,document.getElementById("importFile").value="",document.getElementById("btnImport").style.display="none",document.getElementById("importAlert").style.display="none"}catch(e){console.error("Import error:",e),showProgressError(`Gagal import: ${e.message}`),setTimeout(()=>{hideProgressOverlay(),showAlert("importAlert",`‚ùå Gagal import: ${e.message}`,"danger")},2e3)}}else showAlert("importAlert","Tidak ada asset yang dipilih untuk diimport","warning")}function extractAssetIdFromFilename(e){if(!e)return null;const t=e.match(/^([AN]-[A-Z0-9]+-\d+-[A-Z0-9]+-\d+)_\d+_/);if(t&&t[1])return t[1];const a=e.match(/[AN]-[A-Z0-9]+-\d+-[A-Z0-9]+-\d+/);if(a)return a[0];const n=e.indexOf("_");if(n>0){const t=e.substring(0,n);if(t.match(/^[AN]-[A-Z0-9]+/))return t}return null}function showZipImportPreview(e,t){currentPreviewData=e,currentZipFile=t;const a=document.getElementById("zipImportModal");document.getElementById("zipPreviewStats").innerHTML=`\n        <span class="badge badge-info">Total: ${e.stats.total}</span>\n        <span class="badge badge-success">Baru: ${e.stats.new}</span>\n        <span class="badge badge-warning">Konflik: ${e.stats.conflict}</span>\n        <span class="badge badge-primary">üì∏ Foto: ${e.stats.photos_in_zip}</span>\n        ${e.stats.same>0?`<span class="badge badge-secondary">Sama: ${e.stats.same}</span>`:""}\n    `,renderZipAssetsTab(e.assets),document.querySelectorAll(".zip-tab").forEach(e=>{e.removeEventListener("click",handleZipTabClick),e.addEventListener("click",handleZipTabClick)}),a.classList.add("active")}function handleZipTabClick(){document.querySelectorAll(".zip-tab").forEach(e=>{e.classList.remove("active"),e.style.borderBottom="none"}),this.classList.add("active"),this.style.borderBottom="3px solid var(--primary)";const e=this.getAttribute("data-tab");"assets"===e&&renderZipAssetsTab(currentPreviewData.assets),"photos"===e&&renderZipPhotosTab(currentPreviewData),"conflicts"===e&&renderZipConflictsTab(currentPreviewData.assets.filter(e=>e.conflict))}function renderZipAssetsTab(e){const t=document.getElementById("zipPreviewContainer");if(!e||0===e.length)return void(t.innerHTML='<div class="empty-state"><i class="fas fa-cubes"></i><p>Tidak ada data asset</p></div>');let a='<div style="max-height: 400px; overflow-y: auto;">';e.forEach((e,t)=>{const n=e.conflict?"import-invalid":"import-valid",s=e.conflict?'<span class="badge badge-danger"><i class="fas fa-exclamation-triangle"></i> Konflik</span>':'<span class="badge badge-success"><i class="fas fa-check"></i> Baru</span>',i=e.selected?"checked":"",o=e.keepExisting?"disabled":"";a+=`\n            <div class="import-row ${n}" data-asset-index="${t}">\n                <div style="display: flex; align-items: center; gap: 15px;">\n                    <div>\n                        <input type="checkbox" \n                               class="asset-select-checkbox" \n                               data-asset-index="${t}" \n                               ${i} \n                               ${o}\n                               onchange="toggleAssetSelection(${t}, this.checked)">\n                    </div>\n                    \n                    <div style="flex: 1;">\n                        <div style="display: flex; justify-content: space-between; align-items: center;">\n                            <div>\n                                <strong>${e.nama_asset||"Tanpa Nama"}</strong>\n                                ${s}\n                            </div>\n                            <span class="badge ${"asset"===e.jenis_item?"badge-info":"badge-warning"}">\n                                ${"asset"===e.jenis_item?"Asset":"Non-Asset"}\n                            </span>\n                        </div>\n                        \n                        <div style="font-size: 13px; margin-top: 5px;">\n                            <span><strong>Material:</strong> ${e.material_kode}</span> |\n                            <span><strong>No RS:</strong> ${e.no_rs}</span> |\n                            <span><strong>Lokasi:</strong> ${e.lokasi}</span>\n                        </div>\n                        \n                        ${e.conflict?`\n                            <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 5px;">\n                                <div style="display: flex; gap: 15px; align-items: center;">\n                                    <div>\n                                        <input type="radio" \n                                               name="conflict_resolve_${t}" \n                                               id="override_${t}" \n                                               value="override"\n                                               ${e.keepExisting?"":"checked"}\n                                               onchange="resolveConflict(${t}, 'override')">\n                                        <label for="override_${t}">Timpa data lama</label>\n                                    </div>\n                                    <div>\n                                        <input type="radio" \n                                               name="conflict_resolve_${t}" \n                                               id="keep_${t}" \n                                               value="keep"\n                                               ${e.keepExisting?"checked":""}\n                                               onchange="resolveConflict(${t}, 'keep')">\n                                        <label for="keep_${t}">Pertahankan data lama</label>\n                                    </div>\n                                </div>\n                                <div style="font-size: 12px; margin-top: 5px; color: var(--secondary);">\n                                    <strong>Data lama ID:</strong> ${e.existingId}\n                                </div>\n                            </div>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n        `}),a+="</div>",t.innerHTML=a}function renderZipPhotosTab(e){const t=document.getElementById("zipPreviewContainer"),{photos:a,photoFiles:n,backupInfo:s}=e;let i='<div style="max-height: 400px; overflow-y: auto;">';if(s){const e=new Date(s.timestamp).toLocaleString("id-ID");i+=`\n            <div class="alert alert-info" style="margin-bottom: 15px;">\n                <i class="fas fa-info-circle"></i>\n                <strong>Informasi Backup:</strong><br>\n                Tanggal: ${e}<br>\n                Dibuat oleh: ${s.created_by?.nama||"Unknown"}<br>\n                Versi App: ${s.app_version}\n            </div>\n        `}i+=`<p><strong>Total Foto di ZIP:</strong> ${n.length} file</p>`,0===n.length?i+='<div class="empty-state"><i class="fas fa-images"></i><p>Tidak ada foto dalam ZIP</p></div>':(i+='<div style="display: flex; flex-wrap: wrap; gap: 15px;">',n.slice(0,20).forEach((e,t)=>{i+=`\n                <div style="text-align: center; width: 100px;">\n                    <div style="width: 100px; height: 100px; background: var(--card-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border-color); overflow: hidden;">\n                        <i class="fas fa-file-image" style="font-size: 40px; color: var(--primary-light);"></i>\n                    </div>\n                    <small style="font-size: 10px; word-break: break-word;">${e.name.substring(0,15)}...</small>\n                </div>\n            `}),n.length>20&&(i+=`<div style="width:100%; text-align:center; margin-top:10px;">... dan ${n.length-20} foto lainnya</div>`),i+="</div>"),i+="</div>",t.innerHTML=i}function renderZipConflictsTab(e){const t=document.getElementById("zipPreviewContainer");if(0===e.length)return void(t.innerHTML='<div class="alert alert-success"><i class="fas fa-check-circle"></i> Tidak ada konflik!</div>');let a='<div style="max-height: 400px; overflow-y: auto;">';e.forEach((e,t)=>{a+=`\n            <div class="import-invalid" style="margin-bottom: 10px; padding: 15px;">\n                <div style="font-weight: 600; color: var(--danger);">\n                    <i class="fas fa-exclamation-triangle"></i> Konflik #${t+1}\n                </div>\n                <div style="margin-top: 5px;">\n                    <strong>${e.nama_asset}</strong> (${e.material_kode} | ${e.no_rs})\n                </div>\n                <div style="font-size: 12px; margin-top: 5px;">\n                    Data baru akan menggantikan data lama dengan ID: ${e.existingId}\n                </div>\n                <div style="margin-top: 10px; display: flex; gap: 10px;">\n                    <button class="btn btn-small btn-conflict-refresh" onclick="resolveConflict(${t}, 'override')">\n                        <i class="fas fa-exclamation-circle"></i> Timpa\n                    </button>\n                    <button class="btn btn-small btn-conflict-cancel" onclick="resolveConflict(${t}, 'keep')">\n                        <i class="fas fa-check"></i> Pertahankan\n                    </button>\n                </div>\n            </div>\n        `}),a+="</div>",t.innerHTML=a}function toggleAssetSelection(e,t){currentPreviewData&&currentPreviewData.assets[e]&&(currentPreviewData.assets[e].selected=t,updateZipStats())}function resolveConflict(e,t){if(!currentPreviewData||!currentPreviewData.assets[e])return;const a=currentPreviewData.assets[e];"override"===t?(a.selected=!0,a.keepExisting=!1):"keep"===t&&(a.selected=!1,a.keepExisting=!0);const n=document.querySelector(".zip-tab.active");n&&"assets"===n.getAttribute("data-tab")?renderZipAssetsTab(currentPreviewData.assets):n&&"conflicts"===n.getAttribute("data-tab")&&renderZipConflictsTab(currentPreviewData.assets.filter(e=>e.conflict)),updateZipStats()}function updateZipStats(){if(!currentPreviewData)return;const e=document.getElementById("zipPreviewStats"),t=currentPreviewData.assets.filter(e=>e.selected).length,a=currentPreviewData.assets.filter(e=>e.keepExisting).length;e.innerHTML=`\n        <span class="badge badge-info">Total: ${currentPreviewData.assets.length}</span>\n        <span class="badge badge-success">Dipilih: ${t}</span>\n        <span class="badge badge-secondary">Dipertahankan: ${a}</span>\n        <span class="badge badge-warning">Konflik: ${currentPreviewData.assets.filter(e=>e.conflict).length}</span>\n        <span class="badge badge-primary">üì∏ Foto: ${currentPreviewData.photoFiles.length}</span>\n    `}async function checkForDuplicatesAfterImport(){try{const e=await loadAssetsFromIndexedDB(),t=new Map,a=[];e.forEach(e=>{const n=`${e.material_kode}|${e.no_rs}`;t.has(n)?a.push({key:n,asset1:t.get(n),asset2:e}):t.set(n,e)}),a.length>0&&(console.warn(`‚ö†Ô∏è Ditemukan ${a.length} duplikasi data!`),showToastNotification(`‚ö†Ô∏è Terdeteksi ${a.length} duplikasi data. Jalankan sinkronisasi untuk memperbaiki.`,"warning"))}catch(e){console.error("Error checking duplicates:",e)}}async function exportExcelTemplate(){try{const e=event?.target;e&&(e.disabled=!0,e.innerHTML='<div class="loading"></div> Memuat...'),await AssetLoader.xlsx();const t=[{nama_asset:"",material_kode:"",no_rs:"",no_po:"",no_asset:"",lokasi:"",kondisi:"baik",catatan_awal:""}],a=[{nama_asset:"",material_kode:"",no_rs:"",no_po:"",lokasi:"",kondisi:"baik",jumlah:1,catatan_awal:""}],n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,XLSX.utils.json_to_sheet(t),"ASSET"),XLSX.utils.book_append_sheet(n,XLSX.utils.json_to_sheet(a),"NON_ASSET");const s=XLSX.write(n,{bookType:"xlsx",type:"array"}),i=new Blob([s],{type:"application/octet-stream"});saveAs(i,"asset_import_template.xlsx"),showAlert("importAlert","‚úÖ Template berhasil dibuat","success")}catch(e){showAlert("importAlert","‚ùå Gagal membuat template","danger")}finally{const e=event?.target;e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-file-excel"></i> Download Template')}}async function createBackup(){if(requireInternet("Backup data"))if(currentUser)if(indexedDBInstance)try{const e=document.getElementById("btnBackup");e.innerHTML;e.innerHTML='<div class="loading"></div> Memuat library...',e.disabled=!0,await AssetLoader.loadMultiple(["jszip","filesaver"]),e.innerHTML='<div class="loading"></div> Membuat backup lengkap...',showProgressOverlay("backup",{title:"Membuat Backup Lengkap",subtitle:"Mengumpulkan data dan foto..."}),updateProgressStep("load_data","active"),updateProgressBar(5),updateProgressText("Memuat data asset...");const t=await loadAssetsFromIndexedDB();updateProgressBar(10),updateProgressText(`Memuat ${t.length} asset...`),updateProgressText("Memuat data foto...");const a=await getAllPhotos(),n=a.length;updateProgressBar(15),updateProgressText("Memuat data aktivitas...");const s=await getAllUserActivities();updateProgressBar(18),updateProgressText("Memuat data pengaturan...");const i=await getAllSettings();updateProgressStep("load_data","completed"),updateProgressBar(20),updateProgressStep("process_photos","active"),updateProgressText(`Menyiapkan ${n} foto...`),updateProgressBar(25);const o=new JSZip,r=o.folder("photos"),l=[];let d=0,c=0;const u=50;for(let e=0;e<a.length;e+=u){const s=Math.min(e+u,a.length),i=a.slice(e,s);updateProgressBar(25+(e+i.length)/n*45),updateProgressText(`Memproses foto ${e+1}-${s} dari ${n}...`),await Promise.all(i.map(async(e,a)=>{try{const{image:a,thumbnail:n,...s}=e;s.processed_at=(new Date).toISOString(),l.push(s);t.find(t=>t.id===e.assetId);const i=e.timestamp||Date.now(),o=e.type||"utama";let u=`${e.assetId}_${i}_${o}.jpg`,m=!1;if(e.image&&e.image.startsWith("data:image"))try{const t=e.image.split(",")[1],a=atob(t),n=new Uint8Array(a.length);for(let e=0;e<a.length;e++)n[e]=a.charCodeAt(e);r.file(u,n),m=!0,d++}catch(e){console.warn("Gagal konversi base64 foto:",e)}if(!m&&e.cloudinary?.secure_url&&navigator.onLine)try{const t=await fetch(e.cloudinary.secure_url,{timeout:1e4,cache:"no-cache"});if(t.ok){const e=await t.blob();r.file(u,e),m=!0,d++}}catch(e){console.warn("Gagal download dari Cloudinary:",e)}m||(c++,s.backup_failed=!0)}catch(e){console.error("Error processing photo:",e),c++}})),await new Promise(e=>setTimeout(e,10))}updateProgressStep("process_photos","completed"),updateProgressBar(70),updateProgressStep("create_zip","active"),updateProgressText("Menyiapkan file JSON..."),updateProgressBar(75);const m={timestamp:Date.now(),date_iso:(new Date).toISOString(),app_version:APP_META?.VERSION||"unknown",build_code:APP_META?.BUILD_CODE||"unknown",database_schema:"asset_management_v2_2026",created_by:{uid:currentUser.uid,nama:currentUser.nama||currentUser.email,email:currentUser.email,role:currentUser.role},counts:{assets:t.length,photos:l.length,photos_saved:d,photos_failed:c,activities:s.length,settings:Object.keys(i).length},export_stats:{start_time:(new Date).toISOString(),duration_seconds:0}};updateProgressText("Menyimpan data asset..."),o.file("assets_data.json",JSON.stringify(t,null,2)),updateProgressBar(78),updateProgressText("Menyimpan metadata foto..."),o.file("photos_meta.json",JSON.stringify(l,null,2)),updateProgressBar(80),updateProgressText("Menyimpan data aktivitas..."),o.file("activities_data.json",JSON.stringify(s,null,2)),updateProgressBar(82),updateProgressText("Menyimpan data pengaturan..."),o.file("settings_data.json",JSON.stringify(i,null,2)),updateProgressBar(84),updateProgressText("Menyimpan info backup..."),o.file("backup_info.json",JSON.stringify(m,null,2));const p=`ASSET MANAGEMENT BACKUP\n===========================\nTanggal: ${(new Date).toLocaleString("id-ID")}\nDibuat oleh: ${currentUser.nama||currentUser.email}\n\nSTATISTIK:\n- Total Asset: ${t.length}\n- Total Foto: ${d}\n- Foto Gagal: ${c}\n\nCARA RESTORE:\n1. Buka tab Backup & Export\n2. Pilih file ZIP ini\n3. Untuk konflik, pilih "Timpa Data Lama" untuk update data yang ada\n4. Data akan diupdate dengan ID yang sama (TIDAK membuat duplikat)\n`;o.file("import_instructions.txt",p),updateProgressBar(86),updateProgressText("Mengompres file..."),updateProgressBar(88);const g=await o.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6},onUpdate:e=>{updateProgressBar(88+e.percent/100*10),updateProgressText(`Mengompres... ${Math.round(e.percent)}%`)}});updateProgressBar(98),updateProgressText("Menyimpan file...");const f=new Date,h=`asset_backup_${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}_${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}${f.getSeconds().toString().padStart(2,"0")}.zip`;saveAs(g,h),updateProgressStep("save_backup","active"),updateProgressText("Menyimpan ke riwayat..."),await saveBackupToHistory(m),updateProgressStep("save_backup","completed"),updateProgressStep("finalize","active"),updateProgressBar(100),updateProgressText("Backup selesai!"),setTimeout(()=>{hideProgressOverlay();let e=`‚úÖ Backup berhasil!\nüì¶ Assets: ${t.length}\nüì∏ Foto: ${d}`;c>0&&(e+=`\n‚ö†Ô∏è Foto gagal: ${c}`),showAlert("backupInfo",e,c>0?"warning":"success")},1e3)}catch(e){console.error("‚ùå Backup error:",e),showProgressError(`Gagal backup: ${e.message}`),setTimeout(()=>{hideProgressOverlay(),showAlert("backupInfo",`‚ùå Backup gagal: ${e.message}`,"danger")},2e3)}finally{const e=document.getElementById("btnBackup");e&&(e.innerHTML='<i class="fas fa-file-archive"></i> Buat Backup ZIP',e.disabled=!1)}else showAlert("backupInfo","Database belum siap","danger");else showAlert("backupInfo","Harus login dulu","danger")}async function saveBackupToHistory(e){return new Promise((t,a)=>{const n=indexedDBInstance.transaction(["backups"],"readwrite").objectStore("backups").add(e);n.onsuccess=function(){t()},n.onerror=function(e){a(e.target.error)}})}async function loadBackupHistory(){try{const e=await new Promise((e,t)=>{const a=indexedDBInstance.transaction(["backups"],"readonly").objectStore("backups").getAll();a.onsuccess=function(){const t=a.result.sort((e,t)=>t.timestamp-e.timestamp);e(t)},a.onerror=t}),t=document.getElementById("backupHistory"),a=document.getElementById("backupCount");if(!e||0===e.length)return t.innerHTML='\n                <div class="empty-state" style="padding: 30px 20px;">\n                    <i class="fas fa-history"></i>\n                    <h3>Belum ada riwayat backup</h3>\n                    <p>Buat backup pertama Anda untuk memulai</p>\n                </div>\n            ',void(a.textContent="0 backup tersimpan");a.textContent=`${e.length} backup tersimpan`;let n='<div class="backup-history-list">';e.slice(0,10).forEach(e=>{const t=new Date(e.timestamp).toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});n+=`\n                <div class="asset-card">\n                    <div class="asset-header">\n                        <div>\n                            <div class="asset-title">Backup ${t}</div>\n                            <div class="asset-subtitle">\n                                üì¶ Items: ${e.counts?.assets||0} | \n                                üì∏ Foto: ${e.counts?.photos_saved||e.counts?.photos||0}\n                                ${e.counts?.photos_failed?` | ‚ö†Ô∏è Gagal: ${e.counts.photos_failed}`:""}\n                            </div>\n                        </div>\n                        <div class="badge badge-info">v${e.app_version||"1.0"}</div>\n                    </div>\n                    <div style="font-size: 12px; color: var(--secondary); margin-top: 5px;">\n                        Dibuat oleh: ${e.created_by?.nama||e.created_by?.email||"Unknown"}\n                    </div>\n                </div>\n            `}),e.length>10&&(n+=`<p style="text-align: center; margin-top: 10px; color: var(--secondary);">... dan ${e.length-10} backup lainnya</p>`),n+="</div>",t.innerHTML=n}catch(e){console.error("Error loading backup history:",e)}}async function loadBackupHistoryData(){return new Promise((e,t)=>{const a=indexedDBInstance.transaction(["backups"],"readonly").objectStore("backups").getAll();a.onsuccess=function(){const t=a.result||[];t.sort((e,t)=>t.timestamp-e.timestamp),e(t)},a.onerror=function(e){t(e.target.error)}})}async function updateStorageInfo(){try{if(!indexedDBInstance)return void console.warn("IndexedDB not ready");let e=0,t=0,a=0,n=0,s=0;const i=["photos","assets","user_activities","settings","backups"],o=indexedDBInstance.transaction(i,"readonly"),[r,l,d,c,u]=await Promise.all([new Promise(e=>{const t=o.objectStore("photos").getAll();t.onsuccess=()=>e(t.result||[]),t.onerror=()=>e([])}),new Promise(e=>{const t=o.objectStore("assets").getAll();t.onsuccess=()=>e(t.result||[]),t.onerror=()=>e([])}),new Promise(e=>{const t=o.objectStore("user_activities").getAll();t.onsuccess=()=>e(t.result||[]),t.onerror=()=>e([])}),new Promise(e=>{const t=o.objectStore("settings").getAll();t.onsuccess=()=>e(t.result||[]),t.onerror=()=>e([])}),new Promise(e=>{const t=o.objectStore("backups").getAll();t.onsuccess=()=>e(t.result||[]),t.onerror=()=>e([])})]);t=r.length,r.forEach(t=>{if(t.image&&t.image.startsWith("data:"))try{const a=t.image.split(",")[1];if(a){const t=(a.match(/=/g)||[]).length,n=3*a.length/4-t;e+=n}}catch(e){console.warn("Error menghitung foto:",e)}if(t.thumbnail&&t.thumbnail.startsWith("data:"))try{const a=t.thumbnail.split(",")[1];if(a){const t=(a.match(/=/g)||[]).length,n=3*a.length/4-t;e+=.3*n}}catch(e){}}),a=l.length;const m=JSON.stringify(l);e+=new Blob([m]).size,n=d.length;const p=JSON.stringify(d);e+=.5*new Blob([p]).size;const g={};c.forEach(e=>{e.key&&(g[e.key]=e)});const f=JSON.stringify(g);e+=new Blob([f]).size,s=u.length;const h=JSON.stringify(u);e+=new Blob([h]).size;const y=e/1048576;let v=51200,b=(y/v*100).toFixed(1);if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();if(e.quota){v=e.quota/1048576;const n=e.usage||0;if(n>0){const s=n/1048576;return b=(n/e.quota*100).toFixed(1),void updateStorageUI(s,v,b,t,a)}}}catch(e){console.warn("Cannot get storage estimate:",e)}updateStorageUI(y,v,b,t,a)}catch(e){console.error("‚ùå Error calculating storage:",e),document.getElementById("localStorageInfo").innerHTML='<div style="color: var(--danger); padding: 10px;">‚ùå Error menghitung penyimpanan</div>'}}function updateStorageUI(e,t,a,n,s){const i=document.getElementById("localStorageInfo"),o=document.getElementById("storageUsedText"),r=document.getElementById("storageTotalText"),l=document.getElementById("storagePercent"),d=document.getElementById("storageProgress");if(!i)return;const c=e.toFixed(2),u=t.toFixed(2),m=parseFloat(a);let p="var(--success)",g="";m>80?(p="var(--danger)",g="‚ö†Ô∏è Penyimpanan hampir penuh! Backup dan hapus data lama."):m>60?(p="var(--warning)",g="‚ÑπÔ∏è Pertimbangkan untuk backup."):g="‚úÖ Penyimpanan aman.",o&&(o.textContent=`${c} MB`),r&&(r.textContent=`${u} MB`),l&&(l.textContent=`${m}%`,l.style.color=p),d&&(d.style.width=`${Math.min(100,m)}%`,d.style.backgroundColor=p),i.innerHTML=`\n        <div style="margin-bottom: 10px;">\n            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                <span style="font-weight: 600;">Penyimpanan:</span>\n                <span style="color: var(--text-color);">${c} MB / ${u} MB</span>\n            </div>\n            <div class="progress-bar" style="height: 10px; background: var(--border-color); border-radius: 5px; overflow: hidden;">\n                <div id="storageProgress" class="progress-bar-fill" \n                     style="width: ${Math.min(100,m)}%; height: 100%; background: ${p}; transition: width 0.5s ease;">\n                </div>\n            </div>\n            <div style="text-align: center; font-weight: 600; margin-top: 5px; color: ${p};">\n                ${m}%\n            </div>\n        </div>\n        \n        <div style="font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">\n            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                <span>üì∏ Foto tersimpan:</span>\n                <span style="font-weight: 600;">${n} file</span>\n            </div>\n            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                <span>üì¶ Total asset:</span>\n                <span style="font-weight: 600;">${s} item</span>\n            </div>\n            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                <span>üíæ Rata-rata per foto:</span>\n                <span style="font-weight: 600;">${n>0?(e/n).toFixed(2):0} MB</span>\n            </div>\n        </div>\n        \n        <div style="font-size: 12px; color: var(--secondary); margin-top: 10px; padding: 8px; background: var(--light); border-radius: 5px;">\n            <i class="fas fa-info-circle"></i> ${g}\n        </div>\n    `;const f=document.getElementById("storageUsed");f&&(f.textContent=`${c} MB`)}function updateSettingsUserInfo(){if(!currentUser)return;const e=document.getElementById("currentUserName"),t=document.getElementById("currentUserRole"),a=document.getElementById("currentUserLogin");if(e&&(e.textContent=currentUser.nama||currentUser.email),t&&(t.textContent="owner"===currentUser.role?"Owner":"User"),a){let e="Baru saja";if(currentUser.lastLogin)try{let t;const a=currentUser.lastLogin;a&&"object"==typeof a&&a.toDate&&"function"==typeof a.toDate?t=a.toDate():a&&"object"==typeof a&&a._seconds?t=new Date(1e3*a._seconds):a&&"object"==typeof a&&a.seconds?t=new Date(1e3*a.seconds):"string"==typeof a||"number"==typeof a?t=new Date(a):a instanceof Date&&(t=a),t&&!isNaN(t.getTime())?e=t.toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):console.warn("Invalid lastLogin format:",a)}catch(t){console.error("Error formatting lastLogin:",t,currentUser.lastLogin),"string"==typeof currentUser.lastLogin&&(e=currentUser.lastLogin)}a.textContent=`Login: ${e}`}const n=document.getElementById("ownerSettings");n&&(n.style.display="owner"===currentUser.role?"block":"none")}function updateSettingsSyncInfo(){const e=document.getElementById("firebaseStatusText"),t=document.getElementById("cloudinaryStatusText");e&&(e.innerHTML=isFirebaseConnected?"‚úÖ Firebase: Terhubung":"‚ùå Firebase: Offline"),t&&(t.innerHTML=navigator.onLine?"‚úÖ Cloudinary: Siap":"‚ùå Cloudinary: Offline")}async function loadSettings(){try{await loadCloudinarySettings();const e=[{id:"autoSync",key:"autoSync",defaultValue:!0},{id:"syncInterval",key:"syncInterval",defaultValue:"60000"},{id:"enableCompression",key:"compression",defaultValue:!0}];for(const t of e)try{const e=await getSetting(t.key);if(void 0!==e){const a=document.getElementById(t.id);a&&("checkbox"===a.type?a.checked=e.value:a.value=e.value)}else{const e=document.getElementById(t.id);e&&"checkbox"===e.type&&(e.checked=t.defaultValue)}}catch(e){console.log(`Error loading setting ${t.key}:`,e)}}catch(e){console.error("Error loading settings:",e)}}async function exportAllData(){if(!requireInternet("Export data"))return;const e=document.getElementById("btnExportAllData"),t=e.innerHTML;try{e.disabled=!0,e.innerHTML='<div class="loading"></div> Memuat library...',await AssetLoader.loadMultiple(["jszip","filesaver","xlsx"]),e.innerHTML='<div class="loading"></div> Export lengkap...',showProgressOverlay("export",{title:"Export Semua Data",subtitle:"Menyiapkan laporan, schema, dan foto..."}),updateProgressStep("load_data","active"),updateProgressBar(5),updateProgressText("Memuat data asset..."),0===assets.length&&await loadAssets(),await cleanupOrphanPhotos(),updateProgressBar(10),updateProgressText("Memuat data foto...");const t=await getAllPhotos(),a=t.length;updateProgressStep("load_data","completed"),updateProgressBar(15),updateProgressStep("prepare_photos","active"),updateProgressText("Menyiapkan foto untuk export...");const n=new JSZip,s=n.folder("photos"),i=new Set,o=[];let r=0,l=0;const d=assets.filter(e=>t.filter(t=>t.assetId===e.id).length>0).length;let c=0;updateProgressBar(20),updateProgressText(`Mengekspor foto (0/${a})...`);for(const e of assets){const n=t.filter(t=>t.assetId===e.id);if(!n.length)continue;c++;let u=(e.nama_asset||"tanpa_nama").replace(/[\\/:*?"<>|]/g,"").trim();i.has(u.toLowerCase())&&(u+="_"+e.id.substring(0,6),o.push(`Konflik nama: ${e.nama_asset}`)),i.add(u.toLowerCase());for(let t=0;t<n.length;t++){const i=n[t];let o=null,d="jpg";try{l++;if(updateProgressBar(20+l/a*30),updateProgressText(`Mengekspor foto ${l}/${a}: ${e.nama_asset.substring(0,20)}...`),i.image&&i.image.startsWith("data:image")){const e=i.image.split(",")[1],t=atob(e),a=t.length,n=new Uint8Array(a);for(let e=0;e<a;e++)n[e]=t.charCodeAt(e);o=n,i.image.includes("png")&&(d="png"),i.image.includes("webp")&&(d="webp"),i.image.includes("gif")&&(d="gif")}else if(i.cloudinary?.secure_url){const e=await fetch(i.cloudinary.secure_url);if(!e.ok)throw new Error("Download Cloudinary gagal");const t=await e.blob();o=await t.arrayBuffer(),d=t.type.split("/")[1]||"jpg"}if(!o)continue;let c=u;n.length>1&&(c+=`_${t+1}`),c+=`.${d}`,s.file(c,o),r++,l%10==0&&await new Promise(e=>setTimeout(e,0))}catch(e){console.warn("Gagal export foto:",e)}}updateProgressBar(20+c/d*30)}updateProgressStep("prepare_photos","completed"),updateProgressBar(50),o.length>0&&n.file("conflict_list.txt",o.join("\n")),updateProgressStep("create_excel","active"),updateProgressText("Membuat laporan Excel (1/3)..."),updateProgressBar(55);const u=assets.map(e=>{const t="non-asset"===e.jenis_item,a=e.kondisi_detail||{};return{"ID Asset":e.id,Jenis:t?"NON-ASSET":"ASSET",Nama:e.nama_asset,"Kode Material":e.material_kode,"No RS":e.no_rs||"","No PO":e.no_po||"","No Asset":"asset"===e.jenis_item?e.no_asset||"":"-",Lokasi:e.lokasi,"Kondisi (Asset)":t?"-":e.kondisi||"","Total Jumlah":t?e.total_jumlah||0:1,"Jumlah Baik":t?a.baik||0:"-","Jumlah Rusak":t?a.rusak||0:"-","Jumlah Mutasi":t?a.Mutasi||0:"-",Dibuat:e.created_at,"Dibuat Oleh":e.created_by?.nama||"","Update Terakhir":e.updated_at,"Update Oleh":e.updated_by?.nama||""}});updateProgressBar(60),updateProgressText("Membuat laporan Excel (2/3)...");const m=[];let p=0;assets.forEach(e=>{const t="non-asset"===e.jenis_item;(e.riwayat||[]).forEach(a=>{p++,p%100==0&&updateProgressText(`Memproses riwayat ${p}...`);let n="",s="",i="";if(t&&"object"==typeof a.old_jumlah){const e=a.old_jumlah||{},t=a.new_jumlah||{};n=`Baik:${e.baik||0}, Rusak:${e.rusak||0}, Mutasi:${e.Mutasi||0}`,s=`Baik:${t.baik||0}, Rusak:${t.rusak||0}, Mutasi:${t.Mutasi||0}`,i=e.baik!==t.baik||e.rusak!==t.rusak||e.Mutasi!==t.Mutasi?"MUTASI DISTRIBUSI":"TANPA PERUBAHAN STOK"}else i=a.old_kondisi!==a.new_kondisi?"PERUBAHAN KONDISI":a.old_lokasi!==a.new_lokasi?"PERPINDAHAN LOKASI":"UPDATE DATA";m.push({"ID Asset":e.id,"Nama Item":e.nama_asset,Jenis:t?"NON-ASSET":"ASSET",Tanggal:a.tanggal,"Tipe Perubahan":i,"Kondisi Lama":a.old_kondisi||"","Kondisi Baru":a.new_kondisi||"","Lokasi Lama":a.old_lokasi||"","Lokasi Baru":a.new_lokasi||"","Jumlah Lama":n,"Jumlah Baru":s,"Detail Perubahan":"",Catatan:a.catatan||"",User:a.user?.nama||""})})}),updateProgressBar(65),updateProgressText("Membuat laporan Excel (3/3)...");const g=t.map(e=>({"Asset ID":e.assetId,Tipe:e.type,Tanggal:e.tanggal,Sumber:e.cloudinary?"Cloudinary":"Local","Upload Status":e.uploadStatus||""})),f=[{"Tanggal Export":(new Date).toLocaleString(),"Total Asset":assets.length,"Total Foto":r,"Total Riwayat":m.length,"Konflik Nama":o.length}],h=XLSX.utils.book_new();XLSX.utils.book_append_sheet(h,XLSX.utils.json_to_sheet(u),"ASSETS"),XLSX.utils.book_append_sheet(h,XLSX.utils.json_to_sheet(m),"RIWAYAT"),XLSX.utils.book_append_sheet(h,XLSX.utils.json_to_sheet(g),"FOTO"),XLSX.utils.book_append_sheet(h,XLSX.utils.json_to_sheet(f),"RINGKASAN");const y=XLSX.write(h,{bookType:"xlsx",type:"array"});n.file("asset_laporan.xlsx",y),updateProgressStep("create_excel","completed"),updateProgressBar(75),updateProgressStep("create_zip","active"),updateProgressText("Membuat schema Excel..."),updateProgressBar(80);const v=XLSX.utils.book_new();XLSX.utils.book_append_sheet(v,XLSX.utils.json_to_sheet(assets),"assets_raw"),XLSX.utils.book_append_sheet(v,XLSX.utils.json_to_sheet(t),"photos_raw");const b=XLSX.write(v,{bookType:"xlsx",type:"array"});n.file("asset_schema.xlsx",b),updateProgressBar(85),updateProgressText("Menambahkan metadata...");const w={export_date:(new Date).toISOString(),total_assets:assets.length,total_photos:r,conflicts:o.length,version:APP_META?.VERSION||"unknown"};n.file("export_metadata.json",JSON.stringify(w,null,2)),updateProgressText("Mengompres file..."),updateProgressBar(90);const k=await n.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6},onUpdate:e=>{updateProgressBar(90+e.percent/100*10),updateProgressText(`Mengompres... ${Math.round(e.percent)}%`)}}),I=`asset_export_lengkap_${(new Date).toISOString().replace(/[:T]/g,"-").split(".")[0]}.zip`;saveAs(k,I),updateProgressStep("create_zip","completed"),updateProgressStep("finalize","active"),updateProgressBar(100),updateProgressText("Export selesai!"),setTimeout(()=>{hideProgressOverlay(),showAlert("addAssetAlert",`‚úÖ Export lengkap berhasil!\nüì¶ ${assets.length} item\nüì∏ ${r} foto\nüìä ${m.length} riwayat`,"success")},1e3)}catch(e){console.error("Export error:",e),showProgressError(`Gagal export: ${e.message}`),setTimeout(()=>{hideProgressOverlay(),showAlert("addAssetAlert",`‚ùå Gagal export: ${e.message}`,"danger")},2e3)}finally{e.disabled=!1,e.innerHTML=t}}async function resetAllData(){return new Promise(e=>{const t=document.createElement("div");t.innerHTML='\n            <div class="modal active" id="resetAllModal">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <div class="modal-title text-danger">RESET TOTAL (CLOUD + LOKAL)</div>\n                        <div class="close-modal" id="closeResetAllModal">&times;</div>\n                    </div>\n                    <div style="padding: 20px;">\n                        <div class="alert alert-danger">\n                            <i class="fas fa-radiation"></i>\n                            <strong>BAHAYA!</strong> Tindakan ini akan menghapus:\n                            <ul style="margin-left: 20px; margin-top: 10px;">\n                                <li><strong>SEMUA DATA DI FIRESTORE (CLOUD)</strong></li>\n                                <li>Semua data di database lokal (IndexedDB)</li>\n                                <li>Semua pengaturan dan riwayat</li>\n                            </ul>\n                            <p>Data foto di Cloudinary tidak akan dihapus otomatis, namun link referensinya akan hilang.</p>\n                            <p><strong>Tindakan ini tidak dapat dibatalkan!</strong></p>\n                        </div>\n                        <div class="form-group">\n                            <label>Ketik email login Anda untuk konfirmasi:</label>\n                            <input type="email" id="resetConfirmEmail" placeholder="email@contoh.com" class="form-control" style="width: 100%; padding: 10px; margin: 10px 0;">\n                        </div>\n                        <div id="resetEmailError" style="color: var(--danger); display: none; margin-bottom: 10px;">\n                            <i class="fas fa-exclamation-circle"></i> Email konfirmasi tidak cocok!\n                        </div>\n                        <div style="display: flex; gap: 10px;">\n                            <button class="btn btn-danger" id="confirmResetAll">\n                                <i class="fas fa-bomb"></i> HAPUS SEGALANYA\n                            </button>\n                            <button class="btn btn-outline" id="cancelResetAll">Batal</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(t);const a=()=>{document.getElementById("resetAllModal")?.remove(),e(!1)};setTimeout(()=>{const t=document.getElementById("confirmResetAll"),n=document.getElementById("resetConfirmEmail");document.getElementById("closeResetAllModal").onclick=a,document.getElementById("cancelResetAll").onclick=a,t.onclick=async()=>{const t=n.value.trim(),a=firebase.auth().currentUser?firebase.auth().currentUser.email:"";if(!a||t!==a)return document.getElementById("resetEmailError").style.display="block",void(n.style.borderColor="var(--danger)");document.getElementById("resetAllModal").remove(),showAlert("addAssetAlert","üîÑ Memulai proses reset total...","info");try{if(navigator.onLine&&isFirebaseConnected){const e=async()=>{const e=await db.collection("assets").get();if(!e.empty){const t=db.batch();e.docs.forEach(e=>t.delete(e.ref)),await t.commit()}};await Promise.race([e(),new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout hapus cloud")),15e3))]),showAlert("addAssetAlert","‚úÖ Data Cloud berhasil dihapus","success")}indexedDB.close(),await new Promise(e=>{const t=indexedDB.deleteDatabase("assetDB");t.onsuccess=()=>e(),t.onerror=()=>e(),t.onblocked=()=>e()}),localStorage.clear(),assets=[],pendingSyncAssets=[],showAlert("addAssetAlert","‚úÖ Reset Berhasil! Memuat ulang aplikasi...","success"),setTimeout(()=>location.reload(),2e3),e(!0)}catch(t){console.error("Reset Error:",t),showAlert("addAssetAlert",`‚ùå Gagal reset: ${t.message}`,"danger"),e(!1)}}},100)})}let loginAttempts=0,lastAttemptTime=0;const MAX_ATTEMPTS=5,LOCKOUT_TIME=9e5;async function verifyUserPassword(e){const t=Date.now();if(t-lastAttemptTime>9e5&&(loginAttempts=0),loginAttempts>=5){return{success:!1,message:`Terlalu banyak percobaan. Coba lagi dalam ${Math.ceil((9e5-(t-lastAttemptTime))/6e4)} menit.`}}lastAttemptTime=t,loginAttempts++;try{const t=firebase.auth().currentUser;if(!t)return{success:!1,message:"Anda tidak login"};const a=firebase.auth.EmailAuthProvider.credential(t.email,e);return await t.reauthenticateWithCredential(a),loginAttempts=0,{success:!0}}catch(e){console.error("Verifikasi gagal:",e);let t="Password salah";"auth/network-request-failed"===e.code&&(t="Masalah koneksi. Cek internet Anda.");const a=5-loginAttempts;return a>0&&(t+=` (Sisa ${a} percobaan)`),{success:!1,message:t}}}async function clearLocalData(){return new Promise(e=>{if(!currentUser)return showToastNotification("Anda harus login terlebih dahulu","danger"),void e(!1);const t=document.createElement("div");t.innerHTML='\n            <div class="modal active" id="clearLocalModal">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <div class="modal-title">Hapus Data Lokal</div>\n                        <div class="close-modal" id="closeClearLocalModal">&times;</div>\n                    </div>\n                    <div id="clearLocalModalContent" style="padding: 20px;">\n                        <div class="alert alert-warning">\n                            <i class="fas fa-exclamation-triangle"></i>\n                            <strong>PERINGATAN!</strong> Tindakan ini akan menghapus:\n                            <ul style="margin-left: 20px; margin-top: 10px;">\n                                <li>Semua data item dari IndexedDB</li>\n                                <li>Semua foto dari database lokal</li>\n                                <li>Semua riwayat backup</li>\n                                <li>Semua pengaturan lokal</li>\n                            </ul>\n                            <p style="margin-top: 10px;">Data di Firebase dan Cloudinary TIDAK akan terpengaruh.</p>\n                            <p><strong>‚ö†Ô∏è SETELAH INI, APLIKASI AKAN MENGAMBIL ULANG DATA DARI CLOUD</strong></p>\n                            <p><strong>Tindakan ini tidak dapat dibatalkan!</strong></p>\n                        </div>\n                        <div class="form-group">\n                            <label for="clearLocalPassword">Masukkan PASSWORD Anda untuk konfirmasi:</label>\n                            <input type="password" id="clearLocalPassword" placeholder="Password Firebase Anda" class="form-control" style="width: 100%; padding: 10px; margin: 10px 0;">\n                        </div>\n                        <div id="clearLocalError" style="color: var(--danger); display: none; margin-bottom: 10px;">\n                            <i class="fas fa-exclamation-circle"></i> Password salah!\n                        </div>\n                        <div id="clearLocalLoading" style="display: none; margin-bottom: 10px; text-align: center;">\n                            <div class="loading"></div> Memverifikasi...\n                        </div>\n                        <div class="form-group" style="display: flex; gap: 10px;">\n                            <button class="btn btn-danger" id="confirmClearLocal">\n                                <i class="fas fa-trash"></i> HAPUS DATA LOKAL\n                            </button>\n                            <button class="btn btn-outline" id="cancelClearLocal">\n                                <i class="fas fa-times"></i> Batal\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(t);const a=()=>{const t=document.getElementById("clearLocalModal");t&&t.remove(),e(!1)};setTimeout(()=>{const t=document.getElementById("closeClearLocalModal"),n=document.getElementById("cancelClearLocal"),s=document.getElementById("confirmClearLocal"),i=document.getElementById("clearLocalPassword"),o=document.getElementById("clearLocalError"),r=document.getElementById("clearLocalLoading");t&&t.addEventListener("click",a),n&&n.addEventListener("click",a),s&&i&&s.addEventListener("click",async()=>{const t=i.value.trim();if(!t)return o.textContent="Password tidak boleh kosong",o.style.display="block",i.style.borderColor="var(--danger)",void i.focus();s.disabled=!0,r.style.display="block",o.style.display="none";const a=await verifyUserPassword(t);if(!a.success)return o.textContent=a.message,o.style.display="block",i.style.borderColor="var(--danger)",i.focus(),s.disabled=!1,void(r.style.display="none");const n=document.getElementById("clearLocalModal");n&&n.remove(),showAlert("addAssetAlert","üîÑ Menghapus data lokal...","info");try{const t=[...assets];let a=[];try{a=await getAllPhotos()}catch(e){console.warn("Could not backup photos:",e)}const n=["assets","photos","backups","settings","syncQueue","user_activities","sync_metadata"];for(const e of n)try{await new Promise(t=>{const a=indexedDBInstance.transaction([e],"readwrite").objectStore(e).clear();a.onsuccess=function(){t()},a.onerror=function(a){console.error(`‚ùå Error clearing ${e}:`,a.target.error),t()}})}catch(t){console.error(`‚ùå Error with ${e}:`,t)}if("function"==typeof saveLastPullTimestamp&&await saveLastPullTimestamp(0),localStorage.removeItem("theme"),localStorage.removeItem("lastPullTimestamp"),assets=[],pendingSyncAssets=[],"function"==typeof updateAssetSelects&&updateAssetSelects(),"function"==typeof displayAssets&&displayAssets(),"function"==typeof updateDashboard&&updateDashboard(),"function"==typeof loadBackupHistory&&loadBackupHistory(),showAlert("addAssetAlert","‚úÖ Data lokal berhasil dihapus! Mengambil data dari cloud...","success"),navigator.onLine&&isFirebaseConnected&&"function"==typeof firstTimeSyncFromCloud){showAlert("addAssetAlert","üîÑ Mengambil data dari cloud...","info");try{const e=await firstTimeSyncFromCloud();e&&e.length>0?(assets=e,showAlert("addAssetAlert",`‚úÖ Berhasil mengambil ${e.length} asset dari cloud!`,"success"),"function"==typeof updateAssetSelects&&updateAssetSelects(),"function"==typeof displayAssets&&displayAssets(),"function"==typeof updateDashboard&&updateDashboard()):showAlert("addAssetAlert","‚ÑπÔ∏è Tidak ada data di cloud. Mulai dengan menambah item baru.","info")}catch(e){console.error("‚ùå Gagal sync dari cloud:",e),showAlert("addAssetAlert","‚ö†Ô∏è Gagal sync dari cloud. Memulihkan data lama...","warning");for(const e of t)"function"==typeof saveAssetToIndexedDB&&await saveAssetToIndexedDB(e,e.syncStatus||"pending");for(const e of a)try{await new Promise(t=>{const a=indexedDBInstance.transaction(["photos"],"readwrite");a.objectStore("photos").add(e),a.oncomplete=t})}catch(e){console.warn("Error restoring photo:",e)}"function"==typeof loadAssetsFromIndexedDB&&(assets=await loadAssetsFromIndexedDB()),"function"==typeof updateAssetSelects&&updateAssetSelects(),"function"==typeof displayAssets&&displayAssets(),"function"==typeof updateDashboard&&updateDashboard(),showAlert("addAssetAlert","‚úÖ Data lokal dipulihkan. Silakan coba sync manual nanti.","warning")}}else showAlert("addAssetAlert","‚ö†Ô∏è Anda offline. Data lokal kosong. Online kan untuk mengambil data dari cloud.","warning");e(!0)}catch(t){console.error("‚ùå Error clearing local data:",t),showAlert("addAssetAlert",`‚ùå Error menghapus data: ${t.message}`,"danger"),e(!1)}});const l=document.getElementById("clearLocalModal");l&&l.addEventListener("click",e=>{e.target===l&&a()}),i&&(i.addEventListener("keypress",e=>{"Enter"===e.key&&document.getElementById("confirmClearLocal")?.click()}),i.focus())},100)})}function updateConnectionStatus(e){isFirebaseConnected=e;const t=navigator.onLine,a=document.getElementById("firebaseStatus"),n=document.getElementById("syncStatus"),s=document.getElementById("cloudinaryStatus"),i=document.getElementById("offlineWarning");if(i&&i.remove(),t)e?(a.innerHTML='<i class="fas fa-cloud"></i> <span>Firebase: Terhubung</span>',a.className="status-badge status-online",n.innerHTML='<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Aktif</span>',n.className="status-badge status-online"):(a.innerHTML='<i class="fas fa-cloud"></i> <span>Firebase: Error Koneksi</span>',a.className="status-badge status-warning",n.innerHTML='<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Error</span>',n.className="status-badge status-warning"),s.innerHTML='<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Siap</span>',s.className="status-badge status-online";else{a.innerHTML='<i class="fas fa-cloud"></i> <span>Firebase: Offline</span>',a.className="status-badge status-offline",n.innerHTML='<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Diblokir</span>',n.className="status-badge status-offline",s.innerHTML='<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Diblokir</span>',s.className="status-badge status-offline";const e=document.querySelector(".nav-tab.active");if(e&&"dashboard"===e.getAttribute("data-tab")){const e=document.querySelector(".dashboard-grid");if(e){const t=document.createElement("div");t.id="offlineWarning",t.className="alert alert-danger",t.style.marginBottom="20px",t.innerHTML='\n                    <i class="fas fa-exclamation-triangle"></i> \n                    <strong>MODE OFFLINE</strong> - Fitur yang membutuhkan internet diblokir.\n                ',e.parentNode.insertBefore(t,e)}}}}function showProgressOverlay(e,t={}){currentProgressType=e;const a=document.getElementById("progressOverlay"),n=document.getElementById("progressTitle"),s=document.getElementById("progressSubtitle"),i=document.getElementById("progressSteps"),o=document.getElementById("progressError"),r=document.getElementById("btnCancelProgress"),l=document.getElementById("btnCloseProgress"),d=document.getElementById("progressFill"),c=document.getElementById("progressText");d.style.width="0%",c.textContent="0%",n.textContent=t.title||"Memproses...",s.textContent=t.subtitle||"Mohon tunggu...",o.style.display="none",o.innerHTML="",progressSteps="save"===e?[{id:"validate",title:"Validasi Data",desc:"Memvalidasi input form"},{id:"prepare",title:"Mempersiapkan Data",desc:"Mempersiapkan data untuk disimpan"},{id:"create_items",title:"Membuat Item",desc:"Membuat data item"},{id:"save_photos",title:"Menyimpan Foto",desc:"Mengolah dan menyimpan foto"},{id:"save_items",title:"Menyimpan ke Database",desc:"Menyimpan data ke penyimpanan lokal"},{id:"finalize",title:"Finalisasi",desc:"Menyelesaikan proses"}]:"update"===e?[{id:"validate",title:"Validasi Data",desc:"Memvalidasi input update"},{id:"prepare",title:"Mempersiapkan Update",desc:"Mempersiapkan data update"},{id:"process_photo",title:"Mengolah Foto",desc:"Mengolah foto baru (jika ada)"},{id:"save_update",title:"Menyimpan Update",desc:"Menyimpan perubahan ke database"},{id:"sync",title:"Sinkronisasi",desc:"Menyinkronkan dengan cloud"},{id:"finalize",title:"Finalisasi",desc:"Menyelesaikan proses"}]:"backup"===e?[{id:"load_data",title:"Memuat Data",desc:"Mengambil data dari database"},{id:"process_photos",title:"Memproses Foto",desc:"Mengkompres dan menyiapkan foto"},{id:"create_zip",title:"Membuat ZIP",desc:"Mengompres file"},{id:"save_backup",title:"Menyimpan Backup",desc:"Menyimpan file ke history"},{id:"finalize",title:"Finalisasi",desc:"Menyelesaikan proses"}]:"import"===e?[{id:"read_zip",title:"Membaca ZIP",desc:"Menganalisis file backup"},{id:"import_assets",title:"Import Asset",desc:"Memulihkan data asset"},{id:"import_photos",title:"Import Foto",desc:"Memulihkan file foto"},{id:"reload_data",title:"Memuat Ulang",desc:"Memperbarui tampilan"},{id:"finalize",title:"Finalisasi",desc:"Menyelesaikan proses"}]:"export"===e?[{id:"load_data",title:"Memuat Data",desc:"Mengambil data dari database"},{id:"prepare_photos",title:"Menyiapkan Foto",desc:"Mengolah foto untuk export"},{id:"create_excel",title:"Membuat Excel",desc:"Menyusun laporan Excel"},{id:"create_zip",title:"Membuat ZIP",desc:"Mengompres semua file"},{id:"finalize",title:"Finalisasi",desc:"Menyelesaikan proses"}]:"first_sync"===e?[{id:"fetch_assets",title:"Mengunduh Asset",desc:"Mengambil data asset dari cloud"},{id:"save_assets",title:"Menyimpan Asset",desc:"Menyimpan asset ke database lokal"},{id:"process_photos",title:"Memproses Foto",desc:"Mengekstrak dan menyimpan foto"},{id:"update_metadata",title:"Update Metadata",desc:"Memperbarui informasi sinkronisasi"},{id:"finalize",title:"Finalisasi",desc:"Menyelesaikan sinkronisasi awal"}]:[{id:"start",title:"Memulai",desc:"Memulai proses..."},{id:"process",title:"Memproses",desc:"Sedang memproses..."},{id:"finish",title:"Menyelesaikan",desc:"Menyelesaikan proses..."}],i.innerHTML=progressSteps.map((e,t)=>`\n        <div class="progress-step pending" id="step-${e.id}">\n            <div class="step-icon pending">${t+1}</div>\n            <div class="step-info">\n                <div class="step-title">${e.title}</div>\n                <div class="step-description">${e.desc}</div>\n            </div>\n        </div>\n    `).join(""),r.style.display="save"===e||"update"===e?"inline-flex":"none",l.style.display="none",a.classList.add("active"),document.body.style.overflow="hidden"}function updateProgressStep(e,t){const a=document.getElementById(`step-${e}`);if(!a)return void console.warn(`Step element not found: ${e}`);a.classList.remove("pending","active","completed"),a.classList.add(t);const n=a.querySelector(".step-icon");n&&(n.classList.remove("pending","active","completed"),n.classList.add(t));const s=progressSteps.findIndex(t=>t.id===e);if(s>=0&&("completed"===t||"active"===t))for(let e=0;e<s;e++){const t=progressSteps[e].id,a=document.getElementById(`step-${t}`);if(a&&!a.classList.contains("completed")){a.classList.remove("pending","active"),a.classList.add("completed");const e=a.querySelector(".step-icon");e&&(e.classList.remove("pending","active"),e.classList.add("completed"))}}}function updateProgressBar(e){const t=document.getElementById("progressFill"),a=document.getElementById("progressText");if(!t||!a)return void console.warn("Progress elements not found");const n=Math.min(100,Math.max(0,e));t.style.width=`${n}%`,a.textContent=`${Math.round(n)}%`}function updateProgressText(e){const t=document.getElementById("progressSubtitle");t&&(t.textContent=e)}function showProgressError(e){const t=document.getElementById("progressError"),a=document.getElementById("btnCancelProgress"),n=document.getElementById("btnCloseProgress");t&&(t.innerHTML=`<i class="fas fa-exclamation-circle"></i> ${e}`,t.style.display="block"),a&&(a.style.display="none"),n&&(n.style.display="inline-flex"),console.error(`üìä Progress error: ${e}`)}function hideProgressOverlay(){const e=document.getElementById("progressOverlay");e&&e.classList.remove("active"),document.body.style.overflow="",currentProgressType="",progressSteps=[],progressInterval&&(clearInterval(progressInterval),progressInterval=null)}function openWaReportModal(){document.getElementById("waReportModal").classList.add("active")}function closeWaModal(){document.getElementById("waReportModal").classList.remove("active")}function generateWaReport(e){let t="";const a=new Date,n=a.toLocaleDateString("id-ID"),s=a.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}),i=assets.filter(e=>"asset"===e.jenis_item),o=assets.filter(e=>"non-asset"===e.jenis_item);t+="*LAPORAN ASSET CONTROL*\n",t+=`Tanggal Laporan : ${n} ${s}\n\n`,t+=`Total Semua Item : ${assets.length}\n`,t+=`Total Asset      : ${i.length}\n`,t+=`Total Non-Asset  : ${o.length}\n\n`,t+="simple"===e?generateSimple(i,o):generateFull(i,o),currentWaMessage=t,document.getElementById("waPreview").value=t,checkWaLength(t)}function generateSimple(e,t){let a="";return a+="‚îÅ‚îÅ‚îÅ ASSET ‚îÅ‚îÅ‚îÅ\n\n",e.forEach((e,t)=>{a+=`${t+1}.\n`,a+=`Nama     : *${e.nama_asset}*\n`,a+=`Kode     : ${e.material_kode}\n`,a+=`No RS    : ${e.no_rs}\n`,a+=`No PO    : ${e.no_po||"-"}\n`,a+=`No Asset : ${e.no_asset||"-"}\n`,a+=`Lokasi   : ${e.lokasi}\n`,a+=`Kondisi  : ${e.kondisi}\n`,a+=`Jumlah   : ${e.total_jumlah}\n\n`}),a+="‚îÅ‚îÅ‚îÅ NON-ASSET ‚îÅ‚îÅ‚îÅ\n\n",t.forEach((e,t)=>{a+=`${t+1}.\n`,a+=`Nama    : *${e.nama_asset}*\n`,a+=`Kode    : ${e.material_kode}\n`,a+=`No RS   : ${e.no_rs}\n`,a+=`No PO   : ${e.no_po||"-"}\n`,a+=`Lokasi  : ${e.lokasi}\n\n`,a+="Kondisi :\n";const n=e.kondisi_detail||{};n.baik>0&&(a+=`Baik (${n.baik})\n`),n.rusak>0&&(a+=`Rusak (${n.rusak})\n`),n.Mutasi>0&&(a+=`Mutasi (${n.Mutasi})\n`),a+=`\nTotal   : ${e.total_jumlah}\n\n`}),a}function generateFull(e,t){let a="";return a+="‚îÅ‚îÅ‚îÅ ASSET ‚îÅ‚îÅ‚îÅ\n\n",e.forEach(e=>{a+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n",a+=`Nama            : *${e.nama_asset}*\n`,a+=`Kode Material   : ${e.material_kode}\n`,a+=`No RS           : ${e.no_rs}\n`,a+=`No PO           : ${e.no_po||"-"}\n`,a+=`No Asset        : ${e.no_asset||"-"}\n`,a+=`Lokasi          : ${e.lokasi}\n`,a+=`Kondisi Saat Ini: ${e.kondisi}\n`,a+=`Jumlah          : ${e.total_jumlah}\n\n`,e.riwayat&&e.riwayat.length>0&&(a+="Perubahan Kondisi:\n\n",e.riwayat.forEach((e,t)=>{"create"!==e.tipe&&(a+=`${t+1}. ${new Date(e.tanggal).toLocaleDateString()}\n`,e.old_kondisi&&e.new_kondisi&&(a+=`   Dari        : ${e.old_kondisi}\n`,a+=`   Menjadi     : ${e.new_kondisi}\n`),e.old_kondisi_detail&&e.new_kondisi_detail&&(a+="   Perubahan Detail\n"),a+=`   Catatan     : ${e.catatan||"-"}\n`,a+=`   Diubah oleh : ${e.user?.nama||"-"}\n\n`)})),a+="\n"}),a+="\n‚îÅ‚îÅ‚îÅ NON-ASSET ‚îÅ‚îÅ‚îÅ\n\n",t.forEach(e=>{a+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n",a+=`Nama          : *${e.nama_asset}*\n`,a+=`Kode Material : ${e.material_kode}\n`,a+=`No RS         : ${e.no_rs}\n`,a+=`No PO         : ${e.no_po||"-"}\n`,a+=`Lokasi        : ${e.lokasi}\n\n`;const t=e.kondisi_detail||{};a+="Ringkasan Kondisi:\n",a+=`Baik   : ${t.baik||0}\n`,a+=`Rusak  : ${t.rusak||0}\n`,a+=`Mutasi : ${t.Mutasi||0}\n`,a+=`Total  : ${e.total_jumlah}\n\n`}),a}function checkWaLength(e){const t=document.getElementById("waWarning"),a=document.getElementById("btnSendWA");e.length>3800?(a.style.display="none",t.innerText="Pesan terlalu panjang untuk WhatsApp."):(a.style.display="inline-block",t.innerText="")}function sendToWhatsApp(){const e=encodeURIComponent(currentWaMessage);window.location.href=`https://wa.me/?text=${e}`}function copyReport(){navigator.clipboard.writeText(currentWaMessage),alert("Laporan berhasil disalin.")}function switchTab(e){document.querySelectorAll(".nav-tab").forEach(t=>{t.classList.remove("active"),t.getAttribute("data-tab")===e&&t.classList.add("active")}),document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active"),t.id===`${e}-tab`&&t.classList.add("active")}),"dashboard"===e?updateDashboard():"daftar"===e?displayAssets():"galeri"===e&&loadGallery()}function setupEventListeners(){if(window._eventListenersSetup)return;document.getElementById("themeToggle").addEventListener("click",toggleTheme),document.querySelectorAll(".nav-tab").forEach(e=>{e.addEventListener("click",function(){switchTab(this.getAttribute("data-tab"))})}),document.getElementById("clearLocalData")?.addEventListener("click",function(){clearLocalData()}),document.getElementById("resetAllData")?.addEventListener("click",function(){if(!currentUser||"owner"!==currentUser.role)return void showAlert("addAssetAlert","‚ùå Hanya owner yang dapat reset semua data","danger");"assetmanagement"===document.getElementById("resetPassword").value?document.getElementById("resetModal").classList.add("active"):showAlert("addAssetAlert","Sandi salah!","danger")}),document.getElementById("testCloudinary").addEventListener("click",async function(){if(!requireInternet("Test koneksi Cloudinary"))return;if(!isCloudinaryEnabled)return void showAlert("addAssetAlert","Aktifkan Cloudinary terlebih dahulu","warning");const e=this,t=e.innerHTML;e.innerHTML='<div class="loading"></div> Testing...',e.disabled=!0;try{const a=document.createElement("canvas");a.width=100,a.height=100;const n=a.getContext("2d");n.fillStyle="#3b82f6",n.fillRect(0,0,100,100),n.fillStyle="#ffffff",n.font="16px Arial",n.textAlign="center",n.fillText("TEST",50,50),a.toBlob(async function(a){try{const n=new File([a],"test_connection.png",{type:"image/png"});await uploadToCloudinary(n,"test_connection","test"),showAlert("addAssetAlert","‚úÖ Koneksi Cloudinary berhasil!","success"),e.innerHTML=t,e.disabled=!1}catch(a){console.error("Cloudinary test upload error:",a),showAlert("addAssetAlert",`‚ùå Koneksi gagal: ${a.message}`,"danger"),e.innerHTML=t,e.disabled=!1}},"image/png")}catch(a){console.error("Cloudinary test error:",a),showAlert("addAssetAlert",`‚ùå Error: ${a.message}`,"danger"),e.innerHTML=t,e.disabled=!1}}),document.getElementById("btnPreview").addEventListener("click",showDataPreview),document.getElementById("confirmSave").addEventListener("click",async function(){const e=this,t=e.innerHTML;e.innerHTML='<div class="loading"></div> Menyimpan...',e.disabled=!0,await saveItemData(),e.innerHTML=t,e.disabled=!1}),document.getElementById("cancelSave").addEventListener("click",function(){document.getElementById("previewModal").classList.remove("active")}),document.getElementById("closePreviewModal").addEventListener("click",function(){document.getElementById("previewModal").classList.remove("active")}),document.getElementById("addAssetForm").addEventListener("submit",async function(e){e.preventDefault(),showDataPreview()}),document.getElementById("btnExportAllData").addEventListener("click",exportAllData),document.getElementById("btnBackup").addEventListener("click",async function(){await createBackup()}),document.getElementById("btnExportTemplate")?.addEventListener("click",function(){exportExcelTemplate()}),document.getElementById("importDropzone").addEventListener("click",function(){document.getElementById("importFile").click()}),document.getElementById("importFile").addEventListener("change",function(e){if(e.target.files.length>0){if(selectedImportFile=e.target.files[0],selectedImportFile.name.endsWith(".zip"))selectedImportType="zip";else{if(!selectedImportFile.name.endsWith(".xlsx"))return showAlert("importAlert","‚ùå File harus berupa ZIP atau Excel","danger"),selectedImportFile=null,void(this.value="");selectedImportType="excel"}const t=`\n                <div class="alert alert-info">\n                    <i class="fas fa-file-${"zip"===selectedImportType?"archive":"excel"}"></i>\n                    <strong>File dipilih:</strong> ${selectedImportFile.name}<br>\n                    <strong>Tipe:</strong> ${"zip"===selectedImportType?"ZIP (Full Data + Foto)":"Excel (Data Massal)"}<br>\n                    <strong>Ukuran:</strong> ${(selectedImportFile.size/1024/1024).toFixed(2)} MB<br>\n                    <em>Klik "Preview & Import Data" untuk mulai</em>\n                </div>\n            `;document.getElementById("importAlert").innerHTML=t,document.getElementById("importAlert").style.display="block",document.getElementById("btnImport").style.display="inline-flex"}}),document.getElementById("btnImport").addEventListener("click",async function(){if(!selectedImportFile)return void showAlert("importAlert","Pilih file terlebih dahulu","danger");if(!currentUser)return void showAlert("importAlert","Harus login terlebih dahulu","danger");const e=this,t=e.innerHTML;e.disabled=!0,e.innerHTML='<div class="loading"></div> Memproses...';try{"zip"===selectedImportType?await previewZipImport(selectedImportFile):await previewExcelImport(selectedImportFile)}catch(e){console.error("Import error:",e),showAlert("importAlert",`‚ùå Gagal: ${e.message}`,"danger")}finally{e.disabled=!1,e.innerHTML=t}}),document.getElementById("lokasi").addEventListener("change",function(){const e=document.getElementById("customLokasi");"other"===this.value?(e.style.display="block",e.required=!0):(e.style.display="none",e.required=!1)}),document.getElementById("newLokasi").addEventListener("change",function(){const e=document.getElementById("customLokasiUpdate");"other"===this.value?(e.style.display="block",e.required=!0):(e.style.display="none",e.required=!1)}),document.getElementById("assetSelect").addEventListener("change",function(){const e=this.value;e?loadAssetForUpdate(e):document.getElementById("assetInfo").style.display="none"}),document.getElementById("updateConditionForm").removeEventListener("submit",handleUpdate),document.getElementById("updateConditionForm").addEventListener("submit",handleUpdate),document.getElementById("galeriAssetSelect").addEventListener("change",function(){loadGallery(this.value)}),document.getElementById("filterPhotoSource").addEventListener("change",function(){loadGallery(document.getElementById("galeriAssetSelect").value)}),document.getElementById("searchAsset").addEventListener("input",function(){displayAssets()}),document.getElementById("filterJenis").addEventListener("change",function(){displayAssets()}),document.getElementById("filterKondisi").addEventListener("change",function(){displayAssets()}),document.getElementById("filterLokasi").addEventListener("change",function(){displayAssets()}),document.getElementById("filterFoto").addEventListener("change",function(){displayAssets()}),document.getElementById("btnSyncNow").addEventListener("click",runSyncNow),document.getElementById("confirmResetAll").addEventListener("click",resetAllData),document.getElementById("cancelReset").addEventListener("click",function(){document.getElementById("resetModal").classList.remove("active")}),document.getElementById("closeResetModal").addEventListener("click",function(){document.getElementById("resetModal").classList.remove("active")}),document.getElementById("autoSync").addEventListener("change",function(){saveSetting({key:"autoSync",value:this.checked})}),document.getElementById("syncInterval").addEventListener("change",function(){saveSetting({key:"syncInterval",value:this.value})}),document.getElementById("enableCompression").addEventListener("change",function(){saveSetting({key:"compression",value:this.checked})}),document.getElementById("closeAssetDetail").addEventListener("click",function(){document.getElementById("assetDetailModal").classList.remove("active")}),document.getElementById("closePhotoModal").addEventListener("click",function(){document.getElementById("photoModal").classList.remove("active")}),document.getElementById("closeCloudinaryModal").addEventListener("click",function(){document.getElementById("cloudinaryUploadModal").classList.remove("active")}),document.getElementById("btnOpenWaReport")?.addEventListener("click",function(){openWaReportModal()}),document.getElementById("jenis_item")?.addEventListener("change",function(){toggleJumlahField()}),document.getElementById("foto_utama")?.addEventListener("change",function(){previewPhotos(this)}),document.getElementById("closeWaModal")?.addEventListener("click",function(){closeWaModal()}),document.getElementById("btnWaSimple")?.addEventListener("click",function(){generateWaReport("simple")}),document.getElementById("btnWaFull")?.addEventListener("click",function(){generateWaReport("full")}),document.getElementById("btnSendWA")?.addEventListener("click",function(){sendToWhatsApp()}),document.getElementById("btnCopyReport")?.addEventListener("click",function(){copyReport()}),document.getElementById("closeZipPreview")?.addEventListener("click",function(){closeZipPreview()}),document.getElementById("btnConfirmZipImport")?.addEventListener("click",function(){confirmZipImport()}),document.getElementById("btnCancelZipPreview")?.addEventListener("click",function(){closeZipPreview()}),document.getElementById("closeImportPreviewBtn")?.addEventListener("click",function(){closeImportPreview()}),document.getElementById("btnSaveImportedData")?.addEventListener("click",function(){saveImportedData()}),document.getElementById("btnCancelImportPreview")?.addEventListener("click",function(){closeImportPreview()}),document.getElementById("btnRunFullCleanup")?.addEventListener("click",function(){runFullCleanup()}),window.addEventListener("click",function(e){"assetDetailModal"===e.target.id&&document.getElementById("assetDetailModal").classList.remove("active"),"photoModal"===e.target.id&&document.getElementById("photoModal").classList.remove("active"),"cloudinaryUploadModal"===e.target.id&&document.getElementById("cloudinaryUploadModal").classList.remove("active"),"resetModal"===e.target.id&&document.getElementById("resetModal").classList.remove("active"),"previewModal"===e.target.id&&document.getElementById("previewModal").classList.remove("active")});["btnSyncNow","btnBackup","btnExportAllData","btnImport","testCloudinary"].forEach(e=>{const t=document.getElementById(e);if(t){const e=t.onclick;t.addEventListener("click",function(t){if(!navigator.onLine)return t.preventDefault(),t.stopPropagation(),showToastNotification("‚ùå Fitur ini membutuhkan koneksi internet!","danger"),!1;e&&e.call(this,t)})}}),window.addEventListener("online",async()=>{showToastNotification("üì∂ Koneksi internet tersambung","success"),updateConnectionStatus(isFirebaseConnected),retryPendingThumbnails()}),window.addEventListener("offline",()=>{showToastNotification("üì¥ Mode offline - Fitur online diblokir","warning"),isFirebaseConnected=!1,updateConnectionStatus(!1),updateDashboard()}),window.addEventListener("beforeunload",function(e){if(_intervals.forEach(e=>clearInterval(e)),_intervals.length=0,currentUser){const t=assets.filter(e=>"pending"===e.syncStatus).length;if(t>0){const a=`Ada ${t} data belum sync. Yakin ingin keluar?`;return e.returnValue=a,a}}}),window._eventListenersSetup=!0}if(window.addEventListener("error",function(e){return console.error("üåê Global error caught:",e.error||e.message),e.preventDefault(),e.message?.includes("ResizeObserver")||showToastNotification("Terjadi kesalahan, tapi aplikasi tetap berjalan","warning"),!0}),window.addEventListener("unhandledrejection",function(e){return console.error("üíî Unhandled promise rejection:",e.reason),e.preventDefault(),e.reason?.message&&!e.reason.message.includes("offline")&&showToastNotification("Promise error caught","warning"),!0}),"undefined"!=typeof Android||window.navigator.userAgent.includes("WebIntoApp")||window.navigator.userAgent.includes("webintoapp")){window.__isWebIntoApp=!0;const e=window.fetch;window.fetch=function(...t){return!navigator.onLine&&t[0]&&"string"==typeof t[0]&&(t[0].includes("cloudinary")||t[0].includes("res.cloudinary"))?(console.warn("‚õî Blocked fetch to cloudinary while offline"),Promise.reject(new Error("Offline mode - fetch blocked"))):e.apply(this,t)};try{document.addEventListener("gesturestart",function(e){e.preventDefault()})}catch(e){}}async function initApp(){try{updateSplashStatus("Memulai aplikasi..."),initTheme(),updateSplashStatus("Menerapkan tema..."),updateSplashStatus("Inisialisasi database lokal...");try{indexedDBInstance=await initIndexedDB(),updateSplashStatus("Database lokal siap")}catch(e){console.error("‚ùå IndexedDB failed:",e),updateSplashStatus("Gagal inisialisasi database","Mode darurat aktif")}updateSplashStatus("Menyiapkan antarmuka..."),setupEventListeners(),setupAuthForms(),setupUserDropdown(),updateSplashStatus("Menyiapkan koneksi cloud...");try{await initFirebase()}catch(e){console.error("‚ùå Firebase init error:",e)}firebase.auth().onAuthStateChanged(async e=>{e?(handleUserSignedIn(e).catch(console.error),window._backgroundInitialized||(window._backgroundInitialized=!0,setTimeout(()=>{initBackground(),startBackgroundScheduler()},1e3))):(hideSplashScreen(),showLoginOverlay())})}catch(e){console.error("‚ùå Fatal error initializing app:",e),updateSplashStatus("Error","Memuat ulang..."),setTimeout(()=>{hideSplashScreen(),showLoginOverlay()},2e3)}}document.addEventListener("DOMContentLoaded",function(){showSplashScreen(),setTimeout(()=>{initApp()},2e3),setTimeout(()=>{const e=document.querySelector('.nav-tab[data-tab="settings"]');e&&e.addEventListener("click",async function(){setTimeout(async()=>{await updateStorageInfo(),updateSettingsUserInfo(),updateSettingsSyncInfo()},300)})},2e3)});