<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" 
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asset Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase versi lengkap (bukan modular) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        /* VARIABEL TEMA */
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --secondary: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #9ca3af;
            --gray-light: #e5e7eb;
            --white: #ffffff;
            --card-bg: #ffffff;
            --body-bg: #f3f4f6;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --header-gradient: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
             --header-bg: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        /* TEMA GELAP */
        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-light: #60a5fa;
            --secondary: #9ca3af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #f9fafb;
            --light: #1f2937;
            --gray: #6b7280;
            --gray-light: #374151;
            --white: #111827;
            --card-bg: #1f2937;
            --body-bg: #111827;
            --text-color: #f9fafb;
            --border-color: #374151;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --header-gradient: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
        }

        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

    .header {
        position: relative;
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        overflow: hidden;
    }
    
    /* OVERLAY LEBIH RINGAN AGAR GAMBAR LEBIH JELAS */
    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.6) 0%, rgba(30, 64, 175, 0.6) 100%);
        border-radius: 10px;
        z-index: 1;
    }
    
    .header > * {
        position: relative;
        z-index: 2;
    }
    
    /* Hapus background dari CSS */
    .header[data-bg-ready="true"] {
        background: none;
    }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-info {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* STATUS BADGES */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .status-badge i {
            font-size: 12px;
        }

        .status-online { background-color: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-offline { background-color: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .status-warning { background-color: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-info { background-color: rgba(59, 130, 246, 0.2); color: var(--primary-light); }

        /* THEME TOGGLE */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(15deg);
        }

        /* NAVIGATION */
        .nav-tabs {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 16px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 3px solid transparent;
            background-color: var(--card-bg);
        }

        .nav-tab:hover {
            background-color: var(--light);
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .dashboard-card h3 {
            font-size: 16px;
            color: var(--secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dashboard-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .dashboard-card .subtext {
            font-size: 14px;
            color: var(--secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: var(--light);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--secondary);
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* CHARTS */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .chart-card h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--white);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* BUTTONS */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e48a0a;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* ASSET CARDS */
        .asset-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .asset-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-color);
        }

        .asset-subtitle {
            color: var(--secondary);
            font-size: 14px;
            margin-top: 5px;
        }
        /* ========== ASSET THUMBNAIL STYLES ========== */
.asset-thumbnail-container {
    display: flex;
    gap: 5px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.asset-thumb {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    object-fit: cover;
    border: 2px solid var(--border-color);
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.asset-thumb:hover {
    transform: scale(1.1);
    border-color: var(--primary);
    z-index: 10;
}

.asset-thumb-placeholder {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    background: var(--light);
    border: 2px dashed var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--secondary);
    font-size: 20px;
    cursor: pointer;
}

.asset-thumb-placeholder:hover {
    background: var(--gray-light);
    color: var(--primary);
}

.asset-thumb-more {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    background: var(--primary-light);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}

.asset-thumb-more:hover {
    background: var(--primary);
}

.asset-thumb-badge {
    position: relative;
}

.asset-thumb-badge .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 10px;
    padding: 2px 6px;
}
        /* BADGES */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-success {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .badge-danger {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .badge-info {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--primary-light);
        }
/* Tambahkan di bagian CSS */
@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

.sync-active {
    animation: pulse 1.5s infinite;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
}

#syncProgressIndicator {
    transition: all 0.3s ease;
    border: 1px solid rgba(255,255,255,0.2);
}

#syncProgressIndicator .loading {
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
}

.sync-complete {
    background: rgba(16, 185, 129, 0.3) !important;
    animation: none !important;
}

.sync-error {
    background: rgba(239, 68, 68, 0.3) !important;
    animation: none !important;
}
        .sync-badge {
            background-color: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
/* Tambahkan di CSS */
.status-badge-pending {
    background-color: rgba(245, 158, 11, 0.2);
    color: var(--warning);
}

/* Style untuk photo pending indicator */
.photo-pending-indicator {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(245, 158, 11, 0.9);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
}
        .cloudinary-badge {
            background-color: rgba(14, 165, 233, 0.15);
            color: var(--info);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* PHOTO PREVIEW */
        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-thumb:hover {
            transform: scale(1.05);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 10px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--secondary);
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* TIMELINE */
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 20px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--border-color);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary);
        }

        .timeline-date {
            font-size: 14px;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .timeline-content {
            background-color: var(--light);
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        /* GALLERY */
        /* ========== GALLERY CONDITION STYLES ========== */
.gallery-condition-baik { border-top: 4px solid #10b981; }
.gallery-condition-rusak { border-top: 4px solid #ef4444; }
.gallery-condition-mutasi { border-top: 4px solid #f59e0b; }
.gallery-condition-distribusi { border-top: 4px solid #3b82f6; }
.gallery-condition-unknown { border-top: 4px solid #9ca3af; }

.gallery-item {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
}

.gallery-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.gallery-item .badge {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.gallery-image {
    transition: transform 0.3s ease;
}

.gallery-item:hover .gallery-image {
    transform: scale(1.05);
}

/* Filter by condition (opsional) */
.gallery-filter-condition {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.condition-filter-btn {
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
}

.condition-filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.condition-filter-btn[data-condition="baik"]:hover { background: #10b98120; }
.condition-filter-btn[data-condition="rusak"]:hover { background: #ef444420; }
.condition-filter-btn[data-condition="Mutasi"]:hover { background: #f59e0b20; }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .gallery-item {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .gallery-item:hover {
            transform: translateY(-5px);
        }

        .gallery-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .gallery-info {
            padding: 15px;
            background-color: var(--card-bg);
        }

        .gallery-asset {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .gallery-date {
            font-size: 12px;
            color: var(--secondary);
        }

        /* ALERTS */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            border-left: 4px solid transparent;
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border-left-color: var(--success);
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border-left-color: var(--warning);
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-left-color: var(--danger);
        }

        .alert-info {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--primary-light);
            border-left-color: var(--primary-light);
        }

        /* FILE UPLOAD */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background-color: var(--white);
        }

        .file-upload:hover {
            border-color: var(--primary-light);
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--gray-light);
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* SETTINGS TAB */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .setting-card h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 18px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-color);
        }

        .setting-description {
            font-size: 12px;
            color: var(--secondary);
            margin-top: 5px;
        }

        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s ease;
        }

        /* TOAST NOTIFICATION */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 280px;
            max-width: 420px;
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.35);
            animation: slideIn .3s ease;
            background: #f1f5f9;
            color: #0f172a;
            border-left: 4px solid #3b82f6;
        }

        [data-theme="dark"] .toast-notification {
            background: #0f172a;
            color: #e5e7eb;
        }

        .toast-notification[data-type="success"] { border-left-color: #22c55e; }
        .toast-notification[data-type="warning"] { border-left-color: #f59e0b; }
        .toast-notification[data-type="danger"] { border-left-color: #ef4444; }

        .toast-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            opacity: .7;
        }
        .toast-close:hover { opacity: 1; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                min-width: 100%;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .asset-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .nav-tab {
                min-width: auto;
                white-space: nowrap;
            }
        }

        /* GLOBAL ALERT */
        #globalAlertContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: calc(100% - 40px);
            max-width: 520px;
            pointer-events: none;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        /* LOGIN & REGISTER STYLES */
.login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--header-gradient);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.login-container {
    background-color: var(--card-bg);
    border-radius: 15px;
    width: 100%;
    max-width: 450px;
    padding: 40px 35px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    animation: slideUp 0.5s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
}

.login-header {
    text-align: center;
    margin-bottom: 35px;
}

.login-header h1 {
    color: var(--primary);
    font-size: 32px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.login-header p {
    color: var(--secondary);
    font-size: 16px;
}

.login-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 30px;
}

.login-tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    font-weight: 600;
    color: var(--secondary);
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.login-tab:hover {
    color: var(--primary);
}

.login-tab.active {
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
}

.login-form {
    display: none;
}

.login-form.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

.login-input-group {
    margin-bottom: 20px;
    position: relative;
}

.login-input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-color);
    font-size: 14px;
}

.login-input-group input, 
.login-input-group select {
    width: 100%;
    padding: 14px 15px;
    background-color: var(--white);
    color: var(--text-color);
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.login-input-group input:focus, 
.login-input-group select:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
}

.login-input-group .input-with-icon {
    position: relative;
}

.login-input-group .input-with-icon i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary);
    font-size: 18px;
}

.login-input-group .input-with-icon input {
    padding-left: 50px;
}

.login-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    font-size: 14px;
}

.remember-me {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.remember-me input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.forgot-password {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
}

.forgot-password:hover {
    color: var(--primary-light);
    text-decoration: underline;
}

.login-btn {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
}

.login-btn:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
}

.login-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.login-divider {
    text-align: center;
    margin: 25px 0;
    position: relative;
    color: var(--secondary);
}

.login-divider::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    width: 45%;
    height: 1px;
    background: var(--border-color);
}

.login-divider::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    width: 45%;
    height: 1px;
    background: var(--border-color);
}

.switch-form {
    text-align: center;
    margin-top: 25px;
    color: var(--secondary);
}

.switch-form a {
    color: var(--primary);
    font-weight: 600;
    text-decoration: none;
    margin-left: 5px;
}

.switch-form a:hover {
    text-decoration: underline;
}

.login-error {
    background-color: rgba(239, 68, 68, 0.15);
    color: var(--danger);
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid var(--danger);
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 14px;
}

.login-error i {
    margin-top: 2px;
}

.login-success {
    background-color: rgba(16, 185, 129, 0.15);
    color: var(--success);
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid var(--success);
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 14px;
}

.login-success i {
    margin-top: 2px;
}

/* User Profile in Header */
.user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 15px;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.user-profile:hover {
    background: rgba(255, 255, 255, 0.2);
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 16px;
}

.user-info {
    color: white;
}

.user-name {
    font-weight: 600;
    font-size: 14px;
}

.user-role {
    font-size: 12px;
    opacity: 0.8;
}

/* User Dropdown Menu */
.user-dropdown {
    position: absolute;
    top: 70px;
    right: 20px;
    background: var(--card-bg);
    border-radius: 10px;
    min-width: 250px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    z-index: 1000;
    display: none;
    animation: fadeIn 0.3s ease;
}

.user-dropdown.active {
    display: block;
}

.dropdown-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.dropdown-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.dropdown-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 20px;
}

.dropdown-user-details h3 {
    font-size: 16px;
    margin-bottom: 5px;
    color: var(--text-color);
}

.dropdown-user-details p {
    font-size: 13px;
    color: var(--secondary);
    margin-bottom: 3px;
}

.dropdown-user-details .user-role-badge {
    display: inline-block;
    background: rgba(59, 130, 246, 0.15);
    color: var(--primary);
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-top: 5px;
}

.dropdown-menu {
    padding: 10px 0;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
}

.dropdown-item:hover {
    background-color: var(--light);
    color: var(--primary);
}

.dropdown-item i {
    width: 20px;
    text-align: center;
    font-size: 16px;
}

.dropdown-divider {
    height: 1px;
    background: var(--border-color);
    margin: 10px 0;
}

.dropdown-item.logout {
    color: var(--danger);
}

.dropdown-item.logout:hover {
    background-color: rgba(239, 68, 68, 0.1);
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: white;
    display: none;
}

.loading-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
}

.loading-overlay p {
    font-size: 18px;
    font-weight: 600;
    margin-top: 10px;
}

/* Responsive */
@media (max-width: 768px) {
    .login-container {
        padding: 30px 20px;
    }
    
    .user-profile {
        padding: 6px 12px;
    }
    
    .user-name {
        font-size: 12px;
    }
    
    .user-role {
        font-size: 10px;
    }
    
    .user-dropdown {
        right: 10px;
        left: 10px;
        min-width: auto;
    }
}
@media print {

    body * {
        visibility: hidden !important;
    }

    #assetDetailModal,
    #assetDetailModal * {
        visibility: visible !important;
    }

    #assetDetailModal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
    }

    @page {
        size: A4;
        margin: 10mm;
    }
}

/* Tambahkan di CSS */
.user-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary);
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.user-badge i {
    font-size: 10px;
}

.asset-meta {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    color: var(--secondary);
}

.meta-item i {
    color: var(--primary-light);
}

.timeline-item.user-action {
    border-left: 3px solid var(--primary);
}

.timeline-content strong {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
}

.user-avatar-small {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
}
/* Progress Overlay */
.progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: white;
    display: none;
}

.progress-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.progress-content {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.progress-header {
    margin-bottom: 20px;
}

.progress-header h3 {
    font-size: 24px;
    margin-bottom: 10px;
    color: var(--text-color);
}

.progress-header p {
    color: var(--secondary);
}

.progress-steps {
    text-align: left;
    margin: 20px 0;
}

.progress-step {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
    background: var(--light);
}

.progress-step.completed {
    background: rgba(16, 185, 129, 0.1);
    border-left: 4px solid var(--success);
}

.progress-step.active {
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid var(--primary);
}

.progress-step.pending {
    opacity: 0.6;
}

.step-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.step-icon.completed {
    background: var(--success);
    color: white;
}

.step-icon.active {
    background: var(--primary);
    color: white;
}

.step-icon.pending {
    background: var(--secondary);
    color: white;
}

.step-info {
    flex: 1;
}

.step-title {
    font-weight: 600;
    margin-bottom: 3px;
    color: var(--text-color);
}

.step-description {
    font-size: 12px;
    color: var(--secondary);
}

.progress-bar-container {
    margin: 20px 0;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.progress-text {
    font-size: 14px;
    color: var(--secondary);
    text-align: center;
}

.progress-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    justify-content: center;
}

.progress-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid var(--danger);
    text-align: left;
}

.progress-error i {
    margin-right: 10px;
}
/* Settings specific styles */
.setting-card .progress-bar {
    background: var(--border-color);
    border-radius: 5px;
    overflow: hidden;
    margin: 8px 0;
}

.setting-card .progress-bar-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s ease;
}

.owner-only {
    border-left: 4px solid var(--danger);
    background: rgba(239, 68, 68, 0.05);
}

.setting-description.warning {
    color: var(--danger);
    font-weight: 600;
}

#ownerSettings {
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
    margin-top: 15px;
}

#currentUserRole.owner {
    color: var(--danger);
    font-weight: 700;
}

#currentUserRole.user {
    color: var(--primary);
    font-weight: 600;
}
.import-invalid {
    background-color: rgba(255,0,0,0.08);
    border: 1px solid rgba(255,0,0,0.4);
}

.import-valid {
    border: 1px solid rgba(0,150,0,0.3);
}

.import-row {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
}

.import-row small {
    color: red;
}
/* Conflict Modal Styles */
.conflict-details {
    background: var(--light);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid var(--warning);
}

.conflict-version {
    display: flex;
    gap: 15px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.conflict-cloud, .conflict-local {
    flex: 1;
    min-width: 200px;
    padding: 15px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.conflict-cloud {
    border-left: 4px solid var(--info);
}

.conflict-local {
    border-left: 4px solid var(--secondary);
    opacity: 0.8;
}

.conflict-timestamp {
    font-size: 12px;
    color: var(--secondary);
    margin-top: 5px;
}

.conflict-user {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 5px 10px;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 20px;
    font-size: 13px;
}

.conflict-user i {
    color: var(--primary);
}

.conflict-actions {
    display: flex;
    gap: 10px;
    margin-top: 25px;
    flex-wrap: wrap;
}

.btn-conflict-refresh {
    flex: 2;
    background: var(--primary);
    color: white;
}

.btn-conflict-override {
    flex: 2;
    background: var(--warning);
    color: white;
}

.btn-conflict-cancel {
    flex: 1;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
}


/* Tambahkan di media query */
@media (max-width: 768px) {
    .header-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .app-info {
        flex-wrap: wrap;
    }
    
    .status-badge {
        font-size: 11px;
        padding: 3px 8px;
    }
    
    /* Prevent zoom on input focus */
    input, select, textarea {
        font-size: 16px !important;
    }
}
/* ========== ACTIVITY STYLES ========== */
.activity-item {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.activity-item:hover {
    transform: translateX(5px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

/* Warna untuk berbagai tipe aktivitas */
.activity-condition-baik { border-left-color: #10b981 !important; }
.activity-condition-rusak { border-left-color: #ef4444 !important; }
.activity-condition-mutasi { border-left-color: #f59e0b !important; }
.activity-lokasi { border-left-color: #3b82f6 !important; }
.activity-create { border-left-color: #8b5cf6 !important; }
.activity-update { border-left-color: #6b7280 !important; }

/* Badge untuk tipe aktivitas */
.activity-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.activity-badge-create { background: #8b5cf620; color: #8b5cf6; }
.activity-badge-update { background: #6b728020; color: #6b7280; }
.activity-badge-move { background: #3b82f620; color: #3b82f6; }
.activity-badge-condition { background: #f59e0b20; color: #f59e0b; }

/* Animasi untuk aktivitas baru */
@keyframes highlightNew {
    0% { background-color: rgba(16, 185, 129, 0.2); }
    100% { background-color: transparent; }
}

.activity-new {
    animation: highlightNew 2s ease;
}

/* Scrollbar untuk container aktivitas */
#recentActivity::-webkit-scrollbar {
    width: 6px;
}

#recentActivity::-webkit-scrollbar-track {
    background: var(--light);
    border-radius: 10px;
}

#recentActivity::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: 10px;
}
    </style>
</head>
<body>
 
    <!-- Splash Screen - TAMBAHKAN INI PALING ATAS -->
    <div id="splashScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); z-index: 10001; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; transition: opacity 0.5s;">
        <i class="fas fa-cubes" style="font-size: 80px; margin-bottom: 20px;"></i>
        <h2 style="margin-bottom: 10px; font-size: 28px;">Asset Management System</h2>
        <p style="font-size: 16px; opacity: 0.9;" id="splashStatus">Memulai aplikasi...</p>
        <div class="loading" style="width: 50px; height: 50px; margin-top: 30px; border-width: 4px;"></div>
        <p style="margin-top: 30px; font-size: 13px; opacity: 0.7;" id="splashDetail">Inisialisasi database lokal...</p>
    </div>

   
    <div class="container">
        <!-- HEADER -->
<div class="header">
    <!-- Baris 1: Judul dan Tombol Aksi -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <h1 style="display: flex; align-items: center; gap: 10px; margin: 0;">
            <i class="fas fa-cubes"></i> Asset Management System
        </h1>
        
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <!-- Sync Progress Indicator -->
            <div id="syncProgressIndicator" style="display: none; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); padding: 4px 12px; border-radius: 20px;">
                <div class="loading" style="width: 14px; height: 14px; border-width: 2px;"></div>
                <span id="syncProgressText" style="font-size: 13px;">Menyinkronkan</span>
                <span id="syncProgressPercent" style="font-size: 11px; opacity: 0.9;">0%</span>
            </div>
            
            <!-- User Profile -->
            <div class="user-profile" id="userProfile" style="display: none; padding: 4px 12px;">
                <div class="user-avatar" id="userAvatar" style="width: 28px; height: 28px; font-size: 14px;">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName" style="font-size: 13px;">User</div>
                    <div class="user-role" id="userRole" style="font-size: 11px;">Role</div>
                </div>
            </div>
            
            <!-- Sync Button -->
            <button class="btn btn-success btn-small" id="btnSyncNow" style="padding: 6px 12px; font-size: 13px;">
                <i class="fas fa-sync"></i> Sync
            </button>
            
            <!-- Theme Toggle -->
            <button class="theme-toggle" id="themeToggle" style="width: 34px; height: 34px;">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>
    
    <!-- Baris 2: Status Badges -->
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <div class="status-badge" id="firebaseStatus" style="font-size: 12px; padding: 4px 10px;">
            <i class="fas fa-cloud" style="font-size: 11px;"></i>
            <span>Firebase: Terhubung</span>
        </div>
        <div class="status-badge" id="indexeddbStatus" style="font-size: 12px; padding: 4px 10px;">
            <i class="fas fa-database" style="font-size: 11px;"></i>
            <span>DB Lokal: Siap</span>
        </div>
        <div class="status-badge" id="cloudinaryStatus" style="font-size: 12px; padding: 4px 10px;">
            <i class="fas fa-cloud-upload-alt" style="font-size: 11px;"></i>
            <span>Cloudinary: Siap</span>
        </div>
        <div class="status-badge" id="syncStatus" style="font-size: 12px; padding: 4px 10px;">
            <i class="fas fa-sync-alt" style="font-size: 11px;"></i>
            <span>Sync: Aktif</span>
        </div>
    </div>
</div>

        <div id="globalAlertContainer">
            <div id="addAssetAlert" class="alert" style="display: none;"></div>
        </div>

        <!-- NAVIGATION TABS -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-tab" data-tab="tambah">
                <i class="fas fa-plus-circle"></i> Tambah Item
            </div>
            <div class="nav-tab" data-tab="daftar">
                <i class="fas fa-list"></i> Daftar Item
            </div>
            <div class="nav-tab" data-tab="update">
                <i class="fas fa-edit"></i> Update Kondisi
            </div>
            <div class="nav-tab" data-tab="galeri">
                <i class="fas fa-images"></i> Galeri Foto
            </div>
            <div class="nav-tab" data-tab="backup">
                <i class="fas fa-download"></i> Backup & Export
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="fas fa-cog"></i> Pengaturan
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div class="tab-content active" id="dashboard-tab">
            <h2><i class="fas fa-chart-line"></i> Dashboard Analitik</h2>
            
            <!-- STATS GRID -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Total Item</h3>
                    <div class="value" id="totalAssets">0</div>
                    <div class="subtext">Jumlah semua item</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="assetCount">0</div>
                            <div class="stat-label">Asset</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="nonAssetCount">0</div>
                            <div class="stat-label">Non-Asset</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalJumlah">0</div>
                            <div class="stat-label">Total Unit</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3>Kondisi Item</h3>
                    <div class="value" id="baikCount">0</div>
                    <div class="subtext">Item dalam kondisi baik</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="rusakCount">0</div>
                            <div class="stat-label">Rusak</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="MutasiCount">0</div>
                            <div class="stat-label">Mutasi</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalPhotos">0</div>
                            <div class="stat-label">Total Foto</div>
                        </div>
                    </div>
                </div>
           <!-- Di dalam dashboard-card yang menampilkan sinkronisasi -->
<div class="dashboard-card">
    <h3>Sinkronisasi</h3>
    <div class="value" id="syncedAssets">0</div>
    <div class="subtext">Item tersinkronisasi</div>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value" id="pendingSync">0</div>
            <div class="stat-label">Asset Pending</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="pendingPhotosCount">0</div>  <!-- INI PENTING! -->
            <div class="stat-label">Foto Pending</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="storageUsed">0 MB</div>
            <div class="stat-label">Penyimpanan</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="lastSync">-</div>
            <div class="stat-label">Terakhir Sync</div>
        </div>
    </div>
</div>

                
                <div class="dashboard-card">
                    <h3>Lokasi Item</h3>
                    <div class="value" id="totalLokasi">0</div>
                    <div class="subtext">Jumlah lokasi berbeda</div>
                    <div id="lokasiStats" style="margin-top: 15px;">
                        <!-- Lokasi stats akan diisi JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- CHARTS -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Distribusi Jenis Item</h3>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>Distribusi Kondisi Item</h3>
                    <div class="chart-container">
                        <canvas id="conditionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- RECENT ACTIVITY -->
            <div class="chart-card">
                <h3>Aktivitas Terkini</h3>
                <div id="recentActivity">
                    <div class="empty-state" style="padding: 30px 20px;">
                        <i class="fas fa-history"></i>
                        <p>Belum ada aktivitas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB TAMBAH ITEM -->
        <div class="tab-content" id="tambah-tab">
            <h2><i class="fas fa-plus-circle"></i> Tambah Item Baru</h2>
         
            <form id="addAssetForm">
                <div class="form-row">
                    <div class="form-col">
                        <label for="jenis_item">Jenis Item *</label>
                        <select id="jenis_item" required onchange="toggleJumlahField()">
                            <option value="">Pilih Jenis Item</option>
                            <option value="asset">Asset</option>
                            <option value="non-asset">Non-Asset</option>
                        </select>
                    </div>
                    <div class="form-col" id="jumlahContainer" style="display: none;">
                        <label for="jumlah">Jumlah *</label>
                        <input type="number" id="jumlah" min="1" value="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label for="nama_asset">Nama Item *</label>
                        <input type="text" id="nama_asset" required placeholder="Nama asset/non-asset">
                    </div>
                    <div class="form-col">
                        <label for="material_kode">Kode Material *</label>
                        <input type="text" id="material_kode" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label for="no_rs">No. Reservation Slip (RS) *</label>
                        <input type="text" id="no_rs" required>
                    </div>
                    <div class="form-col">
                        <label for="no_po">No. Purchase Order / POA</label>
                        <input type="text" id="no_po" placeholder="PO atau POA (opsional)">
                    </div>
                </div>
                <div class="form-group" id="noAssetGroup">
    <label>No Asset (Opsional)</label>
    <input type="text" id="no_asset" placeholder="Nomor asset internal">
</div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="lokasi">Lokasi *</label>
                        <input list="lokasi-list" id="lokasi" name="lokasi" placeholder="Pilih atau ketik lokasi" required>
                        <datalist id="lokasi-list">
                            <option value="Main Workshops">
                            <option value="Gudang Office">
                            <option value="Workshops Tyre">
                            <option value="Workshops Track">
                            <option value="Workshops Welder">
                            <option value="Workshops Maintenance">
                            <option value="Workshops DT">
                            <option value="Workshops wheel">
                            <option value="Pit stop">
                            <option value="other">Lainnya (Ketik manual)...</option>
                        </datalist>
                        <input type="text" id="customLokasi" placeholder="Ketik lokasi baru" style="display: none; margin-top: 5px;">
                    </div>
                    <div class="form-col">
                        <label for="kondisi">Kondisi Awal *</label>
                        <select id="kondisi" required>
                            <option value="">Pilih Kondisi</option>
                            <option value="baik">Baik</option>
                            <option value="rusak">Rusak</option>
                            <option value="Mutasi">Mutasi</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label for="foto_utama">Foto Utama (Max 5MB) *</label>
                        <input type="file" id="foto_utama" accept="image/*" required multiple onchange="previewPhotos(this)">
                        <small>Foto item dalam kondisi saat ini (bisa multiple)</small>
                        <div id="photoPreview" class="photo-preview" style="margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="catatan_awal">Catatan Awal (Opsional)</label>
                    <textarea id="catatan_awal" rows="3" placeholder="Catatan tentang kondisi awal item..."></textarea>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-primary" id="btnPreview">
                        <i class="fas fa-eye"></i> Preview Data
                    </button>
                    <button type="submit" class="btn btn-success" id="btnTambahAsset">
                        <i class="fas fa-save"></i> Simpan Item
                    </button>
                    <button type="reset" class="btn btn-outline">
                        <i class="fas fa-redo"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>

        <!-- TAB DAFTAR ITEM -->
        <div class="tab-content" id="daftar-tab">
            <h2><i class="fas fa-list"></i> Daftar Item</h2><button class="btn btn-success btn-small"
    onclick="openWaReportModal()">
    <i class="fab fa-whatsapp"></i> Kirim WA
</button>

<div class="form-row">
    <div class="form-col">
        <input type="text" id="searchAsset" placeholder="Cari berdasarkan nama, kode, RS, atau lokasi...">
    </div>
    <div class="form-col">
        <select id="filterJenis">
            <option value="">Semua Jenis</option>
            <option value="asset">Asset</option>
            <option value="non-asset">Non-Asset</option>
        </select>
    </div>
    <div class="form-col">
        <select id="filterKondisi">
            <option value="">Semua Kondisi</option>
            <option value="baik">Baik</option>
            <option value="rusak">Rusak</option>
            <option value="Mutasi">Mutasi</option>
        </select>
    </div>
    <div class="form-col">
        <select id="filterLokasi">
            <option value="">Semua Lokasi</option>
            <option value="Main Workshops">Main Workshops</option>
            <option value="Gudang Office">Gudang Office</option>
            <option value="Workshops Tyre">Workshops Tyre</option>
            <option value="Workshops Track">Workshops Track</option>
            <option value="Workshops Welder">Workshops Welder</option>
            <option value="Workshops Maintenance">Workshops Maintenance</option>
            <option value="Workshops DT">Workshops DT</option>
            <option value="Workshops wheel">Workshops wheel</option>
            <option value="Pit stop">Pit stop</option>
        </select>
    </div>
</div>

<!-- Baris Filter Foto - TAMBAHKAN INI -->
<div class="form-row" style="margin-top: 10px;">
    <div class="form-col">
        <select id="filterFoto">
            <option value="">Semua Item (Dengan/Tanpa Foto)</option>
            <option value="with-photos"> Dengan Foto</option>
            <option value="without-photos"> Tanpa Foto</option>
        </select>
    </div>
    <div class="form-col">
        <!-- Bisa ditambahkan filter lain di sini jika diperlukan -->
    </div>
    <div class="form-col">
        <!-- Kosong untuk menjaga keseimbangan layout -->
    </div>
    <div class="form-col">
        <!-- Kosong -->
    </div>
</div>
            
            <div id="assetsList">
                <div class="empty-state">
                    <i class="fas fa-cubes"></i>
                    <h3>Belum ada item</h3>
                    <p>Tambahkan item baru untuk mulai mengelola</p>
                </div>
            </div>
        </div>

        <!-- TAB UPDATE KONDISI -->
        <div class="tab-content" id="update-tab">
            <h2><i class="fas fa-edit"></i> Update Kondisi Item</h2>
            <div id="updateAlert" class="alert" style="display: none;"></div>
            
            <div class="form-group">
                <label for="assetSelect">Pilih Item *</label>
                <select id="assetSelect" required>
                    <option value="">Pilih item untuk update kondisi</option>
                </select>
            </div>
            
            <div id="assetInfo" style="display: none;">
                <div class="asset-card">
                    <div class="asset-header">
                        <div>
                            <div class="asset-title" id="updateAssetName"></div>
                            <div class="asset-subtitle">
                              Material Code :   <span id="updateAssetCode"></span> | No RS :   <span id="updateAssetCodeRs"></span>  | No Asset : <span id="updateAssetNo"></span> |  Lokasi :
                                <span id="updateAssetLocation"></span> | 
                                Jenis: <span id="updateAssetJenis"></span> |
                                Kondisi: <span id="updateAssetCondition"></span>
                            </div>
                        </div>
                        <div id="updateAssetBadge"></div>
                    </div>
                    <div class="photo-preview" id="updateAssetPhotos"></div>
                </div>
                
                <form id="updateConditionForm">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="newLokasi">Lokasi Baru (Opsional)</label>
                            <select id="newLokasi">
                                <option value="">Pilih Lokasi</option>
                                <option value="Main Workshops">Main Workshops</option>
                                <option value="Gudang Office">Gudang Office</option>
                                <option value="Workshops Tyre">Workshops Tyre</option>
                                <option value="Workshops Track">Workshops Track</option>
                                <option value="Workshops Welder">Workshops Welder</option>
                                <option value="Workshops Maintenance">Workshops Maintenance</option>
                                <option value="Workshops DT">Workshops DT</option>
                                <option value="Workshops wheel">Workshops wheel</option>
                                <option value="Pit stop">Pit stop</option>
                                <option value="other">Lainnya (Ketik manual)...</option>
                            </select>
                            <input type="text" id="customLokasiUpdate" placeholder="Ketik lokasi baru" style="display: none; margin-top: 5px;">
                        </div>
                        <div class="form-col">
                            <label for="newCondition">Kondisi Baru *</label>
                            <select id="newCondition" required>
                                <option value="">Pilih Kondisi Baru</option>
                                <option value="baik">Baik</option>
                                <option value="rusak">Rusak</option>
                                <option value="Mutasi">Mutasi</option>
                            </select>
                        </div>
                       <div id="nonAssetMutationBox" style="display:none; margin-top:15px;">
    <h4>Perubahan Kondisi Asset</h4>

    <div class="form-row">
        <div class="form-col">
            <label>Kondisi Asal *</label>
            <select id="mutationFrom">
                <option value="">Pilih kondisi asal</option>
                <option value="baik">Baik</option>
                <option value="rusak">Rusak</option>
                <option value="Mutasi">Mutasi</option>
            </select>
        </div>

        <div class="form-col">
            <label>Kondisi Tujuan *</label>
            <select id="mutationTo">
                <option value="">Pilih kondisi tujuan</option>
                <option value="baik">Baik</option>
                <option value="rusak">Rusak</option>
                <option value="Mutasi">Mutasi</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>Jumlah Dipindahkan</label>
        <input type="number" id="mutationQty" min="1" placeholder="Isi jika ada perubahan kondisi">
        <small>Kosongkan jika hanya update lokasi / catatan</small>
    </div>
</div>


                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="updateFoto">Foto Kondisi Baru (Max 5MB)</label>
                            <input type="file" id="updateFoto" accept="image/*">
                            <small>Foto untuk mendokumentasikan perubahan kondisi</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="updateCatatan">Catatan Perubahan *</label>
                        <textarea id="updateCatatan" rows="3" placeholder="Jelaskan perubahan kondisi, penyebab, atau tindakan yang dilakukan..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-warning" id="btnUpdateCondition">
                            <i class="fas fa-sync-alt"></i> Update Kondisi
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB GALERI FOTO -->
        <div class="tab-content" id="galeri-tab">
            <h2><i class="fas fa-images"></i> Galeri Foto Item</h2>
            <div class="form-group">
                <label for="galeriAssetSelect">Pilih Item</label>
                <select id="galeriAssetSelect">
                    <option value="">Semua Item</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="filterPhotoSource">Sumber Foto</label>
                <select id="filterPhotoSource">
                    <option value="">Semua Sumber</option>
                    <option value="local">Lokal (IndexedDB)</option>
                    <option value="cloudinary">Cloudinary</option>
                </select>
            </div>
            
            <div id="galleryContainer">
                <div class="empty-state">
                    <i class="fas fa-images"></i>
                    <h3>Belum ada foto</h3>
                    <p>Foto akan ditampilkan setelah item ditambahkan</p>
                </div>
            </div>
        </div>

        <!-- TAB BACKUP & EXPORT -->
        <div class="tab-content" id="backup-tab">
            <h2><i class="fas fa-download"></i> Backup, Restore & Export</h2>
            

<div class="form-row">
    <!-- Backup Section (tetap) -->
    <div class="form-col">
        <h3><i class="fas fa-file-archive"></i> Backup Data</h3>
        <p>Backup semua data ke file ZIP (termasuk Excel).</p>
        <div id="backupInfo" class="alert alert-info">
            <i class="fas fa-info-circle"></i> Backup akan berisi:
            <ul style="margin-left: 20px; margin-top: 5px;">
                <li>Data asset/non-asset</li>
                <li>Semua foto</li>
                <li>File Excel export</li>
            </ul>
        </div>
        <button class="btn btn-primary" id="btnBackup">
            <i class="fas fa-file-archive"></i> Buat Backup ZIP
        </button>
        <button class="btn btn-success" id="btnExportAllData">
            <i class="fas fa-file-excel"></i> Export All Data
        </button>
    </div>

    <!-- IMPORT SECTION (BARU - Gabungan ZIP & Excel) -->
    <div class="form-col">
        <h3><i class="fas fa-upload"></i> Import Data</h3>
        <p>Import data dari file ZIP (full data) atau Excel (massal).</p>
        
        <div id="importAlert" class="alert" style="display: none;"></div>
        
        <!-- Dropzone untuk kedua jenis file -->
        <div class="file-upload" id="importDropzone">
            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; margin-bottom: 15px; color: var(--primary-light);"></i>
            <h3>Seret file ke sini</h3>
            <p>Support: ZIP (.zip) untuk full data + foto | Excel (.xlsx) untuk data massal</p>
            <input type="file" id="importFile" accept=".zip,.xlsx" style="display: none;">
        </div>
        
        <!-- Opsi Import (hanya sebagai info, bukan selector) -->
        <div style="margin-top: 15px; padding: 10px; background: var(--light); border-radius: 8px;">
            <div style="display: flex; gap: 15px; align-items: center;">
                <div style="flex: 1; text-align: center; padding: 10px; border-right: 1px solid var(--border-color);">
                    <i class="fas fa-file-archive" style="color: var(--warning); font-size: 20px;"></i>
                    <div><strong>ZIP</strong></div>
                    <small>Full data + foto</small>
                </div>
                <div style="flex: 1; text-align: center; padding: 10px;">
                    <i class="fas fa-file-excel" style="color: var(--success); font-size: 20px;"></i>
                    <div><strong>Excel</strong></div>
                    <small>Data massal</small>
                </div>
            </div>
        </div>

        <!-- Tombol Import (muncul setelah pilih file) -->
        <button class="btn btn-warning" id="btnImport" style="display: none; margin-top: 15px; width: 100%;">
            <i class="fas fa-file-import"></i> Preview & Import Data
        </button>

        <!-- Template Excel (opsional) -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
            <div style="display: flex; gap: 10px; align-items: center;">
                <i class="fas fa-download" style="color: var(--primary);"></i>
                <span style="flex: 1;">Butuh template Excel?</span>
                <button onclick="exportExcelTemplate()" class="btn btn-outline btn-small">
                    <i class="fas fa-file-excel"></i> Download Template
                </button>
            </div>
        </div>
    </div>
</div>
            
            <!-- Riwayat Backup -->
            <div class="form-group" style="margin-top: 30px;">
                <h3><i class="fas fa-history"></i> Riwayat Backup & Export</h3>
                <div id="backupHistory">
                    <div class="empty-state" style="padding: 30px 20px;">
                        <i class="fas fa-history"></i>
                        <p>Belum ada riwayat backup</p>
                    </div>
                </div>
            </div>
        </div>

<!-- TAB SETTINGS -->
<div class="tab-content" id="settings-tab">
    <h2><i class="fas fa-cog"></i> Pengaturan Aplikasi</h2>
    
    <div class="settings-grid">
        <!-- Cloudinary Settings -->
        <div class="setting-card">
            <h3><i class="fas fa-cloud-upload-alt"></i> Cloudinary</h3>
            
            <div class="setting-item">
                <div class="setting-label">Status</div>
                <div class="status-badge status-online" id="cloudinarySettingsStatus">
                    <i class="fas fa-check-circle"></i> Selalu Aktif
                </div>
                <div class="setting-description">
                    Foto otomatis diupload ke Cloudinary saat online
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">Cloud Name</label>
                <input type="text" id="cloudinaryCloudName" value="di5m9sto5" readonly>
                <div class="setting-description">
                    Nama cloud Cloudinary
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">Upload Preset</label>
                <input type="text" id="cloudinaryUploadPreset" value="unsigned" readonly>
                <div class="setting-description">
                    Preset upload unsigned
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">Asset Folder</label>
                <input type="text" id="cloudinaryFolder" value="assets">
                <div class="setting-description">
                    Folder untuk menyimpan foto
                </div>
            </div>
            
            <button class="btn btn-outline btn-small" id="testCloudinary">
                <i class="fas fa-wifi"></i> Test Koneksi
            </button>
        </div>
        
        <!-- Sync Settings -->
        <div class="setting-card">
            <h3><i class="fas fa-sync-alt"></i> Sinkronisasi</h3>
            
            <div class="setting-item">
                <div class="setting-label">Auto Sync</div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSync" checked>
                    <span class="toggle-slider"></span>
                </label>
                <div class="setting-description">
                    Sinkronisasi otomatis saat online
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Sync Interval</div>
                <select id="syncInterval">
                    <option value="30000">30 detik</option>
                    <option value="60000" selected>1 menit</option>
                    <option value="300000">5 menit</option>
                    <option value="900000">15 menit</option>
                </select>
                <div class="setting-description">
                    Interval sinkronisasi otomatis
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Terakhir Sync</div>
                <div id="lastSyncTime" style="font-weight: 600; color: var(--primary);">
                    Belum pernah
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Status Koneksi</div>
                <div id="syncStatusInfo" style="font-size: 13px;">
                    <span id="firebaseStatusText">Mengecek...</span><br>
                    <span id="cloudinaryStatusText">Mengecek...</span>
                </div>
            </div>
        </div>
        
        <!-- Storage Settings -->
        <div class="setting-card">
            <h3><i class="fas fa-database"></i> Penyimpanan</h3>
            
            <div class="setting-item">
                <div class="setting-label">Penyimpanan Lokal</div>
                <div id="localStorageInfo">
                    <div class="progress-bar" style="height: 10px; margin: 5px 0;">
                        <div id="storageProgress" class="progress-bar-fill" style="width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px;">
                        <span id="storageUsedText">0 MB</span>
                        <span id="storageTotalText">-</span>
                    </div>
                    <div id="storagePercent" style="text-align: center; font-weight: 600; margin-top: 5px;">
                        0%
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Kompresi Foto</div>
                <label class="toggle-switch">
                    <input type="checkbox" id="enableCompression" checked>
                    <span class="toggle-slider"></span>
                </label>
                <div class="setting-description">
                    Kompresi otomatis (1280px, quality 0.7)
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Ukuran Maks Foto</div>
                <select id="maxPhotoSize">
                    <option value="2">2 MB</option>
                    <option value="5" selected>5 MB</option>
                    <option value="10">10 MB</option>
                </select>
                <div class="setting-description">
                    Ukuran maksimal per file foto
                </div>
            </div>
            <!-- Tambah di settings card -->
<div class="setting-item">
    <div class="setting-label">Manajemen Foto</div>
    <div class="form-row">
        <select id="photoStorageMode">
            <option value="optimized">Optimized (Rekomendasi)</option>
            <option value="thumbnail">Thumbnail Only (Hemat)</option>
            <option value="full">Full Quality (Boros)</option>
        </select>
    </div>
    <div class="setting-description">
        Mode thumbnail: simpan versi kecil untuk preview, download HD saat online
    </div>
    <button class="btn btn-outline btn-small" onclick=cleanupOldPhotos()>
        <i class="fas fa-broom"></i> Bersihkan Foto Lama
    </button>
</div>
            <!-- Reset Data - Hanya untuk Owner -->
            <div id="ownerSettings" style="display: none;">
                <div class="setting-item">
                    <div class="setting-label">Reset Semua Data</div>
                    <div class="form-row" style="margin-top: 10px;">
                        <input type="password" id="resetPassword" placeholder="Masukkan sandi: 115ganteng" 
                               style="flex: 1; padding: 8px 12px; font-size: 14px;">
                        <button class="btn btn-danger btn-small" id="resetAllData">
                            <i class="fas fa-trash"></i> Reset
                        </button>
                    </div>
                    <div class="setting-description" style="color: var(--danger);">
                         Hapus SEMUA data (lokal & cloud) - Hanya Owner
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <button class="btn btn-outline btn-small" id="clearLocalData">
                    <i class="fas fa-trash-alt"></i> Hapus Data Lokal
                </button>
                <div class="setting-description">
                    Hanya hapus data dari browser ini
                </div>
            </div>
        </div>

        <!-- Backup Settings -->
        <div class="setting-card">
            <h3><i class="fas fa-history"></i> Backup & Restore</h3>
            
      
            <div class="setting-item">
                <div class="setting-label">Riwayat Backup</div>
                <div id="backupCount" style="font-weight: 600;">
                    0 backup tersimpan
                </div>
            </div>
         
        </div>
    </div>
    
    <!-- App Info -->
    <div class="setting-card" style="margin-top: 20px;">
        <h3><i class="fas fa-info-circle"></i> Informasi Aplikasi</h3>
        <div class="form-row">
            <div class="form-col">
                <div class="setting-label">Versi</div>
                <div id="appVersion" style="font-weight: 600;">3.6.0</div>
                
                <div class="setting-label">Build Date</div>
                <div id="buildDate" style="font-weight: 600;">20 Februari 2026</div>
                
                <div class="setting-label">Build Code</div>
                <div style="font-family: monospace; font-size: 13px; color: var(--primary);">
                    360
                </div>
            </div>
            <div class="form-col">
                <div class="setting-label">Pengguna</div>
                <div id="currentUserName" style="font-weight: 600;">-</div>
                
                <div class="setting-label">Role</div>
                <div id="currentUserRole" style="font-weight: 600;">-</div>
                
                <div class="setting-label">Login</div>
                <div id="currentUserLogin" style="font-size: 12px; color: var(--secondary);">
                    -
                </div>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <div class="setting-label">Fitur Utama</div>
            <div style="font-size: 12px; color: var(--secondary); line-height: 1.5;">
                 Asset & Non-Asset Management  IndexedDB Local Storage  
                 Firebase Sync  Cloudinary Auto-Upload  
                 Backup ZIP  Export Excel  Dark Mode  
                 User Authentication  Activity Logging
            </div>
        </div>
    </div>
</div>
    
    <!-- MODALS -->

<div class="modal" id="assetDetailModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Detail Item</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-outline btn-small" id="printAssetDetail" title="Print" style="padding: 6px 12px;">
                    <i class="fas fa-print"></i>
                </button>
                <button class="btn btn-outline btn-small" id="shareAssetDetail" title="Share" style="padding: 6px 12px;">
                    <i class="fas fa-share-alt"></i>
                </button>
                <span class="close-modal" id="closeAssetDetail" style="font-size: 24px; margin-left: 5px;">&times;</span>
            </div>
        </div>
        <div id="assetDetailContent"></div>
    </div>
</div>
    <div class="modal" id="photoModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Foto Item</div>
                <div class="close-modal" id="closePhotoModal">&times;</div>
            </div>
            <div id="photoModalContent" style="text-align: center;">
                <img id="largePhoto" src="" alt="Foto Item" style="max-width: 100%; border-radius: 8px;">
                <div id="photoInfo" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="cloudinaryUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Upload ke Cloudinary</div>
                <div class="close-modal" id="closeCloudinaryModal">&times;</div>
            </div>
            <div id="cloudinaryUploadContent" style="padding: 20px;">
                <div id="uploadProgress" class="empty-state">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Mengupload foto...</h3>
                    <div class="progress-bar">
                        <div id="uploadProgressBar" class="progress-bar-fill"></div>
                    </div>
                    <p id="uploadStatus">Memulai upload...</p>
                </div>
            </div>
        </div>
    </div>
        <!-- Modal Report Data WA -->
    <div class="modal" id="waReportModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Preview Laporan WA</div>
      <span class="close-modal" onclick="closeWaModal()">&times;</span>
    </div>

    <div style="margin-bottom:15px;">
      <button class="btn btn-outline btn-small"
          onclick="generateWaReport('simple')">Simple</button>
      <button class="btn btn-outline btn-small"
          onclick="generateWaReport('full')">Full</button>
    </div>

    <textarea id="waPreview"
      style="width:100%;height:300px;"></textarea>

    <div style="margin-top:15px;">
      <button class="btn btn-success btn-small"
          id="btnSendWA"
          onclick="sendToWhatsApp()">Kirim WA</button>

      <button class="btn btn-primary btn-small"
          onclick="copyReport()">Salin</button>
    </div>

    <div id="waWarning"
         style="color:red;margin-top:10px;"></div>
  </div>
</div>

    <!-- Modal Preview Data -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Preview Data Sebelum Save</div>
                <div class="close-modal" id="closePreviewModal">&times;</div>
            </div>
            <div id="previewContent" style="padding: 20px;">
                <!-- Data akan diisi oleh JavaScript -->
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border-color);">
                <div class="form-row">
                    <div class="form-col">
                        <label>Foto Preview:</label>
                        <div id="finalPhotoPreview" class="photo-preview"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-success" id="confirmSave">
                        <i class="fas fa-check"></i> Konfirmasi & Simpan
                    </button>
                    <button class="btn btn-outline" id="cancelSave">
                        <i class="fas fa-times"></i> Kembali ke Form
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk reset data -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Reset Semua Data</div>
                <div class="close-modal" id="closeResetModal">&times;</div>
            </div>
            <div id="resetModalContent" style="padding: 20px;">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>PERINGATAN!</strong> Tindakan ini akan menghapus:
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Semua data lokal (IndexedDB)</li>
                        <li>Semua data di Firebase Firestore</li>
                        <li>Semua foto di Cloudinary</li>
                    </ul>
                    <p style="margin-top: 10px;">Tindakan ini tidak dapat dibatalkan!</p>
                </div>
                <div class="form-group">
                    <label for="confirmResetPassword">Masukkan sandi konfirmasi:</label>
                    <input type="password" id="confirmResetPassword" placeholder="" class="form-control">
                </div>
                <div class="form-group">
                    <button class="btn btn-danger" id="confirmResetAll">
                        <i class="fas fa-trash"></i> HAPUS SEMUA DATA
                    </button>
                    <button class="btn btn-outline" id="cancelReset">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Login Overlay -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-container">
        <div class="login-header">
            <h1><i class="fas fa-cubes"></i> Asset Management</h1>
            <p>Silakan login untuk mengakses sistem</p>
        </div>
        
        <div class="login-tabs">
            <div class="login-tab active" data-form="login">Login</div>
            <div class="login-tab" data-form="register">Register</div>
        </div>
        
        <!-- Login Form -->
        <form class="login-form active" id="loginForm">
            <div id="loginError" class="login-error" style="display: none;"></div>
            <div id="loginSuccess" class="login-success" style="display: none;"></div>
            
            <div class="login-input-group">
                <label for="loginEmail">Email</label>
                <div class="input-with-icon">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="loginEmail" placeholder="nama@perusahaan.com" required>
                </div>
            </div>
            
            <div class="login-input-group">
                <label for="loginPassword">Password</label>
                <div class="input-with-icon">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPassword" placeholder="Masukkan password" required>
                </div>
            </div>
            
            <div class="login-options">
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <span>Ingat saya</span>
                </label>
                <a href="#" class="forgot-password" id="forgotPassword">Lupa password?</a>
            </div>
            
            <button type="submit" class="login-btn" id="btnLogin">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="switch-form">
                Belum punya akun? <a href="#" data-form="register">Daftar sekarang</a>
            </div>
        </form>
        
        <!-- Register Form -->
        <form class="login-form" id="registerForm">
            <div id="registerError" class="login-error" style="display: none;"></div>
            <div id="registerSuccess" class="login-success" style="display: none;"></div>
            
            <div class="login-input-group">
                <label for="registerNama">Nama Lengkap *</label>
                <div class="input-with-icon">
                    <i class="fas fa-user"></i>
                    <input type="text" id="registerNama" placeholder="Nama lengkap" required>
                </div>
            </div>
            
            <div class="login-input-group">
                <label for="registerJabatan">Jabatan *</label>
                <div class="input-with-icon">
                    <i class="fas fa-briefcase"></i>
                    <input type="text" id="registerJabatan" placeholder="Jabatan di perusahaan" required>
                </div>
            </div>
            
            <div class="login-input-group">
                <label for="registerNIK">NIK (Nomor Induk Karyawan) *</label>
                <div class="input-with-icon">
                    <i class="fas fa-id-card"></i>
                    <input type="text" id="registerNIK" placeholder="Nomor induk karyawan" required>
                </div>
            </div>
            
            <div class="login-input-group">
                <label for="registerEmail">Email *</label>
                <div class="input-with-icon">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="registerEmail" placeholder="email@perusahaan.com" required>
                </div>
            </div>
            
            <div class="login-input-group">
                <label for="registerPassword">Password *</label>
                <div class="input-with-icon">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="registerPassword" placeholder="Minimal 6 karakter" required minlength="6">
                </div>
            </div>
            
            <div class="login-input-group">
                <label for="registerConfirmPassword">Konfirmasi Password *</label>
                <div class="input-with-icon">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="registerConfirmPassword" placeholder="Ulangi password" required>
                </div>
            </div>
            
            <button type="submit" class="login-btn" id="btnRegister">
                <i class="fas fa-user-plus"></i> Daftar Akun
            </button>
            
            <div class="switch-form">
                Sudah punya akun? <a href="#" data-form="login">Login disini</a>
            </div>
        </form>
    </div>
</div>
<!-- TAMBAHKAN/MODAL MODAL INI (ganti yang lama) -->
<div class="modal" id="zipImportModal">
    <div class="modal-content" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-file-import"></i> Preview Import ZIP
                <span id="zipPreviewStats" style="font-size: 14px; margin-left: 15px;"></span>
            </div>
            <span class="close-modal" onclick="closeZipPreview()">&times;</span>
        </div>

        <div id="zipPreviewTabs" style="display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;">
            <div class="zip-tab active" data-tab="assets" style="padding: 10px 20px; cursor: pointer; border-bottom: 3px solid var(--primary);">
                <i class="fas fa-cubes"></i> Data Item
            </div>
            <div class="zip-tab" data-tab="photos" style="padding: 10px 20px; cursor: pointer;">
                <i class="fas fa-images"></i> Foto
            </div>
            <div class="zip-tab" data-tab="conflicts" style="padding: 10px 20px; cursor: pointer;">
                <i class="fas fa-exclamation-triangle"></i> Konflik
            </div>
        </div>

        <div id="zipPreviewContainer"></div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-success" onclick="confirmZipImport()">
                    <i class="fas fa-check"></i> Import Data
                </button>
                <button class="btn btn-outline" onclick="closeZipPreview()">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p id="loadingText">Memproses...</p>
</div>

<!-- User Dropdown Menu -->
<div class="user-dropdown" id="userDropdown">
    <div class="dropdown-header">
        <div class="dropdown-user-info">
            <div class="dropdown-avatar" id="dropdownAvatar">U</div>
            <div class="dropdown-user-details">
                <h3 id="dropdownName">User Name</h3>
                <p id="dropdownEmail">user@email.com</p>
                <p id="dropdownJabatan">-</p>
                <p id="dropdownNIK">-</p>
                <span class="user-role-badge" id="dropdownRole">User</span>
            </div>
        </div>
    </div>
    <div class="dropdown-menu">
        <a href="#" class="dropdown-item" id="btnProfile">
            <i class="fas fa-user"></i> Profil Saya
        </a>
        <a href="#" class="dropdown-item" id="btnChangePassword">
            <i class="fas fa-key"></i> Ubah Password
        </a>
        <div class="dropdown-divider"></div>
        <a href="#" class="dropdown-item logout" id="btnLogout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div id="importPreviewModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">

        <div class="modal-header">
            <h3>Preview Import Data</h3>
            <button onclick="closeImportPreview()" class="btn-close"></button>
        </div>

        <div class="modal-body">

            <div id="importPreviewContainer"></div>

        </div>

        <div class="modal-footer">
            <button onclick="saveImportedData()" class="btn btn-success">
                <i class="fas fa-save"></i> Simpan Semua
            </button>

            <button onclick="closeImportPreview()" class="btn btn-secondary">
                Batal
            </button>
        </div>

    </div>
</div>


<!-- Progress Overlay -->
<div class="progress-overlay" id="progressOverlay">
    <div class="progress-content">
        <div class="progress-header">
            <h3 id="progressTitle">Menyimpan Data</h3>
            <p id="progressSubtitle">Mohon tunggu...</p>
        </div>
        
        <div class="progress-steps" id="progressSteps">
            <!-- Steps akan diisi oleh JavaScript -->
        </div>
        
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <div id="progressError" class="progress-error" style="display: none;"></div>
        
        <div class="progress-actions">
            <button class="btn btn-danger" id="btnCancelProgress" style="display: none;">
                <i class="fas fa-times"></i> Batalkan
            </button>
            <button class="btn btn-outline" id="btnCloseProgress" style="display: none;">
                <i class="fas fa-times"></i> Tutup
            </button>
        </div>
    </div>
</div>

    <script>
     // ==============================================
// KONFIGURASI & INISIALISASI
// ==============================================

// Konfigurasi Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBxEBA92uOfGeobPa-vtfac9DOuvh1k2eI",
    authDomain: "monitoring-f6347.firebaseapp.com",
    projectId: "monitoring-f6347",
    messagingSenderId: "299367981985",
    appId: "1:299367981985:web:9a93492e42bc4651fd61e0",
    measurementId: "G-0N22LKVQ7F"
};

// Pastikan Firebase SDK yang diperlukan sudah dimuat
let firebaseAuthLoaded = false;
let firebaseFirestoreLoaded = false;
        
// Konfigurasi Cloudinary - SELALU AKTIF
const CLOUDINARY_CONFIG = {
    cloud_name: "di5m9sto5",
    upload_preset: "unsigned",
    api_url: "https://api.cloudinary.com/v1_1/di5m9sto5/image/upload",
    folder: "assets",
    enabled: true // Selalu aktif
};

        
        const APP_META = {
            VERSION: '3.6.0',
            BUILD_DATE: '20 Februari 2026',
            BUILD_CODE: 360
        };

        // Konfigurasi Keamanan & Limit
        const SAFE_CONFIG = {
            MAX_PHOTO_SIZE: 5 * 1024 * 1024, // 5MB
            MAX_ASSETS: 1000,
            MAX_PHOTOS_PER_ASSET: 20,
            MAX_TOTAL_PHOTOS: 10000,
            COMPRESSION_MAX_WIDTH: 1280,
            COMPRESSION_QUALITY: 0.7
        };

        // Variabel Global
        let db;
        let assets = [];
        let indexedDBInstance;
        let isFirebaseConnected = false;
        let isCloudinaryEnabled = true;
        let pendingSyncAssets = [];
        let pendingCloudinaryUploads = [];
        let theme = localStorage.getItem('theme') || 'light';
    
        let lastSyncTime = null;
        let memoryWarningShown = false;
        
        // Chart instances
        let conditionChart = null;
        let typeChart = null;
        
        // Send Wa
        const MAX_WA_LENGTH = 3800;
        let currentWaMessage = "";




// ==============================================
// INTERNET CHECK & BLOCKER
// ==============================================

function requireInternet(actionName) {
    if (!navigator.onLine) {
        showToastNotification(` ${actionName} membutuhkan koneksi internet!`, 'danger');
        
        // Tampilkan alert juga di globalAlertContainer
        const alertContainer = document.getElementById('globalAlertContainer');
        if (alertContainer) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${actionName} membutuhkan koneksi internet. Silakan online terlebih dahulu.`;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 4000);
        }
        
        return false;
    }
    return true;
}


        // ==============================================
// SPLASH SCREEN MANAGEMENT - TAMBAHKAN INI
// ==============================================

function updateSplashStatus(message, detail = '') {
    const statusEl = document.getElementById('splashStatus');
    const detailEl = document.getElementById('splashDetail');
    if (statusEl) statusEl.textContent = message;
    if (detailEl && detail) detailEl.textContent = detail;
    console.log("Splash:", message, detail);
}

function hideSplashScreen() {
    const splash = document.getElementById('splashScreen');
    if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => {
            splash.style.display = 'none';
        }, 500);
    }
}

function showSplashScreen() {
    const splash = document.getElementById('splashScreen');
    if (splash) {
        splash.style.display = 'flex';
        splash.style.opacity = '1';
    }
}
        // ==============================================
        // FUNGSI UTILITAS
        // ==============================================
 // ==============================================
// UTILITIES - INTERVAL MANAGEMENT
// ==============================================

// Array untuk menyimpan semua interval ID
const _intervals = [];

/**
 * Membuat interval yang aman dan ter-track untuk dibersihkan
 * @param {Function} fn - Fungsi yang akan dijalankan
 * @param {number} time - Interval time dalam milliseconds
 * @returns {number} interval ID
 */
function setSafeInterval(fn, time) {
    const id = setInterval(fn, time);
    _intervals.push(id);
    return id;
}
function clearSafeInterval(id) {
    const index = _intervals.indexOf(id);
    if (index > -1) {
        _intervals.splice(index, 1);
        clearInterval(id);
    }
}



        // =============================================
    // ==============================================
// FUNGSI NORMALISASI DATA ASSET - UNIVERSAL
// ==============================================
// ==============================================

function normalizeAssetData(rawData, options = {}) {
    const {
        userInfo = currentUser,
        isImport = false,
        source = 'unknown', // 'form', 'excel', 'zip'
        timestamp = null
    } = options;
    
    // 1. TENTUKAN JENIS ITEM
    const jenis_item = rawData.jenis_item || 'asset';
    
    // 2. PASTIKAN MATERIAL CODE & NO RS ADA
    if (!rawData.material_kode || !rawData.no_rs) {
        throw new Error("Material code dan No RS wajib ada");
    }
    
    // 3. NORMALKAN MATERIAL CODE & NO RS
    const material_kode = rawData.material_kode.toString().replace(/\s+/g, '').toUpperCase();
    const no_rs = rawData.no_rs.toString().replace(/\s+/g, '').toUpperCase();
    
    // 4. TENTUKAN ID (pakai yang sudah ada atau buat baru)
    let id = rawData.id;
    const useTimestamp = timestamp || Date.now();
    const random = Math.random().toString(36).substring(2, 8).toUpperCase();
    
    if (!id || isImport) {
        // Untuk import, buat ID baru
        const prefix = jenis_item === 'asset' ? 'A' : 'N';
        id = `${prefix}-${material_kode}-${useTimestamp}-${random}-1`;
    }
    
    // 5. NORMALISASI DATA DASAR
    const normalized = {
        id: id,
        jenis_item: jenis_item,
        nama_asset: (rawData.nama_asset || '').trim(),
        material_kode: material_kode,
        no_rs: no_rs,
        no_po: rawData.no_po || null,
        lokasi: (rawData.lokasi || '').trim(),
        catatan_awal: rawData.catatan_awal || null,
        
        // Timestamp
        created_at: rawData.created_at || new Date().toISOString(),
        updated_at: new Date().toISOString(),
        updatedAt: Date.now(), //  NUMBER timestamp untuk perbandingan
        
        // Sync status
        syncStatus: 'pending'
    };
    
    // 6. NORMALISASI USER INFO
    const userInfoObj = userInfo ? {
        uid: userInfo.uid || 'system',
        nama: userInfo.nama || userInfo.email || 'System',
        email: userInfo.email || 'system@local',
        jabatan: userInfo.jabatan || '',
        timestamp: Date.now()
    } : {
        uid: 'system',
        nama: 'System',
        email: 'system@local',
        jabatan: '',
        timestamp: Date.now()
    };
    
    // 7. SET CREATED_BY & UPDATED_BY
    if (rawData.created_by && !isImport) {
        normalized.created_by = rawData.created_by;
    } else {
        normalized.created_by = userInfoObj;
    }
    
    normalized.updated_by = userInfoObj;
    normalized.updatedByName = userInfoObj.nama;
    
    // 8. NORMALISASI KHUSUS BERDASARKAN JENIS
    if (jenis_item === 'asset') {
        // ASSET
        normalized.kondisi = rawData.kondisi || 'baik';
        normalized.kondisi_detail = null;
        normalized.total_jumlah = 1;
        normalized.no_asset = rawData.no_asset || null;
        
    } else {
        // NON-ASSET
        normalized.kondisi = null;
        
        // Normalisasi kondisi_detail
        if (rawData.kondisi_detail && typeof rawData.kondisi_detail === 'object') {
            normalized.kondisi_detail = {
                baik: parseInt(rawData.kondisi_detail.baik) || 0,
                rusak: parseInt(rawData.kondisi_detail.rusak) || 0,
                Mutasi: parseInt(rawData.kondisi_detail.Mutasi) || 0
            };
        } else {
            // Buat dari kondisi string dan jumlah
            const jumlah = parseInt(rawData.jumlah || rawData.total_jumlah || 1);
            const kondisi = (rawData.kondisi || 'baik').toLowerCase();
            
            normalized.kondisi_detail = {
                baik: kondisi === 'baik' ? jumlah : 0,
                rusak: kondisi === 'rusak' ? jumlah : 0,
                Mutasi: kondisi === 'Mutasi' ? jumlah : 0
            };
        }
        
        // Hitung total_jumlah dari kondisi_detail
        normalized.total_jumlah = 
            (normalized.kondisi_detail.baik || 0) +
            (normalized.kondisi_detail.rusak || 0) +
            (normalized.kondisi_detail.Mutasi || 0);
        
        normalized.no_asset = null;
    }
    
    // 9. NORMALISASI RIWAYAT
    if (!rawData.riwayat || !Array.isArray(rawData.riwayat) || rawData.riwayat.length === 0) {
        // Buat riwayat baru
        const riwayatItem = {
            tanggal: new Date().toISOString(),
            tipe: isImport ? 'import' : 'create',
            user: userInfoObj,
            catatan: isImport ? `Import dari ${source}` : 'Item dibuat'
        };
        
        if (jenis_item === 'asset') {
            riwayatItem.old_kondisi = null;
            riwayatItem.new_kondisi = normalized.kondisi;
            riwayatItem.old_lokasi = null;
            riwayatItem.new_lokasi = normalized.lokasi;
            riwayatItem.old_jumlah = null;
            riwayatItem.new_jumlah = 1;
        } else {
            riwayatItem.old_kondisi_detail = null;
            riwayatItem.new_kondisi_detail = normalized.kondisi_detail;
            riwayatItem.old_lokasi = null;
            riwayatItem.new_lokasi = normalized.lokasi;
            riwayatItem.old_jumlah = null;
            riwayatItem.new_jumlah = normalized.total_jumlah;
        }
        
        normalized.riwayat = [riwayatItem];
    } else {
        // Pakai riwayat yang ada
        normalized.riwayat = rawData.riwayat;
    }
    
    // 10. TAMBAHKAN METADATA IMPORT (jika dari import)
    if (isImport) {
        normalized.imported_at = new Date().toISOString();
        normalized.imported_by = userInfo ? {
            uid: userInfo.uid,
            nama: userInfo.nama,
            email: userInfo.email
        } : null;
        normalized.import_source = source;
    }
    
    return normalized;
}    
        
        
// FUNGSI HASH PASSWORD (SHA-256)
// =============================================

async function hashPassword(password) {
    // Encode password ke Uint8Array
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    
    // Generate hash menggunakan SHA-256
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    
    // Konversi ke hex string
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
    return hashHex;
}

// Untuk kompatibilitas dengan browser lama (fallback)
function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash).toString(16);
}
        function toggleJumlahField() {
            const jenisItem = document.getElementById('jenis_item').value;
            const jumlahContainer = document.getElementById('jumlahContainer');
            const jumlahInput = document.getElementById('jumlah');
            const jenis = document.getElementById('jenis_item').value;
const noAssetGroup = document.getElementById('noAssetGroup');

if (jenis === 'asset') {
    noAssetGroup.style.display = 'block';
} else {
    noAssetGroup.style.display = 'none';
    document.getElementById('no_asset').value = '';
}

            if (jenisItem === 'non-asset') {
                jumlahContainer.style.display = 'block';
                jumlahInput.required = true;
                jumlahInput.value = 1;
            } else {
                jumlahContainer.style.display = 'none';
                jumlahInput.required = false;
                jumlahInput.value = 1;
            }
        }
        
        function previewPhotos(input) {
            const previewContainer = document.getElementById('photoPreview');
            previewContainer.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'photo-thumb';
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.title = `Foto ${i + 1}: ${file.name}`;
                        
                        const container = document.createElement('div');
                        container.style.position = 'relative';
                        container.style.display = 'inline-block';
                        container.style.margin = '5px';
                        
                        // Tambah nomor foto
                        const badge = document.createElement('div');
                        badge.style.position = 'absolute';
                        badge.style.top = '5px';
                        badge.style.left = '5px';
                        badge.style.background = 'rgba(0,0,0,0.7)';
                        badge.style.color = 'white';
                        badge.style.borderRadius = '50%';
                        badge.style.width = '20px';
                        badge.style.height = '20px';
                        badge.style.textAlign = 'center';
                        badge.style.lineHeight = '20px';
                        badge.style.fontSize = '12px';
                        badge.textContent = i + 1;
                        
                        container.appendChild(img);
                        container.appendChild(badge);
                        previewContainer.appendChild(container);
                    }
                    
                    reader.readAsDataURL(file);
                }
            }
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // MODIFIKASI fungsi compressImage untuk menghasilkan thumbnail
async function compressImage(file, options = {}) {
    const {
        maxWidth = SAFE_CONFIG.COMPRESSION_MAX_WIDTH,
        quality = SAFE_CONFIG.COMPRESSION_QUALITY,
        forThumbnail = false
    } = options;
    
    return new Promise((resolve, reject) => {
        // Untuk thumbnail, ukuran lebih kecil
        const targetWidth = forThumbnail ? 300 : maxWidth;
        const targetQuality = forThumbnail ? 0.6 : quality;
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > targetWidth) {
                    height = Math.round((height * targetWidth) / width);
                    width = targetWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.drawImage(img, 0, 0, width, height);
                
                // Simpan sebagai blob untuk ukuran lebih kecil
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        resolve({
                            base64: reader.result,
                            blob: blob,
                            size: blob.size,
                            width: width,
                            height: height
                        });
                    };
                }, 'image/jpeg', targetQuality);
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
}


        
        function showAlert(_, message, type = 'info') {
            const container = document.getElementById('globalAlertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 4000);
        }
        
        function showToastNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.dataset.type = type;
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.closest('.toast-notification').remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) toast.remove();
            }, 5000);
        }
        

// ==============================================
// INISIALISASI FIREBASE - VERSI BARU
// ==============================================

async function initFirebase() {
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Load Firebase Auth jika belum ada
        if (typeof firebase.auth !== 'function') {
            await loadFirebaseAuth();
        }
        
        // Setup Firestore
        if (typeof firebase.firestore === 'function') {
            db = firebase.firestore();
        }
        
        // Cek koneksi
        if (navigator.onLine) {
            try {
                await db.collection('assets').limit(1).get();
                isFirebaseConnected = true;
                console.log(" Firebase: Connected");
            } catch (error) {
                isFirebaseConnected = false;
                console.warn(" Firebase: Connection failed", error);
            }
        } else {
            isFirebaseConnected = false;
            console.log(" Firebase: Offline");
        }
        
        updateConnectionStatus(isFirebaseConnected);
        return true;
        
    } catch (error) {
        console.error("Firebase init error:", error);
        isFirebaseConnected = false;
        updateConnectionStatus(false);
        return false;
    }
}
// Fungsi untuk memuat Firebase Auth SDK
function loadFirebaseAuth() {
    return new Promise((resolve, reject) => {
        // Cek jika sudah dimuat
        if (typeof firebase.auth === 'function') {
            resolve();
            return;
        }
        
        // Cek jika script sudah ada
        if (document.querySelector('script[src*="firebase-auth"]')) {
            // Tunggu sampai script selesai dimuat
            const checkInterval = setSafeInterval(() => {
                if (typeof firebase.auth === 'function') {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);
            return;
        }
        
        // Load Firebase Auth SDK
        const script = document.createElement('script');
        script.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js";
        script.onload = () => {
            console.log(" Firebase Auth SDK loaded successfully");
            resolve();
        };
        script.onerror = (error) => {
            console.error(" Failed to load Firebase Auth SDK:", error);
            reject(new Error("Failed to load Firebase Auth SDK"));
        };
        document.head.appendChild(script);
    });
}
// ==============================================
// INISIALISASI INDEXEDDB - VERSI 4 (TAMBAH SYNC_METADATA)
// ==============================================

function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const DB_VERSION = 4; // Upgrade ke versi 4
        const request = window.indexedDB.open('assetDB', DB_VERSION);
        
        request.onerror = function(event) {
            console.error(" IndexedDB error:", event.target.error);
            document.getElementById('indexeddbStatus').innerHTML = 
                '<i class="fas fa-database"></i> <span>Database Lokal: Error</span>';
            document.getElementById('indexeddbStatus').className = 'status-badge status-offline';
            
            const fallbackRequest = window.indexedDB.open('assetDB');
            fallbackRequest.onsuccess = function(e) {
                indexedDBInstance = e.target.result;
                console.warn(" Berhasil buka database tanpa version upgrade");
                resolve(indexedDBInstance);
            };
            fallbackRequest.onerror = reject;
        };
        
        request.onsuccess = function(event) {
            indexedDBInstance = event.target.result;
            const currentVersion = indexedDBInstance.version;
            if (currentVersion < DB_VERSION) {
                console.log(` Database version ${currentVersion} perlu upgrade ke ${DB_VERSION}`);
                indexedDBInstance.close();
                initIndexedDB();
                return;
            }
            
            document.getElementById('indexeddbStatus').innerHTML = 
                '<i class="fas fa-database"></i> <span>Database Lokal: Siap</span>';
            resolve(indexedDBInstance);
        };
        
        request.onupgradeneeded = function(event) {
            console.log(` IndexedDB upgrade needed: ${event.oldVersion}  ${event.newVersion}`);
            const db = event.target.result;
            
            // ============= EXISTING STORES =============
            
            // Create users store if it doesn't exist
            if (!db.objectStoreNames.contains('users')) {
                const userStore = db.createObjectStore('users', { keyPath: 'uid' });
                userStore.createIndex('email', 'email', { unique: true });
                userStore.createIndex('nik', 'nik', { unique: true });
                userStore.createIndex('role', 'role', { unique: false });
                console.log(" Created 'users' store");
            }
            
            if (!db.objectStoreNames.contains('assets')) {
                const assetStore = db.createObjectStore('assets', { keyPath: 'id' });
                assetStore.createIndex('syncStatus', 'syncStatus', { unique: false });
                assetStore.createIndex('kondisi', 'kondisi', { unique: false });
                assetStore.createIndex('lokasi', 'lokasi', { unique: false });
                assetStore.createIndex('jenis_item', 'jenis_item', { unique: false });
                console.log(" Created 'assets' store");
            }
            
            if (!db.objectStoreNames.contains('photos')) {
                const photoStore = db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
                photoStore.createIndex('assetId', 'assetId', { unique: false });
                photoStore.createIndex('type', 'type', { unique: false });
                photoStore.createIndex('uploadStatus', 'uploadStatus', { unique: false });
                photoStore.createIndex('timestamp', 'timestamp', { unique: false });
                console.log(" Created 'photos' store");
            }
            
            if (!db.objectStoreNames.contains('backups')) {
                db.createObjectStore('backups', { keyPath: 'timestamp' });
                console.log(" Created 'backups' store");
            }
            
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
                console.log(" Created 'settings' store");
            }
            
            if (!db.objectStoreNames.contains('syncQueue')) {
                const syncStore = db.createObjectStore('syncQueue', { keyPath: 'id' });
                syncStore.createIndex('type', 'type', { unique: false });
                syncStore.createIndex('status', 'status', { unique: false });
                console.log(" Created 'syncQueue' store");
            }
            
            if (!db.objectStoreNames.contains('user_activities')) {
                const activityStore = db.createObjectStore('user_activities', { keyPath: 'timestamp' });
                activityStore.createIndex('user', 'user.uid', { unique: false });
                activityStore.createIndex('action', 'action', { unique: false });
                activityStore.createIndex('date', 'date', { unique: false });
                console.log(" Created 'user_activities' store");
            }
            
            // ============= STORE BARU UNTUK SYNC METADATA =============
            if (!db.objectStoreNames.contains('sync_metadata')) {
                const syncMetaStore = db.createObjectStore('sync_metadata', { keyPath: 'key' });
                console.log(" Created 'sync_metadata' store");
            }
        };
        
        request.onblocked = function(event) {
            console.warn(" IndexedDB upgrade blocked. Tutup tab lain yang menggunakan aplikasi ini.");
            alert(" Tutup tab lain yang menggunakan aplikasi ini, lalu refresh halaman.");
        };
    });
}
        // Load user from IndexedDB
async function loadUserFromIndexedDB(userId) {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            reject(new Error("IndexedDB not initialized"));
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.get(userId);
            
            request.onsuccess = function() {
                resolve(request.result);
            };
            
            request.onerror = function(event) {
                reject(event.target.error);
            };
        } catch (error) {
            reject(error);
        }
    });
}


        // ==============================================
        // MANAJEMEN TEMA
        // ==============================================
        
        function initTheme() {
            document.documentElement.setAttribute('data-theme', theme);
            
            const themeIcon = document.querySelector('#themeToggle i');
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
            
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        }
        
        function toggleTheme() {
            theme = theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.querySelector('#themeToggle i');
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }
        
        // ==============================================
        // CLOUDINARY FUNCTIONS
        // ==============================================
        
        async function loadCloudinarySettings() {
    // Cloudinary selalu aktif
    isCloudinaryEnabled = true;
    updateCloudinaryStatus();
}
        
     // ==============================================
// UPLOAD TO CLOUDINARY DENGAN RETRY MECHANISM
// ==============================================

/**
 * Upload file ke Cloudinary dengan mekanisme retry otomatis
 * @param {File} file - File yang akan diupload
 * @param {string} assetId - ID asset terkait
 * @param {string} type - Tipe foto (utama, rusak, dll)
 * @param {number} maxRetries - Maksimal percobaan (default: 3)
 * @returns {Promise<Object>} Response dari Cloudinary
 */
async function uploadWithRetry(file, assetId, type, maxRetries = 3) {
    let lastError = null;
    
    for (let i = 0; i < maxRetries; i++) {
        try {
            // Hitung delay dengan exponential backoff: 1s, 2s, 4s
            if (i > 0) {
                const delay = 1000 * Math.pow(2, i - 1); // 0, 1000, 2000
                console.log(` Retry ${i}/${maxRetries-1} after ${delay}ms...`);
                await new Promise(r => setTimeout(r, delay));
            }
            
            return await uploadToCloudinary(file, assetId, type);
            
        } catch (error) {
            lastError = error;
            console.warn(` Upload attempt ${i + 1} failed:`, error.message);
            
            // Jika ini percobaan terakhir, throw error
            if (i === maxRetries - 1) {
                console.error(` All ${maxRetries} attempts failed`);
                throw new Error(`Upload gagal setelah ${maxRetries} kali: ${error.message}`);
            }
        }
    }
    
    throw lastError; // Fallback, seharusnya tidak sampai sini
}   
        
        async function uploadToCloudinary(file, assetId, type) {
          if (!requireInternet('Upload ke Cloudinary')) {
        throw new Error("Tidak dapat upload: offline");
    }
            return new Promise((resolve, reject) => {
                if (!isCloudinaryEnabled) {
                    reject(new Error("Cloudinary tidak diaktifkan"));
                    return;
                }
                
                if (!navigator.onLine) {
                    reject(new Error("Tidak terhubung ke internet"));
                    return;
                }
                
                if (!file || !(file instanceof File)) {
                    reject(new Error("File tidak valid"));
                    return;
                }
                
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    reject(new Error(`File terlalu besar (${(file.size / (1024 * 1024)).toFixed(2)}MB). Maksimal 5MB.`));
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.upload_preset);
                formData.append('folder', CLOUDINARY_CONFIG.folder);
                
                const modal = document.getElementById('cloudinaryUploadModal');
                const progressBar = document.getElementById('uploadProgressBar');
                const statusText = document.getElementById('uploadStatus');
                
                modal.classList.add('active');
                progressBar.style.width = '10%';
                statusText.textContent = 'Mempersiapkan upload...';
                
                const uploadTimeout = setTimeout(() => {
                    modal.classList.remove('active');
                    reject(new Error("Upload timeout (30 detik)"));
                }, 30000);
                
                let simulatedProgress = 10;
                const progressInterval = setSafeInterval(() => {
                    if (simulatedProgress < 80) {
                        simulatedProgress += 10;
                        progressBar.style.width = simulatedProgress + '%';
                    }
                }, 500);
                
                fetch(CLOUDINARY_CONFIG.api_url, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    clearInterval(progressInterval);
                    clearTimeout(uploadTimeout);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error.message || 'Cloudinary error');
                    }
                    
                    progressBar.style.width = '100%';
                    statusText.textContent = 'Upload berhasil!';
                    
                    setTimeout(() => {
                        modal.classList.remove('active');
                        resolve({
                            public_id: data.public_id,
                            secure_url: data.secure_url,
                            created_at: data.created_at,
                            width: data.width,
                            height: data.height,
                            bytes: data.bytes,
                            format: data.format,
                            resource_type: data.resource_type,
                            url: data.url
                        });
                    }, 1000);
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    clearTimeout(uploadTimeout);
                    
                    modal.classList.remove('active');
                    console.error("Cloudinary upload error:", error);
                    
                    let errorMessage = error.message;
                    if (errorMessage.includes('Failed to fetch')) {
                        errorMessage = "Gagal terhubung ke Cloudinary. Cek koneksi internet.";
                    } else if (errorMessage.includes('NetworkError')) {
                        errorMessage = "Masalah jaringan. Coba lagi nanti.";
                    }
                    
                    reject(new Error(errorMessage));
                });
            });
        }
        
        
        
        function updateCloudinaryStatus() {
    const statusElement = document.getElementById('cloudinaryStatus');
    const isOnline = navigator.onLine;
    
    if (isOnline) {
        statusElement.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Siap</span>';
        statusElement.className = 'status-badge status-online';
    } else {
        statusElement.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Diblokir</span>';
        statusElement.className = 'status-badge status-offline';
    }
}
        
        // ==============================================
        // SETTINGS MANAGEMENT
        // ==============================================
        
        async function saveSetting(setting) {
            return new Promise((resolve, reject) => {
                const transaction = indexedDBInstance.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                
                const request = store.put(setting);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = reject;
            });
        }
        
        async function getSetting(key) {
            return new Promise((resolve, reject) => {
                const transaction = indexedDBInstance.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                
                const request = store.get(key);
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = reject;
            });
        }
        
        async function loadSettings() {
            try {
                await loadCloudinarySettings();
                
                const settingsToLoad = [
                    { id: 'autoSync', key: 'autoSync', defaultValue: true },
                    { id: 'syncInterval', key: 'syncInterval', defaultValue: '60000' },
                    { id: 'enableCompression', key: 'compression', defaultValue: true }
                ];
                
                for (const setting of settingsToLoad) {
                    try {
                        const saved = await getSetting(setting.key);
                        if (saved !== undefined) {
                            const element = document.getElementById(setting.id);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = saved.value;
                                } else {
                                    element.value = saved.value;
                                }
                            }
                        } else {
                            const element = document.getElementById(setting.id);
                            if (element && element.type === 'checkbox') {
                                element.checked = setting.defaultValue;
                            }
                        }
                    } catch (err) {
                        console.log(`Error loading setting ${setting.key}:`, err);
                    }
                }
                
            } catch (error) {
                console.error("Error loading settings:", error);
            }
        }
// ==============================================
// FUNGSI UPDATE STORAGE - VERSI TRANSACTION (1x BACA)
// ==============================================

async function updateStorageInfo() {
    try {
        console.log(" Menghitung penggunaan penyimpanan...");
        
        if (!indexedDBInstance) {
            console.warn("IndexedDB not ready");
            return;
        }
        
        let totalUsed = 0;
        let photoCount = 0;
        let assetCount = 0;
        let activitiesCount = 0;
        let backupsCount = 0;
        
        //  GUNAKAN SATU TRANSACTION UNTUK BANYAK STORES
        const stores = ['photos', 'assets', 'user_activities', 'settings', 'backups'];
        const transaction = indexedDBInstance.transaction(stores, 'readonly');
        
        // Baca semua store secara parallel
        const [photos, assetsData, activities, settingsArray, backups] = await Promise.all([
            new Promise((resolve) => {
                const req = transaction.objectStore('photos').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            }),
            new Promise((resolve) => {
                const req = transaction.objectStore('assets').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            }),
            new Promise((resolve) => {
                const req = transaction.objectStore('user_activities').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            }),
            new Promise((resolve) => {
                const req = transaction.objectStore('settings').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            }),
            new Promise((resolve) => {
                const req = transaction.objectStore('backups').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            })
        ]);
        
        // Hitung foto
        photoCount = photos.length;
        
        photos.forEach(photo => {
            if (photo.image && photo.image.startsWith('data:')) {
                try {
                    const base64Data = photo.image.split(',')[1];
                    if (base64Data) {
                        const padding = (base64Data.match(/=/g) || []).length;
                        const sizeInBytes = (base64Data.length * 3 / 4) - padding;
                        totalUsed += sizeInBytes;
                    }
                } catch (e) {
                    console.warn("Error menghitung foto:", e);
                }
            }
            
            if (photo.thumbnail && photo.thumbnail.startsWith('data:')) {
                try {
                    const thumbData = photo.thumbnail.split(',')[1];
                    if (thumbData) {
                        const padding = (thumbData.match(/=/g) || []).length;
                        const sizeInBytes = (thumbData.length * 3 / 4) - padding;
                        totalUsed += sizeInBytes * 0.3;
                    }
                } catch (e) {}
            }
        });
        
        // Hitung asset
        assetCount = assetsData.length;
        const assetsJson = JSON.stringify(assetsData);
        totalUsed += new Blob([assetsJson]).size;
        
        // Hitung activities
        activitiesCount = activities.length;
        const activitiesJson = JSON.stringify(activities);
        totalUsed += new Blob([activitiesJson]).size * 0.5;
        
        // Hitung settings
        const settingsObj = {};
        settingsArray.forEach(setting => {
            if (setting.key) settingsObj[setting.key] = setting;
        });
        const settingsJson = JSON.stringify(settingsObj);
        totalUsed += new Blob([settingsJson]).size;
        
        // Hitung backups
        backupsCount = backups.length;
        const backupsJson = JSON.stringify(backups);
        totalUsed += new Blob([backupsJson]).size;
        
        // Konversi ke MB
        const usedMB = totalUsed / (1024 * 1024);
        
        // Dapatkan quota storage
        let totalMB = 50 * 1024; // Default 50GB
        let percent = (usedMB / totalMB * 100).toFixed(1);
        
        if (navigator.storage && navigator.storage.estimate) {
            try {
                const estimate = await navigator.storage.estimate();
                if (estimate.quota) {
                    totalMB = estimate.quota / (1024 * 1024);
                    const usedBytes = estimate.usage || 0;
                    
                    if (usedBytes > 0) {
                        const usedMBFromEstimate = usedBytes / (1024 * 1024);
                        percent = (usedBytes / estimate.quota * 100).toFixed(1);
                        updateStorageUI(usedMBFromEstimate, totalMB, percent, photoCount, assetCount);
                        return;
                    }
                }
            } catch (estimateError) {
                console.warn("Cannot get storage estimate:", estimateError);
            }
        }
        
        // Fallback ke perhitungan manual
        updateStorageUI(usedMB, totalMB, percent, photoCount, assetCount);
        
    } catch (error) {
        console.error(" Error calculating storage:", error);
        document.getElementById('localStorageInfo').innerHTML = 
            '<div style="color: var(--danger); padding: 10px;"> Error menghitung penyimpanan</div>';
    }
}
// Update storage UI dengan informasi detail
function updateStorageUI(usedMB, totalMB, percent, photoCount, assetCount) {
    const storageInfo = document.getElementById('localStorageInfo');
    const storageUsedText = document.getElementById('storageUsedText');
    const storageTotalText = document.getElementById('storageTotalText');
    const storagePercent = document.getElementById('storagePercent');
    const storageProgress = document.getElementById('storageProgress');
    
    if (!storageInfo) return;
    
    // Format numbers
    const formattedUsed = usedMB.toFixed(2);
    const formattedTotal = totalMB.toFixed(2);
    const formattedPercent = parseFloat(percent);
    
    // Determine color based on usage
    let progressColor = 'var(--success)';
    let warningText = '';
    
    if (formattedPercent > 80) {
        progressColor = 'var(--danger)';
        warningText = ' Penyimpanan hampir penuh! Backup dan hapus data lama.';
    } else if (formattedPercent > 60) {
        progressColor = 'var(--warning)';
        warningText = ' Pertimbangkan untuk backup.';
    } else {
        warningText = ' Penyimpanan aman.';
    }
    
    // Update elements
    if (storageUsedText) {
        storageUsedText.textContent = `${formattedUsed} MB`;
    }
    
    if (storageTotalText) {
        storageTotalText.textContent = `${formattedTotal} MB`;
    }
    
    if (storagePercent) {
        storagePercent.textContent = `${formattedPercent}%`;
        storagePercent.style.color = progressColor;
    }
    
    if (storageProgress) {
        storageProgress.style.width = `${Math.min(100, formattedPercent)}%`;
        storageProgress.style.backgroundColor = progressColor;
    }
    
    // Update full info dengan detail
    storageInfo.innerHTML = `
        <div style="margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: 600;">Penyimpanan:</span>
                <span style="color: var(--text-color);">${formattedUsed} MB / ${formattedTotal} MB</span>
            </div>
            <div class="progress-bar" style="height: 10px; background: var(--border-color); border-radius: 5px; overflow: hidden;">
                <div id="storageProgress" class="progress-bar-fill" 
                     style="width: ${Math.min(100, formattedPercent)}%; height: 100%; background: ${progressColor}; transition: width 0.5s ease;">
                </div>
            </div>
            <div style="text-align: center; font-weight: 600; margin-top: 5px; color: ${progressColor};">
                ${formattedPercent}%
            </div>
        </div>
        
        <div style="font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span> Foto tersimpan:</span>
                <span style="font-weight: 600;">${photoCount} file</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span> Total asset:</span>
                <span style="font-weight: 600;">${assetCount} item</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span> Rata-rata per foto:</span>
                <span style="font-weight: 600;">${photoCount > 0 ? (usedMB/photoCount).toFixed(2) : 0} MB</span>
            </div>
        </div>
        
        <div style="font-size: 12px; color: var(--secondary); margin-top: 10px; padding: 8px; background: var(--light); border-radius: 5px;">
            <i class="fas fa-info-circle"></i> ${warningText}
        </div>
    `;
    
    // Update dashboard storage
    const storageUsedElement = document.getElementById('storageUsed');
    if (storageUsedElement) {
        storageUsedElement.textContent = `${formattedUsed} MB`;
    }
}



// Fungsi untuk update user info di settings
function updateSettingsUserInfo() {
    if (!currentUser) return;
    
    const userName = document.getElementById('currentUserName');
    const userRole = document.getElementById('currentUserRole');
    const userLogin = document.getElementById('currentUserLogin');
    
    if (userName) userName.textContent = currentUser.nama || currentUser.email;
    if (userRole) userRole.textContent = currentUser.role === 'owner' ? 'Owner' : 'User';
    
    // Format last login dengan aman
    if (userLogin) {
        let lastLoginText = 'Baru saja';
        
        if (currentUser.lastLogin) {
            try {
                let date;
                const lastLogin = currentUser.lastLogin;
                
                // CASE 1: Firestore Timestamp
                if (lastLogin && typeof lastLogin === 'object' && lastLogin.toDate && typeof lastLogin.toDate === 'function') {
                    date = lastLogin.toDate();
                }
                // CASE 2: Object dengan _seconds (Firestore internal)
                else if (lastLogin && typeof lastLogin === 'object' && lastLogin._seconds) {
                    date = new Date(lastLogin._seconds * 1000);
                }
                // CASE 3: Object dengan seconds
                else if (lastLogin && typeof lastLogin === 'object' && lastLogin.seconds) {
                    date = new Date(lastLogin.seconds * 1000);
                }
                // CASE 4: String ISO
                else if (typeof lastLogin === 'string') {
                    date = new Date(lastLogin);
                }
                // CASE 5: Number timestamp
                else if (typeof lastLogin === 'number') {
                    date = new Date(lastLogin);
                }
                // CASE 6: Date object
                else if (lastLogin instanceof Date) {
                    date = lastLogin;
                }
                
                // Validasi date
                if (date && !isNaN(date.getTime())) {
                    lastLoginText = date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    console.warn("Invalid lastLogin format:", lastLogin);
                }
                
            } catch (error) {
                console.error("Error formatting lastLogin:", error, currentUser.lastLogin);
                // Fallback ke string asli jika ada
                if (typeof currentUser.lastLogin === 'string') {
                    lastLoginText = currentUser.lastLogin;
                }
            }
        }
        
        userLogin.textContent = `Login: ${lastLoginText}`;
    }
    
    // Show/hide owner settings
    const ownerSettings = document.getElementById('ownerSettings');
    if (ownerSettings) {
        ownerSettings.style.display = currentUser.role === 'owner' ? 'block' : 'none';
    }
}
// Fungsi untuk update sync status di settings
function updateSettingsSyncInfo() {
    const firebaseStatusText = document.getElementById('firebaseStatusText');
    const cloudinaryStatusText = document.getElementById('cloudinaryStatusText');
    
    if (firebaseStatusText) {
        firebaseStatusText.innerHTML = isFirebaseConnected ? 
            ' Firebase: Terhubung' : 
            ' Firebase: Offline';
    }
    
    if (cloudinaryStatusText) {
        cloudinaryStatusText.innerHTML = navigator.onLine ? 
            ' Cloudinary: Siap' : 
            ' Cloudinary: Offline';
    }
}

        // ==============================================
        // INDEXEDDB OPERATIONS
        // ==============================================
        
        async function saveAssetToIndexedDB(assetData, syncStatus = 'pending') {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['assets'], 'readwrite');
        const store = transaction.objectStore('assets');
        
        // Pastikan ada semua field yang diperlukan
        const assetWithSync = {
            ...assetData,
            syncStatus: syncStatus,
            lastUpdated: Date.now()
        };
        
        // Validasi data sebelum save
        if (!assetWithSync.id) {
            reject(new Error("Asset ID is required"));
            return;
        }
        
        console.log(" Saving asset to IndexedDB:", assetWithSync.id);
        
        const request = store.put(assetWithSync);
        
        request.onsuccess = function() {
            console.log(" Asset saved to IndexedDB:", assetWithSync.id);
            resolve(assetWithSync);
        };
        
        request.onerror = function(event) {
            console.error(" Error saving to IndexedDB:", event.target.error);
            reject(event.target.error);
        };
        
        transaction.oncomplete = function() {
            console.log(" Transaction completed for asset:", assetWithSync.id);
        };
    });
}
        // ==============================================
// LOAD ASSETS FROM INDEXEDDB ONLY - GANTI DENGAN INI
// ==============================================

// ==============================================
// LOAD ASSETS - PRIORITAS LOKAL
// ==============================================

async function loadAssetsFromIndexedDBOnly() {
    updateSplashStatus('Memuat data dari penyimpanan lokal...');
    
    try {
        assets = await loadAssetsFromIndexedDB();
        console.log(` Loaded ${assets.length} assets from IndexedDB`);
        
        // Hitung pending sync
        pendingSyncAssets = assets.filter(a => a.syncStatus === 'pending');
        
        // Update UI
        updateAssetSelects();
        displayAssets();
        updateDashboard();
        
        updateSplashStatus(`Berhasil memuat ${assets.length} item`, 'Menampilkan data...');
        return assets;
        
    } catch (error) {
        console.error("Error loading from IndexedDB:", error);
        updateSplashStatus('Gagal memuat data lokal', 'Menggunakan mode baru');
        return [];
    }
}

// Load assets dengan auto-sync jika online
async function loadAssets() {
    // Prioritaskan dari lokal (cepat)
    await loadAssetsFromIndexedDBOnly();
    
    // Jika online, sync di background
    if (navigator.onLine && isFirebaseConnected && !isSyncRunning) {
        setTimeout(() => {
            runSyncNow().catch(err => {
                console.warn("Background sync error:", err);
            });
        }, 2000);
    }
    
    return assets;
}
        async function loadAssetsFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = indexedDBInstance.transaction(['assets'], 'readonly');
                const store = transaction.objectStore('assets');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    resolve(request.result || []);
                };
                
                request.onerror = reject;
            });
        }
        
        async function getAllPhotos() {
            return new Promise((resolve, reject) => {
                if (!indexedDB) {
                    console.error("IndexedDB not initialized");
                    resolve([]);
                    return;
                }
                
                try {
                    const transaction = indexedDBInstance.transaction(['photos'], 'readonly');
                    const store = transaction.objectStore('photos');
                    const request = store.getAll();
                    
                    request.onsuccess = function() {
                        const result = request.result || [];
                        resolve(result);
                    };
                    
                    request.onerror = function(event) {
                        console.error("Error getting photos:", event.target.error);
                        reject(event.target.error);
                    };
                    
                    transaction.onerror = function(event) {
                        console.error("Transaction error:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("Exception in getAllPhotos:", error);
                    resolve([]);
                }
            });
        }
        
        async function getAssetPhotos(assetId) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['photos'], 'readonly');
        const store = transaction.objectStore('photos');
        const index = store.index('assetId');
        const request = index.getAll(assetId);
        
        request.onsuccess = function() {
            const photos = request.result || [];
            
            const processedPhotos = photos.map(photo => {
                // OFFLINE-FIRST: Prioritaskan gambar lokal
                let displayUrl = null;
                let source = 'local';
                let isThumbnail = false;
                
                // PRIORITAS 1: Gambar lokal (paling aman)
                if (photo.image) {
                    displayUrl = photo.image;
                    source = 'local';
                }
                // PRIORITAS 2: Thumbnail lokal
                else if (photo.thumbnail) {
                    displayUrl = photo.thumbnail;
                    source = 'local';
                    isThumbnail = true;
                }
                // PRIORITAS 3: Cloudinary (ONLY IF ONLINE)
                else if (photo.cloudinary && photo.cloudinary.secure_url && navigator.onLine) {
                    displayUrl = photo.cloudinary.secure_url;
                    source = 'cloudinary';
                }
                // PRIORITAS 4: Placeholder
                else {
                    displayUrl = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50\' y=\'50\' font-size=\'14\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ENo Image%3C/text%3E%3C/svg%3E';
                    source = 'placeholder';
                }
                
                return {
                    ...photo,
                    displayUrl: displayUrl,
                    source: source,
                    isThumbnail: isThumbnail,
                    hasCloudinary: !!(photo.cloudinary),
                    hasLocal: !!(photo.image || photo.thumbnail),
                    // Tambah info untuk UI
                    canLoadFull: !!(photo.cloudinary || photo.image)
                };
            });
            
            resolve(processedPhotos);
        };
        
        request.onerror = function(event) {
            console.error("Error getting photos:", event.target.error);
            resolve([]); // Jangan reject, kasih array kosong
        };
    });
}
async function cleanupOldPhotos() {
    // Hapus foto yang sudah diupload ke Cloudinary dan sudah lebih dari 30 hari
    const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
    const now = Date.now();
    
    const allPhotos = await getAllPhotos();
    let deletedCount = 0;
    
    for (const photo of allPhotos) {
        // Jika sudah diupload ke Cloudinary dan sudah lama
        if (photo.cloudinary && photo.uploadStatus === 'UPLOADED') {
            const photoAge = now - photo.timestamp;
            
            // Hapus jika lebih dari 30 hari
            if (photoAge > THIRTY_DAYS) {
                await deletePhoto(photo.id);
                deletedCount++;
            }
            // Atau jika hanya thumbnail (sudah tidak punya gambar penuh)
            else if (photo.cloudinaryOnly) {
                await deletePhoto(photo.id);
                deletedCount++;
            }
        }
    }
    
    
    showToastNotification(` Cleaned up ${deletedCount} old photos`);
    return deletedCount;
}

async function deletePhoto(photoId) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['photos'], 'readwrite');
        const store = transaction.objectStore('photos');
        const request = store.delete(photoId);
        
        request.onsuccess = resolve;
        request.onerror = reject;
    });
}
// Fungsi untuk membersihkan foto orphan (tanpa asset)
async function cleanupOrphanPhotos() {
    const allPhotos = await getAllPhotos();
    const assetIds = new Set(assets.map(a => a.id));
    let deletedCount = 0;
    
    for (const photo of allPhotos) {
        if (!assetIds.has(photo.assetId)) {
            await deletePhoto(photo.id);
            deletedCount++;
        }
    }
    
    console.log(` Cleaned up ${deletedCount} orphan photos`);
    return deletedCount;
}


// Jalankan cleanup secara periodik
setSafeInterval(cleanupOldPhotos, 7 * 24 * 60 * 60 * 1000); // Seminggu sekali //
// ==============================================
// FUNGSI SYNC METADATA - TIMESTAMP PULL TERAKHIR
// ==============================================

// Ambil timestamp pull terakhir dari IndexedDB
async function getLastPullTimestamp() {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve(0);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['sync_metadata'], 'readonly');
            const store = transaction.objectStore('sync_metadata');
            const request = store.get('lastPullTimestamp');
            
            request.onsuccess = () => {
                resolve(request.result?.value || 0);
            };
            
            request.onerror = () => resolve(0);
        } catch {
            resolve(0);
        }
    });
}

// Simpan timestamp pull terakhir
async function saveLastPullTimestamp(timestamp) {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve();
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['sync_metadata'], 'readwrite');
            const store = transaction.objectStore('sync_metadata');
            
            store.put({
                key: 'lastPullTimestamp',
                value: timestamp,
                updatedAt: Date.now()
            });
            
            transaction.oncomplete = () => {
                console.log(` Saved last pull timestamp: ${new Date(timestamp).toISOString()}`);
                resolve();
            };
            
            transaction.onerror = (e) => {
                console.warn("Error saving last pull timestamp:", e);
                resolve();
            };
        } catch (error) {
            console.warn("Error in saveLastPullTimestamp:", error);
            resolve();
        }
    });
}

// Ambil daftar pending sync dari IndexedDB (gunakan index)
async function getPendingAssets() {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            resolve([]);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['assets'], 'readonly');
            const store = transaction.objectStore('assets');
            
            if (store.indexNames.contains('syncStatus')) {
                const index = store.index('syncStatus');
                const request = index.getAll('pending');
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = (e) => {
                    console.error("Error getting pending assets from index:", e);
                    // Fallback: filter manual
                    const allRequest = store.getAll();
                    allRequest.onsuccess = () => {
                        const all = allRequest.result || [];
                        resolve(all.filter(a => a.syncStatus === 'pending'));
                    };
                };
            } else {
                // Fallback
                const allRequest = store.getAll();
                allRequest.onsuccess = () => {
                    const all = allRequest.result || [];
                    resolve(all.filter(a => a.syncStatus === 'pending'));
                };
            }
        } catch (error) {
            console.error("Exception in getPendingAssets:", error);
            resolve([]);
        }
    });
}

// Simpan batch asset ke IndexedDB (untuk first time sync)
async function saveAssetBatchToIndexedDB(assets) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['assets'], 'readwrite');
        const store = transaction.objectStore('assets');
        
        let completed = 0;
        let hasError = false;
        
        assets.forEach(asset => {
            const request = store.put(asset);
            
            request.onsuccess = () => {
                completed++;
                if (completed === assets.length && !hasError) {
                    resolve();
                }
            };
            
            request.onerror = (e) => {
                hasError = true;
                console.error("Error saving asset batch:", e);
                reject(e.target.error);
            };
        });
        
        transaction.onerror = (e) => {
            if (!hasError) {
                reject(e.target.error);
            }
        };
    });
}
        // ==============================================
        // FIRESTORE OPERATIONS
        // ==============================================
        // ==============================================
// FIRESTORE SYNC METADATA OPERATIONS
// ==============================================

const SYNC_META_COLLECTION = 'sync_meta';
const SYNC_META_DOC = 'assets_changelog';

// Ambil metadata sync dari cloud
async function getCloudSyncMetadata() {
    if (!navigator.onLine || !isFirebaseConnected || !db) {
        return null;
    }
    
    try {
        const docRef = db.collection(SYNC_META_COLLECTION).doc(SYNC_META_DOC);
        const doc = await docRef.get();
        
        if (doc.exists) {
            return doc.data();
        } else {
            // Buat dokumen metadata jika belum ada
            const initialMeta = {
                lastGlobalUpdate: 0,
                changedAssets: [],
                changedCount: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await docRef.set(initialMeta);
            return initialMeta;
        }
    } catch (error) {
        console.error("Error getting cloud sync metadata:", error);
        return null;
    }
}

// Update metadata cloud setelah batch write
async function updateCloudSyncMetadata(assetIds = []) {
    if (!navigator.onLine || !isFirebaseConnected || !db) {
        console.log(" Cannot update sync metadata: offline");
        return;
    }
    
    try {
        const metaRef = db.collection(SYNC_META_COLLECTION).doc(SYNC_META_DOC);
        const now = Date.now();
        
        if (assetIds.length === 0) {
            // Hanya update timestamp
            await metaRef.set({
                lastGlobalUpdate: now,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        } else {
            // Update timestamp + tambah daftar asset yang berubah
            const batch = db.batch();
            
            batch.set(metaRef, {
                lastGlobalUpdate: now,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // Tambah setiap asset ke array changedAssets
            assetIds.forEach(assetId => {
                batch.update(metaRef, {
                    changedAssets: firebase.firestore.FieldValue.arrayUnion(assetId),
                    changedCount: firebase.firestore.FieldValue.increment(1)
                });
            });
            
            await batch.commit();
        }
        
        console.log(` Updated sync metadata with ${assetIds.length} assets`);
        
    } catch (error) {
        console.error(" Error updating sync metadata:", error);
    }
}

// ==============================================
// RESET METADATA CLOUD - VERSI DENGAN UPDATE TIMESTAMP
// ==============================================

async function resetCloudSyncMetadata(keepTimestamp = true) {
    if (!navigator.onLine || !isFirebaseConnected || !db) {
        return;
    }
    
    try {
        const metaRef = db.collection(SYNC_META_COLLECTION).doc(SYNC_META_DOC);
        
        if (keepTimestamp) {
            // Hanya kosongkan array, pertahankan timestamp
            await metaRef.update({
                changedAssets: [],
                changedCount: 0,
                lastReset: firebase.firestore.FieldValue.serverTimestamp(),
                //  TAMBAHKAN INI UNTUK UPDATE TIMESTAMP GLOBAL
                lastGlobalUpdate: Date.now()
            });
        } else {
            // Reset total
            await metaRef.set({
                lastGlobalUpdate: Date.now(),
                changedAssets: [],
                changedCount: 0,
                lastReset: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
        
        console.log(" Reset sync metadata - changedAssets cleared, lastGlobalUpdate updated");
        
    } catch (error) {
        console.error("Error resetting sync metadata:", error);
    }
}

// Hapus asset tertentu dari daftar changedAssets (jika ada error)
async function removeFromChangedAssets(assetIds) {
    if (!navigator.onLine || !isFirebaseConnected || !db || !assetIds.length) {
        return;
    }
    
    try {
        const metaRef = db.collection(SYNC_META_COLLECTION).doc(SYNC_META_DOC);
        const batch = db.batch();
        
        assetIds.forEach(assetId => {
            batch.update(metaRef, {
                changedAssets: firebase.firestore.FieldValue.arrayRemove(assetId),
                changedCount: firebase.firestore.FieldValue.increment(-1)
            });
        });
        
        await batch.commit();
        console.log(` Removed ${assetIds.length} assets from changed list`);
        
    } catch (error) {
        console.error("Error removing from changedAssets:", error);
    }
}
        // ==============================================
// MODIFIED: saveAssetToFirestore dengan dukungan transaction
// ==============================================

async function saveAssetToFirestore(assetData, transaction = null) {
    if (!navigator.onLine) {
        console.warn(" Cannot save to Firestore: offline");
        throw new Error("Tidak dapat menyimpan ke cloud: offline");
    }
    
    if (!isFirebaseConnected) {
        throw new Error("Firebase tidak terhubung");
    }
    
    try {
        // Pisahkan field yang tidak perlu untuk Firestore
        const { syncStatus, lastUpdated, ...firestoreData } = assetData;
        
        // Get photos untuk asset ini
        const photos = await getAssetPhotos(assetData.id);
        
        // Siapkan data foto untuk Firestore
        const photoData = photos.map(photo => {
            const photoForFirestore = {
                type: photo.type,
                tanggal: photo.tanggal,
                timestamp: photo.timestamp,
                uploadStatus: photo.uploadStatus || 'LOCAL'
            };
            
            if (photo.cloudinary) {
                photoForFirestore.cloudinary = {
                    secure_url: photo.cloudinary.secure_url,
                    public_id: photo.cloudinary.public_id,
                    created_at: photo.cloudinary.created_at
                };
            }
            
            if (photo.uploaded_by) {
                photoForFirestore.uploaded_by = photo.uploaded_by;
            }
            
            return photoForFirestore;
        });
        
        // Tambahkan foto ke data asset
        const assetWithPhotos = {
            ...firestoreData,
            photos: photoData,
            lastPhotoSync: Date.now()
        };
        
        // Save ke Firestore dengan atau tanpa transaction
        const assetRef = db.collection('assets').doc(assetWithPhotos.id);
        
        if (transaction) {
            // Gunakan transaction yang sudah ada
            transaction.set(assetRef, assetWithPhotos, { merge: true });
        } else {
            // Tanpa transaction
            await assetRef.set(assetWithPhotos, { merge: true });
        }
        
        console.log(` Asset ${assetData.id} saved to Firestore with ${photoData.length} photos`);
        return assetData.id;
        
    } catch (error) {
        console.error(" Error saving to Firestore:", error);
        
        if (error.code === 'failed-precondition') {
            throw new Error("Database Firestore belum diinisialisasi");
        } else if (error.code === 'permission-denied') {
            throw new Error("Tidak ada izin menulis ke Firestore");
        } else {
            throw error;
        }
    }
}
        
// ==============================================
// FIRST TIME SYNC - VERSI DENGAN ERROR HANDLING FOTO
// ==============================================

// ==============================================
// FIRST TIME SYNC - VERSI DENGAN PROGRESS STEPS
// ==============================================

async function firstTimeSyncFromCloud() {
    if (!navigator.onLine || !isFirebaseConnected) {
        console.log(" Cannot first time sync: offline");
        return [];
    }
    
    showProgressOverlay('first_sync', {
        title: 'Sinkronisasi Awal',
        subtitle: 'Mengunduh semua data dari cloud...'
    });
    
    try {
        // STEP 1: Ambil SEMUA asset
        updateProgressStep('fetch_assets', 'active');
        updateProgressText('Mengunduh data asset...');
        updateProgressBar(10);
        
        const snapshot = await db.collection('assets').get();
        const allAssets = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            syncStatus: 'synced'
        }));
        
        updateProgressStep('fetch_assets', 'completed');
        console.log(` Downloaded ${allAssets.length} assets from cloud`);
        
        // STEP 2: Simpan asset ke IndexedDB
        updateProgressStep('save_assets', 'active');
        updateProgressText(`Menyimpan ${allAssets.length} asset...`);
        updateProgressBar(30);
        
        await saveAssetBatchToIndexedDB(allAssets);
        updateProgressStep('save_assets', 'completed');
        
        // STEP 3: EKSTRAK DAN SIMPAN FOTO
        updateProgressStep('process_photos', 'active');
        updateProgressText('Memproses foto...');
        updateProgressBar(50);
        
        let photoCount = 0;
        let photoErrorCount = 0;
        const BATCH_SIZE = 20;
        
        for (let i = 0; i < allAssets.length; i++) {
            const asset = allAssets[i];
            
            // Update progress setiap 20 asset
            if (i % BATCH_SIZE === 0) {
                const progress = 50 + ((i + 1) / allAssets.length) * 30;
                updateProgressBar(progress);
                updateProgressText(`Memproses foto asset ${i+1}/${allAssets.length}...`);
            }
            
            if (asset.photos && Array.isArray(asset.photos) && asset.photos.length > 0) {
                for (const photoData of asset.photos) {
                    try {
                        const photo = {
                            assetId: asset.id,
                            type: photoData.type || 'utama',
                            timestamp: photoData.timestamp || Date.now(),
                            tanggal: photoData.tanggal || new Date().toISOString(),
                            uploadStatus: 'UPLOADED',
                            cloudinary: photoData.cloudinary || null,
                            source: 'firestore_sync'
                        };
                        
                        await new Promise((resolve, reject) => {
                            const transaction = indexedDBInstance.transaction(['photos'], 'readwrite');
                            const store = transaction.objectStore('photos');
                            const request = store.add(photo);
                            
                            request.onsuccess = () => {
                                photoCount++;
                                resolve();
                            };
                            
                            request.onerror = (e) => {
                                console.warn(`Error saving photo:`, e);
                                photoErrorCount++;
                                resolve();
                            };
                        });
                    } catch (photoError) {
                        console.error(`Failed to process photo:`, photoError);
                        photoErrorCount++;
                    }
                }
            }
        }
        
        updateProgressStep('process_photos', 'completed');
        updateProgressBar(80);
        
        // STEP 4: Update timestamp
        updateProgressStep('update_metadata', 'active');
        updateProgressText('Memperbarui metadata...');
        
        let maxUpdatedAt = 0;
        allAssets.forEach(asset => {
            const assetTime = asset.updatedAt || asset.lastUpdated || 0;
            if (assetTime > maxUpdatedAt) maxUpdatedAt = assetTime;
        });
        
        if (maxUpdatedAt > 0) {
            await saveLastPullTimestamp(maxUpdatedAt);
        }
        
        await updateCloudSyncMetadata([]);
        updateProgressStep('update_metadata', 'completed');
        updateProgressBar(95);
        
        // STEP 5: Finalisasi
        updateProgressStep('finalize', 'active');
        updateProgressText('Menyelesaikan...');
        
        await initPhotoCache();
        updateProgressStep('finalize', 'completed');
        updateProgressBar(100);
        
        console.log(` First time sync: ${allAssets.length} assets, ${photoCount} photos (${photoErrorCount} errors)`);
        
        const message = photoErrorCount > 0 
            ? ` Sinkronisasi awal: ${allAssets.length} asset, ${photoCount} foto (${photoErrorCount} gagal)`
            : ` Sinkronisasi awal selesai: ${allAssets.length} asset, ${photoCount} foto`;
        
        showToastNotification(message, photoErrorCount > 0 ? 'warning' : 'success');
        
        return allAssets;
        
    } catch (error) {
        console.error(" First time sync error:", error);
        showToastNotification(' Gagal sinkronisasi awal', 'danger');
        throw error;
    } finally {
        hideProgressOverlay();
    }
}

async function pullChangesFromCloud(lastPullTimestamp) {
    if (!navigator.onLine || !isFirebaseConnected) {
        console.log(" Cannot pull changes: offline");
        return [];
    }
    
    console.log(` Pulling changes since ${new Date(lastPullTimestamp).toISOString()}`);
    
    try {
        //  QUERY DENGAN updatedAt (field utama)
        const snapshot = await db.collection('assets')
            .where('updatedAt', '>', lastPullTimestamp)
            .get();
        
        const changedAssets = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                ...data,
                //  PASTIKAN KEDUA FIELD ADA
                updatedAt: data.updatedAt || data.lastUpdated || 0,
                lastUpdated: data.lastUpdated || data.updatedAt || 0,
                syncStatus: 'synced'
            };
        });
        
        console.log(` Found ${changedAssets.length} changed assets`);
        return changedAssets;
        
    } catch (error) {
        console.error("Error pulling changes:", error);
        
        // Fallback: cek metadata dulu
        try {
            const meta = await getCloudSyncMetadata();
            if (meta && meta.changedAssets && meta.changedAssets.length > 0) {
                // Ambil satu per satu berdasarkan ID
                const assets = [];
                for (const assetId of meta.changedAssets.slice(0, 50)) {
                    const doc = await db.collection('assets').doc(assetId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        assets.push({
                            id: doc.id,
                            ...data,
                            updatedAt: data.updatedAt || data.lastUpdated || 0,
                            lastUpdated: data.lastUpdated || data.updatedAt || 0,
                            syncStatus: 'synced'
                        });
                    }
                }
                return assets;
            }
        } catch (fallbackError) {
            console.error("Fallback also failed:", fallbackError);
        }
        
        return [];
    }
}
// Proses perubahan dari cloud (resolve konflik)
async function processCloudChanges(cloudAssets) {
    let newCount = 0;
    let updateCount = 0;
    let conflictCount = 0;
    
    for (const cloudAsset of cloudAssets) {
        // Cari di data lokal (assets array global)
        const localAsset = assets.find(a => a.id === cloudAsset.id);
        
        if (!localAsset) {
            // ASSET BARU: langsung simpan
            await saveAssetToIndexedDB(cloudAsset, 'synced');
            newCount++;
            
        } else {
            // ASSET LAMA: bandingkan timestamp
            const cloudTime = cloudAsset.updatedAt || cloudAsset.lastUpdated || 0;
            const localTime = localAsset.updatedAt || localAsset.lastUpdated || 0;
            
            if (cloudTime > localTime) {
                // Cloud lebih baru
                if (localAsset.syncStatus === 'pending') {
                    // KONFLIK! Cloud lebih baru, TAPI lokal pending
                    console.warn(` Conflict: asset ${cloudAsset.id} changed in both places`);
                    
                    // Tampilkan modal konflik
                    const resolution = await showSimpleConflictModal(localAsset, cloudAsset);
                    
                    if (resolution === 'useCloud') {
                        // Timpa lokal dengan cloud
                        await saveAssetToIndexedDB({
                            ...cloudAsset,
                            syncStatus: 'synced'
                        }, 'synced');
                        conflictCount++;
                    }
                    // else 'useLocal': pertahankan lokal (akan di-upload nanti)
                    
                } else {
                    // AMAN: cloud lebih baru, lokal tidak pending
                    await saveAssetToIndexedDB({
                        ...cloudAsset,
                        syncStatus: 'synced'
                    }, 'synced');
                    updateCount++;
                }
            }
            // else: lokal sudah up-to-date atau lebih baru, skip
        }
    }
    
    console.log(` Cloud changes: ${newCount} new, ${updateCount} updated, ${conflictCount} conflicts`);
    return { newCount, updateCount, conflictCount };
}
        // ==============================================
// MODAL KONFLIK SEDERHANA
// ==============================================

// ==============================================
// MODAL KONFLIK SEDERHANA - VERSI DENGAN UNIQUE FUNCTION
// ==============================================

async function showSimpleConflictModal(localAsset, cloudAsset) {
    return new Promise((resolve) => {
        const modalId = 'conflictModal_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        const resolveFuncName = `resolveConflict_${modalId}`;
        
        const formatDate = (ts) => {
            if (!ts) return 'Tidak diketahui';
            try {
                return new Date(ts).toLocaleString('id-ID');
            } catch {
                return String(ts);
            }
        };
        
        const localTime = formatDate(localAsset.updatedAt || localAsset.lastUpdated);
        const cloudTime = formatDate(cloudAsset.updatedAt || cloudAsset.lastUpdated);
        
        const localUser = localAsset.updated_by?.nama || localAsset.updatedByName || 'Anda';
        const cloudUser = cloudAsset.updated_by?.nama || cloudAsset.updatedByName || 'User lain';
        
        const modalHTML = `
            <div class="modal active" id="${modalId}">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title"> Konflik Data</div>
                        <span class="close-modal" onclick="document.getElementById('${modalId}').remove(); window.${resolveFuncName}('cancel')">&times;</span>
                    </div>
                    
                    <div style="padding: 20px;">
                        <p><strong>${localAsset.nama_asset || 'Item'}</strong> telah diubah di dua tempat:</p>
                        
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--warning);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><i class="fas fa-database"></i> <strong>Versi Lokal (Anda)</strong></span>
                                <span class="badge badge-warning">Pending</span>
                            </div>
                            <div> ${localTime}</div>
                            <div> ${localUser}</div>
                            <div> Kondisi: ${localAsset.kondisi || '-'}</div>
                            <div> Lokasi: ${localAsset.lokasi || '-'}</div>
                        </div>
                        
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--info);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><i class="fas fa-cloud"></i> <strong>Versi Cloud</strong></span>
                                <span class="badge badge-info">Terbaru</span>
                            </div>
                            <div> ${cloudTime}</div>
                            <div> ${cloudUser}</div>
                            <div> Kondisi: ${cloudAsset.kondisi || '-'}</div>
                            <div> Lokasi: ${cloudAsset.lokasi || '-'}</div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-info" style="flex:1" onclick="${resolveFuncName}('useCloud')">
                                <i class="fas fa-cloud"></i> Pakai Cloud
                            </button>
                            <button class="btn btn-warning" style="flex:1" onclick="${resolveFuncName}('useLocal')">
                                <i class="fas fa-database"></i> Pakai Lokal
                            </button>
                        </div>
                        
                        <p style="margin-top: 15px; font-size: 12px; color: var(--secondary);">
                            <i class="fas fa-info-circle"></i> Memilih Cloud akan MENIMPA data lokal Anda.
                            Memilih Lokal akan MENGUPDATE data cloud.
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        //  SIMPAN FUNGSI DI WINDOW DENGAN NAMA UNIK
        window[resolveFuncName] = (choice) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
            delete window[resolveFuncName];
            resolve(choice);
        };
        
        // Auto-remove jika modal ditutup dengan cara lain
        const checkInterval = setSafeInterval(() => {
            if (!document.getElementById(modalId)) {
                clearInterval(checkInterval);
                if (window[resolveFuncName]) {
                    delete window[resolveFuncName];
                    resolve('cancel');
                }
            }
        }, 500);
    });
}
        // ==============================================
        // SYNC FUNCTIONS
        // ==============================================
        


// ==============================================
// SYNC ENGINE BARU - METADATA BASED
// ==============================================

let isSyncRunning = false;
let syncStartTime = null;

// Tampilkan progress sync
function showSyncProgress(show = true, message = 'Menyinkronkan...', percent = null) {
    const indicator = document.getElementById('syncProgressIndicator');
    const textEl = document.getElementById('syncProgressText');
    const percentEl = document.getElementById('syncProgressPercent');
    const syncBtn = document.getElementById('btnSyncNow');
    
    if (!indicator) return;
    
    if (show) {
        indicator.style.display = 'flex';
        if (textEl) textEl.textContent = message;
        
        if (percent !== null && percentEl) {
            percentEl.textContent = `${percent}%`;
            percentEl.style.display = 'inline';
        } else if (percentEl) {
            percentEl.style.display = 'none';
        }
        
        indicator.classList.remove('sync-complete', 'sync-error');
        indicator.classList.add('sync-active');
        
        if (syncBtn) {
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px;"></div> Syncing...';
        }
    } else {
        indicator.style.display = 'none';
        indicator.classList.remove('sync-active', 'sync-complete', 'sync-error');
        
        if (syncBtn) {
            syncBtn.disabled = false;
            syncBtn.innerHTML = '<i class="fas fa-sync"></i> Sync Now';
        }
    }
}

// ==============================================
// SYNC ENGINE - VERSI OPTIMAL (TANPA READ GANDA)
// ==============================================

async function runSyncNow() {
    if (!requireInternet('Sinkronisasi')) return;
    
    if (isSyncRunning) {
        showToastNotification(' Sinkronisasi masih berjalan', 'info');
        return;
    }

    if (!navigator.onLine || !isFirebaseConnected) {
        showToastNotification(' Tidak dapat sync (offline)', 'warning');
        return;
    }

    isSyncRunning = true;
    syncStartTime = Date.now();
    
    showSyncProgress(true, 'Memulai sinkronisasi...', 0);
    updateSyncStatus(true);

    try {
        console.log(" Metadata-based sync dimulai...");
        
        // =============================================
        // STEP 1: CEK METADATA CLOUD (1 READ)
        // =============================================
        showSyncProgress(true, 'Mengecek perubahan...', 10);
        
        const cloudMeta = await getCloudSyncMetadata();
        const localLastPull = await getLastPullTimestamp(); //  SIMPAN SEKALI
        
        // =============================================
        // STEP 2: PUSH PERUBAHAN LOKAL (UPLOAD)
        // =============================================
        showSyncProgress(true, 'Mengupload perubahan lokal...', 20);
        
        const pendingAssets = await getPendingAssets();
        let uploadedIds = [];
        
        if (pendingAssets.length > 0) {
            console.log(` Uploading ${pendingAssets.length} pending assets...`);
            
            for (let i = 0; i < pendingAssets.length; i++) {
                const asset = pendingAssets[i];
                
                try {
                    // Cek konflik dengan cloud
                    if (cloudMeta && cloudMeta.lastGlobalUpdate > localLastPull) {
                        const cloudDoc = await db.collection('assets').doc(asset.id).get();
                        
                        if (cloudDoc.exists) {
                            const cloudData = cloudDoc.data();
                            const cloudTime = cloudData.updatedAt || cloudData.lastUpdated || 0;
                            const localTime = asset.updatedAt || asset.lastUpdated || 0;
                            
                            if (cloudTime > localTime) {
                                // Konflik!
                                console.warn(` Conflict detected for ${asset.id}`);
                                
                                const resolution = await showSimpleConflictModal(asset, cloudData);
                                
                                if (resolution === 'useCloud') {
                                    // Pakai cloud, update lokal
                                    await saveAssetToIndexedDB({
                                        ...cloudData,
                                        syncStatus: 'synced'
                                    }, 'synced');
                                    continue; // Skip upload
                                }
                                // else 'useLocal': lanjut upload (akan override)
                            }
                        }
                    }
                    
                    // Upload ke Firestore
                    const { syncStatus, ...firestoreData } = asset;
                    await db.collection('assets').doc(asset.id).set(firestoreData, { merge: true });
                    
                    // Update status lokal
                    await updateAssetSyncStatus(asset.id, 'synced');
                    uploadedIds.push(asset.id);
                    
                } catch (assetError) {
                    console.error(` Failed to upload ${asset.id}:`, assetError);
                }
                
                // Update progress
                const percent = 20 + ((i + 1) / pendingAssets.length) * 30;
                showSyncProgress(true, `Mengupload ${i+1}/${pendingAssets.length}...`, percent);
            }
            
            // Update metadata cloud dengan asset yang baru diupload
            if (uploadedIds.length > 0) {
                await updateCloudSyncMetadata(uploadedIds);
            }
        }
        
        // =============================================
        // STEP 3: PULL PERUBAHAN DARI CLOUD (DOWNLOAD)
        // =============================================
        showSyncProgress(true, 'Mengambil perubahan dari cloud...', 60);
        
        //  GUNAKAN localLastPull YANG SUDAH DISIMPAN, BUKAN BACA ULANG
        const updatedCloudMeta = await getCloudSyncMetadata();
        
        if (updatedCloudMeta && updatedCloudMeta.lastGlobalUpdate > localLastPull) {
            console.log(` Cloud has newer data (${updatedCloudMeta.lastGlobalUpdate} > ${localLastPull})`);
            
            // Ambil perubahan dari cloud (delta based)
            const cloudChanges = await pullChangesFromCloud(localLastPull);
            
            if (cloudChanges.length > 0) {
                // Proses perubahan (resolve konflik)
                await processCloudChanges(cloudChanges);
                
                // Cari timestamp terbesar
                const maxTimestamp = Math.max(
                    ...cloudChanges.map(c => c.updatedAt || c.lastUpdated || 0)
                );
                
                if (maxTimestamp > 0) {
                    await saveLastPullTimestamp(maxTimestamp);
                }
            }
            
            // Reset metadata cloud (kosongkan changedAssets)
            await resetCloudSyncMetadata(true);
            
            //  UPDATE TIMESTAMP DI METADATA CLOUD JUGA
            await db.collection('sync_meta').doc('assets_changelog').update({
                lastGlobalUpdate: Date.now()
            }).catch(err => console.warn("Failed to update lastGlobalUpdate:", err));
        }
        
        // =============================================
        // STEP 4: RELOAD DATA DAN UPDATE UI
        // =============================================
        showSyncProgress(true, 'Memuat ulang data...', 90);
        
        await loadAssetsFromIndexedDBOnly();
        updateDashboard();
        
        // =============================================
        // SELESAI
        // =============================================
        const syncTime = ((Date.now() - syncStartTime) / 1000).toFixed(1);
        
        showSyncProgress(true, `Selesai dalam ${syncTime}s`, 100);
        
        setTimeout(() => {
            showSyncProgress(false);
        }, 2000);
        
        showToastNotification(
            ` Sinkronisasi selesai (${pendingAssets.length} upload, ${uploadedIds.length} sukses)`,
            'success'
        );

        lastSyncTime = new Date();
        const lastEl = document.getElementById('lastSyncTime');
        if (lastEl) lastEl.textContent = lastSyncTime.toLocaleString();

    } catch (e) {
        console.error(" Sync error:", e);
        
        showSyncProgress(true, 'Sync gagal', 0);
        setTimeout(() => showSyncProgress(false), 2000);
        
        showToastNotification(` Sync gagal: ${e.message}`, 'danger');

    } finally {
        isSyncRunning = false;
        updateSyncStatus(false);
    }
}
// ==============================================
// FUNGSI GET PENDING PHOTOS - VERSI FINAL (TANPA FALLBACK)
// ==============================================

async function getPendingPhotos() {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            resolve([]);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');
            
            //  CEK INDEX, TAPI TIDAK PAKAI FALLBACK
            if (!store.indexNames.contains('uploadStatus')) {
                console.error("uploadStatus index not found in IndexedDB");
                resolve([]);
                return;
            }
            
            const index = store.index('uploadStatus');
            const request = index.getAll('PENDING');
            
            request.onsuccess = function() {
                resolve(request.result || []);
            };
            
            request.onerror = function(event) {
                console.error("Error getting pending photos:", event.target.error);
                reject(event.target.error);
            };
            
        } catch (error) {
            console.error("Exception in getPendingPhotos:", error);
            reject(error);
        }
    });
}
           


// Get asset from IndexedDB
async function getAssetFromIndexedDB(assetId) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['assets'], 'readonly');
        const store = transaction.objectStore('assets');
        const request = store.get(assetId);
        
        request.onsuccess = function() {
            resolve(request.result);
        };
        
        request.onerror = reject;
    });
}


      function updateSyncStatus(active) {
    const el = document.getElementById('syncStatus');
    if (!el) return;
    
    if (active) {
        el.className = 'status-badge status-info';
        el.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> <span>Sinkronisasi: Berjalan</span>';
    } else {
        el.className = isFirebaseConnected ? 'status-badge status-online' : 'status-badge status-offline';
        el.innerHTML = isFirebaseConnected
            ? '<i class="fas fa-check-circle"></i> <span>Sinkronisasi: Siap</span>'
            : '<i class="fas fa-times-circle"></i> <span>Sinkronisasi: Offline</span>';
    }
}




        // ==============================================
        // ASSET MANAGEMENT
        // ==============================================
        

    

        // ==============================================
        // PREVIEW & SAVE FUNCTIONS
        // ==============================================

function normalizeValue(val, options = {}) {
    const {
        trim = true,
        removeSpaces = true,
        toUpper = true,
        toLower = false
    } = options;
    
    let result = (val || '').toString();
    
    if (trim) result = result.trim();
    if (removeSpaces) result = result.replace(/\s+/g, '');
    if (toUpper) result = result.toUpperCase();
    if (toLower) result = result.toLowerCase();
    
    return result;
}

function checkDuplicateAsset(materialKode, noRS) {
    const normMaterial = normalizeValue(materialKode);
    const normRS = normalizeValue(noRS);

    return assets.find(a =>
        normalizeValue(a.material_kode) === normMaterial &&
        normalizeValue(a.no_rs) === normRS
    );
}

        function showDataPreview() {
            const jenisItem = document.getElementById('jenis_item').value;
            const nama = document.getElementById('nama_asset').value;
            const materialKode = document.getElementById('material_kode').value;
            const noRS = document.getElementById('no_rs').value;
            const noPO = document.getElementById('no_po').value;
            const noAsset = document.getElementById('no_asset').value;
            const lokasi = document.getElementById('lokasi').value;
            const kondisi = document.getElementById('kondisi').value;
            const catatan = document.getElementById('catatan_awal').value;
            const jumlah = document.getElementById('jumlah').value || '1';
            const fotoFiles = document.getElementById('foto_utama').files;
            
            if (!jenisItem || !nama || !materialKode || !noRS || !lokasi || !kondisi || fotoFiles.length === 0) {
                showAlert('addAssetAlert', 'Harap lengkapi semua field wajib!', 'danger');
                return;
                
            }
            // ===============================
// CEK DUPLIKAT MATERIAL + NO RS
// ===============================
const duplicate = checkDuplicateAsset(materialKode, noRS);

if (duplicate) {

    showAlert(
        'addAssetAlert',
        `
         ASSET SUDAH ADA , CHECK DI DETAIL ITEM!<br><br>
        <strong>Material Code:</strong> ${duplicate.material_kode}<br>
        <strong>No RS:</strong> ${duplicate.no_rs}<br>
        <strong>Nama:</strong> ${duplicate.nama_asset}<br>
        <strong>Lokasi:</strong> ${duplicate.lokasi}<br>
        <strong>ID:</strong> ${duplicate.id}
        `,
        'danger'
    );

    return;
}

            const previewContent = document.getElementById('previewContent');
            const fotoPreview = document.getElementById('finalPhotoPreview');
            
            previewContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Preview data yang akan disimpan:
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <strong>Jenis Item:</strong><br>
                        <span style="color: ${jenisItem === 'asset' ? 'var(--success)' : 'var(--primary)'}; font-weight: bold;">
                            ${jenisItem === 'asset' ? 'ASSET' : 'NON-ASSET'}
                        </span>
                    </div>
                    <div>
                        <strong>Jumlah:</strong><br>
                        ${jenisItem === 'non-asset' ? jumlah : '1 (auto untuk asset)'}
                    </div>
                    <div>
                        <strong>Nama Item:</strong><br>
                        ${nama}
                    </div>
                    <div>
                        <strong>Kode Material:</strong><br>
                        ${materialKode}
                    </div>
                    <div>
                        <strong>No. Reservation Slip:</strong><br>
                        ${noRS}
                    </div>
                    <div>
                        <strong>No. PO/POA:</strong><br>
                        ${noPO || '(tidak diisi)'}
                    </div>
                    <div> <strong>No. Asset:</strong><br>
                        ${noAsset || '(tidak diisi)'}
                    
                    <div>
                        <strong>Lokasi:</strong><br>
                        ${lokasi}
                    </div>
                    <div>
                        <strong>Kondisi:</strong><br>
                        <span class="badge ${kondisi === 'baik' ? 'badge-success' : kondisi === 'rusak' ? 'badge-danger' : 'badge-warning'}">
                            ${kondisi === 'baik' ? 'Baik' : kondisi === 'rusak' ? 'Rusak' : 'Mutasi'}
                        </span>
                    </div>
                    ${catatan ? `
                    <div style="grid-column: span 2;">
                        <strong>Catatan:</strong><br>
                        ${catatan}
                    </div>
                    ` : ''}
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: var(--light); border-radius: 5px;">
                    <small><i class="fas fa-camera"></i> Total foto: ${fotoFiles.length} file</small>
                </div>
            `;
            
            fotoPreview.innerHTML = '';
            if (fotoFiles && fotoFiles.length > 0) {
                for (let i = 0; i < fotoFiles.length; i++) {
                    const file = fotoFiles[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'photo-thumb';
                        img.style.width = '100px';
                        img.style.height = '100px';
                        img.title = `Foto ${i + 1}`;
                        
                        const container = document.createElement('div');
                        container.style.position = 'relative';
                        container.style.display = 'inline-block';
                        container.style.margin = '5px';
                        
                        const label = document.createElement('div');
                        label.style.position = 'absolute';
                        label.style.bottom = '0';
                        label.style.left = '0';
                        label.style.right = '0';
                        label.style.background = 'rgba(0,0,0,0.7)';
                        label.style.color = 'white';
                        label.style.textAlign = 'center';
                        label.style.padding = '2px';
                        label.style.fontSize = '11px';
                        label.textContent = `Foto ${i + 1}`;
                        
                        container.appendChild(img);
                        container.appendChild(label);
                        fotoPreview.appendChild(container);
                    }
                    
                    reader.readAsDataURL(file);
                }
            }
            
            document.getElementById('previewModal').classList.add('active');
        }
        
async function saveItemData() {

    if (!currentUser) {
        showAlert('addAssetAlert', 'Anda harus login untuk menambahkan item', 'danger');
        return false;
    }

    showProgressOverlay('save', {
        title: 'Menyimpan Item',
        subtitle: 'Sedang memproses data...'
    });

    try {

        const jenisItem = document.getElementById('jenis_item').value;
        const nama = document.getElementById('nama_asset').value;
        const materialKode = document.getElementById('material_kode').value;
        const noRS = document.getElementById('no_rs').value;
        const noPO = document.getElementById('no_po').value;
        let noAsset = null;

if (jenisItem === 'asset') {
    noAsset = document.getElementById('no_asset')?.value.trim() || null;
}

        const lokasiSelect = document.getElementById('lokasi').value;

        let lokasi = lokasiSelect;

        if (lokasiSelect === 'other') {
            lokasi = document.getElementById('customLokasi').value.trim();
            if (!lokasi) {
                hideProgressOverlay();
                showAlert('addAssetAlert', 'Harap isi lokasi custom', 'danger');
                return false;
            }
        }

        const duplicate = checkDuplicateAsset(materialKode, noRS);
        if (duplicate) {
            hideProgressOverlay();
            showAlert(
                'addAssetAlert',
                ` Kombinasi Material Code + No RS sudah ada.<br><strong>ID:</strong> ${duplicate.id}`,
                'danger'
            );
            return false;
        }

        const kondisi = document.getElementById('kondisi').value;
        const catatan = document.getElementById('catatan_awal').value;
        const jumlah = jenisItem === 'non-asset'
            ? parseInt(document.getElementById('jumlah').value)
            : 1;

        const fotoFiles = document.getElementById('foto_utama').files;

        if (fotoFiles.length === 0) {
            hideProgressOverlay();
            showAlert('addAssetAlert', 'Foto wajib diisi', 'danger');
            return false;
        }

        updateProgressStep('validate', 'completed');
        updateProgressStep('prepare', 'active');
        updateProgressBar(20);

        const timestamp = Date.now();
        const randomSuffix = Math.random().toString(36).substring(2, 8).toUpperCase();

        const creatorInfo = {
            uid: currentUser.uid,
            nama: currentUser.nama || currentUser.email,
            email: currentUser.email,
            jabatan: currentUser.jabatan || '',
            timestamp: timestamp
        };

        updateProgressStep('prepare', 'completed');
        updateProgressStep('create_items', 'active');
        updateProgressBar(40);

        let itemsToSave = [];

        // ===============================
        // ASSET (1 unit per record)
        // ===============================
        if (jenisItem === 'asset') {

            const itemId = `A-${materialKode}-${timestamp}-${randomSuffix}-1`;

            itemsToSave.push({
                id: itemId,
                jenis_item: 'asset',
                nama_asset: nama,
                material_kode: materialKode,
                no_rs: noRS,
                no_po: noPO || null,
no_asset: noAsset,
lokasi: lokasi,


                kondisi: kondisi,
                kondisi_detail: null,
                total_jumlah: 1,

                catatan_awal: catatan || null,
                created_at: new Date().toISOString(),
                created_by: creatorInfo,
                updated_at: new Date().toISOString(),
                updated_by: creatorInfo,

                riwayat: [{
                    tanggal: new Date().toISOString(),
                    tipe: 'create',
                    user: creatorInfo,

                    old_kondisi: null,
                    new_kondisi: kondisi,

                    old_lokasi: null,
                    new_lokasi: lokasi,

                    old_jumlah: null,
                    new_jumlah: 1,

                    catatan: 'Item dibuat',
                    detail: `Dibuat oleh ${creatorInfo.nama}`
                }],

                syncStatus: 'pending'
            });
        }

        // ===============================
        // NON-ASSET (1 record saja)
        // ===============================
        else {

            const itemId = `N-${materialKode}-${timestamp}-${randomSuffix}-1`;

            const kondisiDetail = {
                baik: kondisi === 'baik' ? jumlah : 0,
                rusak: kondisi === 'rusak' ? jumlah : 0,
                Mutasi: kondisi === 'Mutasi' ? jumlah : 0
            };

            itemsToSave.push({
                id: itemId,
                jenis_item: 'non-asset',
                nama_asset: nama,
                material_kode: materialKode,
                no_rs: noRS,
                no_po: noPO || null,
                lokasi: lokasi,

                kondisi: null,
                kondisi_detail: kondisiDetail,
                total_jumlah: jumlah,

                catatan_awal: catatan || null,
                created_at: new Date().toISOString(),
                created_by: creatorInfo,
                updated_at: new Date().toISOString(),
                updated_by: creatorInfo,

                riwayat: [{
                    tanggal: new Date().toISOString(),
                    tipe: 'create',
                    user: creatorInfo,

                    old_kondisi_detail: null,
                    new_kondisi_detail: kondisiDetail,

                    old_lokasi: null,
                    new_lokasi: lokasi,

                    old_jumlah: null,
                    new_jumlah: jumlah,

                    catatan: 'Item dibuat',
                    detail: `Dibuat oleh ${creatorInfo.nama}`
                }],

                syncStatus: 'pending'
            });
        }

        updateProgressStep('create_items', 'completed');
        updateProgressStep('save_photos', 'active');
        updateProgressBar(60);

        const mainItemId = itemsToSave[0].id;
        let savedPhotos = [];

        for (let i = 0; i < fotoFiles.length; i++) {

            const file = fotoFiles[i];
            updateProgressText(`Mengolah foto ${i + 1}...`);

            const compressedImage = await compressImage(file);
            const photoData = await savePhotoWithCloudinary(
                mainItemId,
                'utama',
                compressedImage,
                file,
                creatorInfo
            );

            savedPhotos.push(photoData);
            updateProgressBar(60 + ((i + 1) / fotoFiles.length) * 20);
        }

        updateProgressStep('save_photos', 'completed');
        updateProgressStep('save_items', 'active');
        updateProgressBar(85);

        for (const itemData of itemsToSave) {
            await saveAssetToIndexedDB(itemData, 'pending');

            logUserActivity('create_asset', {
                assetId: itemData.id,
                assetName: itemData.nama_asset,
                jenis: itemData.jenis_item,
                jumlah: itemData.total_jumlah
            });
        }

        assets.push(...itemsToSave);

        updateProgressStep('save_items', 'completed');
        if (navigator.onLine && isFirebaseConnected) {
            const assetIds = itemsToSave.map(item => item.id);
            await updateCloudSyncMetadata(assetIds);
        }
        updateProgressStep('finalize', 'active');
        updateProgressBar(100);

        updateAssetSelects();
        displayAssets();
        updateDashboard();

        document.getElementById('addAssetForm').reset();
        document.getElementById('customLokasi').style.display = 'none';
        document.getElementById('photoPreview').innerHTML = '';
        toggleJumlahField();

        
            hideProgressOverlay();

            showAlert(
                'addAssetAlert',
                ` ${jenisItem === 'asset' ? 'Asset' : 'Non-asset'} berhasil disimpan!`,
                'success'
            );

            document.getElementById('previewModal').classList.remove('active');

            if (navigator.onLine && isFirebaseConnected && !isSyncRunning) {
            setTimeout(runSyncNow, 1000);
        } else {
            switchTab('daftar');
        }

        return true;

    } catch (error) {
        console.error("Error saving item:", error);
        showProgressError(`Gagal menyimpan item: ${error.message}`);
        return false;
    }
}

       // Log user activity
async function logUserActivity(action, data = {}) {
    if (!currentUser) return;
    
    const activity = {
        timestamp: Date.now(),
        date: new Date().toISOString(),
        user: {
            uid: currentUser.uid,
            nama: currentUser.nama || currentUser.email,
            email: currentUser.email,
            jabatan: currentUser.jabatan || ''
        },
        action: action,
        data: data,
        ip: await getClientIP(),
        userAgent: navigator.userAgent
    };
    
    // Simpan ke IndexedDB
    try {
        await new Promise((resolve, reject) => {
            const transaction = indexedDBInstance.transaction(['user_activities'], 'readwrite');
            const store = transaction.objectStore('user_activities');
            const request = store.add(activity);
            
            request.onsuccess = function() {
                console.log(` Activity logged: ${action}`);
                resolve();
            };
            
            request.onerror = reject;
        });
    } catch (error) {
        console.error("Error logging activity:", error);
    }
    
    // Kirim ke Firestore jika online
    if (isFirebaseConnected && navigator.onLine) {
        try {
            await db.collection('user_activities').add(activity);
        } catch (error) {
            console.error("Error sending activity to Firestore:", error);
        }
    }
}

// Get client IP (simplified)
async function getClientIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        return 'unknown';
    }
} 

// ==============================================
// FUNGSI BARU: CONFLICT DETECTION ENGINE
// ==============================================


async function detectConflict(assetId, localData) {
    // Jika offline, tidak bisa deteksi konflik
    if (!navigator.onLine || !isFirebaseConnected || !db) {
        return {
            hasConflict: false,
            canProceed: true,
            reason: 'offline'
        };
    }
    
    try {
        // 1. Ambil versi terbaru dari Firestore
        const cloudDoc = await db.collection('assets').doc(assetId).get();
        
        if (!cloudDoc.exists) {
            // Asset belum ada di cloud  aman (biasanya untuk asset baru)
            return { hasConflict: false, canProceed: true };
        }
        
        const cloudData = cloudDoc.data();
        
        // 2. Bandingkan timestamp (gunakan field updatedAt)
        // Pastikan kita punya timestamp numerik
        const localTimestamp = localData.updatedAt || localData.lastUpdated || 0;
        const cloudTimestamp = cloudData.updatedAt || cloudData.lastUpdated || 0;
        
        // 3. Jika cloud lebih baru  konflik
        if (cloudTimestamp > localTimestamp) {
            // Dapatkan informasi user dari berbagai kemungkinan field
            const cloudUpdatedBy = cloudData.updatedByName || 
                                   cloudData.updated_by?.nama || 
                                   cloudData.updated_by?.email ||
                                   'User tidak dikenal';
            
            const cloudUpdatedById = cloudData.updatedBy || 
                                     cloudData.updated_by?.uid ||
                                     'unknown';
            
            const cloudUpdatedAtISO = cloudData.updatedAtISO || 
                                      cloudData.updated_at || 
                                      new Date(cloudTimestamp).toISOString();
            
            const localUpdatedBy = localData.updatedByName || 
                                   localData.updated_by?.nama || 
                                   currentUser?.nama || 
                                   'Anda';
            
            const localUpdatedAtISO = localData.updatedAtISO || 
                                      localData.updated_at || 
                                      new Date(localTimestamp).toISOString();
            
            return {
                hasConflict: true,
                canProceed: false,
                cloudData: cloudData,
                localData: localData,
                conflictInfo: {
                    cloudUpdatedAt: cloudUpdatedAtISO,
                    cloudUpdatedBy: cloudUpdatedBy,
                    cloudUpdatedById: cloudUpdatedById,
                    cloudTimestamp: cloudTimestamp,
                    localUpdatedAt: localUpdatedAtISO,
                    localUpdatedBy: localUpdatedBy,
                    localTimestamp: localTimestamp
                }
            };
        }
        
        // Tidak ada konflik
        return { hasConflict: false, canProceed: true };
        
    } catch (error) {
        console.error(" Error detecting conflict:", error);
        // Jika error, asumsikan aman (fallback)
        return { 
            hasConflict: false, 
            canProceed: true, 
            error: error.message,
            warning: 'Gagal mengecek konflik, lanjutkan dengan hati-hati'
        };
    }
}

/**
 * Menampilkan modal konflik dengan 3 pilihan
 * @param {Object} conflictResult - Hasil dari detectConflict()
 * @param {string} assetName - Nama asset untuk ditampilkan
 * @returns {Promise<string>} Resolusi user: 'refresh', 'override', atau 'cancel'
 */
function showConflictModal(conflictResult, assetName = 'Item') {
    return new Promise((resolve) => {
        const { cloudData, conflictInfo } = conflictResult;
        
        // Format tanggal dengan aman
        const formatDate = (dateStr) => {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                return date.toLocaleString('id-ID', {
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch {
                return dateStr;
            }
        };
        
        const cloudDate = formatDate(conflictInfo.cloudUpdatedAt);
        const localDate = formatDate(conflictInfo.localUpdatedAt);
        
        // Buat modal element
        const modalId = 'conflictModal_' + Date.now();
        const modalHTML = `
            <div class="modal active" id="${modalId}">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> 
                            Konflik Data Terdeteksi
                        </div>
                        <span class="close-modal" onclick="document.getElementById('${modalId}').remove()">&times;</span>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div class="alert alert-warning" style="margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i>
                            <strong>${assetName}</strong> sudah diubah oleh user lain.
                        </div>
                        
                        <div class="conflict-version">
                            <div class="conflict-cloud">
                                <h4 style="margin-bottom: 10px; color: var(--info);">
                                    <i class="fas fa-cloud"></i> Versi Cloud (Terbaru)
                                </h4>
                                <div class="conflict-user">
                                    <i class="fas fa-user-circle"></i>
                                    <strong>${conflictInfo.cloudUpdatedBy}</strong>
                                </div>
                                <div class="conflict-timestamp">
                                    <i class="fas fa-clock"></i> ${cloudDate}
                                </div>
                                ${conflictInfo.cloudUpdatedById !== 'unknown' ? 
                                    `<div style="font-size: 11px; margin-top: 5px; color: var(--secondary);">
                                        ID: ${conflictInfo.cloudUpdatedById.substring(0, 8)}...
                                    </div>` : ''}
                            </div>
                            
                            <div class="conflict-local">
                                <h4 style="margin-bottom: 10px; color: var(--secondary);">
                                    <i class="fas fa-database"></i> Versi Lokal (Anda)
                                </h4>
                                <div class="conflict-user">
                                    <i class="fas fa-user-circle"></i>
                                    <strong>${conflictInfo.localUpdatedBy}</strong>
                                </div>
                                <div class="conflict-timestamp">
                                    <i class="fas fa-clock"></i> ${localDate}
                                </div>
                            </div>
                        </div>
                        
                        <div class="conflict-actions">
                            <button class="btn btn-conflict-refresh" id="refreshBtn_${modalId}">
                                <i class="fas fa-sync-alt"></i> Refresh & Muat Data Cloud
                            </button>
                            <button class="btn btn-conflict-override" id="overrideBtn_${modalId}">
                                <i class="fas fa-exclamation-circle"></i> Tetap Simpan (Override)
                            </button>
                            <button class="btn btn-conflict-cancel" id="cancelBtn_${modalId}">
                                <i class="fas fa-times"></i> Batal
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; font-size: 12px; color: var(--secondary); text-align: center; padding: 10px; background: var(--light); border-radius: 6px;">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Refresh:</strong> Muat data terbaru dari cloud (perubahan Anda akan hilang)<br>
                            <strong>Override:</strong> Timpa data cloud dengan versi Anda (data cloud akan hilang)
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Tambahkan modal ke DOM
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
        
        // Event listeners
        document.getElementById(`refreshBtn_${modalId}`).addEventListener('click', () => {
            document.getElementById(modalId).remove();
            resolve('refresh');
        });
        
        document.getElementById(`overrideBtn_${modalId}`).addEventListener('click', () => {
            document.getElementById(modalId).remove();
            resolve('override');
        });
        
        document.getElementById(`cancelBtn_${modalId}`).addEventListener('click', () => {
            document.getElementById(modalId).remove();
            resolve('cancel');
        });
        
        // Close button (X)
        document.querySelector(`#${modalId} .close-modal`).addEventListener('click', () => {
            document.getElementById(modalId).remove();
            resolve('cancel');
        });
        
        // Close with ESC
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                    resolve('cancel');
                }
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // Auto-remove handler saat modal dihapus
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.removedNodes.forEach((node) => {
                    if (node.id === modalId) {
                        document.removeEventListener('keydown', escHandler);
                        observer.disconnect();
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true });
    });
}

/**
 * Helper untuk menyiapkan data foto untuk Firestore
 * @param {string} assetId - ID asset
 * @returns {Promise<Array>} Array foto untuk Firestore
 */
async function preparePhotosForFirestore(assetId) {
    try {
        const photos = await getAssetPhotos(assetId);
        
        return photos.map(photo => {
            const photoForFirestore = {
                type: photo.type,
                tanggal: photo.tanggal,
                timestamp: photo.timestamp,
                uploadStatus: photo.uploadStatus || 'LOCAL'
            };
            
            if (photo.cloudinary) {
                photoForFirestore.cloudinary = {
                    secure_url: photo.cloudinary.secure_url,
                    public_id: photo.cloudinary.public_id,
                    created_at: photo.cloudinary.created_at
                };
            }
            
            if (photo.uploaded_by) {
                photoForFirestore.uploaded_by = photo.uploaded_by;
            }
            
            return photoForFirestore;
        });
    } catch (error) {
        console.error("Error preparing photos for Firestore:", error);
        return [];
    }
}
        // ==============================================
        // DASHBOARD FUNCTIONS
        // =============================================// ==============================================
// FUNGSI UPDATE DASHBOARD - VERSI EFISIEN (1 READ SAJA)
// ==============================================

async function updateDashboard() {
    try {
        // Deklarasikan variabel
        let pendingPhotosCount = 0;
        let totalPhotos = 0;
        let photos = [];
        
        // Cek status offline dan update UI jika perlu
        if (!navigator.onLine) {
            // Update status badges
            const firebaseStatus = document.getElementById('firebaseStatus');
            const syncStatus = document.getElementById('syncStatus');
            const cloudinaryStatus = document.getElementById('cloudinaryStatus');
            
            if (firebaseStatus) {
                firebaseStatus.innerHTML = '<i class="fas fa-cloud"></i> <span>Firebase: Offline</span>';
                firebaseStatus.className = 'status-badge status-offline';
            }
            
            if (syncStatus) {
                syncStatus.innerHTML = '<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Diblokir</span>';
                syncStatus.className = 'status-badge status-offline';
            }
            
            if (cloudinaryStatus) {
                cloudinaryStatus.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Diblokir</span>';
                cloudinaryStatus.className = 'status-badge status-offline';
            }
        }

        if (!assets || assets.length === 0) {
            await loadAssets();
            await cleanupOrphanPhotos();
        }
        
        //  HITUNG STATISTIK ASSET
        const totalAssets = assets.length;
        const assetCount = assets.filter(a => a.jenis_item === 'asset').length;
        const nonAssetCount = assets.filter(a => a.jenis_item === 'non-asset').length;
        const baikCount = assets.filter(a => getEffectiveCondition(a) === 'baik').length;
        const rusakCount = assets.filter(a => getEffectiveCondition(a) === 'rusak').length;
        const MutasiCount = assets.filter(a => getEffectiveCondition(a) === 'Mutasi').length;
        const pendingSync = assets.filter(a => a.syncStatus === 'pending').length;
        const syncedAssets = totalAssets - pendingSync;
        
        //  AMBIL FOTO SEKALI UNTUK SEMUA KEPERLUAN
        try {
            photos = await getAllPhotos();
            totalPhotos = photos.length;
            
            // Hitung foto pending dari array yang sama (tanpa baca ulang)
            pendingPhotosCount = photos.filter(photo => 
                photo.uploadStatus === 'PENDING'
            ).length;
            
            console.log(` Found ${pendingPhotosCount} pending photos in dashboard`);
        } catch (photoError) {
            console.error("Error getting photos:", photoError);
            photos = [];
            totalPhotos = 0;
            pendingPhotosCount = 0;
        }
        
        // Hitung total unit
        const totalJumlah = assets.reduce((sum, asset) => sum + (asset.total_jumlah || 1), 0);
        
        // Hitung lokasi unik
        const locations = [...new Set(assets.filter(a => a.lokasi).map(a => a.lokasi))];
        const totalLokasi = locations.length;
        
        //  HITUNG STORAGE USED (GUNAKAN PHOTOS YANG SUDAH DIAMBIL)
        let storageUsed = 0;
        photos.forEach(photo => {
            if (photo.image && photo.image.startsWith('data:')) {
                try {
                    const base64Data = photo.image.split(',')[1];
                    if (base64Data) {
                        const padding = (base64Data.match(/=/g) || []).length;
                        const sizeInBytes = (base64Data.length * 3 / 4) - padding;
                        storageUsed += sizeInBytes;
                    }
                } catch (e) {
                    // Fallback ke rumus lama jika error
                    const base64Length = photo.image.length - 'data:image/jpeg;base64,'.length;
                    storageUsed += (base64Length * 0.75);
                }
            }
        });
        storageUsed = Math.round(storageUsed / (1024 * 1024) * 100) / 100;
        
        // ============ UPDATE SEMUA ELEMENT DASHBOARD ============
        const safeUpdate = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            } else {
                console.warn(`Element dengan ID "${id}" tidak ditemukan`);
            }
        };
        
        // Update statistik utama
        safeUpdate('totalAssets', totalAssets);
        safeUpdate('assetCount', assetCount);
        safeUpdate('nonAssetCount', nonAssetCount);
        safeUpdate('totalJumlah', totalJumlah);
        safeUpdate('baikCount', baikCount);
        safeUpdate('rusakCount', rusakCount);
        safeUpdate('MutasiCount', MutasiCount);
        safeUpdate('totalPhotos', totalPhotos);
        safeUpdate('syncedAssets', syncedAssets);
        safeUpdate('pendingSync', pendingSync);
        
        // ============ UPDATE FOTO PENDING ============
        const pendingPhotosElement = document.getElementById('pendingPhotosCount');
        if (pendingPhotosElement) {
            pendingPhotosElement.textContent = pendingPhotosCount;
        }
        
        // Update element lain yang mungkin menampilkan foto pending
        const possibleElements = document.querySelectorAll('[id*="pendingPhoto"], [class*="pending-photo"], .stat-item .stat-value');
        possibleElements.forEach(el => {
            if (el.closest('.stat-item') && el.closest('.stat-item').innerText.includes('Foto')) {
                el.textContent = pendingPhotosCount;
            }
        });
        
        console.log(` Dashboard updated - Pending Photos: ${pendingPhotosCount}`);
        
        // Update storage
        safeUpdate('storageUsed', `${storageUsed} MB`);
        safeUpdate('totalLokasi', totalLokasi);
        
        // Update last sync
        const lastSyncElement = document.getElementById('lastSync');
        if (lastSyncElement && lastSyncTime) {
            lastSyncElement.textContent = lastSyncTime.toLocaleTimeString();
        } else if (lastSyncElement) {
            lastSyncElement.textContent = 'Belum pernah';
        }
        
        // Update lokasi stats
        const lokasiStats = document.getElementById('lokasiStats');
        if (lokasiStats && locations.length > 0) {
            let lokasiHtml = '';
            locations.slice(0, 3).forEach(loc => {
                const count = assets.filter(a => a.lokasi === loc).length;
                lokasiHtml += `
                    <div style="margin-bottom: 5px; font-size: 12px;">
                        <strong>${loc}:</strong> ${count} item
                    </div>
                `;
            });
            
            if (locations.length > 3) {
                lokasiHtml += `<div style="font-size: 11px; color: var(--secondary);">+${locations.length - 3} lokasi lainnya</div>`;
            }
            
            lokasiStats.innerHTML = lokasiHtml;
        }
        
        // Update charts
        const typeChartCtx = document.getElementById('typeChart');
        const conditionChartCtx = document.getElementById('conditionChart');
        
        if (typeChartCtx && conditionChartCtx && totalAssets > 0) {
            updateCharts();
        }
        
        // Update recent activity
        updateRecentActivity();
        
    } catch (error) {
        console.error(" Error updating dashboard:", error);
        
        // Fallback ke 0 untuk semua nilai
        const safeUpdate = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        };
        
        safeUpdate('totalAssets', '0');
        safeUpdate('assetCount', '0');
        safeUpdate('nonAssetCount', '0');
        safeUpdate('totalJumlah', '0');
        safeUpdate('baikCount', '0');
        safeUpdate('rusakCount', '0');
        safeUpdate('MutasiCount', '0');
        safeUpdate('totalPhotos', '0');
        safeUpdate('syncedAssets', '0');
        safeUpdate('pendingSync', '0');
        safeUpdate('pendingPhotosCount', '0');
        safeUpdate('storageUsed', '0 MB');
        safeUpdate('totalLokasi', '0');
    }
}
        function updateCharts() {
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            const assetCount = assets.filter(a => a.jenis_item === 'asset').length;
            const nonAssetCount = assets.filter(a => a.jenis_item === 'non-asset').length;
            
            if (typeChart) {
                typeChart.destroy();
            }
            
            typeChart = new Chart(typeCtx, {
                type: 'pie',
                data: {
                    labels: ['Asset', 'Non-Asset'],
                    datasets: [{
                        data: [assetCount, nonAssetCount],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
            
            const conditionCtx = document.getElementById('conditionChart').getContext('2d');
            const baikCount = assets.filter(a => getEffectiveCondition(a) === 'baik').length;
const rusakCount = assets.filter(a => getEffectiveCondition(a) === 'rusak').length;
const MutasiCount = assets.filter(a => getEffectiveCondition(a) === 'Mutasi').length;
            if (conditionChart) {
                conditionChart.destroy();
            }
            
            conditionChart = new Chart(conditionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Baik', 'Rusak', 'Mutasi'],
                    datasets: [{
                        data: [baikCount, rusakCount, MutasiCount],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
        }
        
        // ==============================================
// UPDATE RECENT ACTIVITY - VERSI DETAIL
// ==============================================
function updateRecentActivity() {
    const activityContainer = document.getElementById('recentActivity');
    
    // Kumpulkan semua aktivitas dari semua asset
    const allActivities = [];
    
    assets.forEach(asset => {
        if (asset.riwayat && Array.isArray(asset.riwayat) && asset.riwayat.length > 0) {
            
            asset.riwayat.forEach((history, index) => {
                // Tentukan apakah ini riwayat terbaru atau bukan
                const isLatest = (index === asset.riwayat.length - 1);
                
                // Format pesan berdasarkan tipe dan jenis item
                let actionMessage = '';
                let actionIcon = '';
                let actionColor = '';
                let detailInfo = '';
                
                // ============ ASSET ============
                if (asset.jenis_item === 'asset') {
                    // Cek perubahan kondisi
                    if (history.old_kondisi && history.new_kondisi && 
                        history.old_kondisi !== history.new_kondisi) {
                        
                        actionIcon = history.new_kondisi === 'baik' ? '' :
                                    history.new_kondisi === 'rusak' ? '' : '';
                        
                        actionMessage = `Perubahan Kondisi: ${history.old_kondisi || '-'}  ${history.new_kondisi || '-'}`;
                        actionColor = history.new_kondisi === 'baik' ? '#10b981' :
                                     history.new_kondisi === 'rusak' ? '#ef4444' : '#f59e0b';
                        
                        detailInfo = `Kondisi berubah dari ${history.old_kondisi || 'awal'} menjadi ${history.new_kondisi}`;
                    }
                    
                    // Cek perubahan lokasi
                    else if (history.old_lokasi && history.new_lokasi && 
                             history.old_lokasi !== history.new_lokasi) {
                        
                        actionIcon = '';
                        actionMessage = `Perpindahan Lokasi: ${history.old_lokasi || '-'}  ${history.new_lokasi || '-'}`;
                        actionColor = '#3b82f6';
                        detailInfo = `Item dipindahkan dari ${history.old_lokasi || 'awal'} ke ${history.new_lokasi}`;
                    }
                    
                    // Create new asset
                    else if (history.tipe === 'create') {
                        actionIcon = '';
                        actionMessage = `Item Baru Ditambahkan`;
                        actionColor = '#10b981';
                        detailInfo = `Kondisi awal: ${history.new_kondisi || asset.kondisi || '-'}`;
                    }
                    
                    // Update umum
                    else {
                        actionIcon = '';
                        actionMessage = `Data Diperbarui`;
                        actionColor = '#6b7280';
                        detailInfo = history.catatan || 'Update data asset';
                    }
                }
                
                // ============ NON-ASSET ============
                else if (asset.jenis_item === 'non-asset') {
                    // Cek perubahan distribusi jumlah
                    if (history.old_jumlah && history.new_jumlah && 
                        typeof history.old_jumlah === 'object' && 
                        typeof history.new_jumlah === 'object') {
                        
                        const oldDetail = history.old_jumlah || {};
                        const newDetail = history.new_jumlah || {};
                        
                        // Hitung perubahan
                        const changes = [];
                        if (oldDetail.baik !== newDetail.baik) {
                            const diff = newDetail.baik - oldDetail.baik;
                            changes.push(`Baik: ${diff > 0 ? '+' : ''}${diff}`);
                        }
                        if (oldDetail.rusak !== newDetail.rusak) {
                            const diff = newDetail.rusak - oldDetail.rusak;
                            changes.push(`Rusak: ${diff > 0 ? '+' : ''}${diff}`);
                        }
                        if (oldDetail.Mutasi !== newDetail.Mutasi) {
                            const diff = newDetail.Mutasi - oldDetail.Mutasi;
                            changes.push(`Mutasi: ${diff > 0 ? '+' : ''}${diff}`);
                        }
                        
                        actionIcon = '';
                        actionMessage = `Distribusi Berubah`;
                        actionColor = '#8b5cf6';
                        detailInfo = changes.join(' | ');
                    }
                    
                    // Cek perubahan lokasi
                    else if (history.old_lokasi && history.new_lokasi && 
                             history.old_lokasi !== history.new_lokasi) {
                        
                        actionIcon = '';
                        actionMessage = `Perpindahan Lokasi: ${history.old_lokasi || '-'}  ${history.new_lokasi || '-'}`;
                        actionColor = '#3b82f6';
                        detailInfo = `Item dipindahkan dari ${history.old_lokasi || 'awal'} ke ${history.new_lokasi}`;
                    }
                    
                    // Create new item
                    else if (history.tipe === 'create') {
                        actionIcon = '';
                        actionMessage = `Item Baru Ditambahkan`;
                        actionColor = '#10b981';
                        
                        const jumlah = asset.total_jumlah || 
                                       (history.new_jumlah?.baik + history.new_jumlah?.rusak + history.new_jumlah?.Mutasi) || 
                                       0;
                        detailInfo = `Total ${jumlah} unit (Baik: ${history.new_jumlah?.baik || 0}, Rusak: ${history.new_jumlah?.rusak || 0}, Mutasi: ${history.new_jumlah?.Mutasi || 0})`;
                    }
                    
                    // Update umum
                    else {
                        actionIcon = '';
                        actionMessage = `Data Diperbarui`;
                        actionColor = '#6b7280';
                        detailInfo = history.catatan || 'Update data non-asset';
                    }
                }
                
                // Tambahkan user info
                const userName = history.user?.nama || 
                                history.user?.email || 
                                asset.updated_by?.nama || 
                                'System';
                
                const userInitial = userName.charAt(0).toUpperCase();
                
                // Format tanggal
                let dateDisplay = '';
                try {
                    const date = new Date(history.tanggal);
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                    const diffMinutes = Math.floor(diffTime / (1000 * 60));
                    
                    if (diffMinutes < 1) {
                        dateDisplay = 'Baru saja';
                    } else if (diffMinutes < 60) {
                        dateDisplay = `${diffMinutes} menit yang lalu`;
                    } else if (diffHours < 24) {
                        dateDisplay = `${diffHours} jam yang lalu`;
                    } else if (diffDays === 1) {
                        dateDisplay = 'Kemarin';
                    } else if (diffDays < 7) {
                        dateDisplay = `${diffDays} hari yang lalu`;
                    } else {
                        dateDisplay = date.toLocaleDateString('id-ID', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        });
                    }
                } catch (e) {
                    dateDisplay = history.tanggal ? new Date(history.tanggal).toLocaleString() : '-';
                }
                
                allActivities.push({
                    assetId: asset.id,
                    assetName: asset.nama_asset,
                    assetJenis: asset.jenis_item === 'asset' ? 'Asset' : 'Non-Asset',
                    tanggal: history.tanggal,
                    timestamp: new Date(history.tanggal).getTime(),
                    dateDisplay: dateDisplay,
                    actionMessage: actionMessage,
                    actionIcon: actionIcon,
                    actionColor: actionColor,
                    detailInfo: detailInfo,
                    userName: userName,
                    userInitial: userInitial,
                    catatan: history.catatan || '-',
                    isLatest: isLatest
                });
            });
        }
    });
    
    // Urutkan berdasarkan tanggal (terbaru di atas)
    allActivities.sort((a, b) => b.timestamp - a.timestamp);
    
    // Ambil 10 aktivitas terbaru
    const recentActivities = allActivities.slice(0, 10);
    
    if (recentActivities.length === 0) {
        activityContainer.innerHTML = `
            <div class="empty-state" style="padding: 30px 20px;">
                <i class="fas fa-history" style="font-size: 48px; color: var(--gray-light);"></i>
                <h3 style="margin-top: 15px;">Belum ada aktivitas</h3>
                <p style="color: var(--secondary);">Aktivitas akan muncul setelah Anda menambah atau mengupdate item</p>
            </div>
        `;
        return;
    }
    
    // Build HTML
    let html = '<div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">';
    
    recentActivities.forEach((activity, index) => {
        // Warna border berdasarkan jenis aktivitas
        let borderColor = activity.actionColor;
        let badgeClass = '';
        
        if (activity.actionMessage.includes('Kondisi')) {
            badgeClass = activity.actionMessage.includes('baik') ? 'badge-success' :
                        activity.actionMessage.includes('rusak') ? 'badge-danger' : 'badge-warning';
        } else if (activity.actionMessage.includes('Lokasi')) {
            badgeClass = 'badge-info';
        } else if (activity.actionMessage.includes('Baru')) {
            badgeClass = 'badge-success';
        } else {
            badgeClass = 'badge-secondary';
        }
        
        html += `
            <div class="activity-item" style="
                background: var(--card-bg);
                border-left: 4px solid ${borderColor};
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 12px;
                box-shadow: var(--shadow);
                transition: transform 0.2s ease;
                position: relative;
                ${activity.isLatest ? 'border: 2px solid ' + borderColor + ';' : ''}
            ">
                <!-- HEADER ACTIVITY -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <span style="
                            background: ${borderColor}20;
                            color: ${borderColor};
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 18px;
                        ">
                            ${activity.actionIcon}
                        </span>
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="font-weight: 600; color: var(--text-color);">
                                    ${activity.assetName}
                                </span>
                                <span class="badge ${activity.assetJenis === 'Asset' ? 'badge-info' : 'badge-warning'}" style="font-size: 10px;">
                                    ${activity.assetJenis}
                                </span>
                                ${activity.isLatest ? 
                                    '<span class="badge badge-success" style="font-size: 10px;"><i class="fas fa-star"></i> Terbaru</span>' : 
                                    ''}
                            </div>
                            <div style="font-size: 13px; color: var(--secondary); margin-top: 3px;">
                                ${activity.actionMessage}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: var(--secondary); background: var(--light); padding: 4px 8px; border-radius: 12px;">
                            <i class="far fa-clock"></i> ${activity.dateDisplay}
                        </div>
                    </div>
                </div>
                
                <!-- DETAIL INFO -->
                <div style="margin: 10px 0 8px 42px; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 13px; color: var(--text-color);">
                    <i class="fas fa-info-circle" style="color: ${borderColor}; margin-right: 5px;"></i>
                    ${activity.detailInfo}
                </div>
                
                <!-- FOOTER: USER & CATATAN -->
                <div style="margin-left: 42px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: ${borderColor};
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: bold;
                        ">
                            ${activity.userInitial}
                        </div>
                        <span style="font-size: 12px; color: var(--secondary);">
                            ${activity.userName}
                        </span>
                    </div>
                    
                    ${activity.catatan && activity.catatan !== '-' ? `
                        <div style="font-size: 12px; color: var(--secondary); max-width: 60%;" title="${activity.catatan}">
                            <i class="fas fa-quote-right" style="opacity: 0.5;"></i> 
                            ${activity.catatan.length > 40 ? activity.catatan.substring(0, 40) + '...' : activity.catatan}
                        </div>
                    ` : ''}
                </div>
                
                <!-- TOMBOL LIHAT DETAIL (jika ingin langsung ke asset) -->
                <div style="margin-top: 12px; margin-left: 42px; display: flex; gap: 8px;">
                    <button class="btn btn-outline btn-small" onclick="showAssetDetail('${activity.assetId}')" style="font-size: 11px; padding: 4px 10px;">
                        <i class="fas fa-eye"></i> Lihat Detail Item
                    </button>
                </div>
            </div>
        `;
    });
    
    // Tambah tombol Lihat Semua jika ada lebih dari 10
    if (allActivities.length > 10) {
        html += `
            <div style="text-align: center; margin-top: 15px; padding: 10px; background: var(--light); border-radius: 8px;">
                <span style="font-size: 13px; color: var(--secondary);">
                    <i class="fas fa-list"></i> Total ${allActivities.length} aktivitas
                </span>
                <button class="btn btn-outline btn-small" onclick="showAllActivities()" style="margin-left: 10px;">
                    Lihat Semua
                </button>
            </div>
        `;
    }
    
    html += '</div>';
    activityContainer.innerHTML = html;
}

// ==============================================
// FUNGSI UNTUK MELIHAT SEMUA AKTIVITAS (OPSIONAL)
// ==============================================
function showAllActivities() {
    // Kumpulkan semua aktivitas
    const allActivities = [];
    
    assets.forEach(asset => {
        if (asset.riwayat && Array.isArray(asset.riwayat)) {
            asset.riwayat.forEach(history => {
                allActivities.push({
                    asset: asset,
                    history: history,
                    tanggal: history.tanggal
                });
            });
        }
    });
    
    // Urutkan
    allActivities.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
    
    // Buat modal untuk menampilkan semua aktivitas
    const modalHTML = `
        <div class="modal active" id="allActivitiesModal">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-history"></i> Semua Aktivitas (${allActivities.length})
                    </div>
                    <span class="close-modal" onclick="document.getElementById('allActivitiesModal').remove()">&times;</span>
                </div>
                <div style="padding: 20px;" id="allActivitiesContent">
                    <!-- Akan diisi dengan JS -->
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Render activities di modal
    const content = document.getElementById('allActivitiesContent');
    let html = '';
    
    allActivities.forEach((item, index) => {
        const asset = item.asset;
        const history = item.history;
        const date = new Date(history.tanggal).toLocaleString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        html += `
            <div class="asset-card" style="margin-bottom: 10px;">
                <div class="asset-header">
                    <div>
                        <div class="asset-title">${asset.nama_asset}</div>
                        <div class="asset-subtitle">
                            ${date} | ${history.user?.nama || 'System'}
                        </div>
                    </div>
                </div>
                <div style="padding: 10px; background: var(--light); border-radius: 5px;">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${JSON.stringify(history, null, 2)}</pre>
                </div>
            </div>
        `;
    });
    
    content.innerHTML = html;
}
        
        // ==============================================
        // UI FUNCTIONS
        // ==============================================
// ==============================================
// GLOBAL CONDITION HELPER
// ==============================================

function getEffectiveCondition(asset) {

    if (!asset) return null;

    // Asset biasa
    if (asset.jenis_item === 'asset') {
        return asset.kondisi || null;
    }

    // Non-asset
    if (asset.jenis_item === 'non-asset') {

        if (!asset.kondisi_detail || typeof asset.kondisi_detail !== 'object') {
            return null;
        }

        const detail = asset.kondisi_detail;

        let max = 0;
        let dominant = null;

        for (const key of ['baik', 'rusak', 'Mutasi']) {
            const value = detail[key] || 0;
            if (value > max) {
                max = value;
                dominant = key;
            }
        }

        return dominant;
    }

    return null;
}
        
// ==============================================
// FILTER FOTO - VERSI LENGKAP DENGAN CACHE
// ==============================================

// Cache untuk menyimpan jumlah foto per asset
let photoCountMap = new Map();
let isPhotoCacheLoaded = false;

// Inisialisasi cache foto
async function initPhotoCache() {
    try {
        console.log(" Initializing photo cache...");
        const allPhotos = await getAllPhotos();
        
        photoCountMap.clear();
        
        allPhotos.forEach(photo => {
            const currentCount = photoCountMap.get(photo.assetId) || 0;
            photoCountMap.set(photo.assetId, currentCount + 1);
        });
        
        isPhotoCacheLoaded = true;
        console.log(` Photo cache ready: ${photoCountMap.size} assets with photos`);
    } catch (error) {
        console.error(" Error initializing photo cache:", error);
        isPhotoCacheLoaded = false;
    }
}

// Fungsi untuk mendapatkan jumlah foto dari cache
function getPhotoCountFromCache(assetId) {
    return photoCountMap.get(assetId) || 0;
}

// ==============================================
// DISPLAY ASSETS DENGAN THUMBNAIL FOTO
// ==============================================
async function displayAssets(filteredAssets = assets) {
    const assetsList = document.getElementById('assetsList');
    const filterJenis = document.getElementById('filterJenis').value;
    const filterKondisi = document.getElementById('filterKondisi').value;
    const filterLokasi = document.getElementById('filterLokasi').value;
    const filterFoto = document.getElementById('filterFoto').value;
    
    // Tampilkan loading jika cache belum siap
    if (!isPhotoCacheLoaded) {
        assetsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>Memuat data foto...</h3>
                <p>Mohon tunggu sebentar</p>
            </div>
        `;
        await initPhotoCache();
    }
    
    // Filter berdasarkan jenis
    if (filterJenis) {
        filteredAssets = filteredAssets.filter(asset => asset.jenis_item === filterJenis);
    }
    
    // Filter berdasarkan kondisi
    if (filterKondisi) {
        filteredAssets = filteredAssets.filter(asset =>
            getEffectiveCondition(asset) === filterKondisi
        );
    }
    
    // Filter berdasarkan lokasi
    if (filterLokasi) {
        filteredAssets = filteredAssets.filter(asset => asset.lokasi === filterLokasi);
    }
    
    // FILTER FOTO - Gunakan cache
    if (filterFoto) {
        filteredAssets = filteredAssets.filter(asset => {
            const photoCount = getPhotoCountFromCache(asset.id);
            
            if (filterFoto === 'with-photos') {
                return photoCount > 0;
            } else if (filterFoto === 'without-photos') {
                return photoCount === 0;
            }
            return true;
        });
    }
    
    // Search filter
    const searchTerm = document.getElementById('searchAsset').value.toLowerCase();
    if (searchTerm) {
        filteredAssets = filteredAssets.filter(asset => 
            asset.nama_asset.toLowerCase().includes(searchTerm) ||
            asset.material_kode.toLowerCase().includes(searchTerm) ||
            (asset.no_rs && asset.no_rs.toLowerCase().includes(searchTerm)) ||
            (asset.no_po && asset.no_po.toLowerCase().includes(searchTerm)) ||
            asset.lokasi.toLowerCase().includes(searchTerm)
        );
    }
    
    // Render hasil
    if (!filteredAssets || filteredAssets.length === 0) {
        assetsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-cubes"></i>
                <h3>Tidak ada item</h3>
                <p>Tidak ada item yang sesuai dengan filter</p>
            </div>
        `;
        return;
    }
    
    // Ambil foto untuk semua asset yang difilter (batch)
    const allPhotos = await getAllPhotos();
    const photoMap = new Map();
    
    // Group photos by assetId
    allPhotos.forEach(photo => {
        if (!photoMap.has(photo.assetId)) {
            photoMap.set(photo.assetId, []);
        }
        photoMap.get(photo.assetId).push(photo);
    });
    
    let html = '';
    
    for (const asset of filteredAssets) {
        const effectiveCondition = getEffectiveCondition(asset);
        const assetPhotos = photoMap.get(asset.id) || [];
        const photoCount = assetPhotos.length;
        
        const badgeClass =
            effectiveCondition === 'baik' ? 'badge-success' :
            effectiveCondition === 'rusak' ? 'badge-danger' :
            effectiveCondition === 'Mutasi' ? 'badge-warning' :
            'badge-info';
        
        const badgeText =
            effectiveCondition === 'baik' ? 'Baik' :
            effectiveCondition === 'rusak' ? 'Rusak' :
            effectiveCondition === 'Mutasi' ? 'Mutasi' :
            'Distribusi';
        
        const jenisBadge = asset.jenis_item === 'asset' ? 
            '<span class="badge badge-info" style="margin-right: 5px;"><i class="fas fa-cube"></i> Asset</span>' :
            '<span class="badge badge-warning" style="margin-right: 5px;"><i class="fas fa-boxes"></i> Non-Asset</span>';
        
        const syncBadge = asset.syncStatus === 'pending' ? 
            '<span class="sync-badge"><i class="fas fa-clock"></i> Pending</span>' : 
            '<span class="sync-badge" style="background-color: rgba(16, 185, 129, 0.15); color: var(--success);"><i class="fas fa-check"></i> Synced</span>';
        
        // ============ BUAT THUMBNAIL FOTO ============
        let thumbnailsHtml = '<div class="asset-thumbnail-container">';
        
        if (photoCount > 0) {
            // Tampilkan maksimal 3 foto thumbnail
            const maxThumbs = Math.min(photoCount, 3);
            
            for (let i = 0; i < maxThumbs; i++) {
                const photo = assetPhotos[i];
                
                // Tentukan sumber gambar yang aman
                let imgSrc = photo.displayUrl || 
                            photo.image || 
                            photo.thumbnail || 
                            (photo.cloudinary?.secure_url && navigator.onLine ? photo.cloudinary.secure_url : null);
                
                if (imgSrc) {
                    thumbnailsHtml += `
                        <div class="asset-thumb-badge" style="position: relative;">
                            <img src="${imgSrc}" 
                                 class="asset-thumb" 
                                 data-asset-id="${asset.id}"
                                 data-photo-index="${i}"
                                 onclick="showPhotoFromThumb('${asset.id}', ${i})"
                                 title="${photo.type === 'utama' ? 'Foto Utama' : 'Foto ' + photo.type}"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\' viewBox=\'0 0 60 60\'%3E%3Crect width=\'60\' height=\'60\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'30\' y=\'35\' font-size=\'12\' text-anchor=\'middle\' fill=\'%23999\'%3E%3C/text%3E%3C/svg%3E';">
                            ${photo.type === 'utama' ? '<span class="badge badge-info" style="position: absolute; top: -5px; right: -5px; font-size: 8px; padding: 2px 4px;"></span>' : ''}
                        </div>
                    `;
                } else {
                    // Fallback jika gambar tidak tersedia
                    thumbnailsHtml += `
                        <div class="asset-thumb-placeholder" onclick="showAssetDetail('${asset.id}')">
                            <i class="fas fa-image"></i>
                        </div>
                    `;
                }
            }
            
            // Jika lebih dari 3 foto, tampilkan indikator "+X"
            if (photoCount > 3) {
                thumbnailsHtml += `
                    <div class="asset-thumb-more" onclick="showAssetDetail('${asset.id}')" title="${photoCount - 3} foto lainnya">
                        +${photoCount - 3}
                    </div>
                `;
            }
        } else {
            // Tidak ada foto
            thumbnailsHtml += `
                <div class="asset-thumb-placeholder" onclick="showAssetDetail('${asset.id}')" title="Tidak ada foto">
                    <i class="fas fa-camera"></i>
                </div>
            `;
        }
        
        thumbnailsHtml += '</div>';
        
        // ============ CARD UTAMA ============
        html += `
            <div class="asset-card" data-asset-id="${asset.id}">
                <div class="asset-header">
                    <div style="flex: 1;">
                        <div class="asset-title">
                            ${jenisBadge} ${asset.nama_asset} ${syncBadge}
                        </div>
                        <div class="asset-subtitle">
                            <i class="fas fa-barcode"></i> ${asset.material_kode} | 
                            <i class="fas fa-file-alt"></i> RS: ${asset.no_rs || '-'} | 
                            <i class="fas fa-map-pin"></i> ${asset.lokasi}
                            ${asset.jenis_item === 'asset' ? ` | <i class="fas fa-tag"></i> No Asset: ${asset.no_asset || '-'}` : ''}
                        </div>
                    </div>
                    <div>
                        <div class="badge ${badgeClass}">${badgeText}</div>
                        <div style="margin-top: 5px; text-align: right;">
                            <small><i class="fas fa-camera"></i> ${photoCount} foto</small>
                        </div>
                    </div>
                </div>
                
                ${thumbnailsHtml}
                
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-col">
                        <button class="btn btn-outline btn-small view-detail" data-asset-id="${asset.id}">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        <button class="btn btn-outline btn-small update-condition-btn" data-asset-id="${asset.id}">
                            <i class="fas fa-edit"></i> Update
                        </button>
                        <button class="btn btn-outline btn-small view-photos" data-asset-id="${asset.id}">
                            <i class="fas fa-images"></i> Galeri
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    assetsList.innerHTML = html;
    
    // Event listeners
    document.querySelectorAll('.view-detail').forEach(btn => {
        btn.addEventListener('click', function() {
            const assetId = this.getAttribute('data-asset-id');
            showAssetDetail(assetId);
        });
    });
    
    document.querySelectorAll('.update-condition-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const assetId = this.getAttribute('data-asset-id');
            switchTab('update');
            setTimeout(() => {
                document.getElementById('assetSelect').value = assetId;
                loadAssetForUpdate(assetId);
            }, 100);
        });
    });
    
    document.querySelectorAll('.view-photos').forEach(btn => {
        btn.addEventListener('click', function() {
            const assetId = this.getAttribute('data-asset-id');
            switchTab('galeri');
            setTimeout(() => {
                document.getElementById('galeriAssetSelect').value = assetId;
                loadGallery(assetId);
            }, 100);
        });
    });
}

// ==============================================
// FUNGSI UNTUK MENAMPILKAN FOTO DARI THUMBNAIL
// ==============================================
async function showPhotoFromThumb(assetId, photoIndex) {
    const photos = await getAssetPhotos(assetId);
    if (!photos || photos.length === 0 || photoIndex >= photos.length) return;
    
    const photo = photos[photoIndex];
    
    // Tentukan sumber gambar
    let imgSrc = photo.displayUrl || photo.image || photo.thumbnail;
    
    // Jika online dan ada cloudinary, pakai yang HD
    if (navigator.onLine && photo.cloudinary?.secure_url) {
        imgSrc = photo.cloudinary.secure_url;
    }
    
    // Fallback
    if (!imgSrc) {
        showToastNotification('Foto tidak tersedia', 'warning');
        return;
    }
    
    // Tampilkan di modal foto
    document.getElementById('largePhoto').src = imgSrc;
    
    const photoInfo = document.getElementById('photoInfo');
    if (photoInfo) {
        const date = photo.tanggal ? new Date(photo.tanggal).toLocaleDateString('id-ID') : 'Tidak diketahui';
        const type = photo.type === 'utama' ? 'Foto Utama' : `Foto ${photo.type}`;
        const source = photo.cloudinary ? 'Cloudinary' : 'Lokal';
        
        photoInfo.innerHTML = `
            <p><strong>${type}</strong></p>
            <p><i class="fas fa-calendar"></i> ${date}</p>
            <p><i class="fas fa-cloud"></i> Sumber: ${source}</p>
            ${photo.cloudinary ? '<small class="badge badge-info">HD Tersedia</small>' : ''}
        `;
    }
    
    document.getElementById('photoModal').classList.add('active');
}



// ==============================================
// MODIFIED: showAssetDetail dengan Error Handling & Offline Support
// ==============================================

async function showAssetDetail(assetId) {
    try {
        // Validasi input
        if (!assetId) {
            showToastNotification('ID asset tidak valid', 'danger');
            return;
        }

        // Cari asset
        const asset = assets.find(a => a.id === assetId);
        if (!asset) {
            showToastNotification('Item tidak ditemukan', 'danger');
            return;
        }

        // Ambil photos dengan error handling
        let photos = [];
        try {
            photos = await getAssetPhotos(assetId);
        } catch (photoError) {
            console.error("Error loading photos for asset detail:", photoError);
            photos = []; // Tetap lanjut walau error
        }

        const modal = document.getElementById('assetDetailModal');
        const content = document.getElementById('assetDetailContent');
        
        if (!modal || !content) {
            console.error("Modal elements not found");
            return;
        }

        // =============================================
        // HELPER FUNCTIONS (dengan error handling)
        // =============================================
        
        const safeFormatDate = (dateValue) => {
            if (!dateValue) return 'Tidak tersedia';
            try {
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) return 'Tanggal tidak valid';
                return date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return String(dateValue);
            }
        };

        const safeFormatUserInfo = (userInfo) => {
            if (!userInfo) return 'Tidak tersedia';
            try {
                return `
                    <div style="margin-top:5px;">
                        <strong>${userInfo.nama || userInfo.email || 'Unknown'}</strong>
                        ${userInfo.jabatan ? `<br><small>${userInfo.jabatan}</small>` : ''}
                        ${userInfo.timestamp ? `<br><small>${safeFormatDate(userInfo.timestamp)}</small>` : ''}
                    </div>
                `;
            } catch {
                return '<div>Tidak tersedia</div>';
            }
        };

        const safeFormatDistribusi = (obj) => {
            if (!obj || typeof obj !== 'object') return '';
            try {
                return `
                    <div style="font-size:13px;">
                        Baik: ${obj.baik || 0} |
                        Rusak: ${obj.rusak || 0} |
                        Mutasi: ${obj.Mutasi || 0}
                    </div>
                `;
            } catch {
                return '';
            }
        };

        // =============================================
        // DETERMINE CONDITION & BADGES
        // =============================================
        
        let effectiveCondition = null;
        try {
            effectiveCondition = getEffectiveCondition(asset);
        } catch (e) {
            console.warn("Error getting effective condition:", e);
        }

        const badgeClass = !effectiveCondition ? 'badge-info' :
            effectiveCondition === 'baik' ? 'badge-success' :
            effectiveCondition === 'rusak' ? 'badge-danger' :
            effectiveCondition === 'Mutasi' ? 'badge-warning' : 'badge-info';

        const badgeText = !effectiveCondition ? 'Unknown' :
            effectiveCondition === 'baik' ? 'Baik' :
            effectiveCondition === 'rusak' ? 'Rusak' :
            effectiveCondition === 'Mutasi' ? 'Mutasi' : 'Distribusi';

        const jenisText = asset.jenis_item === 'asset' ? 'Asset' : 'Non-Asset';
        const jenisClass = asset.jenis_item === 'asset' ? 'badge-info' : 'badge-warning';

        const syncStatus = asset.syncStatus === 'pending'
            ? '<span class="sync-badge"><i class="fas fa-clock"></i> Pending Sync</span>'
            : '<span class="sync-badge" style="background-color: rgba(16,185,129,0.15); color: var(--success);"><i class="fas fa-check"></i> Synced</span>';

        // =============================================
        // PHOTOS SECTION - DENGAN SAFE IMAGE HANDLING
        // =============================================
        
        let photosHtml = '<h3 style="margin-top:20px;"><i class="fas fa-images"></i> Foto Item</h3>';
        
        if (photos.length > 0) {
            photosHtml += '<div class="photo-preview" style="margin-top:10px;">';
            
            photos.forEach((photo, index) => {
                try {
                    // PASTIKAN displayUrl AMAN
                    let imgSrc = photo.displayUrl;
                    
                    // Validasi: jangan pakai URL cloudinary saat offline
                    if (!navigator.onLine && photo.source === 'cloudinary') {
                        // Fallback ke local jika ada
                        if (photo.image) {
                            imgSrc = photo.image;
                        } else if (photo.thumbnail) {
                            imgSrc = photo.thumbnail;
                        } else {
                            imgSrc = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50\' y=\'50\' font-size=\'14\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EOffline%3C/text%3E%3C/svg%3E';
                        }
                    }
                    
                    // Final fallback
                    if (!imgSrc || imgSrc === 'null' || imgSrc === 'undefined') {
                        imgSrc = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50\' y=\'50\' font-size=\'14\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ENo Image%3C/text%3E%3C/svg%3E';
                    }
                    
                    const imageIndicator = photo.isThumbnail ? 
                        '<span class="badge badge-info" style="font-size: 10px;"><i class="fas fa-compress"></i> Thumb</span>' : 
                        (photo.source === 'cloudinary' ? 
                            '<span class="cloudinary-badge"><i class="fas fa-cloud"></i> HD</span>' : 
                            '<span class="sync-badge"><i class="fas fa-database"></i> HD</span>');
                    
                    // Simpan data lengkap untuk event click
                    const photoDataAttr = `data-photo-index="${index}" data-photo-id="${photo.id || ''}" data-has-local="${!!photo.image}" data-has-cloudinary="${!!photo.cloudinary}" data-local-src="${photo.image || photo.thumbnail || ''}" data-cloudinary-src="${photo.cloudinary?.secure_url || ''}"`;
                    
                    photosHtml += `
                        <div style="position: relative; display: inline-block; margin: 5px;">
                            <img src="${imgSrc}" 
                                 class="photo-thumb safe-detail-image" 
                                 ${photoDataAttr}
                                 data-type="${photo.type || 'utama'}"
                                 data-date="${photo.tanggal || ''}"
                                 data-source="${photo.source || 'local'}"
                                 style="width:100px; height:100px; object-fit:cover; border-radius:8px; border:2px solid var(--border-color); cursor:pointer;"
                                 loading="lazy"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'50\' y=\'50\' font-size=\'14\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ELoad Error%3C/text%3E%3C/svg%3E'">
                            <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 5;">
                                ${imageIndicator}
                            </div>
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; text-align: center; font-size: 11px; padding: 2px; border-radius: 0 0 8px 8px; z-index: 5;">
                                ${photo.type === 'utama' ? 'Utama' : photo.type === 'rusak' ? 'Rusak' : 'Perbaikan'}
                            </div>
                        </div>
                    `;
                } catch (photoError) {
                    console.warn("Error rendering photo:", photoError);
                }
            });
            
            photosHtml += '</div>';
        } else {
            photosHtml += '<p style="color: var(--secondary);">Belum ada foto untuk item ini.</p>';
        }

        // =============================================
        // TIMELINE SECTION
        // =============================================
        
        let timelineHtml = '<h3 style="margin-top:20px;"><i class="fas fa-history"></i> Riwayat Perubahan</h3>';

        if (asset.riwayat && Array.isArray(asset.riwayat) && asset.riwayat.length > 0) {
            timelineHtml += '<div class="timeline">';

            try {
                // Sort riwayat (terbaru dulu)
                const sortedRiwayat = [...asset.riwayat].sort((a, b) => {
                    try {
                        return new Date(b.tanggal) - new Date(a.tanggal);
                    } catch {
                        return 0;
                    }
                });

                sortedRiwayat.forEach(item => {
                    try {
                        const dateStr = safeFormatDate(item.tanggal);
                        let changesHtml = '';

                        if (item.tipe === 'create') {
                            changesHtml += `<div><strong>Item Dibuat</strong></div>`;

                            if (asset.jenis_item === 'asset') {
                                changesHtml += `
                                    <div><strong>Kondisi Awal:</strong> ${item.new_kondisi || '-'}</div>
                                `;
                            }

                            if (asset.jenis_item === 'non-asset') {
                                changesHtml += `
                                    <div><strong>Distribusi Awal:</strong>
                                        ${safeFormatDistribusi(item.new_kondisi_detail)}
                                    </div>
                                `;
                            }

                            changesHtml += `
                                <div><strong>Lokasi Awal:</strong> ${item.new_lokasi || '-'}</div>
                            `;
                        }

                        if (item.tipe === 'update') {
                            if (asset.jenis_item === 'asset' &&
                                item.old_kondisi !== item.new_kondisi) {
                                changesHtml += `
                                    <div><strong>Kondisi:</strong>
                                    ${item.old_kondisi || '-'}  ${item.new_kondisi || '-'}</div>
                                `;
                            }

                            if (asset.jenis_item === 'non-asset' &&
                                item.old_jumlah && item.new_jumlah) {
                                try {
                                    if (JSON.stringify(item.old_jumlah) !== JSON.stringify(item.new_jumlah)) {
                                        changesHtml += `
                                            <div><strong>Distribusi Jumlah:</strong></div>
                                            <div style="margin-left:10px;">
                                                <div>Sebelum:</div>
                                                ${safeFormatDistribusi(item.old_jumlah)}
                                                <div>Sesudah:</div>
                                                ${safeFormatDistribusi(item.new_jumlah)}
                                            </div>
                                        `;
                                    }
                                } catch (e) {
                                    // Abaikan jika error
                                }
                            }

                            if (item.old_lokasi !== item.new_lokasi) {
                                changesHtml += `
                                    <div><strong>Lokasi:</strong>
                                    ${item.old_lokasi || '-'}  ${item.new_lokasi || '-'}</div>
                                `;
                            }
                        }

                        timelineHtml += `
                            <div class="timeline-item">
                                <div class="timeline-date">
                                    ${dateStr}
                                </div>
                                <div class="timeline-content">
                                    ${changesHtml || '<em>Tidak ada perubahan utama</em>'}
                                    ${item.catatan ? `<p style="margin-top:6px;">${item.catatan}</p>` : ''}
                                    <div style="font-size:12px; color:var(--secondary);">
                                        ${item.user?.nama || 'System'}
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (itemError) {
                        console.warn("Error rendering timeline item:", itemError);
                    }
                });
            } catch (timelineError) {
                console.warn("Error processing timeline:", timelineError);
                timelineHtml += '<p style="color: var(--secondary);">Error memuat riwayat</p>';
            }

            timelineHtml += '</div>';
        } else {
            timelineHtml += '<p style="color: var(--secondary);">Belum ada riwayat perubahan.</p>';
        }

        // =============================================
        // MAIN CONTENT
        // =============================================
        
        content.innerHTML = `
            <div class="asset-card" style="margin-bottom:20px;">
                <div class="asset-header">
                    <div>
                        <div class="asset-title">${asset.nama_asset || 'Tanpa Nama'} ${syncStatus}</div>
                        <div class="asset-subtitle">
                            <span class="badge ${jenisClass}">${jenisText}</span> |
                            Kode: ${asset.material_kode || '-'} | 
                            ${asset.no_rs ? `No RS: ${asset.no_rs} | ` : ''}
                            ${asset.no_po ? `No PO: ${asset.no_po} | ` : ''}
                            No Asset: ${asset.jenis_item === 'asset' ? (asset.no_asset || '-') : '-'} |
                            Lokasi: ${asset.lokasi || '-'}
                        </div>
                    </div>
                    <div class="badge ${badgeClass}">${badgeText}</div>
                </div>

                <div style="margin-top:15px;">
                    <strong>Jumlah Total:</strong>
                    ${asset.jenis_item === 'non-asset' ? (asset.total_jumlah || 0) : '1'} unit
                </div>

                ${
                    asset.jenis_item === 'non-asset' && asset.kondisi_detail
                        ? `
                        <div style="margin-top:10px;">
                            <strong>Distribusi Saat Ini:</strong>
                            ${safeFormatDistribusi(asset.kondisi_detail)}
                        </div>
                        `
                        : ''
                }
            </div>

            ${photosHtml}
            ${timelineHtml}
        `;

        // Tampilkan modal
        modal.classList.add('active');



// =============================================
// SAFE EVENT LISTENERS UNTUK FOTO
// =============================================

setTimeout(() => {
    try {
        const photoElements = document.querySelectorAll('#assetDetailModal .safe-detail-image');
        
        photoElements.forEach((img, idx) => {
            img.addEventListener('click', function(e) {
                try {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Priority 1: Pakai src yang sudah di-render (sudah aman)
                    let imageSrc = this.src;
                    
                    // Cek apakah image valid (tidak placeholder error)
                    if (!imageSrc || 
                        imageSrc.includes('No Image') || 
                        imageSrc.includes('Load Error') || 
                        imageSrc.includes('Offline') ||
                        imageSrc.includes('svg')) {
                        
                        // Priority 2: Coba pakai local src
                        const localSrc = this.dataset.localSrc;
                        if (localSrc && localSrc !== 'null' && localSrc !== 'undefined') {
                            imageSrc = localSrc;
                        } 
                        // Priority 3: Coba cloudinary (hanya jika online)
                        else if (navigator.onLine) {
                            const cloudinarySrc = this.dataset.cloudinarySrc;
                            if (cloudinarySrc && cloudinarySrc !== 'null' && cloudinarySrc !== 'undefined') {
                                imageSrc = cloudinarySrc;
                            } else {
                                showToastNotification('Foto tidak tersedia', 'warning');
                                return;
                            }
                        } else {
                            showToastNotification('Foto tidak tersedia saat offline', 'warning');
                            return;
                        }
                    }
                    
                    // Validasi final
                    if (!imageSrc || imageSrc.includes('undefined') || imageSrc.includes('null')) {
                        showToastNotification('Sumber foto tidak valid', 'warning');
                        return;
                    }
                    
                    // Tampilkan di modal foto
                    const largePhoto = document.getElementById('largePhoto');
                    const photoInfo = document.getElementById('photoInfo');
                    
                    if (largePhoto) {
                        largePhoto.src = imageSrc;
                        
                        // Handle error pada large photo
                        largePhoto.onerror = function() {
                            this.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\' viewBox=\'0 0 400 300\'%3E%3Crect width=\'400\' height=\'300\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'200\' y=\'150\' font-size=\'20\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EGagal Memuat%3C/text%3E%3C/svg%3E';
                        };
                    }
                    
                    // Tampilkan info foto
                    if (photoInfo) {
                        const photoType = this.dataset.type || 'utama';
                        const photoDate = this.dataset.date ? new Date(this.dataset.date).toLocaleString('id-ID') : 'Tidak diketahui';
                        const photoSource = this.dataset.source || 'local';
                        
                        photoInfo.innerHTML = `
                            <p><strong>Tipe:</strong> ${photoType === 'utama' ? 'Foto Utama' : photoType}</p>
                            <p><strong>Sumber:</strong> ${photoSource === 'cloudinary' ? 'Cloudinary' : 'Lokal'}</p>
                            <p><strong>Tanggal:</strong> ${photoDate}</p>
                            ${!navigator.onLine && this.dataset.hasCloudinary === 'true' ? 
                                '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Foto HD tersedia saat online</p>' : ''}
                        `;
                    }
                    
                    // Buka modal foto
                    const photoModal = document.getElementById('photoModal');
                    if (photoModal) {
                        photoModal.classList.add('active');
                    }
                    
                } catch (clickError) {
                    console.error("Error handling photo click:", clickError);
                    showToastNotification('Gagal membuka foto', 'warning');
                }
            });
        });
        
        console.log(` ${photoElements.length} photo listeners attached`);
        
    } catch (listenerError) {
        console.error("Error setting up photo listeners:", listenerError);
    }
}, 100);

setTimeout(() => {
    try {
        // Event listener untuk print
        const printBtn = document.getElementById('printAssetDetail');
        if (printBtn) {
            // Hapus listener lama dengan mengganti element
            printBtn.replaceWith(printBtn.cloneNode(true));
            const newPrintBtn = document.getElementById('printAssetDetail');
            
            newPrintBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                window.print();
            });
            console.log(" Print button listener attached");
        } else {
            console.warn(" Print button not found in DOM");
        }
        
        // Event listener untuk share
        const shareBtn = document.getElementById('shareAssetDetail');
        if (shareBtn) {
            // Hapus listener lama
            shareBtn.replaceWith(shareBtn.cloneNode(true));
            const newShareBtn = document.getElementById('shareAssetDetail');
            
            newShareBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Ambil ulang asset (pastikan masih ada)
                const asset = assets.find(a => a.id === assetId);
                if (!asset) {
                    showToastNotification('Data asset tidak ditemukan', 'danger');
                    return;
                }
                
                // =============================================
// FUNGSI SHARE - LENGKAP DENGAN SEMUA INFORMASI
// =============================================

const effectiveCondition = getEffectiveCondition(asset);
const badgeText = effectiveCondition === 'baik' ? 'Baik' :
                 effectiveCondition === 'rusak' ? 'Rusak' :
                 effectiveCondition === 'Mutasi' ? 'Mutasi' : 'Distribusi';

// Format teks yang lebih lengkap
const shareTitle = `Detail Asset: ${asset.nama_asset}`;
const shareText = 
` *ASSET MANAGEMENT SYSTEM*


 *Nama Asset:* ${asset.nama_asset}
 *Kode Material:* ${asset.material_kode}
 *No. RS:* ${asset.no_rs || '-'}
 *No. PO:* ${asset.no_po || '-'}
 *No. Asset:* ${asset.jenis_item === 'asset' ? (asset.no_asset || '-') : '-'}
 *Lokasi:* ${asset.lokasi}
 *Jenis:* ${asset.jenis_item === 'asset' ? 'ASSET' : 'NON-ASSET'}
 *Kondisi:* ${badgeText}
 *Jumlah:* ${asset.jenis_item === 'non-asset' ? asset.total_jumlah : '1'} unit

${asset.jenis_item === 'non-asset' && asset.kondisi_detail ? 
` *Detail Distribusi:*
    Baik   : ${asset.kondisi_detail.baik || 0}
    Rusak  : ${asset.kondisi_detail.rusak || 0}
    Mutasi : ${asset.kondisi_detail.Mutasi || 0}` : ''}

 *Update Terakhir:* ${asset.updated_at ? new Date(asset.updated_at).toLocaleString('id-ID') : '-'}
 *Diupdate oleh:* ${asset.updated_by?.nama || '-'}


ID: ${asset.id}`;

if (navigator.share) {
    navigator.share({
        title: shareTitle,
        text: shareText,
        url: window.location.href
    }).catch(shareError => {
        // User membatalkan share bukan error
        if (shareError.name !== 'AbortError') {
            console.warn("Share failed:", shareError);
            showToastNotification('Gagal membagikan', 'warning');
        }
    });
} else {
    // Fallback: copy ke clipboard
    navigator.clipboard.writeText(shareText).then(() => {
        showToastNotification(' Data asset disalin ke clipboard', 'success');
    }).catch(() => {
        // Jika clipboard gagal, tampilkan alert
        alert(shareText);
    });
}

            });
            console.log(" Share button listener attached");
        } else {
            console.warn(" Share button not found in DOM");
        }
        
    } catch (error) {
        console.error("Error setting up button listeners:", error);
    }
}, 200); // Delay lebih lama untuk memastikan DOM siap

        // =============================================
        // CLOSE MODAL HANDLERS (sudah ada di event listener global)
        // =============================================
        
    } catch (error) {
        console.error(" Fatal error in showAssetDetail:", error);
        showToastNotification('Gagal memuat detail item', 'danger');
    }
}

async function handleUpdate(e) {

    e.preventDefault();

    let overlayStarted = false;

    try {

        const assetId = document.getElementById('assetSelect').value;
        const catatan = document.getElementById('updateCatatan').value.trim();
        const fotoInput = document.getElementById('updateFoto');

        if (!assetId) {
            showAlert('updateAlert', 'Pilih item terlebih dahulu', 'danger');
            return;
        }

        const asset = assets.find(a => a.id === assetId);

        if (!asset) {
            showAlert('updateAlert', 'Data tidak ditemukan', 'danger');
            return;
        }

        if (!catatan) {
            showAlert('updateAlert', 'Catatan wajib diisi', 'danger');
            return;
        }

        let newCondition = null;
        let mutationData = null;

        // ======================
        // VALIDASI ASSET
        // ======================
        if (asset.jenis_item === 'asset') {

            newCondition = document.getElementById('newCondition').value;

            if (!newCondition) {
                showAlert('updateAlert', 'Pilih kondisi baru', 'danger');
                return;
            }

            if (asset.kondisi !== newCondition && fotoInput.files.length === 0) {
                showAlert('updateAlert', 'Foto wajib jika kondisi berubah', 'danger');
                return;
            }
        }

        // ======================
        // VALIDASI NON-ASSET
        // ======================
        if (asset.jenis_item === 'non-asset') {

            const from = document.getElementById('mutationFrom').value;
            const to = document.getElementById('mutationTo').value;
            const qty = parseInt(document.getElementById('mutationQty').value);

            if (qty && qty > 0) {

                if (!from || !to || from === to) {
                    showAlert('updateAlert', 'Mutasi tidak valid', 'danger');
                    return;
                }

                const available = asset.kondisi_detail?.[from] || 0;

                if (qty > available) {
                    showAlert('updateAlert', 'Jumlah melebihi stok', 'danger');
                    return;
                }

                mutationData = { from, to, qty };
            }
        }

        // ======================
        // MULAI PROGRESS
        // ======================
        showProgressOverlay('update', {
            title: 'Memperbarui Item',
            subtitle: 'Sedang memproses update...'
        });

        overlayStarted = true;

        // beri waktu browser render overlay
        await new Promise(resolve => setTimeout(resolve, 50));

        updateProgressStep('validate', 'completed');
        updateProgressStep('prepare', 'active');
        updateProgressBar(20);

        let compressedImage = null;
        let file = null;

        // ======================
        // PROSES FOTO (jika ada)
        // ======================
        if (fotoInput.files.length > 0) {

            updateProgressStep('prepare', 'completed');
            updateProgressStep('process_photo', 'active');
            updateProgressBar(40);

            file = fotoInput.files[0];
            compressedImage = await compressImage(file);

            updateProgressStep('process_photo', 'completed');
            updateProgressStep('save_update', 'active');
            updateProgressBar(60);

        } else {
            updateProgressStep('prepare', 'completed');
            updateProgressStep('save_update', 'active');
            updateProgressBar(50);
        }

        // ======================
        // UPDATE DATA
        // ======================
        await updateAssetCondition(
            assetId,
            newCondition,
            catatan,
            compressedImage,
            file,
            null,
            mutationData
        );

        updateProgressStep('save_update', 'completed');
        updateProgressStep('sync', 'active');
        updateProgressBar(75);

        await loadAssets();
        await cleanupOrphanPhotos();
        updateDashboard();
        updateAssetSelects();
        loadAssetForUpdate(assetId);

        updateProgressStep('sync', 'completed');
        updateProgressStep('finalize', 'active');
        updateProgressBar(95);

        updateProgressStep('finalize', 'completed');
        updateProgressBar(100);
        updateProgressText('Update berhasil!');

        setTimeout(() => {
            hideProgressOverlay();
            showAlert('updateAlert', ' Update berhasil', 'success');
        }, 600);

    } catch (err) {

        console.error(err);

        if (overlayStarted) {
            hideProgressOverlay();
        }

        showAlert('updateAlert', err.message || 'Terjadi kesalahan', 'danger');
    }
}
// ==============================================
// FUNGSI HELPER: Update sync status
// ==============================================

async function updateAssetSyncStatus(assetId, status) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['assets'], 'readwrite');
        const store = transaction.objectStore('assets');
        
        const getRequest = store.get(assetId);
        
        getRequest.onsuccess = function() {
            const asset = getRequest.result;
            if (!asset) {
                reject(new Error("Asset not found in IndexedDB"));
                return;
            }
            
            asset.syncStatus = status;
            asset.lastUpdated = Date.now();
            
            // Jika status conflict, tambah info
            if (status === 'conflict') {
                asset.conflictDetected = Date.now();
                asset.conflictResolved = false;
            }
            
            const putRequest = store.put(asset);
            
            putRequest.onsuccess = function() {
                resolve();
            };
            
            putRequest.onerror = reject;
        };
        
        getRequest.onerror = reject;
    });
}
        // ==============================================
// MODIFIED: updateAssetCondition dengan Conflict Detection
// ==============================================

async function updateAssetCondition(
    assetId,
    newCondition,
    catatan,
    photoBase64,
    photoFile,
    newLokasi,
    mutationData = null
) {
    // Cegah double update
    if (window._isUpdating) {
        showToastNotification(' Update sedang berlangsung...', 'info');
        return null;
    }
    window._isUpdating = true;
    
    try {
        // 1. Validasi dasar
        const assetIndex = assets.findIndex(a => a.id === assetId);
        if (assetIndex === -1) {
            throw new Error("Item tidak ditemukan di data lokal");
        }

        const asset = assets[assetIndex];

        if (!currentUser) {
            throw new Error("Anda harus login untuk memperbarui item");
        }

        // 2. Siapkan data yang akan diupdate
        const updaterInfo = {
            uid: currentUser.uid,
            nama: currentUser.nama || currentUser.email,
            email: currentUser.email,
            jabatan: currentUser.jabatan || '',
            timestamp: Date.now()
        };

        const oldCondition = asset.kondisi;
        const oldLokasi = asset.lokasi;
        const finalLokasi = newLokasi || oldLokasi;

        // Buat draft data (belum disimpan)
        const draftAsset = {
            ...JSON.parse(JSON.stringify(asset)),
            lokasi: finalLokasi,
            updated_at: new Date().toISOString(),
            updated_by: updaterInfo,
            updatedAt: Date.now(), // NUMBER timestamp untuk deteksi
            updatedAtISO: new Date().toISOString(),
            updatedByName: updaterInfo.nama,
            syncStatus: 'pending'
        };

        // Update kondisi sesuai jenis item
        let oldJumlah = 1;
        let newJumlah = 1;

        if (draftAsset.jenis_item === 'asset') {
            draftAsset.kondisi = newCondition;
            draftAsset.total_jumlah = 1;
        } else if (mutationData) {
            // Logic non-asset (sama seperti sebelumnya)
            if (!draftAsset.kondisi_detail) {
                draftAsset.kondisi_detail = {
                    baik: draftAsset.total_jumlah || 0,
                    rusak: 0,
                    Mutasi: 0
                };
            }

            const detail = { ...draftAsset.kondisi_detail };
            const { from, to, qty } = mutationData;

            if (qty > (detail[from] || 0)) {
                throw new Error(`Jumlah melebihi stok kondisi ${from}. Tersedia: ${detail[from] || 0}`);
            }

            if (qty <= 0) {
                throw new Error("Jumlah perubahan harus lebih dari 0");
            }

            const oldDetailSnapshot = { ...detail };
            detail[from] -= qty;
            detail[to] = (detail[to] || 0) + qty;

            draftAsset.kondisi_detail = detail;
            draftAsset.kondisi = null;
            oldJumlah = oldDetailSnapshot;
            newJumlah = { ...detail };
        }

        // Tambah history
        if (!draftAsset.riwayat) draftAsset.riwayat = [];

        const historyEntry = {
            id: generateUUID(),
            tanggal: new Date().toISOString(),
            tipe: 'update',
            user: updaterInfo,
            old_kondisi: oldCondition,
            new_kondisi: draftAsset.kondisi,
            old_lokasi: oldLokasi,
            new_lokasi: finalLokasi,
            old_jumlah: oldJumlah,
            new_jumlah: newJumlah,
            catatan: catatan,
            source: 'update'
        };

        draftAsset.riwayat.push(historyEntry);

        // ============ CONFLICT DETECTION ============
        // Hanya cek konflik jika online
        if (navigator.onLine && isFirebaseConnected) {
            const conflictResult = await detectConflict(assetId, draftAsset);
            
            if (conflictResult.hasConflict) {
                // Tampilkan modal konflik
                const userChoice = await showConflictModal(conflictResult, asset.nama_asset);
                
                if (userChoice === 'refresh') {
                    // Jalankan sync dan reload data
                    showToastNotification(' Memuat data terbaru...', 'info');
                    
                    // Sync dulu
                    await runSyncNow();
                    
                    // Reload data untuk form update
                    await loadAssetForUpdate(assetId);
                    
                    // Update dashboard
                    await updateDashboard();
                    
                    showToastNotification(' Data telah diperbarui dari cloud', 'success');
                    
                    window._isUpdating = false;
                    return null; // Exit, jangan lanjut save
                    
                } else if (userChoice === 'cancel') {
                    showToastNotification('Update dibatalkan', 'info');
                    window._isUpdating = false;
                    return null;
                }
                // else 'override'  lanjut save (akan overwrite)
            }
        }
        // ============ END CONFLICT DETECTION ============

        // 3. Proses foto (jika ada)
        if (photoBase64) {
            const finalCondition = draftAsset.kondisi;
            const photoType = finalCondition === 'rusak' ? 'rusak' :
                             finalCondition === 'Mutasi' ? 'Mutasi' : 'update';

            await savePhotoWithCloudinary(
                assetId,
                photoType,
                photoBase64,
                photoFile,
                updaterInfo
            );
        }

        // 4. Simpan ke IndexedDB
        const savedAsset = await saveAssetToIndexedDB(draftAsset, 'pending');
        assets[assetIndex] = savedAsset;

        if (savedAsset.syncStatus === 'pending') {
            pendingSyncAssets = pendingSyncAssets.filter(a => a.id !== assetId);
            pendingSyncAssets.push(savedAsset);
        }
        if (navigator.onLine && isFirebaseConnected) {
            await updateCloudSyncMetadata([assetId]);
        }
        // 5. Sync ke Firestore jika online (dengan transaction)
        if (navigator.onLine && isFirebaseConnected) {
            try {
                // Gunakan transaction untuk atomic update
                await db.runTransaction(async (transaction) => {
                    const assetRef = db.collection('assets').doc(assetId);
                    const cloudDoc = await transaction.get(assetRef);
                    
                    if (cloudDoc.exists) {
                        const cloudData = cloudDoc.data();
                        const cloudTimestamp = cloudData.updatedAt || cloudData.lastUpdated || 0;
                        
                        // Double-check konflik di transaction
                        if (cloudTimestamp > draftAsset.updatedAt) {
                            throw new Error('CONFLICT_IN_TRANSACTION');
                        }
                    }
                    
                    // Siapkan data untuk Firestore
                    const { syncStatus, ...firestoreData } = draftAsset;
                    
                    // Dapatkan data foto
                    const photoData = await preparePhotosForFirestore(assetId);
                    
                    // Save dengan transaction
                    transaction.set(assetRef, {
                        ...firestoreData,
                        photos: photoData,
                        lastPhotoSync: Date.now()
                    }, { merge: true });
                });
                
                // Update status di IndexedDB
                await updateAssetSyncStatus(assetId, 'synced');
                assets[assetIndex].syncStatus = 'synced';
                
                console.log(` Asset ${assetId} synced to Firestore with transaction`);
                
            } catch (txError) {
                if (txError.message === 'CONFLICT_IN_TRANSACTION') {
                    // Konflik di detik terakhir
                    showToastNotification(' Terjadi konflik saat menyimpan. Memuat data terbaru...', 'warning');
                    
                    // Jalankan sync untuk refresh data
                    await runSyncNow();
                    
                    // Reload form
                    await loadAssetForUpdate(assetId);
                    
                    window._isUpdating = false;
                    return null;
                    
                } else {
                    console.warn(" Firestore sync failed, will retry later:", txError);
                    showToastNotification(' Gagal sync ke cloud, data tersimpan lokal', 'warning');
                }
            }
        }

        // 6. Log activity
        await logUserActivity('update_asset', {
            assetId,
            assetName: asset.nama_asset,
            old_kondisi: oldCondition,
            new_kondisi: newCondition,
            old_lokasi: oldLokasi,
            new_lokasi: finalLokasi
        });

        // 7. Jalankan sync di background (jika ada pending)
        if (!isSyncRunning && navigator.onLine) {
            setTimeout(runSyncNow, 1000);
        }

        showToastNotification(' Update berhasil disimpan', 'success');
        
        window._isUpdating = false;
        return savedAsset;

    } catch (error) {
        window._isUpdating = false;
        
        if (error.message === 'REFRESH_DONE' || error.message === 'UPDATE_CANCELLED') {
            // User memilih refresh/cancel, tidak perlu show error
            return null;
        }
        
        console.error(" Error updating asset:", error);
        throw error;
    }
}

        async function loadAssetForUpdate(assetId) {
    const asset = assets.find(a => a.id === assetId);
    if (!asset) return;
    
    const photos = await getAssetPhotos(assetId);
    
    document.getElementById('updateAssetName').textContent = asset.nama_asset;
    document.getElementById('updateAssetCode').textContent = asset.material_kode;
    document.getElementById('updateAssetCodeRs').textContent = asset.no_rs;
    document.getElementById('updateAssetLocation').textContent = asset.lokasi;
    document.getElementById('updateAssetNo').textContent = asset.no_asset || '-';
    document.getElementById('updateAssetJenis').textContent = asset.jenis_item === 'asset' ? 'Asset' : 'Non-Asset';
    
    const effectiveCondition = getEffectiveCondition(asset);
    document.getElementById('updateAssetCondition').textContent = effectiveCondition || '-';
    
    const badgeClass = effectiveCondition === 'baik' ? 'badge-success' :
                      effectiveCondition === 'rusak' ? 'badge-danger' :
                      effectiveCondition === 'Mutasi' ? 'badge-warning' : 'badge-info';
    
    const badgeText = effectiveCondition === 'baik' ? 'Baik' :
                     effectiveCondition === 'rusak' ? 'Rusak' :
                     effectiveCondition === 'Mutasi' ? 'Mutasi' : 'Distribusi';
    
    document.getElementById('updateAssetBadge').innerHTML = `<div class="badge ${badgeClass}">${badgeText}</div>`;
    
    const photosContainer = document.getElementById('updateAssetPhotos');
    photosContainer.innerHTML = '';
    
    if (photos.length > 0) {
        photos.forEach(photo => {
            // =============================================
            // TAMBAHKAN IMAGE INDICATOR DI SINI
            // =============================================
            const imageIndicator = photo.isThumbnail ? 
                '<span class="badge badge-info" style="font-size: 10px; position: absolute; top: 5px; right: 5px; z-index: 10;"><i class="fas fa-compress"></i> Thumb</span>' : 
                (photo.source === 'cloudinary' ? 
                    '<span class="cloudinary-badge" style="position: absolute; top: 5px; right: 5px; z-index: 10;"><i class="fas fa-cloud"></i> HD</span>' : 
                    '<span class="sync-badge" style="position: absolute; top: 5px; right: 5px; z-index: 10;"><i class="fas fa-database"></i> HD</span>');
            
            // Buat container untuk foto dengan posisi relative
            const container = document.createElement('div');
            container.style.position = 'relative';
            container.style.display = 'inline-block';
            container.style.margin = '5px';
            
            const img = document.createElement('img');
            img.src = photo.displayUrl;
            img.className = 'photo-thumb';
            img.alt = `Foto ${photo.type}`;
            img.setAttribute('data-image', photo.displayUrl);
            img.setAttribute('data-date', new Date(photo.tanggal).toLocaleDateString('id-ID'));
            img.setAttribute('data-type', photo.type);
            img.setAttribute('data-source', photo.source);
            img.setAttribute('data-is-thumbnail', photo.isThumbnail || false);
            
            img.addEventListener('click', function() {
                const imageSrc = this.getAttribute('data-image');
                const imageDate = this.getAttribute('data-date');
                const imageType = this.getAttribute('data-type');
                const imageSource = this.getAttribute('data-source');
                
                document.getElementById('largePhoto').src = imageSrc;
                document.getElementById('photoInfo').innerHTML = `
                    <p><strong>Tipe:</strong> ${imageType === 'utama' ? 'Foto Utama' : imageType === 'rusak' ? 'Foto Rusak' : 'Foto Perbaikan'}</p>
                    <p><strong>Sumber:</strong> ${imageSource === 'cloudinary' ? 'Cloudinary' : 'Lokal'}</p>
                    <p><strong>Kualitas:</strong> ${this.getAttribute('data-is-thumbnail') === 'true' ? 'Thumbnail' : 'Full HD'}</p>
                    <p><strong>Tanggal:</strong> ${imageDate}</p>
                `;
                
                document.getElementById('photoModal').classList.add('active');
            });
            
            container.appendChild(img);
            // Tambahkan imageIndicator sebagai HTML string ke container
            container.innerHTML += imageIndicator;
            
            photosContainer.appendChild(container);
        });
    } else {
        photosContainer.innerHTML = '<p>Belum ada foto untuk item ini.</p>';
    }
    
    const newConditionSelect = document.getElementById('newCondition');
    const mutationBox = document.getElementById('nonAssetMutationBox');
    
    if (asset.jenis_item === 'non-asset') {
        newConditionSelect.parentElement.style.display = 'none';
        newConditionSelect.removeAttribute('required');
        mutationBox.style.display = 'block';
    } else {
        newConditionSelect.parentElement.style.display = 'block';
        newConditionSelect.setAttribute('required', 'required');
        mutationBox.style.display = 'none';
    }
    
    document.getElementById('assetInfo').style.display = 'block';
}
        // ==============================================
// LOAD GALLERY DENGAN KETERANGAN KONDISI FOTO
// ==============================================
async function loadGallery(assetId = '') {
    try {
        const galleryContainer = document.getElementById('galleryContainer');
        let allPhotos = [];
        
        try {
            allPhotos = await getAllPhotos();
        } catch (photoError) {
            console.error("Error loading photos:", photoError);
            allPhotos = [];
        }
        
        const filterSource = document.getElementById('filterPhotoSource').value;
        
        let filteredPhotos = allPhotos;
        if (assetId) {
            filteredPhotos = allPhotos.filter(photo => photo.assetId === assetId);
        }
        
        if (filterSource) {
            if (filterSource === 'cloudinary') {
                filteredPhotos = filteredPhotos.filter(photo => photo.cloudinary);
            } else if (filterSource === 'local') {
                filteredPhotos = filteredPhotos.filter(photo => !photo.cloudinary);
            }
        }
        
        // ============ AMBIL DATA ASSET UNTUK INFO KONDISI ============
        const assetMap = {};
        assets.forEach(asset => {
            assetMap[asset.id] = {
                nama: asset.nama_asset,
                kondisi_saat_foto: null // Akan diisi dari riwayat nanti
            };
        });
        
        // Mapping kondisi foto berdasarkan timestamp
        // Kita perlu mencari kondisi asset pada saat foto diambil
        const photoConditionMap = new Map();
        
        for (const photo of filteredPhotos) {
            const asset = assets.find(a => a.id === photo.assetId);
            if (!asset) continue;
            
            let kondisiSaatFoto = 'tidak diketahui';
            let timestampFoto = photo.timestamp || new Date(photo.tanggal).getTime();
            
            // Cari di riwayat untuk mengetahui kondisi saat foto diambil
            if (asset.riwayat && Array.isArray(asset.riwayat)) {
                // Urutkan riwayat berdasarkan tanggal
                const sortedRiwayat = [...asset.riwayat].sort((a, b) => 
                    new Date(a.tanggal) - new Date(b.tanggal)
                );
                
                // Cari riwayat terdekat sebelum foto diambil
                let kondisiTerdekat = null;
                for (const riwayat of sortedRiwayat) {
                    const riwayatTime = new Date(riwayat.tanggal).getTime();
                    if (riwayatTime <= timestampFoto) {
                        if (asset.jenis_item === 'asset') {
                            kondisiTerdekat = riwayat.new_kondisi;
                        } else if (asset.jenis_item === 'non-asset') {
                            // Untuk non-asset, kita perlu dominant condition
                            const detail = riwayat.new_jumlah || riwayat.new_kondisi_detail;
                            if (detail) {
                                const baik = detail.baik || 0;
                                const rusak = detail.rusak || 0;
                                const mutasi = detail.Mutasi || 0;
                                
                                if (baik > rusak && baik > mutasi) kondisiTerdekat = 'baik';
                                else if (rusak > baik && rusak > mutasi) kondisiTerdekat = 'rusak';
                                else if (mutasi > baik && mutasi > rusak) kondisiTerdekat = 'Mutasi';
                                else kondisiTerdekat = 'distribusi';
                            }
                        }
                    }
                }
                
                // Jika tidak ditemukan di riwayat, cek langsung dari asset
                if (!kondisiTerdekat) {
                    if (asset.jenis_item === 'asset') {
                        kondisiTerdekat = asset.kondisi;
                    } else {
                        const detail = asset.kondisi_detail;
                        if (detail) {
                            const baik = detail.baik || 0;
                            const rusak = detail.rusak || 0;
                            const mutasi = detail.Mutasi || 0;
                            
                            if (baik > rusak && baik > mutasi) kondisiTerdekat = 'baik';
                            else if (rusak > baik && rusak > mutasi) kondisiTerdekat = 'rusak';
                            else if (mutasi > baik && mutasi > rusak) kondisiTerdekat = 'Mutasi';
                            else kondisiTerdekat = 'distribusi';
                        }
                    }
                }
                
                photoConditionMap.set(photo.id || `${photo.assetId}_${photo.timestamp}`, kondisiTerdekat);
            }
        }
        
        if (!filteredPhotos || filteredPhotos.length === 0) {
            galleryContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-images"></i>
                    <h3>Belum ada foto</h3>
                    <p>${!navigator.onLine ? 'Mode offline - foto cloudinary tidak tersedia' : 'Foto akan ditampilkan setelah item ditambahkan'}</p>
                </div>
            `;
            return;
        }
        
        // Sort photos by date (newest first)
        filteredPhotos.sort((a, b) => {
            const timeA = a.timestamp || new Date(a.tanggal).getTime();
            const timeB = b.timestamp || new Date(b.tanggal).getTime();
            return timeB - timeA;
        });
        
        let html = '<div class="gallery-grid">';
        
        filteredPhotos.forEach((photo, index) => {
            // Tentukan sumber gambar yang AMAN
            let imgSrc = null;
            let source = 'local';
            
            // OFFLINE-FIRST
            if (photo.image) {
                imgSrc = photo.image;
            } else if (photo.thumbnail) {
                imgSrc = photo.thumbnail;
                source = 'thumbnail';
            } else if (photo.cloudinary && photo.cloudinary.secure_url && navigator.onLine) {
                imgSrc = photo.cloudinary.secure_url;
                source = 'cloudinary';
            } else {
                imgSrc = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'150\' viewBox=\'0 0 200 150\'%3E%3Crect width=\'200\' height=\'150\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'100\' y=\'75\' font-size=\'14\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EImage Unavailable%3C/text%3E%3C/svg%3E';
                source = 'unavailable';
            }
            
            // ============ TENTUKAN KONDISI FOTO ============
            const photoKey = photo.id || `${photo.assetId}_${photo.timestamp}`;
            let kondisiFoto = photoConditionMap.get(photoKey) || 'tidak diketahui';
            
            // Fallback: cek dari type foto
            if (kondisiFoto === 'tidak diketahui') {
                if (photo.type === 'rusak') kondisiFoto = 'rusak';
                else if (photo.type === 'Mutasi') kondisiFoto = 'Mutasi';
                else if (photo.type === 'baik') kondisiFoto = 'baik';
                else if (photo.type === 'utama') {
                    // Coba cek dari asset
                    const asset = assets.find(a => a.id === photo.assetId);
                    if (asset) {
                        if (asset.jenis_item === 'asset') {
                            kondisiFoto = asset.kondisi || 'tidak diketahui';
                        } else {
                            const detail = asset.kondisi_detail;
                            if (detail) {
                                const baik = detail.baik || 0;
                                const rusak = detail.rusak || 0;
                                const mutasi = detail.Mutasi || 0;
                                
                                if (baik > rusak && baik > mutasi) kondisiFoto = 'baik';
                                else if (rusak > baik && rusak > mutasi) kondisiFoto = 'rusak';
                                else if (mutasi > baik && mutasi > rusak) kondisiFoto = 'Mutasi';
                                else kondisiFoto = 'distribusi';
                            }
                        }
                    }
                }
            }
            
            // ============ TENTUKAN BADGE KONDISI ============
            let kondisiBadge = '';
            let kondisiClass = '';
            let kondisiIcon = '';
            
            switch(kondisiFoto) {
                case 'baik':
                    kondisiBadge = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Baik</span>';
                    kondisiClass = 'gallery-condition-baik';
                    kondisiIcon = '';
                    break;
                case 'rusak':
                    kondisiBadge = '<span class="badge badge-danger"><i class="fas fa-exclamation-triangle"></i> Rusak</span>';
                    kondisiClass = 'gallery-condition-rusak';
                    kondisiIcon = '';
                    break;
                case 'Mutasi':
                    kondisiBadge = '<span class="badge badge-warning"><i class="fas fa-exchange-alt"></i> Mutasi</span>';
                    kondisiClass = 'gallery-condition-mutasi';
                    kondisiIcon = '';
                    break;
                case 'distribusi':
                    kondisiBadge = '<span class="badge badge-info"><i class="fas fa-chart-pie"></i> Distribusi</span>';
                    kondisiClass = 'gallery-condition-distribusi';
                    kondisiIcon = '';
                    break;
                default:
                    kondisiBadge = '<span class="badge badge-secondary"><i class="fas fa-question"></i> Tidak Diketahui</span>';
                    kondisiClass = 'gallery-condition-unknown';
                    kondisiIcon = '';
            }
            
            const typeText = photo.type === 'utama' ? 'Utama' : 
                            photo.type === 'rusak' ? 'Rusak' : 
                            photo.type === 'Mutasi' ? 'Mutasi' : 
                            photo.type === 'baik' ? 'Baik' : 'Perbaikan';
            
            const typeClass = photo.type === 'utama' ? 'badge-info' : 
                             photo.type === 'rusak' ? 'badge-danger' : 
                             photo.type === 'Mutasi' ? 'badge-warning' : 
                             photo.type === 'baik' ? 'badge-success' : 'badge-secondary';
            
            const sourceBadge = source === 'cloudinary' ? 
                '<span class="cloudinary-badge"><i class="fas fa-cloud"></i> Cloudinary</span>' : 
                source === 'thumbnail' ?
                '<span class="sync-badge"><i class="fas fa-compress"></i> Thumbnail</span>' :
                source === 'local' ?
                '<span class="sync-badge"><i class="fas fa-database"></i> Lokal</span>' :
                '<span class="badge badge-secondary">Tidak Tersedia</span>';
            
            const date = photo.tanggal ? new Date(photo.tanggal).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '-';
            
            const assetInfo = assetMap[photo.assetId]?.nama || photo.assetId;
            
            html += `
                <div class="gallery-item gallery-item-${kondisiClass}" data-photo-index="${index}" data-kondisi="${kondisiFoto}">
                    <div style="position: relative;">
                        <img src="${imgSrc}" 
                             alt="Foto ${assetInfo}" 
                             class="gallery-image safe-gallery-image" 
                             data-photo-id="${photo.id || ''}"
                             data-asset-id="${photo.assetId}"
                             data-kondisi="${kondisiFoto}"
                             data-type="${photo.type}"
                             data-tanggal="${photo.tanggal}"
                             data-has-cloudinary="${!!photo.cloudinary}"
                             data-has-local="${!!photo.image}"
                             data-local-src="${photo.image || photo.thumbnail || ''}"
                             data-cloudinary-src="${photo.cloudinary?.secure_url || ''}"
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'150\' viewBox=\'0 0 200 150\'%3E%3Crect width=\'200\' height=\'150\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'100\' y=\'75\' font-size=\'14\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3E${kondisiIcon} ${kondisiFoto}%3C/text%3E%3C/svg%3E'">
                        
                        <!-- BADGE KONDISI DI ATAS FOTO -->
                        <div style="position: absolute; top: 10px; left: 10px; z-index: 10;">
                            ${kondisiBadge}
                        </div>
                        
                        <!-- BADGE TIPE FOTO -->
                        <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                            <span class="badge ${typeClass}">${typeText}</span>
                        </div>
                        
                        <!-- INDIKATOR SUMBER (jika thumbnail) -->
                        ${source === 'thumbnail' ? `
                            <div style="position: absolute; bottom: 10px; left: 10px; z-index: 10;">
                                <span class="badge badge-info" style="font-size: 10px;"><i class="fas fa-compress"></i> Thumb</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="gallery-info">
                        <div class="gallery-asset" title="${assetInfo}">
                            <i class="fas fa-cube"></i> ${assetInfo.length > 30 ? assetInfo.substring(0, 30) + '...' : assetInfo}
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin: 8px 0;">
                            ${sourceBadge}
                            ${photo.cloudinary ? '<span class="cloudinary-badge"><i class="fas fa-cloud-upload-alt"></i> HD</span>' : ''}
                        </div>
                        
                        <div class="gallery-date">
                            <i class="fas fa-calendar-alt"></i> ${date}
                        </div>
                        
                        <!-- TOMBOL LIHAT DETAIL -->
                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                            <button class="btn btn-outline btn-small" style="flex:1; padding: 4px;" onclick="showAssetDetail('${photo.assetId}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                            <button class="btn btn-outline btn-small" style="flex:1; padding: 4px;" onclick="downloadPhoto('${photo.assetId}', ${index})">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        galleryContainer.innerHTML = html;
        
        // ============ TAMBAHKAN CSS DINAMIS ============
        const style = document.createElement('style');
        style.textContent = `
            .gallery-condition-baik { border-top: 4px solid #10b981; }
            .gallery-condition-rusak { border-top: 4px solid #ef4444; }
            .gallery-condition-mutasi { border-top: 4px solid #f59e0b; }
            .gallery-condition-distribusi { border-top: 4px solid #3b82f6; }
            .gallery-condition-unknown { border-top: 4px solid #9ca3af; }
            
            .gallery-item {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            .gallery-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            }
        `;
        document.head.appendChild(style);
        
        // ============ EVENT LISTENER UNTUK FOTO ============
        document.querySelectorAll('.safe-gallery-image').forEach(img => {
            img.addEventListener('click', function(e) {
                try {
                    let imageSrc = this.src;
                    
                    // Cek apakah image valid
                    if (imageSrc.includes('Unavailable') || imageSrc.includes('Load Error') || imageSrc.includes('svg')) {
                        // Coba pakai local
                        const localSrc = this.dataset.localSrc;
                        if (localSrc) {
                            imageSrc = localSrc;
                        } else {
                            showToastNotification('Gambar tidak dapat ditampilkan', 'warning');
                            return;
                        }
                    }
                    
                    // Cari data foto
                    const photoIndex = this.closest('.gallery-item')?.dataset.photoIndex;
                    const photo = filteredPhotos[parseInt(photoIndex)];
                    
                    document.getElementById('largePhoto').src = imageSrc;
                    
                    let infoHtml = '';
                    if (photo) {
                        const fullDate = photo.tanggal ? new Date(photo.tanggal).toLocaleString('id-ID', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Tidak diketahui';
                        
                        const kondisi = this.dataset.kondisi || 'tidak diketahui';
                        const kondisiText = kondisi === 'baik' ? 'Baik' : 
                                           kondisi === 'rusak' ? 'Rusak' : 
                                           kondisi === 'Mutasi' ? 'Mutasi' : 
                                           kondisi === 'distribusi' ? 'Distribusi' : 'Tidak Diketahui';
                        
                        infoHtml = `
                            <div style="text-align: left; padding: 10px;">
                                <p><strong><i class="fas fa-cube"></i> Item:</strong> ${assetMap[photo.assetId]?.nama || photo.assetId}</p>
                                <p><strong><i class="fas fa-tag"></i> Tipe Foto:</strong> ${photo.type === 'utama' ? 'Foto Utama' : photo.type}</p>
                                <p><strong><i class="fas fa-clipboard-check"></i> Kondisi Saat Foto:</strong> 
                                    <span class="badge ${
                                        kondisi === 'baik' ? 'badge-success' :
                                        kondisi === 'rusak' ? 'badge-danger' :
                                        kondisi === 'Mutasi' ? 'badge-warning' :
                                        kondisi === 'distribusi' ? 'badge-info' : 'badge-secondary'
                                    }">${kondisiText}</span>
                                </p>
                                <p><strong><i class="fas fa-calendar"></i> Tanggal:</strong> ${fullDate}</p>
                                <p><strong><i class="fas fa-cloud"></i> Sumber:</strong> ${photo.cloudinary ? 'Cloudinary (HD)' : 'Lokal'}</p>
                                ${!navigator.onLine && photo.cloudinary ? '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Foto HD tersedia saat online</p>' : ''}
                            </div>
                        `;
                    }
                    
                    document.getElementById('photoInfo').innerHTML = infoHtml;
                    document.getElementById('photoModal').classList.add('active');
                    
                } catch (clickError) {
                    console.error("Gallery click error:", clickError);
                    showToastNotification('Gagal membuka foto', 'warning');
                }
            });
        });
        
    } catch (error) {
        console.error("Gallery load error:", error);
        document.getElementById('galleryContainer').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                <h3>Gagal memuat galeri</h3>
                <p>${error.message || 'Terjadi kesalahan'}</p>
                <button class="btn btn-outline btn-small" onclick="loadGallery()">
                    <i class="fas fa-redo-alt"></i> Coba Lagi
                </button>
            </div>
        `;
    }
}

// ==============================================
// FUNGSI DOWNLOAD FOTO (OPSIONAL)
// ==============================================
async function downloadPhoto(assetId, photoIndex) {
    const photos = await getAssetPhotos(assetId);
    if (!photos || photos.length === 0 || photoIndex >= photos.length) return;
    
    const photo = photos[photoIndex];
    
    // Tentukan sumber gambar terbaik
    let imgSrc = null;
    let filename = `foto_${assetId}_${Date.now()}.jpg`;
    
    if (navigator.onLine && photo.cloudinary?.secure_url) {
        imgSrc = photo.cloudinary.secure_url;
    } else if (photo.image) {
        imgSrc = photo.image;
    } else if (photo.thumbnail) {
        imgSrc = photo.thumbnail;
        filename = `thumbnail_${assetId}_${Date.now()}.jpg`;
    }
    
    if (!imgSrc) {
        showToastNotification('Tidak ada sumber foto untuk didownload', 'warning');
        return;
    }
    
    try {
        // Download dengan fetch
        const response = await fetch(imgSrc);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToastNotification(' Foto didownload', 'success');
    } catch (error) {
        console.error("Download error:", error);
        showToastNotification(' Gagal download foto', 'danger');
    }
}
        
        function updateAssetSelects() {
            const assetSelect = document.getElementById('assetSelect');
            const galeriSelect = document.getElementById('galeriAssetSelect');
            
            while (assetSelect.options.length > 1) {
                assetSelect.remove(1);
            }
            
            while (galeriSelect.options.length > 1) {
                galeriSelect.remove(1);
            }
            
            assets.forEach(asset => {
                const syncIndicator = asset.syncStatus === 'pending' ? ' (Pending Sync)' : '';
                const jenisIndicator = asset.jenis_item === 'asset' ? '[A]' : '[NA]';
                const option1 = document.createElement('option');
                option1.value = asset.id;
                const effectiveCondition = getEffectiveCondition(asset) || '-';

option1.textContent =
    `${jenisIndicator} ${asset.nama_asset} (${asset.material_kode}) - ${effectiveCondition}${syncIndicator}`;

                assetSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = asset.id;
                option2.textContent = `${jenisIndicator} ${asset.nama_asset} (${asset.material_kode})`;
                galeriSelect.appendChild(option2);
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                }
            });
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'daftar') {
                displayAssets();
            } else if (tabName === 'galeri') {
                loadGallery();
            }
        }

// ==============================================
// BACKUP & EXPORT FUNCTIONS - VERSI LENGKAP
// ==============================================

// ============= VARIABEL GLOBAL UNTUK IMPORT =============
let importDraftData = [];
let selectedImportFile = null;
let selectedImportType = null;
let zipPreviewCache = null;
let currentZipFile = null;
let currentPreviewData = null;

// ============= FUNGSI UTILITY IMPORT =============
function openImportPreview() {
    document.getElementById('importPreviewModal').classList.add('active');
}

function closeImportPreview() {
    document.getElementById('importPreviewModal').classList.remove('active');
    importDraftData = [];
}

function closeZipPreview() {
    document.getElementById('zipImportModal').classList.remove('active');
    currentPreviewData = null;
    currentZipFile = null;
}



function normalizeRow(row) {
    return {
        nama_asset: (row.nama_asset || '').trim(),
        material_kode: (row.material_kode || '').replace(/\s+/g, '').toUpperCase(),
        no_rs: (row.no_rs || '').replace(/\s+/g, '').toUpperCase(),
        no_po: row.no_po || '',
        no_asset: row.no_asset || '',
        lokasi: (row.lokasi || '').trim(),
        kondisi: (row.kondisi || 'baik').toLowerCase(),
        jumlah: parseInt(row.jumlah || 1),
        catatan_awal: row.catatan_awal || '',
        photos: [],
        valid: true,
        errors: [],
        conflict: false
    };
}



// ============= FUNGSI IMPORT EXCEL =============
function handleExcelImport(input) {
    const file = input.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.xlsx')) {
        showAlert('importAlert', ' File harus berekstensi .xlsx', 'danger');
        return;
    }
    
    showAlert('importAlert', ' Membaca file Excel...', 'info');
    previewExcelImport(file);
}

async function previewExcelImport(file) {
    if (!requireInternet('Import Excel')) return;
    if (!currentUser) {
        showAlert('importAlert', 'Harus login dulu', 'danger');
        return;
    }

    const reader = new FileReader();

    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            importDraftData = [];

            // --- ASSET SHEET ---
            const assetSheet = workbook.Sheets['ASSET'];
            if (assetSheet) {
                const rows = XLSX.utils.sheet_to_json(assetSheet);
                rows.forEach(r => {
                    importDraftData.push({
                        ...normalizeRow(r),
                        jenis_item: 'asset'
                    });
                });
            }

            // --- NON ASSET SHEET ---
            const nonAssetSheet = workbook.Sheets['NON_ASSET'];
            if (nonAssetSheet) {
                const rows = XLSX.utils.sheet_to_json(nonAssetSheet);
                rows.forEach(r => {
                    importDraftData.push({
                        ...normalizeRow(r),
                        jenis_item: 'non-asset'
                    });
                });
            }

            if (importDraftData.length === 0) {
                showAlert('importAlert', ' Tidak ada data yang ditemukan', 'danger');
                return;
            }

            validateImportDraft();
            renderImportPreview();
            
        } catch (error) {
            console.error("Import error:", error);
            showAlert('importAlert', ` Gagal membaca file: ${error.message}`, 'danger');
        }
    };

    reader.readAsArrayBuffer(file);
}

function validateImportDraft() {
    importDraftData.forEach(row => {
        row.valid = true;
        row.errors = [];
        row.conflict = false;

        if (!row.nama_asset) row.errors.push('Nama kosong');
        if (!row.material_kode) row.errors.push('Material kosong');
        if (!row.no_rs) row.errors.push('No RS kosong');
        if (!row.lokasi) row.errors.push('Lokasi kosong');

        if (row.jenis_item === 'non-asset') {
            if (!row.jumlah || row.jumlah <= 0)
                row.errors.push('Jumlah tidak valid');
        }

        const duplicate = checkDuplicateAsset(row.material_kode, row.no_rs);
        if (duplicate) {
            row.conflict = true;
            row.errors.push('Konflik data sudah ada');
        }

        if (row.errors.length > 0) {
            row.valid = false;
        }
    });
}

function renderImportPreview() {
    const container = document.getElementById('importPreviewContainer');
    container.innerHTML = '';

    importDraftData.forEach((row, index) => {
        const div = document.createElement('div');
        div.className = 'import-row ' + (row.valid ? 'import-valid' : 'import-invalid');

        const conflictBadge = row.conflict ? 
            '<span class="badge badge-danger" style="margin-left: 5px;"><i class="fas fa-exclamation-triangle"></i> Konflik</span>' : '';

        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${row.nama_asset || '(Tanpa Nama)'}</strong> ${conflictBadge}
                    <div style="font-size: 12px; color: var(--secondary);">
                        ${row.material_kode} | ${row.no_rs} | ${row.lokasi}
                    </div>
                </div>
                <span class="badge ${row.jenis_item === 'asset' ? 'badge-info' : 'badge-warning'}">
                    ${row.jenis_item === 'asset' ? 'Asset' : 'Non-Asset'}
                </span>
            </div>
            
            ${row.errors.length > 0 ? `
                <div style="margin-top: 8px; padding: 5px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; font-size: 12px; color: var(--danger);">
                    <i class="fas fa-exclamation-circle"></i> ${row.errors.join(', ')}
                </div>
            ` : ''}
            
            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                <input type="file" 
                       accept="image/*" 
                       onchange="handleImportPhoto(${index}, this)"
                       style="flex: 1; padding: 5px; font-size: 12px;">
                <button onclick="removeImportRow(${index})" class="btn btn-danger btn-small">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            ${row.photos && row.photos.length > 0 ? `
                <div style="margin-top: 5px; font-size: 11px; color: var(--success);">
                    <i class="fas fa-check"></i> ${row.photos.length} foto terpilih
                </div>
            ` : ''}
        `;

        container.appendChild(div);
    });

    openImportPreview();
}

function handleImportPhoto(index, input) {
    const file = input.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
        showAlert('importAlert', ` File terlalu besar: ${(file.size/1024/1024).toFixed(2)}MB (max 5MB)`, 'danger');
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        if (!importDraftData[index].photos) {
            importDraftData[index].photos = [];
        }
        importDraftData[index].photos.push(e.target.result);
        renderImportPreview();
        showAlert('importAlert', ` Foto ${file.name} ditambahkan`, 'success');
    };
    reader.onerror = function() {
        showAlert('importAlert', ' Gagal membaca file foto', 'danger');
    };
    reader.readAsDataURL(file);
}

function removeImportRow(index) {
    importDraftData.splice(index, 1);
    renderImportPreview();
}

// ============= FUNGSI IMPORT EXCEL DENGAN PROGRESS REALTIME =============
// ==============================================
// FUNGSI IMPORT EXCEL - LENGKAP DENGAN NORMALIZER
// ==============================================

async function saveImportedData() {
    if (!currentUser) {
        showAlert('importAlert', 'Harus login', 'danger');
        return;
    }

    validateImportDraft();

    const invalid = importDraftData.filter(r => !r.valid);
    if (invalid.length > 0) {
        showAlert('importAlert', ' Masih ada data tidak valid', 'danger');
        return;
    }

    showProgressOverlay('import', {
        title: 'Mengimpor Data Excel',
        subtitle: 'Menyimpan data ke database...'
    });

    try {
        let successCount = 0;
        let errorCount = 0;
        let photoSuccessCount = 0;
        let photoErrorCount = 0;
        const totalRows = importDraftData.length;
        let totalPhotos = 0;
        const importedAssetIds = []; //  Untuk update metadata
        
        // Hitung total foto untuk progress
        importDraftData.forEach(row => {
            totalPhotos += row.photos?.length || 0;
        });

        // STEP 1: Mulai import asset
        updateProgressStep('read_zip', 'completed');
        updateProgressStep('import_assets', 'active');
        updateProgressBar(10);
        updateProgressText(`Mengimport 0 dari ${totalRows} item...`);

        for (let i = 0; i < importDraftData.length; i++) {
            const row = importDraftData[i];
            
            try {
                // Update progress setiap item
                const progress = 10 + (i / totalRows) * 40;
                updateProgressBar(progress);
                updateProgressText(`Mengimport item ${i+1} dari ${totalRows}: ${row.nama_asset}`);

                //  GUNAKAN NORMALIZER
                const assetData = normalizeAssetData(
                    {
                        ...row,
                        jenis_item: row.jenis_item,
                        kondisi: row.kondisi,
                        jumlah: row.jumlah,
                        // Data dari Excel tidak punya ID, jadi dibiarkan kosong
                    },
                    {
                        userInfo: currentUser,
                        isImport: true,
                        source: 'excel',
                        timestamp: Date.now() + i // Berbeda tiap row
                    }
                );

                // Simpan ke IndexedDB
                await saveAssetToIndexedDB(assetData, 'pending');
                
                // Catat ID untuk update metadata nanti
                importedAssetIds.push(assetData.id);
                successCount++;
                
            } catch (rowError) {
                console.error("Error saving row:", rowError);
                errorCount++;
            }
        }

        // STEP 2: Import foto (jika ada)
        if (totalPhotos > 0) {
            updateProgressStep('import_assets', 'completed');
            updateProgressStep('import_photos', 'active');
            updateProgressBar(60);
            updateProgressText(`Mengimport ${totalPhotos} foto...`);

            let photoProgress = 0;
            
            for (let i = 0; i < importDraftData.length; i++) {
                const row = importDraftData[i];
                
                if (row.photos && row.photos.length > 0) {
                    //  CARI ID ASSET YANG SUDAH DIBUAT
                    // Kita perlu mapping ulang karena ID dibuat di loop sebelumnya
                    // Cara termudah: buat ulang ID dengan formula yang sama
                    
                    const timestamp = Date.now() + i;
                    const random = Math.random().toString(36).substring(2,8).toUpperCase();
                    const idPrefix = row.jenis_item === 'asset' ? 'A' : 'N';
                    const materialKode = row.material_kode.toString().replace(/\s+/g, '').toUpperCase();
                    const assetId = `${idPrefix}-${materialKode}-${timestamp}-${random}-1`;

                    for (let j = 0; j < row.photos.length; j++) {
                        const base64 = row.photos[j];
                        
                        try {
                            updateProgressText(`Mengimport foto ${photoProgress + 1} dari ${totalPhotos}...`);
                            
                            await savePhotoWithCloudinary(
                                assetId,
                                'utama',
                                base64,
                                null, // file
                                {
                                    uid: currentUser.uid,
                                    nama: currentUser.nama || currentUser.email,
                                    email: currentUser.email
                                }
                            );
                            
                            photoSuccessCount++;
                            
                        } catch (photoError) {
                            console.error("Error saving photo:", photoError);
                            photoErrorCount++;
                        }
                        
                        photoProgress++;
                        const photoProgressPercent = 60 + (photoProgress / totalPhotos) * 20;
                        updateProgressBar(photoProgressPercent);
                    }
                }
            }
        }

        // STEP 3: Reload data
        updateProgressStep('import_photos', 'completed');
        updateProgressStep('reload_data', 'active');
        updateProgressBar(85);
        updateProgressText('Memuat ulang data...');

        await loadAssets();
        await cleanupOrphanPhotos();
        updateAssetSelects();
        displayAssets();
        updateDashboard();

        // ============== UPDATE METADATA CLOUD ==============
        if (navigator.onLine && isFirebaseConnected && importedAssetIds.length > 0) {
            updateProgressText('Mengupdate metadata cloud...');
            await updateCloudSyncMetadata(importedAssetIds);
        }

        // STEP 4: Finalisasi
        updateProgressStep('reload_data', 'completed');
        updateProgressStep('finalize', 'active');
        updateProgressBar(95);
        updateProgressText('Menyelesaikan...');

        // Jalankan sync jika online
        if (navigator.onLine && !isSyncRunning) {
            setTimeout(runSyncNow, 2000);
        }

        updateProgressStep('finalize', 'completed');
        updateProgressBar(100);
        updateProgressText('Import selesai!');

        setTimeout(() => {
            hideProgressOverlay();
            closeImportPreview();
            
            const totalSuccess = successCount + photoSuccessCount;
            const totalError = errorCount + photoErrorCount;
            
            showAlert('importAlert', 
                ` Import Excel berhasil!\n Asset: ${successCount} (${errorCount} gagal)\n Foto: ${photoSuccessCount} (${photoErrorCount} gagal)`,
                totalError > 0 ? 'warning' : 'success'
            );
        }, 1000);

        // Reset variabel global
        importDraftData = [];
        document.getElementById('importFile').value = '';
        document.getElementById('btnImport').style.display = 'none';
        document.getElementById('importAlert').style.display = 'none';

    } catch (error) {
        console.error("Import error:", error);
        showProgressError(`Gagal import: ${error.message}`);
        
        setTimeout(() => {
            hideProgressOverlay();
            showAlert('importAlert', ` Gagal import: ${error.message}`, 'danger');
        }, 2000);
    }
}

// ============= FUNGSI IMPORT ZIP DENGAN PROGRESS REALTIME =============
async function previewZipImport(zipFile) {
    if (!requireInternet('Import ZIP')) return;
    if (!currentUser) {
        showAlert('importAlert', 'Harus login dulu', 'danger');
        return;
    }

    showProgressOverlay('import', {
        title: 'Menganalisis File Backup',
        subtitle: 'Membaca struktur ZIP...'
    });

    try {
        // STEP 1: Membaca ZIP
        updateProgressStep('read_zip', 'active');
        updateProgressBar(10);
        updateProgressText('Membaca file ZIP...');

        const zip = await JSZip.loadAsync(zipFile);
        
        updateProgressBar(30);
        updateProgressText('Membaca data JSON...');

        // BACA FILE JSON
        const assetsFile = zip.file("assets_data.json");
        const photosMetaFile = zip.file("photos_meta.json");
        const backupInfoFile = zip.file("backup_info.json");
        
        if (!assetsFile) {
            throw new Error("File ZIP tidak valid: tidak ditemukan assets_data.json");
        }
        
        const importedAssets = JSON.parse(await assetsFile.async("text"));
        const importedPhotosMeta = photosMetaFile ? JSON.parse(await photosMetaFile.async("text")) : [];
        const backupInfo = backupInfoFile ? JSON.parse(await backupInfoFile.async("text")) : null;
        
        updateProgressBar(50);
        updateProgressText('Membaca file foto...');

        // BACA FILE FOTO DARI FOLDER /photos
        const photoFiles = [];
        const photosFolder = zip.folder("photos");
        if (photosFolder) {
            photosFolder.forEach((relativePath, file) => {
                photoFiles.push({
                    name: relativePath,
                    file: file
                });
            });
        }
        
        updateProgressBar(70);
        updateProgressText('Menganalisis konflik data...');

        // LOAD DATA LOKAL UNTUK CEK KONFLIK
        const localAssets = await loadAssetsFromIndexedDB();
        
        // Buat Map untuk quick lookup
        const localMap = new Map();
        localAssets.forEach(local => {
            const key = `${normalizeValue(local.material_kode)}|${normalizeValue(local.no_rs)}`;
            localMap.set(key, local);
        });
        
        // ANALISIS DATA
        const previewData = {
            assets: [],
            photos: importedPhotosMeta,
            photoFiles: photoFiles,
            backupInfo: backupInfo,
            stats: {
                total: importedAssets.length,
                new: 0,
                conflict: 0,
                same: 0,
                photos_in_zip: photoFiles.length,
                photos_in_meta: importedPhotosMeta.length
            }
        };
        
        // Progress untuk analisis asset
        for (let i = 0; i < importedAssets.length; i++) {
            const imp = importedAssets[i];
            
            if (i % 10 === 0) {
                updateProgressText(`Menganalisis asset ${i+1} dari ${importedAssets.length}...`);
            }
            
            const key = `${normalizeValue(imp.material_kode)}|${normalizeValue(imp.no_rs)}`;
            const existing = localMap.get(key);
            
            const assetPreview = {
                ...imp,
                conflict: !!existing,
                existingId: existing?.id || null,
                existingData: existing || null,
                selected: !existing,
                keepExisting: false
            };
            
            previewData.assets.push(assetPreview);
            
            if (existing) {
                previewData.stats.conflict++;
                if (JSON.stringify(imp) === JSON.stringify(existing)) {
                    previewData.stats.same++;
                }
            } else {
                previewData.stats.new++;
            }
        }
        
        // STEP 5: Selesai
        updateProgressStep('read_zip', 'completed');
        updateProgressStep('finalize', 'active');
        updateProgressBar(100);
        updateProgressText('Analisis selesai!');

        setTimeout(() => {
            hideProgressOverlay();
            
            // Tampilkan preview
            showZipImportPreview(previewData, zip);
            
        }, 500);
        
    } catch (error) {
        console.error("Preview error:", error);
        showProgressError(`Gagal membaca ZIP: ${error.message}`);
        
        setTimeout(() => {
            hideProgressOverlay();
            showAlert('importAlert', ` Gagal membaca ZIP: ${error.message}`, 'danger');
        }, 2000);
    }
}



// ==============================================
// FUNGSI IMPORT ZIP - LENGKAP DENGAN NORMALIZER
// ==============================================

async function confirmZipImport() {
    if (!currentPreviewData || !currentZipFile) {
        showAlert('importAlert', 'Tidak ada data untuk diimport', 'danger');
        return;
    }
    
    const assetsToImport = currentPreviewData.assets.filter(a => a.selected);
    const assetsToKeep = currentPreviewData.assets.filter(a => a.keepExisting);
    
    if (assetsToImport.length === 0) {
        showAlert('importAlert', 'Tidak ada asset yang dipilih untuk diimport', 'warning');
        return;
    }
    
    showProgressOverlay('import', {
        title: 'Mengimport Data ZIP',
        subtitle: `Mengimport ${assetsToImport.length} asset dan ${currentPreviewData.photoFiles.length} foto...`
    });
    
    try {
        let successCount = 0;
        let errorCount = 0;
        let photoSuccessCount = 0;
        let photoErrorCount = 0;
        const importedAssetIds = []; //  Untuk update metadata
        
        // Buat mapping ID lama ke ID baru (untuk konflik)
        const idMapping = new Map();
        
        // STEP 1: Hapus data yang akan ditimpa (jika user memilih override)
        updateProgressStep('read_zip', 'completed');
        updateProgressStep('import_assets', 'active');
        updateProgressBar(5);
        updateProgressText('Mempersiapkan data...');
        
        const assetsToOverride = currentPreviewData.assets.filter(a => a.selected && a.conflict);
        
        for (let i = 0; i < assetsToOverride.length; i++) {
            const asset = assetsToOverride[i];
            
            if (asset.existingId) {
                try {
                    updateProgressText(`Menghapus data lama (${i+1}/${assetsToOverride.length})...`);
                    
                    await deleteAssetFromIndexedDB(asset.existingId);
                    
                    const photos = await getAssetPhotos(asset.existingId);
                    for (const photo of photos) {
                        if (photo.id) {
                            await deletePhotoFromIndexedDB(photo.id);
                        }
                    }
                    
                    console.log(` Deleted existing asset: ${asset.existingId}`);
                } catch (deleteError) {
                    console.warn(` Could not delete asset ${asset.existingId}:`, deleteError);
                }
            }
        }
        
        updateProgressBar(10);
        
        // STEP 2: Import assets
        for (let i = 0; i < assetsToImport.length; i++) {
            try {
                const asset = assetsToImport[i];
                
                updateProgressText(`Mengimport asset ${i+1} dari ${assetsToImport.length}: ${asset.nama_asset}`);
                updateProgressBar(10 + (i / assetsToImport.length) * 30);
                
                // Siapkan data mentah
                const rawData = { ...asset };
                
                // Hapus field temporary
                delete rawData.conflict;
                delete rawData.existingId;
                delete rawData.existingData;
                delete rawData.selected;
                delete rawData.keepExisting;
                
                // Tentukan timestamp dan ID
                let assetTimestamp = null;
                let oldId = rawData.id;
                
                if (asset.conflict && !asset.keepExisting) {
                    // Untuk konflik yang di-override, buat ID baru
                    assetTimestamp = Date.now() + i;
                }
                
                //  GUNAKAN NORMALIZER
                const assetData = normalizeAssetData(
                    rawData,
                    {
                        userInfo: currentUser,
                        isImport: true,
                        source: 'zip',
                        timestamp: assetTimestamp // null jika pakai ID lama
                    }
                );
                
                // Catat mapping ID lama ke ID baru (untuk foto)
                if (oldId && oldId !== assetData.id) {
                    idMapping.set(oldId, assetData.id);
                    console.log(` ID mapping: ${oldId}  ${assetData.id}`);
                }
                
                await saveAssetToIndexedDB(assetData, 'pending');
                importedAssetIds.push(assetData.id);
                successCount++;
                
            } catch (assetError) {
                console.error("Error saving asset:", assetError);
                errorCount++;
            }
        }
        
        // STEP 3: Import foto
        if (currentPreviewData.photoFiles.length > 0) {
            updateProgressStep('import_assets', 'completed');
            updateProgressStep('import_photos', 'active');
            updateProgressBar(40);
            
            // Buat Map untuk lookup asset ID (gabungkan assetsToImport + assetsToKeep)
            const assetMap = new Map();
            
            [...assetsToImport, ...assetsToKeep].forEach(asset => {
                if (asset && asset.id) {
                    assetMap.set(asset.id, asset);
                    
                    // Cek apakah ID ini sudah dimapping
                    const newId = idMapping.get(asset.id);
                    if (newId) {
                        assetMap.set(newId, asset);
                    }
                    
                    // Juga simpan versi pendek (20 karakter pertama) untuk backup lama
                    const shortId = asset.id.substring(0, 20);
                    assetMap.set(shortId, asset);
                }
            });
            
            console.log(` Memproses ${currentPreviewData.photoFiles.length} foto...`);
            console.log(` Tersedia ${assetMap.size} mapping ID asset`);
            
            for (let i = 0; i < currentPreviewData.photoFiles.length; i++) {
                try {
                    const photoFile = currentPreviewData.photoFiles[i];
                    
                    updateProgressText(`Mengimport foto ${i+1} dari ${currentPreviewData.photoFiles.length}...`);
                    updateProgressBar(40 + (i / currentPreviewData.photoFiles.length) * 40);
                    
                    // Baca file dari ZIP
                    const fileData = await photoFile.file.async("base64");
                    const fileName = photoFile.name;
                    
                    // ============ EKSTRAKSI ASSET ID DARI NAMA FILE ============
                    let assetId = null;
                    
                    // Format: {ASSET_ID}_{TIMESTAMP}.jpg
                    const underscoreIndex = fileName.indexOf('_');
                    if (underscoreIndex > 0) {
                        const potentialAssetId = fileName.substring(0, underscoreIndex);
                        
                        // Cek apakah ID ini ada di mapping
                        if (assetMap.has(potentialAssetId)) {
                            assetId = potentialAssetId;
                            console.log(` Foto cocok dengan ID: ${potentialAssetId}`);
                        } else {
                            // Coba cek apakah ID ini sudah dimapping ke ID baru
                            const mappedId = idMapping.get(potentialAssetId);
                            if (mappedId && assetMap.has(mappedId)) {
                                assetId = mappedId;
                                console.log(` Foto cocok via mapping: ${potentialAssetId}  ${mappedId}`);
                            } else {
                                console.warn(` ID tidak ditemukan: ${potentialAssetId}`);
                            }
                        }
                    }
                    
                    // Fallback: cek metadata
                    if (!assetId && currentPreviewData.photos && currentPreviewData.photos[i]) {
                        const metaAssetId = currentPreviewData.photos[i].assetId;
                        if (assetMap.has(metaAssetId)) {
                            assetId = metaAssetId;
                            console.log(` Foto cocok via metadata: ${metaAssetId}`);
                        } else {
                            const mappedId = idMapping.get(metaAssetId);
                            if (mappedId && assetMap.has(mappedId)) {
                                assetId = mappedId;
                                console.log(` Foto cocok via metadata mapping: ${metaAssetId}  ${mappedId}`);
                            }
                        }
                    }
                    
                    if (!assetId) {
                        console.warn(` GAGAL: Tidak dapat menentukan assetId untuk ${fileName}`);
                        photoErrorCount++;
                        continue;
                    }
                    
                    // ============ PROSES FOTO ============
                    
                    // Konversi base64
                    const base64Data = `data:image/jpeg;base64,${fileData}`;
                    
                    // Kompres foto
                    let compressedImage = base64Data;
                    try {
                        const response = await fetch(base64Data);
                        const blob = await response.blob();
                        const file = new File([blob], fileName, { type: 'image/jpeg' });
                        const compressed = await compressImage(file);
                        compressedImage = compressed.base64;
                    } catch (compressError) {
                        console.warn("Compression failed, using original:", compressError);
                    }
                    
                    // Buat photo object
                    const photoData = {
                        assetId: assetId,
                        type: 'utama',
                        image: compressedImage,
                        tanggal: new Date().toISOString(),
                        timestamp: Date.now() + i,
                        uploadStatus: 'PENDING',
                        imported_from_backup: true,
                        imported_at: new Date().toISOString(),
                        retryCount: 0,
                        maxRetries: 3
                    };
                    
                    // Simpan ke IndexedDB
                    await new Promise((resolve, reject) => {
                        const transaction = indexedDBInstance.transaction(['photos'], 'readwrite');
                        const store = transaction.objectStore('photos');
                        const request = store.add(photoData);
                        
                        request.onsuccess = () => {
                            console.log(`    Foto tersimpan, status: PENDING`);
                            resolve();
                        };
                        
                        request.onerror = (e) => {
                            console.error("    Gagal simpan foto:", e.target.error);
                            reject(e.target.error);
                        };
                    });
                    
                    photoSuccessCount++;
                    
                } catch (photoError) {
                    console.error("Error saving photo:", photoError);
                    photoErrorCount++;
                }
            }
            
            console.log(`\n HASIL IMPORT FOTO:`);
            console.log(`    Berhasil: ${photoSuccessCount}`);
            console.log(`    Gagal: ${photoErrorCount}`);
        }
        
        // STEP 4: Reload data
        updateProgressStep('import_photos', 'completed');
        updateProgressStep('reload_data', 'active');
        updateProgressBar(85);
        updateProgressText('Memuat ulang data...');
        
        await loadAssets();
        await cleanupOrphanPhotos();
        updateAssetSelects();
        displayAssets();
        updateDashboard();
        
        // ============== UPDATE METADATA CLOUD ==============
        if (navigator.onLine && isFirebaseConnected && importedAssetIds.length > 0) {
            updateProgressText('Mengupdate metadata cloud...');
            await updateCloudSyncMetadata(importedAssetIds);
        }
        
        // STEP 5: Finalisasi
        updateProgressStep('reload_data', 'completed');
        updateProgressStep('finalize', 'active');
        updateProgressBar(95);
        updateProgressText('Menyelesaikan...');
        
        setTimeout(() => {
            if (navigator.onLine && !isSyncRunning) {
                runSyncNow();
            }
        }, 2000);
        
        updateProgressStep('finalize', 'completed');
        updateProgressBar(100);
        updateProgressText('Import selesai!');
        
        setTimeout(() => {
            hideProgressOverlay();
            closeZipPreview();
            
            const totalSuccess = successCount + photoSuccessCount;
            const totalError = errorCount + photoErrorCount;
            
            showAlert('importAlert', 
                ` Import ZIP berhasil!\n Asset: ${successCount} (${errorCount} gagal)\n Foto: ${photoSuccessCount} (${photoErrorCount} gagal)`,
                totalError > 0 ? 'warning' : 'success'
            );
        }, 1000);
        
        // Reset variabel global
        currentPreviewData = null;
        currentZipFile = null;
        selectedImportFile = null;
        document.getElementById('importFile').value = '';
        document.getElementById('btnImport').style.display = 'none';
        document.getElementById('importAlert').style.display = 'none';
        
    } catch (error) {
        console.error("Import error:", error);
        showProgressError(`Gagal import: ${error.message}`);
        
        setTimeout(() => {
            hideProgressOverlay();
            showAlert('importAlert', ` Gagal import: ${error.message}`, 'danger');
        }, 2000);
    }
}
function showZipImportPreview(previewData, zip) {
    currentPreviewData = previewData;
    currentZipFile = zip;
    
    const modal = document.getElementById('zipImportModal');
    const statsEl = document.getElementById('zipPreviewStats');
    
    statsEl.innerHTML = `
        <span class="badge badge-info">Total: ${previewData.stats.total}</span>
        <span class="badge badge-success">Baru: ${previewData.stats.new}</span>
        <span class="badge badge-warning">Konflik: ${previewData.stats.conflict}</span>
        <span class="badge badge-primary"> Foto: ${previewData.stats.photos_in_zip}</span>
        ${previewData.stats.same > 0 ? `<span class="badge badge-secondary">Sama: ${previewData.stats.same}</span>` : ''}
    `;
    
    // Render tab assets
    renderZipAssetsTab(previewData.assets);
    
    // Setup tab switching
    document.querySelectorAll('.zip-tab').forEach(tab => {
        tab.removeEventListener('click', handleZipTabClick);
        tab.addEventListener('click', handleZipTabClick);
    });
    
    modal.classList.add('active');
}

function handleZipTabClick() {
    document.querySelectorAll('.zip-tab').forEach(t => {
        t.classList.remove('active');
        t.style.borderBottom = 'none';
    });
    this.classList.add('active');
    this.style.borderBottom = '3px solid var(--primary)';
    
    const tabName = this.getAttribute('data-tab');
    if (tabName === 'assets') renderZipAssetsTab(currentPreviewData.assets);
    if (tabName === 'photos') renderZipPhotosTab(currentPreviewData);
    if (tabName === 'conflicts') renderZipConflictsTab(currentPreviewData.assets.filter(a => a.conflict));
}

function renderZipAssetsTab(assets) {
    const container = document.getElementById('zipPreviewContainer');
    
    if (!assets || assets.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-cubes"></i><p>Tidak ada data asset</p></div>';
        return;
    }
    
    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    
    assets.forEach((asset, index) => {
        const conflictClass = asset.conflict ? 'import-invalid' : 'import-valid';
        const conflictIcon = asset.conflict ? 
            '<span class="badge badge-danger"><i class="fas fa-exclamation-triangle"></i> Konflik</span>' : 
            '<span class="badge badge-success"><i class="fas fa-check"></i> Baru</span>';
        
        const selectedAttr = asset.selected ? 'checked' : '';
        const disabledAttr = asset.keepExisting ? 'disabled' : '';
        
        html += `
            <div class="import-row ${conflictClass}" data-asset-index="${index}">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div>
                        <input type="checkbox" 
                               class="asset-select-checkbox" 
                               data-asset-index="${index}" 
                               ${selectedAttr} 
                               ${disabledAttr}
                               onchange="toggleAssetSelection(${index}, this.checked)">
                    </div>
                    
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${asset.nama_asset || 'Tanpa Nama'}</strong>
                                ${conflictIcon}
                            </div>
                            <span class="badge ${asset.jenis_item === 'asset' ? 'badge-info' : 'badge-warning'}">
                                ${asset.jenis_item === 'asset' ? 'Asset' : 'Non-Asset'}
                            </span>
                        </div>
                        
                        <div style="font-size: 13px; margin-top: 5px;">
                            <span><strong>Material:</strong> ${asset.material_kode}</span> |
                            <span><strong>No RS:</strong> ${asset.no_rs}</span> |
                            <span><strong>Lokasi:</strong> ${asset.lokasi}</span>
                        </div>
                        
                        ${asset.conflict ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 5px;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div>
                                        <input type="radio" 
                                               name="conflict_resolve_${index}" 
                                               id="override_${index}" 
                                               value="override"
                                               ${!asset.keepExisting ? 'checked' : ''}
                                               onchange="resolveConflict(${index}, 'override')">
                                        <label for="override_${index}">Timpa data lama</label>
                                    </div>
                                    <div>
                                        <input type="radio" 
                                               name="conflict_resolve_${index}" 
                                               id="keep_${index}" 
                                               value="keep"
                                               ${asset.keepExisting ? 'checked' : ''}
                                               onchange="resolveConflict(${index}, 'keep')">
                                        <label for="keep_${index}">Pertahankan data lama</label>
                                    </div>
                                </div>
                                <div style="font-size: 12px; margin-top: 5px; color: var(--secondary);">
                                    <strong>Data lama ID:</strong> ${asset.existingId}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function renderZipPhotosTab(previewData) {
    const container = document.getElementById('zipPreviewContainer');
    const { photos, photoFiles, backupInfo } = previewData;
    
    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    
    if (backupInfo) {
        const date = new Date(backupInfo.timestamp).toLocaleString('id-ID');
        html += `
            <div class="alert alert-info" style="margin-bottom: 15px;">
                <i class="fas fa-info-circle"></i>
                <strong>Informasi Backup:</strong><br>
                Tanggal: ${date}<br>
                Dibuat oleh: ${backupInfo.created_by?.nama || 'Unknown'}<br>
                Versi App: ${backupInfo.app_version}
            </div>
        `;
    }
    
    html += `<p><strong>Total Foto di ZIP:</strong> ${photoFiles.length} file</p>`;
    
    if (photoFiles.length === 0) {
        html += '<div class="empty-state"><i class="fas fa-images"></i><p>Tidak ada foto dalam ZIP</p></div>';
    } else {
        html += '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
        
        photoFiles.slice(0, 20).forEach((photo, idx) => {
            html += `
                <div style="text-align: center; width: 100px;">
                    <div style="width: 100px; height: 100px; background: var(--card-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border-color); overflow: hidden;">
                        <i class="fas fa-file-image" style="font-size: 40px; color: var(--primary-light);"></i>
                    </div>
                    <small style="font-size: 10px; word-break: break-word;">${photo.name.substring(0, 15)}...</small>
                </div>
            `;
        });
        
        if (photoFiles.length > 20) {
            html += `<div style="width:100%; text-align:center; margin-top:10px;">... dan ${photoFiles.length - 20} foto lainnya</div>`;
        }
        
        html += '</div>';
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function renderZipConflictsTab(conflicts) {
    const container = document.getElementById('zipPreviewContainer');
    
    if (conflicts.length === 0) {
        container.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Tidak ada konflik!</div>';
        return;
    }
    
    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    
    conflicts.forEach((conflict, idx) => {
        html += `
            <div class="import-invalid" style="margin-bottom: 10px; padding: 15px;">
                <div style="font-weight: 600; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i> Konflik #${idx + 1}
                </div>
                <div style="margin-top: 5px;">
                    <strong>${conflict.nama_asset}</strong> (${conflict.material_kode} | ${conflict.no_rs})
                </div>
                <div style="font-size: 12px; margin-top: 5px;">
                    Data baru akan menggantikan data lama dengan ID: ${conflict.existingId}
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button class="btn btn-small btn-conflict-refresh" onclick="resolveConflict(${idx}, 'override')">
                        <i class="fas fa-exclamation-circle"></i> Timpa
                    </button>
                    <button class="btn btn-small btn-conflict-cancel" onclick="resolveConflict(${idx}, 'keep')">
                        <i class="fas fa-check"></i> Pertahankan
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function toggleAssetSelection(index, selected) {
    if (currentPreviewData && currentPreviewData.assets[index]) {
        currentPreviewData.assets[index].selected = selected;
        updateZipStats();
    }
}

function resolveConflict(index, action) {
    if (!currentPreviewData || !currentPreviewData.assets[index]) return;
    
    const asset = currentPreviewData.assets[index];
    
    if (action === 'override') {
        asset.selected = true;
        asset.keepExisting = false;
    } else if (action === 'keep') {
        asset.selected = false;
        asset.keepExisting = true;
    }
    
    const activeTab = document.querySelector('.zip-tab.active');
    if (activeTab && activeTab.getAttribute('data-tab') === 'assets') {
        renderZipAssetsTab(currentPreviewData.assets);
    } else if (activeTab && activeTab.getAttribute('data-tab') === 'conflicts') {
        renderZipConflictsTab(currentPreviewData.assets.filter(a => a.conflict));
    }
    
    updateZipStats();
}

function updateZipStats() {
    if (!currentPreviewData) return;
    
    const statsEl = document.getElementById('zipPreviewStats');
    const selectedCount = currentPreviewData.assets.filter(a => a.selected).length;
    const keptCount = currentPreviewData.assets.filter(a => a.keepExisting).length;
    
    statsEl.innerHTML = `
        <span class="badge badge-info">Total: ${currentPreviewData.assets.length}</span>
        <span class="badge badge-success">Dipilih: ${selectedCount}</span>
        <span class="badge badge-secondary">Dipertahankan: ${keptCount}</span>
        <span class="badge badge-warning">Konflik: ${currentPreviewData.assets.filter(a => a.conflict).length}</span>
        <span class="badge badge-primary"> Foto: ${currentPreviewData.photoFiles.length}</span>
    `;
}



// ============= FUNGSI DELETE HELPER =============
async function deleteAssetFromIndexedDB(assetId) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['assets'], 'readwrite');
        const store = transaction.objectStore('assets');
        const request = store.delete(assetId);
        
        request.onsuccess = resolve;
        request.onerror = (e) => reject(e.target.error);
    });
}

async function deletePhotoFromIndexedDB(photoId) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['photos'], 'readwrite');
        const store = transaction.objectStore('photos');
        const request = store.delete(photoId);
        
        request.onsuccess = resolve;
        request.onerror = (e) => reject(e.target.error);
    });
}

// ============= FUNGSI EXPORT TEMPLATE EXCEL =============
async function exportExcelTemplate() {
    try {
        const assetHeaders = [{
            nama_asset: '',
            material_kode: '',
            no_rs: '',
            no_po: '',
            no_asset: '',
            lokasi: '',
            kondisi: 'baik',
            catatan_awal: ''
        }];

        const nonAssetHeaders = [{
            nama_asset: '',
            material_kode: '',
            no_rs: '',
            no_po: '',
            lokasi: '',
            kondisi: 'baik',
            jumlah: 1,
            catatan_awal: ''
        }];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(assetHeaders), 'ASSET');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(nonAssetHeaders), 'NON_ASSET');

        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });

        saveAs(blob, 'asset_import_template.xlsx');
        showAlert('importAlert', ' Template berhasil dibuat', 'success');

    } catch (error) {
        showAlert('importAlert', ' Gagal membuat template', 'danger');
    }
}

// ============= FUNGSI CREATE BACKUP ZIP - VERSI REALTIME =============
async function createBackup() {
    if (!requireInternet('Backup data')) return;
    if (!currentUser) {
        showAlert('backupInfo', 'Harus login dulu', 'danger');
        return;
    }

    if (!indexedDBInstance) {
        showAlert('backupInfo', 'Database belum siap', 'danger');
        return;
    }

    try {
        const btn = document.getElementById('btnBackup');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loading"></div> Membuat backup lengkap...';
        btn.disabled = true;

        showProgressOverlay('backup', {
            title: 'Membuat Backup Lengkap',
            subtitle: 'Mengumpulkan data dan foto...'
        });

        // STEP 1: Load Data
        updateProgressStep('load_data', 'active');
        updateProgressBar(5);
        updateProgressText('Memuat data asset...');

        const assetsData = await loadAssetsFromIndexedDB();
        updateProgressBar(10);
        updateProgressText(`Memuat ${assetsData.length} asset...`);

        updateProgressText('Memuat data foto...');
        const photosData = await getAllPhotos();
        const totalPhotos = photosData.length;
        updateProgressBar(15);
        
        updateProgressText('Memuat data aktivitas...');
        const activitiesData = await getAllUserActivities();
        updateProgressBar(18);
        
        updateProgressText('Memuat data pengaturan...');
        const settingsData = await getAllSettings();
        
        updateProgressStep('load_data', 'completed');
        updateProgressBar(20);

        // STEP 2: Process Photos
        updateProgressStep('process_photos', 'active');
        updateProgressText(`Menyiapkan ${totalPhotos} foto...`);
        updateProgressBar(25);

        // BUAT ZIP DAN FOLDER
        const zip = new JSZip();
        const photoFolder = zip.folder("photos");
        
        // Array untuk metadata foto
        const photosMeta = [];
        let totalExportedPhotos = 0;
        let failedPhotos = 0;

        // PROSES SETIAP FOTO DENGAN PROGRESS REALTIME
        const BATCH_SIZE = Math.max(1, Math.floor(totalPhotos / 20)); // Update setiap 5%
        let lastUpdate = Date.now();
        const MIN_UPDATE_INTERVAL = 100; // Minimal 100ms antar update

        for (let i = 0; i < photosData.length; i++) {
            const photo = photosData[i];
            
            try {
                // Update progress setiap BATCH_SIZE foto atau minimal interval
                const now = Date.now();
                if (i % BATCH_SIZE === 0 || now - lastUpdate > MIN_UPDATE_INTERVAL || i === photosData.length - 1) {
                    const photoProgress = 25 + ((i + 1) / totalPhotos) * 45;
                    updateProgressBar(photoProgress);
                    updateProgressText(`Memproses foto ${i+1}/${totalPhotos}...`);
                    lastUpdate = now;
                    
                    // Beri kesempatan UI untuk update
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
                
                // Simpan metadata (tanpa image & thumbnail)
                const { image, thumbnail, ...photoMeta } = photo;
                
                // Tambah informasi tambahan untuk metadata
                photoMeta.processed_at = new Date().toISOString();
                photosMeta.push(photoMeta);
                
                // Tentukan nama file
                const asset = assetsData.find(a => a.id === photo.assetId);
                const assetName = asset?.nama_asset?.replace(/[^a-z0-9]/gi, '_') || 'unknown';
                const timestamp = photo.timestamp || Date.now();
                
                let filename = `${assetName}_${photo.assetId.substring(0,8)}_${timestamp}.jpg`;
                
                // Cegah duplikasi
                let counter = 1;
                let baseFilename = filename;
                while (photoFolder.file(filename)) {
                    filename = `${baseFilename.replace('.jpg', '')}_${counter}.jpg`;
                    counter++;
                }
                
                let fileSaved = false;
                
                // PRIORITAS 1: FOTO LOKAL
                if (photo.image && photo.image.startsWith('data:image')) {
                    try {
                        const base64Data = photo.image.split(',')[1];
                        const binary = atob(base64Data);
                        const bytes = new Uint8Array(binary.length);
                        for (let j = 0; j < binary.length; j++) {
                            bytes[j] = binary.charCodeAt(j);
                        }
                        
                        photoFolder.file(filename, bytes);
                        fileSaved = true;
                        totalExportedPhotos++;
                        
                    } catch (base64Error) {
                        console.warn(`Gagal konversi base64 foto ${photo.id}:`, base64Error);
                    }
                }
                
                // PRIORITAS 2: CLOUDINARY
                if (!fileSaved && photo.cloudinary?.secure_url && navigator.onLine) {
                    try {
                        updateProgressText(`Mendownload foto ${i+1}/${totalPhotos} dari Cloudinary...`);
                        
                        const response = await fetch(photo.cloudinary.secure_url, {
                            timeout: 10000,
                            cache: 'no-cache'
                        });
                        
                        if (response.ok) {
                            const blob = await response.blob();
                            photoFolder.file(filename, blob);
                            fileSaved = true;
                            totalExportedPhotos++;
                        }
                        
                    } catch (cloudinaryError) {
                        console.warn(`Gagal download dari Cloudinary foto ${photo.id}:`, cloudinaryError);
                    }
                }
                
                if (!fileSaved) {
                    failedPhotos++;
                    // Catat di metadata bahwa foto gagal disimpan
                    photoMeta.backup_failed = true;
                    photoMeta.backup_failed_reason = 'No accessible image source';
                }
                
            } catch (photoError) {
                console.error(`Error processing photo ${photo.id}:`, photoError);
                failedPhotos++;
                
                // Tetap simpan metadata dengan status error
                photosMeta.push({
                    id: photo.id,
                    assetId: photo.assetId,
                    type: photo.type,
                    timestamp: photo.timestamp,
                    backup_error: photoError.message,
                    backup_failed: true
                });
            }
        }

        updateProgressStep('process_photos', 'completed');
        updateProgressBar(70);

        // STEP 3: Save JSON Files
        updateProgressStep('create_zip', 'active');
        updateProgressText('Menyiapkan file JSON...');
        updateProgressBar(75);

        // BUAT FILE BACKUP INFO
        const backupInfo = {
            timestamp: Date.now(),
            date_iso: new Date().toISOString(),
            app_version: APP_META?.VERSION || 'unknown',
            build_code: APP_META?.BUILD_CODE || 'unknown',
            database_schema: 'asset_management_v2_2026',
            created_by: {
                uid: currentUser.uid,
                nama: currentUser.nama || currentUser.email,
                email: currentUser.email,
                role: currentUser.role
            },
            counts: {
                assets: assetsData.length,
                photos: photosMeta.length,
                photos_saved: totalExportedPhotos,
                photos_failed: failedPhotos,
                activities: activitiesData.length,
                settings: Object.keys(settingsData).length
            },
            export_stats: {
                start_time: new Date().toISOString(),
                duration_seconds: 0
            }
        };

        updateProgressText('Menyimpan data asset...');
        zip.file("assets_data.json", JSON.stringify(assetsData, null, 2));
        updateProgressBar(78);
        
        updateProgressText('Menyimpan metadata foto...');
        zip.file("photos_meta.json", JSON.stringify(photosMeta, null, 2));
        updateProgressBar(80);
        
        updateProgressText('Menyimpan data aktivitas...');
        zip.file("activities_data.json", JSON.stringify(activitiesData, null, 2));
        updateProgressBar(82);
        
        updateProgressText('Menyimpan data pengaturan...');
        zip.file("settings_data.json", JSON.stringify(settingsData, null, 2));
        updateProgressBar(84);
        
        updateProgressText('Menyimpan info backup...');
        zip.file("backup_info.json", JSON.stringify(backupInfo, null, 2));
        
        // Buat file instruksi
        const instructions = `ASSET MANAGEMENT BACKUP
===========================
Tanggal: ${new Date().toLocaleString('id-ID')}
Dibuat oleh: ${currentUser.nama || currentUser.email}

STATISTIK:
- Total Asset: ${assetsData.length}
- Total Foto di Database: ${photosMeta.length}
- Foto Tersimpan di ZIP: ${totalExportedPhotos}
- Foto Gagal Disimpan: ${failedPhotos}
- Total Aktivitas: ${activitiesData.length}
- Total Pengaturan: ${Object.keys(settingsData).length}

CARA RESTORE:
1. Buka tab Backup & Export
2. Klik area import atau pilih file ZIP ini
3. Klik "Preview & Import Data"
4. Periksa data yang akan diimport
5. Klik "Import Data"

CATATAN:
- Foto yang gagal disimpan perlu diupload ulang ke Cloudinary
- Jalankan sinkronisasi setelah import untuk mengupload foto pending
`;

        zip.file("import_instructions.txt", instructions);
        updateProgressBar(86);

        // STEP 4: Compress ZIP
        updateProgressText('Mengompres file...');
        updateProgressBar(88);

        // GENERATE DAN DOWNLOAD ZIP DENGAN PROGRESS
        const content = await zip.generateAsync({
            type: "blob",
            compression: "DEFLATE",
            compressionOptions: { level: 6 },
            onUpdate: (metadata) => {
                // Progress kompresi dari 88% ke 98%
                const percent = 88 + (metadata.percent / 100) * 10;
                updateProgressBar(percent);
                updateProgressText(`Mengompres... ${Math.round(metadata.percent)}% (${(metadata.currentFile ? metadata.currentFile : '')})`);
            }
        });

        updateProgressBar(98);
        updateProgressText('Menyimpan file...');

        const date = new Date();
        const filename = `asset_backup_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}${date.getSeconds().toString().padStart(2,'0')}.zip`;

        saveAs(content, filename);

        // STEP 5: Save to History
        updateProgressText('Menyimpan ke riwayat...');
        await saveBackupToHistory(backupInfo);

        // STEP 6: Finalize
        updateProgressStep('create_zip', 'completed');
        updateProgressStep('finalize', 'active');
        updateProgressBar(100);
        updateProgressText('Backup selesai!');

        setTimeout(() => {
            hideProgressOverlay();
            
            let message = ` Backup berhasil!\n Assets: ${assetsData.length}\n Foto tersimpan: ${totalExportedPhotos}`;
            if (failedPhotos > 0) {
                message += `\n Foto gagal: ${failedPhotos}`;
            }
            if (activitiesData.length > 0) {
                message += `\n Aktivitas: ${activitiesData.length}`;
            }
            
            showAlert('backupInfo', message, failedPhotos > 0 ? 'warning' : 'success');
        }, 1000);

    } catch (error) {
        console.error(" Backup error:", error);
        showProgressError(`Gagal backup: ${error.message}`);
        
        setTimeout(() => {
            hideProgressOverlay();
            showAlert('backupInfo', ` Backup gagal: ${error.message}`, 'danger');
        }, 2000);

    } finally {
        const btn = document.getElementById('btnBackup');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-file-archive"></i> Buat Backup ZIP';
            btn.disabled = false;
        }
    }
}

// ============= FUNGSI BACKUP HISTORY =============
async function saveBackupToHistory(backupInfo) {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['backups'], 'readwrite');
        const store = transaction.objectStore('backups');
        
        const request = store.add(backupInfo);
        
        request.onsuccess = function() {
            resolve();
        };
        
        request.onerror = function(event) {
            reject(event.target.error);
        };
    });
}

async function loadBackupHistory() {
    try {
        const backups = await new Promise((resolve, reject) => {
            const transaction = indexedDBInstance.transaction(['backups'], 'readonly');
            const store = transaction.objectStore('backups');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const sorted = request.result.sort((a, b) => b.timestamp - a.timestamp);
                resolve(sorted);
            };
            
            request.onerror = reject;
        });
        
        const historyContainer = document.getElementById('backupHistory');
        const backupCount = document.getElementById('backupCount');
        
        if (!backups || backups.length === 0) {
            historyContainer.innerHTML = `
                <div class="empty-state" style="padding: 30px 20px;">
                    <i class="fas fa-history"></i>
                    <h3>Belum ada riwayat backup</h3>
                    <p>Buat backup pertama Anda untuk memulai</p>
                </div>
            `;
            backupCount.textContent = '0 backup tersimpan';
            return;
        }
        
        backupCount.textContent = `${backups.length} backup tersimpan`;
        
        let html = '<div class="backup-history-list">';
        
        backups.slice(0, 10).forEach(backup => {
            const date = new Date(backup.timestamp);
            const dateStr = date.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            html += `
                <div class="asset-card">
                    <div class="asset-header">
                        <div>
                            <div class="asset-title">Backup ${dateStr}</div>
                            <div class="asset-subtitle">
                                 Items: ${backup.counts?.assets || 0} | 
                                 Foto: ${backup.counts?.photos_saved || backup.counts?.photos || 0}
                                ${backup.counts?.photos_failed ? ` |  Gagal: ${backup.counts.photos_failed}` : ''}
                            </div>
                        </div>
                        <div class="badge badge-info">v${backup.app_version || '1.0'}</div>
                    </div>
                    <div style="font-size: 12px; color: var(--secondary); margin-top: 5px;">
                        Dibuat oleh: ${backup.created_by?.nama || backup.created_by?.email || 'Unknown'}
                    </div>
                </div>
            `;
        });
        
        if (backups.length > 10) {
            html += `<p style="text-align: center; margin-top: 10px; color: var(--secondary);">... dan ${backups.length - 10} backup lainnya</p>`;
        }
        
        html += '</div>';
        historyContainer.innerHTML = html;
        
    } catch (error) {
        console.error("Error loading backup history:", error);
    }
}

// ============= HELPER FUNCTIONS =============
async function getAllSettings() {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            resolve({});
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const settingsArray = request.result || [];
                const settingsObj = {};
                
                settingsArray.forEach(setting => {
                    if (setting.key) {
                        settingsObj[setting.key] = setting;
                    }
                });
                
                resolve(settingsObj);
            };
            
            request.onerror = function(event) {
                reject(event.target.error);
            };
            
        } catch (error) {
            console.error("Error getting settings:", error);
            resolve({});
        }
    });
}

async function getAllUserActivities() {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            resolve([]);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['user_activities'], 'readonly');
            const store = transaction.objectStore('user_activities');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const activities = request.result || [];
                activities.sort((a, b) => b.timestamp - a.timestamp);
                resolve(activities);
            };
            
            request.onerror = function(event) {
                reject(event.target.error);
            };
            
        } catch (error) {
            console.error("Error getting activities:", error);
            resolve([]);
        }
    });
}

async function loadBackupHistoryData() {
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['backups'], 'readonly');
        const store = transaction.objectStore('backups');
        const request = store.getAll();
        
        request.onsuccess = function() {
            const backups = request.result || [];
            backups.sort((a, b) => b.timestamp - a.timestamp);
            resolve(backups);
        };
        
        request.onerror = function(event) {
            reject(event.target.error);
        };
    });
}

     // ==============================================
// FUNGSI EXPORT LENGKAP (ALL IN ONE)
// Semua data diexport dalam 1 ZIP dengan struktur rapi:
//  asset_export_YYYYMMDD_HHMMSS.zip
//     photos/ (semua foto dengan nama asset + ID jika duplikat)
//     asset_laporan.xlsx (laporan untuk user)
//     asset_schema.xlsx (data mentah untuk developer)
//     conflict_list.txt (daftar konflik nama jika ada)
// ==============================================

// ==============================================
// FUNGSI EXPORT ALL DATA - VERSI REALTIME
// ==============================================

async function exportAllData() {
    if (!requireInternet('Export data')) return;

    const btn = document.getElementById('btnExportAllData');
    const originalText = btn.innerHTML;

    try {
        btn.disabled = true;
        btn.innerHTML = '<div class="loading"></div> Export lengkap...';

        showProgressOverlay('export', {
            title: 'Export Semua Data',
            subtitle: 'Menyiapkan laporan, schema, dan foto...'
        });

        // STEP 1: Load Data
        updateProgressStep('load_data', 'active');
        updateProgressBar(5);
        updateProgressText('Memuat data asset...');

        if (assets.length === 0) await loadAssets();
        await cleanupOrphanPhotos();

        updateProgressBar(10);
        updateProgressText('Memuat data foto...');
        
        const allPhotos = await getAllPhotos();
        const totalPhotos = allPhotos.length;
        
        updateProgressStep('load_data', 'completed');
        updateProgressBar(15);

        // STEP 2: Prepare Photos
        updateProgressStep('prepare_photos', 'active');
        updateProgressText('Menyiapkan foto untuk export...');

        const zip = new JSZip();
        const photoFolder = zip.folder("photos");

        const usedNames = new Set();
        const conflictList = [];
        let totalExportedPhotos = 0;
        let processedPhotos = 0;

        // Hitung total asset yang memiliki foto untuk progress
        const assetsWithPhotos = assets.filter(a => {
            const assetPhotos = allPhotos.filter(p => p.assetId === a.id);
            return assetPhotos.length > 0;
        });
        
        const totalAssetsWithPhotos = assetsWithPhotos.length;
        let processedAssets = 0;

        updateProgressBar(20);
        updateProgressText(`Mengekspor foto (0/${totalPhotos})...`);

        // =============================
        // EXPORT FOTO DENGAN PROGRESS
        // =============================
        for (const asset of assets) {
            const assetPhotos = allPhotos.filter(p => p.assetId === asset.id);
            if (!assetPhotos.length) continue;

            processedAssets++;
            
            let baseName = (asset.nama_asset || 'tanpa_nama')
                .replace(/[\\/:*?"<>|]/g, '')
                .trim();

            if (usedNames.has(baseName.toLowerCase())) {
                baseName += "_" + asset.id.substring(0, 6);
                conflictList.push(`Konflik nama: ${asset.nama_asset}`);
            }

            usedNames.add(baseName.toLowerCase());

            for (let i = 0; i < assetPhotos.length; i++) {
                const photo = assetPhotos[i];
                let arrayBuffer = null;
                let extension = "jpg";

                try {
                    // Update progress setiap foto
                    processedPhotos++;
                    const photoProgress = 20 + (processedPhotos / totalPhotos) * 30;
                    updateProgressBar(photoProgress);
                    updateProgressText(`Mengekspor foto ${processedPhotos}/${totalPhotos}: ${asset.nama_asset.substring(0, 20)}...`);

                    // PRIORITAS 1: BASE64 LOKAL
                    if (photo.image && photo.image.startsWith("data:image")) {
                        const base64Data = photo.image.split(',')[1];
                        const binary = atob(base64Data);
                        const len = binary.length;
                        const bytes = new Uint8Array(len);

                        for (let j = 0; j < len; j++) {
                            bytes[j] = binary.charCodeAt(j);
                        }

                        arrayBuffer = bytes;

                        if (photo.image.includes("png")) extension = "png";
                        if (photo.image.includes("webp")) extension = "webp";
                        if (photo.image.includes("gif")) extension = "gif";
                    }
                    // PRIORITAS 2: CLOUDINARY
                    else if (photo.cloudinary?.secure_url) {
                        const response = await fetch(photo.cloudinary.secure_url);
                        if (!response.ok) throw new Error("Download Cloudinary gagal");

                        const blob = await response.blob();
                        arrayBuffer = await blob.arrayBuffer();
                        extension = blob.type.split("/")[1] || "jpg";
                    }

                    if (!arrayBuffer) continue;

                    let filename = baseName;
                    if (assetPhotos.length > 1) filename += `_${i + 1}`;
                    filename += `.${extension}`;

                    photoFolder.file(filename, arrayBuffer);
                    totalExportedPhotos++;

                    // Beri kesempatan UI untuk update setiap 10 foto
                    if (processedPhotos % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }

                } catch (err) {
                    console.warn("Gagal export foto:", err);
                }
            }
            
            // Update progress per asset
            const assetProgress = 20 + (processedAssets / totalAssetsWithPhotos) * 30;
            updateProgressBar(assetProgress);
        }

        updateProgressStep('prepare_photos', 'completed');
        updateProgressBar(50);

        if (conflictList.length > 0) {
            zip.file("conflict_list.txt", conflictList.join("\n"));
        }

        // STEP 3: Create Excel Laporan
        updateProgressStep('create_excel', 'active');
        updateProgressText('Membuat laporan Excel (1/3)...');
        updateProgressBar(55);

        // ASSETS SHEET
        const assetRows = assets.map(a => {
            const isNonAsset = a.jenis_item === 'non-asset';
            const detail = a.kondisi_detail || {};

            return {
                "ID Asset": a.id,
                "Jenis": isNonAsset ? "NON-ASSET" : "ASSET",
                "Nama": a.nama_asset,
                "Kode Material": a.material_kode,
                "No RS": a.no_rs || "",
                "No PO": a.no_po || "",
                "No Asset": a.jenis_item === 'asset' ? (a.no_asset || "") : "-",
                "Lokasi": a.lokasi,
                "Kondisi (Asset)": !isNonAsset ? (a.kondisi || "") : "-",
                "Total Jumlah": isNonAsset ? (a.total_jumlah || 0) : 1,
                "Jumlah Baik": isNonAsset ? (detail.baik || 0) : "-",
                "Jumlah Rusak": isNonAsset ? (detail.rusak || 0) : "-",
                "Jumlah Mutasi": isNonAsset ? (detail.Mutasi || 0) : "-",
                "Dibuat": a.created_at,
                "Dibuat Oleh": a.created_by?.nama || "",
                "Update Terakhir": a.updated_at,
                "Update Oleh": a.updated_by?.nama || ""
            };
        });

        updateProgressBar(60);
        updateProgressText('Membuat laporan Excel (2/3)...');

        // RIWAYAT SHEET
        const historyRows = [];
        let historyCount = 0;
        
        assets.forEach(a => {
            const isNonAsset = a.jenis_item === 'non-asset';
            (a.riwayat || []).forEach(h => {
                historyCount++;
                
                // Update progress setiap 100 history
                if (historyCount % 100 === 0) {
                    updateProgressText(`Memproses riwayat ${historyCount}...`);
                }

                let oldJumlahDisplay = "";
                let newJumlahDisplay = "";
                let perubahanDetail = "";
                let tipePerubahan = "";

                if (isNonAsset && typeof h.old_jumlah === "object") {
                    const oldDetail = h.old_jumlah || {};
                    const newDetail = h.new_jumlah || {};

                    oldJumlahDisplay = `Baik:${oldDetail.baik || 0}, Rusak:${oldDetail.rusak || 0}, Mutasi:${oldDetail.Mutasi || 0}`;
                    newJumlahDisplay = `Baik:${newDetail.baik || 0}, Rusak:${newDetail.rusak || 0}, Mutasi:${newDetail.Mutasi || 0}`;

                    if (oldDetail.baik !== newDetail.baik || 
                        oldDetail.rusak !== newDetail.rusak || 
                        oldDetail.Mutasi !== newDetail.Mutasi) {
                        tipePerubahan = "MUTASI DISTRIBUSI";
                    } else {
                        tipePerubahan = "TANPA PERUBAHAN STOK";
                    }
                } else {
                    if (h.old_kondisi !== h.new_kondisi) {
                        tipePerubahan = "PERUBAHAN KONDISI";
                    } else if (h.old_lokasi !== h.new_lokasi) {
                        tipePerubahan = "PERPINDAHAN LOKASI";
                    } else {
                        tipePerubahan = "UPDATE DATA";
                    }
                }

                historyRows.push({
                    "ID Asset": a.id,
                    "Nama Item": a.nama_asset,
                    "Jenis": isNonAsset ? "NON-ASSET" : "ASSET",
                    "Tanggal": h.tanggal,
                    "Tipe Perubahan": tipePerubahan,
                    "Kondisi Lama": h.old_kondisi || "",
                    "Kondisi Baru": h.new_kondisi || "",
                    "Lokasi Lama": h.old_lokasi || "",
                    "Lokasi Baru": h.new_lokasi || "",
                    "Jumlah Lama": oldJumlahDisplay,
                    "Jumlah Baru": newJumlahDisplay,
                    "Detail Perubahan": perubahanDetail,
                    "Catatan": h.catatan || "",
                    "User": h.user?.nama || ""
                });
            });
        });

        updateProgressBar(65);
        updateProgressText('Membuat laporan Excel (3/3)...');

        // FOTO SHEET
        const photoRows = allPhotos.map(p => ({
            "Asset ID": p.assetId,
            "Tipe": p.type,
            "Tanggal": p.tanggal,
            "Sumber": p.cloudinary ? "Cloudinary" : "Local",
            "Upload Status": p.uploadStatus || ""
        }));

        // RINGKASAN
        const summaryRow = [{
            "Tanggal Export": new Date().toLocaleString(),
            "Total Asset": assets.length,
            "Total Foto": totalExportedPhotos,
            "Total Riwayat": historyRows.length,
            "Konflik Nama": conflictList.length
        }];

        // BUILD WORKBOOK
        const wbLaporan = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wbLaporan, XLSX.utils.json_to_sheet(assetRows), "ASSETS");
        XLSX.utils.book_append_sheet(wbLaporan, XLSX.utils.json_to_sheet(historyRows), "RIWAYAT");
        XLSX.utils.book_append_sheet(wbLaporan, XLSX.utils.json_to_sheet(photoRows), "FOTO");
        XLSX.utils.book_append_sheet(wbLaporan, XLSX.utils.json_to_sheet(summaryRow), "RINGKASAN");

        const laporanBuffer = XLSX.write(wbLaporan, { bookType: "xlsx", type: "array" });
        zip.file("asset_laporan.xlsx", laporanBuffer);

        updateProgressStep('create_excel', 'completed');
        updateProgressBar(75);

        // STEP 4: Create Schema Excel
        updateProgressStep('create_zip', 'active');
        updateProgressText('Membuat schema Excel...');
        updateProgressBar(80);

        const wbSchema = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wbSchema, XLSX.utils.json_to_sheet(assets), "assets_raw");
        XLSX.utils.book_append_sheet(wbSchema, XLSX.utils.json_to_sheet(allPhotos), "photos_raw");

        const schemaBuffer = XLSX.write(wbSchema, { bookType: "xlsx", type: "array" });
        zip.file("asset_schema.xlsx", schemaBuffer);

        updateProgressBar(85);
        updateProgressText('Menambahkan metadata...');

        // METADATA JSON
        const metadata = {
            export_date: new Date().toISOString(),
            total_assets: assets.length,
            total_photos: totalExportedPhotos,
            conflicts: conflictList.length,
            version: APP_META?.VERSION || "unknown"
        };

        zip.file("export_metadata.json", JSON.stringify(metadata, null, 2));

        // STEP 5: Create ZIP
        updateProgressText('Mengompres file...');
        updateProgressBar(90);

        // Gunakan progress callback dari JSZip
        const content = await zip.generateAsync({
            type: "blob",
            compression: "DEFLATE",
            compressionOptions: { level: 6 },
            onUpdate: (metadata) => {
                const percent = 90 + (metadata.percent / 100) * 10;
                updateProgressBar(percent);
                updateProgressText(`Mengompres... ${Math.round(metadata.percent)}%`);
            }
        });

        const now = new Date();
        const filename = `asset_export_lengkap_${now.toISOString().replace(/[:T]/g, '-').split('.')[0]}.zip`;

        saveAs(content, filename);

        // STEP 6: Finalize
        updateProgressStep('create_zip', 'completed');
        updateProgressStep('finalize', 'active');
        updateProgressBar(100);
        updateProgressText('Export selesai!');

        setTimeout(() => {
            hideProgressOverlay();
            
            showAlert(
                'addAssetAlert',
                ` Export lengkap berhasil!\n ${assets.length} item\n ${totalExportedPhotos} foto\n ${historyRows.length} riwayat`,
                'success'
            );
        }, 1000);

    } catch (error) {
        console.error("Export error:", error);
        showProgressError(`Gagal export: ${error.message}`);
        
        setTimeout(() => {
            hideProgressOverlay();
            showAlert('addAssetAlert', ` Gagal export: ${error.message}`, 'danger');
        }, 2000);

    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
//  SEND WA MANAGEMENT
function openWaReportModal() {
    document.getElementById("waReportModal").classList.add("active");
}

function closeWaModal() {
    document.getElementById("waReportModal").classList.remove("active");
}

function generateWaReport(mode) {

    let message = "";

    const now = new Date();

    const tanggal = now.toLocaleDateString("id-ID");
    const jam = now.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit"
    });

    const assetList = assets.filter(a => a.jenis_item === "asset");
    const nonAssetList = assets.filter(a => a.jenis_item === "non-asset");

    message += "*LAPORAN ASSET CONTROL*\n";
    message += `Tanggal Laporan : ${tanggal} ${jam}\n\n`;

    message += `Total Semua Item : ${assets.length}\n`;
    message += `Total Asset      : ${assetList.length}\n`;
    message += `Total Non-Asset  : ${nonAssetList.length}\n\n`;

    if (mode === "simple") {
        message += generateSimple(assetList, nonAssetList);
    } else {
        message += generateFull(assetList, nonAssetList);
    }

    currentWaMessage = message;

    document.getElementById("waPreview").value = message;

    checkWaLength(message);
}


function generateSimple(assetList, nonAssetList) {

    let msg = "";

    // ===== ASSET =====
    msg += " ASSET \n\n";

    assetList.forEach((a, i) => {
        msg += `${i+1}.\n`;
        msg += `Nama     : *${a.nama_asset}*\n`;
        msg += `Kode     : ${a.material_kode}\n`;
        msg += `No RS    : ${a.no_rs}\n`;
        msg += `No PO    : ${a.no_po || "-"}\n`;
        msg += `No Asset : ${a.no_asset || "-"}\n`;
        msg += `Lokasi   : ${a.lokasi}\n`;
        msg += `Kondisi  : ${a.kondisi}\n`;
        msg += `Jumlah   : ${a.total_jumlah}\n\n`;
    });

    // ===== NON ASSET =====
    msg += " NON-ASSET \n\n";

    nonAssetList.forEach((a, i) => {

        msg += `${i+1}.\n`;
        msg += `Nama    : *${a.nama_asset}*\n`;
        msg += `Kode    : ${a.material_kode}\n`;
        msg += `No RS   : ${a.no_rs}\n`;
        msg += `No PO   : ${a.no_po || "-"}\n`;
        msg += `Lokasi  : ${a.lokasi}\n\n`;

        msg += "Kondisi :\n";

        const kd = a.kondisi_detail || {};

        if (kd.baik > 0) msg += `Baik (${kd.baik})\n`;
        if (kd.rusak > 0) msg += `Rusak (${kd.rusak})\n`;
        if (kd.Mutasi > 0) msg += `Mutasi (${kd.Mutasi})\n`;

        msg += `\nTotal   : ${a.total_jumlah}\n\n`;
    });

    return msg;
}

function generateFull(assetList, nonAssetList) {

    let msg = "";

    msg += " ASSET \n\n";

    assetList.forEach(a => {

        msg += "\n";
        msg += `Nama            : *${a.nama_asset}*\n`;
        msg += `Kode Material   : ${a.material_kode}\n`;
        msg += `No RS           : ${a.no_rs}\n`;
        msg += `No PO           : ${a.no_po || "-"}\n`;
        msg += `No Asset        : ${a.no_asset || "-"}\n`;
        msg += `Lokasi          : ${a.lokasi}\n`;
        msg += `Kondisi Saat Ini: ${a.kondisi}\n`;
        msg += `Jumlah          : ${a.total_jumlah}\n\n`;

        if (a.riwayat && a.riwayat.length > 0) {

            msg += "Perubahan Kondisi:\n\n";

            a.riwayat.forEach((r, i) => {

                if (r.tipe === "create") return;

                msg += `${i+1}. ${new Date(r.tanggal).toLocaleDateString()}\n`;

                if (r.old_kondisi && r.new_kondisi) {
                    msg += `   Dari        : ${r.old_kondisi}\n`;
                    msg += `   Menjadi     : ${r.new_kondisi}\n`;
                }

                if (r.old_kondisi_detail && r.new_kondisi_detail) {
                    msg += `   Perubahan Detail\n`;
                }

                msg += `   Catatan     : ${r.catatan || "-"}\n`;
                msg += `   Diubah oleh : ${r.user?.nama || "-"}\n\n`;
            });
        }

        msg += "\n";
    });

    msg += "\n NON-ASSET \n\n";

    nonAssetList.forEach(a => {

        msg += "\n";
        msg += `Nama          : *${a.nama_asset}*\n`;
        msg += `Kode Material : ${a.material_kode}\n`;
        msg += `No RS         : ${a.no_rs}\n`;
        msg += `No PO         : ${a.no_po || "-"}\n`;
        msg += `Lokasi        : ${a.lokasi}\n\n`;

        const kd = a.kondisi_detail || {};

        msg += "Ringkasan Kondisi:\n";
        msg += `Baik   : ${kd.baik || 0}\n`;
        msg += `Rusak  : ${kd.rusak || 0}\n`;
        msg += `Mutasi : ${kd.Mutasi || 0}\n`;
        msg += `Total  : ${a.total_jumlah}\n\n`;
    });

    return msg;
}

         // helper teks length
function checkWaLength(message) {

    const warning = document.getElementById("waWarning");
    const btnSend = document.getElementById("btnSendWA");

    if (message.length > MAX_WA_LENGTH) {
        btnSend.style.display = "none";
        warning.innerText = "Pesan terlalu panjang untuk WhatsApp.";
    } else {
        btnSend.style.display = "inline-block";
        warning.innerText = "";
    }
}

function sendToWhatsApp() {
    const encoded = encodeURIComponent(currentWaMessage);
    window.location.href = `https://wa.me/?text=${encoded}`;
}

function copyReport() {
    navigator.clipboard.writeText(currentWaMessage);
    alert("Laporan berhasil disalin.");
}

         
         
// ==============================================
// PROGRESS OVERLAY MANAGEMENT - VERSI DIPERBAIKI
// ==============================================

let currentProgressType = '';
let progressSteps = [];
let progressInterval = null;

// ==============================================
// PROGRESS OVERLAY MANAGEMENT - VERSI DENGAN FIRST_SYNC
// ==============================================

function showProgressOverlay(type, options = {}) {
    currentProgressType = type;
    
    const overlay = document.getElementById('progressOverlay');
    const title = document.getElementById('progressTitle');
    const subtitle = document.getElementById('progressSubtitle');
    const stepsContainer = document.getElementById('progressSteps');
    const errorContainer = document.getElementById('progressError');
    const cancelBtn = document.getElementById('btnCancelProgress');
    const closeBtn = document.getElementById('btnCloseProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    // Reset progress bar
    progressFill.style.width = '0%';
    progressText.textContent = '0%';
    
    // Set title and subtitle
    title.textContent = options.title || 'Memproses...';
    subtitle.textContent = options.subtitle || 'Mohon tunggu...';
    
    // Hide error
    errorContainer.style.display = 'none';
    errorContainer.innerHTML = '';
    
    // ============= SET STEPS BERDASARKAN TYPE =============
    
    if (type === 'save') {
        progressSteps = [
            { id: 'validate', title: 'Validasi Data', desc: 'Memvalidasi input form' },
            { id: 'prepare', title: 'Mempersiapkan Data', desc: 'Mempersiapkan data untuk disimpan' },
            { id: 'create_items', title: 'Membuat Item', desc: 'Membuat data item' },
            { id: 'save_photos', title: 'Menyimpan Foto', desc: 'Mengolah dan menyimpan foto' },
            { id: 'save_items', title: 'Menyimpan ke Database', desc: 'Menyimpan data ke penyimpanan lokal' },
            { id: 'finalize', title: 'Finalisasi', desc: 'Menyelesaikan proses' }
        ];
    } 
    else if (type === 'update') {
        progressSteps = [
            { id: 'validate', title: 'Validasi Data', desc: 'Memvalidasi input update' },
            { id: 'prepare', title: 'Mempersiapkan Update', desc: 'Mempersiapkan data update' },
            { id: 'process_photo', title: 'Mengolah Foto', desc: 'Mengolah foto baru (jika ada)' },
            { id: 'save_update', title: 'Menyimpan Update', desc: 'Menyimpan perubahan ke database' },
            { id: 'sync', title: 'Sinkronisasi', desc: 'Menyinkronkan dengan cloud' },
            { id: 'finalize', title: 'Finalisasi', desc: 'Menyelesaikan proses' }
        ];
    } 
    else if (type === 'backup') {
        progressSteps = [
            { id: 'load_data', title: 'Memuat Data', desc: 'Mengambil data dari database' },
            { id: 'process_photos', title: 'Memproses Foto', desc: 'Mengkompres dan menyiapkan foto' },
            { id: 'create_zip', title: 'Membuat ZIP', desc: 'Mengompres file' },
            { id: 'save_backup', title: 'Menyimpan Backup', desc: 'Menyimpan file ke history' },
            { id: 'finalize', title: 'Finalisasi', desc: 'Menyelesaikan proses' }
        ];
    } 
    else if (type === 'import') {
        progressSteps = [
            { id: 'read_zip', title: 'Membaca ZIP', desc: 'Menganalisis file backup' },
            { id: 'import_assets', title: 'Import Asset', desc: 'Memulihkan data asset' },
            { id: 'import_photos', title: 'Import Foto', desc: 'Memulihkan file foto' },
            { id: 'reload_data', title: 'Memuat Ulang', desc: 'Memperbarui tampilan' },
            { id: 'finalize', title: 'Finalisasi', desc: 'Menyelesaikan proses' }
        ];
    } 
    else if (type === 'export') {
        progressSteps = [
            { id: 'load_data', title: 'Memuat Data', desc: 'Mengambil data dari database' },
            { id: 'prepare_photos', title: 'Menyiapkan Foto', desc: 'Mengolah foto untuk export' },
            { id: 'create_excel', title: 'Membuat Excel', desc: 'Menyusun laporan Excel' },
            { id: 'create_zip', title: 'Membuat ZIP', desc: 'Mengompres semua file' },
            { id: 'finalize', title: 'Finalisasi', desc: 'Menyelesaikan proses' }
        ];
    }
    //  TAMBAHKAN INI - FIRST SYNC
    else if (type === 'first_sync') {
        progressSteps = [
            { id: 'fetch_assets', title: 'Mengunduh Asset', desc: 'Mengambil data asset dari cloud' },
            { id: 'save_assets', title: 'Menyimpan Asset', desc: 'Menyimpan asset ke database lokal' },
            { id: 'process_photos', title: 'Memproses Foto', desc: 'Mengekstrak dan menyimpan foto' },
            { id: 'update_metadata', title: 'Update Metadata', desc: 'Memperbarui informasi sinkronisasi' },
            { id: 'finalize', title: 'Finalisasi', desc: 'Menyelesaikan sinkronisasi awal' }
        ];
    }
    else {
        // Default steps
        progressSteps = [
            { id: 'start', title: 'Memulai', desc: 'Memulai proses...' },
            { id: 'process', title: 'Memproses', desc: 'Sedang memproses...' },
            { id: 'finish', title: 'Menyelesaikan', desc: 'Menyelesaikan proses...' }
        ];
    }
    
    // Render steps
    stepsContainer.innerHTML = progressSteps.map((step, index) => `
        <div class="progress-step pending" id="step-${step.id}">
            <div class="step-icon pending">${index + 1}</div>
            <div class="step-info">
                <div class="step-title">${step.title}</div>
                <div class="step-description">${step.desc}</div>
            </div>
        </div>
    `).join('');
    
    // Show/hide buttons
    cancelBtn.style.display = (type === 'save' || type === 'update') ? 'inline-flex' : 'none';
    closeBtn.style.display = 'none';
    
    // Show overlay
    overlay.classList.add('active');
    
    // Disable body scroll
    document.body.style.overflow = 'hidden';
    
    console.log(` Progress overlay shown: ${type}`);
}

function updateProgressStep(stepId, status) {
    const stepElement = document.getElementById(`step-${stepId}`);
    if (!stepElement) {
        console.warn(`Step element not found: ${stepId}`);
        return;
    }
    
    // Remove existing classes
    stepElement.classList.remove('pending', 'active', 'completed');
    stepElement.classList.add(status);
    
    const icon = stepElement.querySelector('.step-icon');
    if (icon) {
        icon.classList.remove('pending', 'active', 'completed');
        icon.classList.add(status);
    }
    
    // Auto-complete previous steps
    const stepIndex = progressSteps.findIndex(step => step.id === stepId);
    if (stepIndex >= 0 && (status === 'completed' || status === 'active')) {
        for (let i = 0; i < stepIndex; i++) {
            const prevStepId = progressSteps[i].id;
            const prevStepElement = document.getElementById(`step-${prevStepId}`);
            if (prevStepElement && !prevStepElement.classList.contains('completed')) {
                prevStepElement.classList.remove('pending', 'active');
                prevStepElement.classList.add('completed');
                
                const prevIcon = prevStepElement.querySelector('.step-icon');
                if (prevIcon) {
                    prevIcon.classList.remove('pending', 'active');
                    prevIcon.classList.add('completed');
                }
            }
        }
    }
    
    console.log(` Step updated: ${stepId} -> ${status}`);
}

function updateProgressBar(percentage) {
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('progressText');
    
    if (!fill || !text) {
        console.warn('Progress elements not found');
        return;
    }
    
    const perc = Math.min(100, Math.max(0, percentage));
    fill.style.width = `${perc}%`;
    text.textContent = `${Math.round(perc)}%`;
    
    console.log(` Progress: ${perc}%`);
}

function updateProgressText(text) {
    const subtitle = document.getElementById('progressSubtitle');
    if (subtitle) {
        subtitle.textContent = text;
    }
    console.log(` Progress text: ${text}`);
}

function showProgressError(message) {
    const errorContainer = document.getElementById('progressError');
    const cancelBtn = document.getElementById('btnCancelProgress');
    const closeBtn = document.getElementById('btnCloseProgress');
    
    if (errorContainer) {
        errorContainer.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        errorContainer.style.display = 'block';
    }
    
    if (cancelBtn) cancelBtn.style.display = 'none';
    if (closeBtn) closeBtn.style.display = 'inline-flex';
    
    console.error(` Progress error: ${message}`);
}

function hideProgressOverlay() {
    const overlay = document.getElementById('progressOverlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
    
    // Enable body scroll
    document.body.style.overflow = '';
    
    // Reset
    currentProgressType = '';
    progressSteps = [];
    
    // Clear any intervals
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    
    console.log(' Progress overlay hidden');
}

// Event listeners untuk progress overlay
document.addEventListener('DOMContentLoaded', function() {
    const cancelBtn = document.getElementById('btnCancelProgress');
    const closeBtn = document.getElementById('btnCloseProgress');
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            if (confirm('Batalkan proses yang sedang berjalan?')) {
                hideProgressOverlay();
                showAlert('addAssetAlert', 'Proses dibatalkan', 'warning');
            }
        });
    }
    
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            hideProgressOverlay();
        });
    }
});
        // ==============================================
        // CONNECTION MANAGEMENT
        // ==============================================

        
        // ==============================================
// CONNECTION MANAGEMENT - VERSI BARU (TANPA POLLING)
// ==============================================

function setupConnectionMonitor() {
    // Tidak perlu polling, sudah pakai event listener online/offline
    // dan Firebase onAuthStateChanged
    console.log(" Connection monitor ready (event-based)");
}

// Update fungsi updateConnectionStatus (sudah ada)
function updateConnectionStatus(connected) {
    isFirebaseConnected = connected;
    const isOnline = navigator.onLine;
    
    const firebaseStatusElement = document.getElementById('firebaseStatus');
    const syncStatusElement = document.getElementById('syncStatus');
    const cloudinaryStatusElement = document.getElementById('cloudinaryStatus');
    
    // Hapus warning offline yang ada
    const existingWarning = document.getElementById('offlineWarning');
    if (existingWarning) existingWarning.remove();
    
    if (!isOnline) {
        // OFFLINE MODE
        firebaseStatusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Firebase: Offline</span>';
        firebaseStatusElement.className = 'status-badge status-offline';
        
        syncStatusElement.innerHTML = '<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Diblokir</span>';
        syncStatusElement.className = 'status-badge status-offline';
        
        cloudinaryStatusElement.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Diblokir</span>';
        cloudinaryStatusElement.className = 'status-badge status-offline';
        
        // Tambah warning di dashboard
        const activeTab = document.querySelector('.nav-tab.active');
        if (activeTab && activeTab.getAttribute('data-tab') === 'dashboard') {
            const dashboardGrid = document.querySelector('.dashboard-grid');
            if (dashboardGrid) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'offlineWarning';
                warningDiv.className = 'alert alert-danger';
                warningDiv.style.marginBottom = '20px';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>MODE OFFLINE</strong> - Fitur yang membutuhkan internet diblokir.
                `;
                dashboardGrid.parentNode.insertBefore(warningDiv, dashboardGrid);
            }
        }
        
    } else {
        // ONLINE MODE
        if (connected) {
            firebaseStatusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Firebase: Terhubung</span>';
            firebaseStatusElement.className = 'status-badge status-online';
            
            syncStatusElement.innerHTML = '<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Aktif</span>';
            syncStatusElement.className = 'status-badge status-online';
        } else {
            firebaseStatusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Firebase: Error Koneksi</span>';
            firebaseStatusElement.className = 'status-badge status-warning';
            
            syncStatusElement.innerHTML = '<i class="fas fa-sync-alt"></i> <span>Sinkronisasi: Error</span>';
            syncStatusElement.className = 'status-badge status-warning';
        }
        
        cloudinaryStatusElement.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> <span>Cloudinary: Siap</span>';
        cloudinaryStatusElement.className = 'status-badge status-online';
    }
    
    console.log(` Connection Status: Online=${isOnline}, Firebase=${connected}`);
}
        
        // ==============================================
        // EVENT LISTENERS & INITIALIZATION
        // ==============================================
// ==============================================
// SETUP EVENT LISTENERS - VERSI DENGAN FLAG
// ==============================================

function setupEventListeners() {
    //  CEK APAKAH SUDAH PERNAH DI-SETUP
    if (window._eventListenersSetup) {
        console.log("Event listeners already setup, skipping...");
        return;
    }
    
    document.querySelector('.container').style.display = 'none';
    
    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // Tab navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });

    // Event listener untuk clear local data
    document.getElementById('clearLocalData')?.addEventListener('click', function() {
        clearLocalData();
    });

    // Event listener untuk reset all data (owner only)
    document.getElementById('resetAllData')?.addEventListener('click', function() {
        if (!currentUser || currentUser.role !== 'owner') {
            showAlert('addAssetAlert', ' Hanya owner yang dapat reset semua data', 'danger');
            return;
        }
        
        const password = document.getElementById('resetPassword').value;
        if (password === '115ganteng') {
            document.getElementById('resetModal').classList.add('active');
        } else {
            showAlert('addAssetAlert', 'Sandi salah!', 'danger');
        }
    });
    

            
            // Test Cloudinary connection
            document.getElementById('testCloudinary').addEventListener('click', async function() {
    if (!requireInternet('Test koneksi Cloudinary')) return;
                if (!isCloudinaryEnabled) {
                    showAlert('addAssetAlert', 'Aktifkan Cloudinary terlebih dahulu', 'warning');
                    return;
                }
                
                const btn = this;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="loading"></div> Testing...';
                btn.disabled = true;
                
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = 100;
                    canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillRect(0, 0, 100, 100);
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('TEST', 50, 50);
                    
                    canvas.toBlob(async function(blob) {
                        try {
                            const file = new File([blob], 'test_connection.png', { type: 'image/png' });
                            await uploadToCloudinary(file, 'test_connection', 'test');
                            
                            showAlert('addAssetAlert', ' Koneksi Cloudinary berhasil!', 'success');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                            
                        } catch (uploadError) {
                            console.error("Cloudinary test upload error:", uploadError);
                            showAlert('addAssetAlert', ` Koneksi gagal: ${uploadError.message}`, 'danger');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    }, 'image/png');
                    
                } catch (error) {
                    console.error("Cloudinary test error:", error);
                    showAlert('addAssetAlert', ` Error: ${error.message}`, 'danger');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
            
            // Preview button
            document.getElementById('btnPreview').addEventListener('click', showDataPreview);
            
            // Confirm save in modal
            document.getElementById('confirmSave').addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="loading"></div> Menyimpan...';
                btn.disabled = true;
                
                await saveItemData();
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
            
            // Cancel save
            document.getElementById('cancelSave').addEventListener('click', function() {
                document.getElementById('previewModal').classList.remove('active');
            });
            
            // Close preview modal
            document.getElementById('closePreviewModal').addEventListener('click', function() {
                document.getElementById('previewModal').classList.remove('active');
            });
            
            // Add asset form
            document.getElementById('addAssetForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                showDataPreview();
            });
            
            // Export All Data
            document.getElementById('btnExportAllData').addEventListener('click', exportAllData);
            
            // Backup button
            document.getElementById('btnBackup').addEventListener('click', async function() {
              
                await createBackup();
            });
            
// GANTI fungsi handle file yang lama dengan ini:
let selectedImportFile = null;
let selectedImportType = null; // 'zip' atau 'excel'

// Setup import dropzone (gantikan yang lama)
document.getElementById('importDropzone').addEventListener('click', function() {
    document.getElementById('importFile').click();
});

document.getElementById('importFile').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        selectedImportFile = e.target.files[0];
        
        // Deteksi tipe file
        if (selectedImportFile.name.endsWith('.zip')) {
            selectedImportType = 'zip';
        } else if (selectedImportFile.name.endsWith('.xlsx')) {
            selectedImportType = 'excel';
        } else {
            showAlert('importAlert', ' File harus berupa ZIP atau Excel', 'danger');
            selectedImportFile = null;
            this.value = '';
            return;
        }
        
        // Tampilkan info file
        const fileInfo = `
            <div class="alert alert-info">
                <i class="fas fa-file-${selectedImportType === 'zip' ? 'archive' : 'excel'}"></i>
                <strong>File dipilih:</strong> ${selectedImportFile.name}<br>
                <strong>Tipe:</strong> ${selectedImportType === 'zip' ? 'ZIP (Full Data + Foto)' : 'Excel (Data Massal)'}<br>
                <strong>Ukuran:</strong> ${(selectedImportFile.size / 1024 / 1024).toFixed(2)} MB<br>
                <em>Klik "Preview & Import Data" untuk mulai</em>
            </div>
        `;
        
        document.getElementById('importAlert').innerHTML = fileInfo;
        document.getElementById('importAlert').style.display = 'block';
        document.getElementById('btnImport').style.display = 'inline-flex';
    }
});

// Tombol Import
document.getElementById('btnImport').addEventListener('click', async function() {
    if (!selectedImportFile) {
        showAlert('importAlert', 'Pilih file terlebih dahulu', 'danger');
        return;
    }
    
    if (!currentUser) {
        showAlert('importAlert', 'Harus login terlebih dahulu', 'danger');
        return;
    }
    
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="loading"></div> Memproses...';
    
    try {
        if (selectedImportType === 'zip') {
            await previewZipImport(selectedImportFile);
        } else {
            await previewExcelImport(selectedImportFile);
        }
    } catch (error) {
        console.error("Import error:", error);
        showAlert('importAlert', ` Gagal: ${error.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});
            
            // Custom lokasi handlers
            document.getElementById('lokasi').addEventListener('change', function() {
                const customInput = document.getElementById('customLokasi');
                if (this.value === 'other') {
                    customInput.style.display = 'block';
                    customInput.required = true;
                } else {
                    customInput.style.display = 'none';
                    customInput.required = false;
                }
            });
            
            document.getElementById('newLokasi').addEventListener('change', function() {
                const customInput = document.getElementById('customLokasiUpdate');
                if (this.value === 'other') {
                    customInput.style.display = 'block';
                    customInput.required = true;
                } else {
                    customInput.style.display = 'none';
                    customInput.required = false;
                }
            });
            
            // Asset select for update
            document.getElementById('assetSelect').addEventListener('change', function() {
                const assetId = this.value;
                if (assetId) {
                    loadAssetForUpdate(assetId);
                } else {
                    document.getElementById('assetInfo').style.display = 'none';
                }
            });
            
// Di setupEventListeners(), sekitar baris 5950
// Ganti yang lama dengan ini:

document.getElementById('updateConditionForm')
    .removeEventListener('submit', handleUpdate); // Hapus listener lama

document.getElementById('updateConditionForm')
    .addEventListener('submit', handleUpdate); // Tambah yang baru



            
            // Gallery filters
            document.getElementById('galeriAssetSelect').addEventListener('change', function() {
                const assetId = this.value;
                loadGallery(assetId);
            });
            
            document.getElementById('filterPhotoSource').addEventListener('change', function() {
                const assetId = document.getElementById('galeriAssetSelect').value;
                loadGallery(assetId);
            });
            
            // Search and filter
            // ==============================================
// FILTER & SEARCH - VERSI SEDERHANA
// ==============================================

// Search input
document.getElementById('searchAsset').addEventListener('input', function() {
    displayAssets();
});

// Filter Jenis
document.getElementById('filterJenis').addEventListener('change', function() {
    displayAssets();
});

// Filter Kondisi
document.getElementById('filterKondisi').addEventListener('change', function() {
    displayAssets();
});

// Filter Lokasi
document.getElementById('filterLokasi').addEventListener('change', function() {
    displayAssets();
});

// ============ FILTER FOTO (YANG BARU) ============
document.getElementById('filterFoto').addEventListener('change', function() {
    console.log(" Filter foto berubah ke:", this.value);
    displayAssets();
});
            
            // Sync buttons
            document.getElementById('btnSyncNow').addEventListener('click', runSyncNow);
            
            


            
            document.getElementById('confirmResetAll').addEventListener('click', resetAllData);
            
            document.getElementById('cancelReset').addEventListener('click', function() {
                document.getElementById('resetModal').classList.remove('active');
            });
            
            document.getElementById('closeResetModal').addEventListener('click', function() {
                document.getElementById('resetModal').classList.remove('active');
            });
            
            // Settings
            document.getElementById('autoSync').addEventListener('change', function() {
                saveSetting({ key: 'autoSync', value: this.checked });
            });
            
            document.getElementById('syncInterval').addEventListener('change', function() {
                saveSetting({ key: 'syncInterval', value: this.value });
            });
            
            document.getElementById('enableCompression').addEventListener('change', function() {
                saveSetting({ key: 'compression', value: this.checked });
            });
            
            
            
            
            
            // Modal close buttons
            document.getElementById('closeAssetDetail').addEventListener('click', function() {
                document.getElementById('assetDetailModal').classList.remove('active');
            });
            
            document.getElementById('closePhotoModal').addEventListener('click', function() {
                document.getElementById('photoModal').classList.remove('active');
            });
            
            document.getElementById('closeCloudinaryModal').addEventListener('click', function() {
                document.getElementById('cloudinaryUploadModal').classList.remove('active');
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.id === 'assetDetailModal') {
                    document.getElementById('assetDetailModal').classList.remove('active');
                }
                if (e.target.id === 'photoModal') {
                    document.getElementById('photoModal').classList.remove('active');
                }
                if (e.target.id === 'cloudinaryUploadModal') {
                    document.getElementById('cloudinaryUploadModal').classList.remove('active');
                }
                if (e.target.id === 'resetModal') {
                    document.getElementById('resetModal').classList.remove('active');
                }
                if (e.target.id === 'previewModal') {
                    document.getElementById('previewModal').classList.remove('active');
                }
            });
const onlineButtons = [
        'btnSyncNow',
        'btnBackup',
        'btnExportAllData',
        'btnImport',
        'testCloudinary'
    ];
    
    onlineButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            const originalClick = btn.onclick;          btn.addEventListener('click', function(e) {
                if (!navigator.onLine) {
                    e.preventDefault();
                    e.stopPropagation();
                    showToastNotification(' Fitur ini membutuhkan koneksi internet!', 'danger');
                    return false;
                }
                // Jalankan fungsi asli jika online
                if (originalClick) originalClick.call(this, e);
            });
        }  
    });    
            
window.addEventListener('online', async () => {
    console.log(" Browser: Online");
    
    showToastNotification(' Koneksi internet tersambung - Fitur online tersedia', 'success');
    
    // Hapus warning offline
    const warning = document.getElementById('offlineWarning');
    if (warning) warning.remove();
    
    // Update status jadi pending dulu
    isFirebaseConnected = false;
    updateConnectionStatus(false);
    
    // Coba konek ke Firebase
    setTimeout(async () => {
        try {
            if (!db) {
                await initFirebase();
            }
            await db.collection('assets').limit(1).get();
            isFirebaseConnected = true;
            updateConnectionStatus(true);
            
            if (currentUser) {
                showToastNotification(' Memulai sinkronisasi...', 'info');
                if (!isSyncRunning) {
                    await runSyncNow();
                }
            }
            
            // Update dashboard untuk menghilangkan warning
            updateDashboard();
            
        } catch (error) {
            console.warn("Firebase connection failed:", error);
            updateConnectionStatus(false);
        }
    }, 1500);
});

window.addEventListener('offline', () => {
    console.log(" Browser: Offline");
    
    showToastNotification(' Mode offline - Fitur online diblokir', 'warning');
    
    isFirebaseConnected = false;
    updateConnectionStatus(false);
    
    // Update dashboard untuk menampilkan warning
    updateDashboard();
});
// Cleanup semua interval saat halaman ditutup/direfresh
// ==============================================
// BEFOREUNLOAD HANDLER - GABUNGAN
// ==============================================

window.addEventListener('beforeunload', function(e) {
    // 1. Cleanup intervals
    console.log(` Cleaning up ${_intervals.length} intervals...`);
    _intervals.forEach(id => clearInterval(id));
    _intervals.length = 0;
    
    // 2. Cek pending sync (hanya jika user login)
    if (currentUser) {
        const pendingSync = assets.filter(a => a.syncStatus === 'pending').length;
        
        if (pendingSync > 0) {
            const message = `Ada ${pendingSync} data belum sync. Yakin ingin keluar?`;
            e.returnValue = message;
            return message;
        }
    }
});

    //  TANDAI BAHWA SUDAH DI-SETUP
    window._eventListenersSetup = true;
    
    console.log(" Event listeners setup complete");
}
        
        // ==============================================
        // ASSET UPDATE FUNCTION
        // ==============================================
// MODIFIKASI fungsi savePhotoWithCloudinary untuk menyimpan thumbnail
async function savePhotoWithCloudinary(assetId, type, base64Image, file = null, userInfo = null) {
    // Buat thumbnail dari gambar utama
    let thumbnail = null;
    if (base64Image) {
        try {
            // Convert base64 ke blob untuk kompresi
            const response = await fetch(base64Image);
            const blob = await response.blob();
            const thumbFile = new File([blob], 'thumb.jpg', { type: 'image/jpeg' });
            
            const thumbResult = await compressImage(thumbFile, { forThumbnail: true });
            thumbnail = thumbResult.base64;
        } catch (error) {
            console.warn("Failed to create thumbnail:", error);
        }
    }
    
    const photoData = {
        assetId: assetId,
        type: type,
        image: base64Image, // Gambar ukuran penuh
        thumbnail: thumbnail, // Thumbnail untuk preview
        tanggal: new Date().toISOString(),
        timestamp: Date.now(),
        uploadStatus: 'PENDING',
        uploaded_by: userInfo,
        retryCount: 0,
        maxRetries: 3,
        // Metadata untuk optimasi
        meta: {
            hasThumbnail: !!thumbnail,
            originalSize: base64Image?.length || 0,
            thumbSize: thumbnail?.length || 0
        }
    };
    
    // Hapus gambar penuh jika terlalu besar dan ada thumbnail
    const MAX_FULL_SIZE = 500 * 1024; // 500KB
    if (photoData.meta.originalSize > MAX_FULL_SIZE && thumbnail) {
        // Simpan hanya thumbnail, gambar penuh hanya di Cloudinary
        photoData.image = null;
        photoData.thumbnailOnly = true;
    }
    
// Coba upload langsung jika online
if (navigator.onLine) {
    try {
        if (!file) {
            const response = await fetch(base64Image);
            const blob = await response.blob();
            file = new File([blob], `photo_${assetId}_${Date.now()}.jpg`, { type: 'image/jpeg' });
        }
        
        //  PAKAI UPLOAD WITH RETRY
        const cloudinaryData = await uploadWithRetry(file, assetId, type, 3);
        
        photoData.cloudinary = cloudinaryData;
        photoData.uploadStatus = 'UPLOADED';
        photoData.uploadedAt = new Date().toISOString();
        
        // Jika sudah diupload, hapus gambar lokal untuk hemat ruang
        photoData.image = null;
        photoData.thumbnail = null;
        photoData.cloudinaryOnly = true;
        
    } catch (error) {
        console.error("Cloudinary upload failed after retries:", error);
        photoData.uploadStatus = 'PENDING';
        photoData.uploadError = error.message;
        // Tetap simpan foto lokal untuk retry nanti
    }
}
    
    // Simpan ke IndexedDB
    return new Promise((resolve, reject) => {
        const transaction = indexedDBInstance.transaction(['photos'], 'readwrite');
        const store = transaction.objectStore('photos');
        
        const request = store.add(photoData);
        
        request.onsuccess = function() {
            photoData.id = request.result;
            resolve(photoData);
        };
        
        request.onerror = function(event) {
            console.error("Error saving photo:", event.target.error);
            reject(event.target.error);
        };
    });
}
        
        // ==============================================
        // RESET FUNCTIONS
        // ==============================================
        
        async function resetAllData() {
            try {
                const password = document.getElementById('confirmResetPassword').value;
                if (password !== '115ganteng') {
                    showAlert('addAssetAlert', 'Sandi salah!', 'danger');
                    return;
                }
                
                const modal = document.getElementById('resetModal');
                modal.classList.remove('active');
                
                showAlert('addAssetAlert', 'Memulai reset semua data...', 'info');
                
                if (isFirebaseConnected) {
                    try {
                        const assetsSnapshot = await db.collection('assets').get();
                        const batch = db.batch();
                        assetsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        console.log("Firebase data deleted");
                    } catch (firebaseError) {
                        console.error("Error deleting Firebase data:", firebaseError);
                    }
                }
                
                try {
                    indexedDB.close();
                    await new Promise((resolve) => {
                        const request = indexedDB.deleteDatabase('assetDB');
                        request.onsuccess = function() {
                            console.log("IndexedDB deleted successfully");
                            resolve();
                        };
                        request.onerror = function(event) {
                            console.error("Error deleting IndexedDB:", event.target.error);
                            resolve();
                        };
                        request.onblocked = function() {
                            console.log("IndexedDB deletion blocked");
                            resolve();
                        };
                    });
                } catch (localError) {
                    console.error("Error clearing local data:", localError);
                }
                
                localStorage.clear();
                
                assets = [];
                pendingSyncAssets = [];
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
                showAlert('addAssetAlert', 'Reset berhasil! Aplikasi akan reload...', 'success');
                
            } catch (error) {
                console.error("Error in resetAllData:", error);
                showAlert('addAssetAlert', `Error reset data: ${error.message}`, 'danger');
            }
        }
        
        async function clearLocalData() {
    return new Promise((resolve) => {
        const modalHTML = `
            <div class="modal active" id="clearLocalModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Hapus Data Lokal</div>
                        <div class="close-modal" id="closeClearLocalModal">&times;</div>
                    </div>
                    <div id="clearLocalModalContent" style="padding: 20px;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>PERINGATAN!</strong> Tindakan ini akan menghapus:
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>Semua data item dari IndexedDB</li>
                                <li>Semua foto dari database lokal</li>
                                <li>Semua riwayat backup</li>
                                <li>Semua pengaturan lokal</li>
                            </ul>
                            <p style="margin-top: 10px;">Data di Firebase dan Cloudinary TIDAK akan terpengaruh.</p>
                            <p><strong> SETELAH INI, APLIKASI AKAN REFRESH OTOMATIS UNTUK MENGAMBIL DATA DARI CLOUD</strong></p>
                            <p><strong>Tindakan ini tidak dapat dibatalkan!</strong></p>
                        </div>
                        <div class="form-group">
                            <label for="clearLocalPassword">Masukkan sandi konfirmasi:</label>
                            <input type="password" id="clearLocalPassword" placeholder="115ganteng" class="form-control" style="width: 100%; padding: 10px; margin: 10px 0;">
                        </div>
                        <div id="clearLocalError" style="color: var(--danger); display: none; margin-bottom: 10px;">
                            <i class="fas fa-exclamation-circle"></i> Sandi salah!
                        </div>
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <button class="btn btn-danger" id="confirmClearLocal">
                                <i class="fas fa-trash"></i> HAPUS DATA LOKAL
                            </button>
                            <button class="btn btn-outline" id="cancelClearLocal">
                                <i class="fas fa-times"></i> Batal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
        
        const closeModal = () => {
            const modal = document.getElementById('clearLocalModal');
            if (modal) {
                modal.remove();
            }
            resolve(false);
        };
        
        setTimeout(() => {
            const closeBtn = document.getElementById('closeClearLocalModal');
            const cancelBtn = document.getElementById('cancelClearLocal');
            const confirmBtn = document.getElementById('confirmClearLocal');
            const passwordInput = document.getElementById('clearLocalPassword');
            const errorMsg = document.getElementById('clearLocalError');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }
            
            if (confirmBtn && passwordInput) {
                confirmBtn.addEventListener('click', async () => {
                    const password = passwordInput.value.trim();
                    
                    if (password !== '115ganteng') {
                        errorMsg.style.display = 'block';
                        passwordInput.style.borderColor = 'var(--danger)';
                        passwordInput.focus();
                        return;
                    }
                    
                    const modal = document.getElementById('clearLocalModal');
                    if (modal) {
                        modal.remove();
                    }
                    
                    showAlert('addAssetAlert', ' Menghapus data lokal...', 'info');
                    
                    try {
                        // ============ HAPUS SEMUA STORE ============
                        const objectStores = ['assets', 'photos', 'backups', 'settings', 'syncQueue', 'user_activities', 'sync_metadata'];
                        
                        for (const storeName of objectStores) {
                            try {
                                await new Promise((storeResolve) => {
                                    const transaction = indexedDBInstance.transaction([storeName], 'readwrite');
                                    const store = transaction.objectStore(storeName);
                                    const request = store.clear();
                                    
                                    request.onsuccess = function() {
                                        console.log(` Cleared ${storeName}`);
                                        storeResolve();
                                    };
                                    
                                    request.onerror = function(event) {
                                        console.error(` Error clearing ${storeName}:`, event.target.error);
                                        storeResolve();
                                    };
                                });
                            } catch (err) {
                                console.error(` Error with ${storeName}:`, err);
                            }
                        }
                        
                        // ============ RESET TIMESTAMP SYNC ============
                        // Reset lastPullTimestamp ke 0 agar ambil semua data dari cloud
                        await saveLastPullTimestamp(0);
                        console.log(" Reset lastPullTimestamp to 0");
                        
                        // Hapus juga dari localStorage
                        localStorage.removeItem('theme');
                        localStorage.removeItem('lastPullTimestamp');
                        
                        // Reset array global
                        assets = [];
                        pendingSyncAssets = [];
                        
                        // Update UI
                        updateAssetSelects();
                        displayAssets();
                        updateDashboard();
                        loadBackupHistory();
                        
                        showAlert('addAssetAlert', ' Data lokal berhasil dihapus! Mengambil data dari cloud...', 'success');
                        
                        // ============ AMBIL DATA DARI CLOUD ============
                        if (navigator.onLine && isFirebaseConnected) {
                            showAlert('addAssetAlert', ' Mengambil data dari cloud...', 'info');
                            
                            try {
                                // Panggil firstTimeSyncFromCloud untuk ambil semua data
                                const cloudAssets = await firstTimeSyncFromCloud();
                                
                                if (cloudAssets && cloudAssets.length > 0) {
                                    assets = cloudAssets;
                                    console.log(` Berhasil mengambil ${cloudAssets.length} asset dari cloud`);
                                    
                                    showAlert('addAssetAlert', ` Berhasil mengambil ${cloudAssets.length} asset dari cloud!`, 'success');
                                    
                                    // Update UI
                                    updateAssetSelects();
                                    displayAssets();
                                    updateDashboard();
                                } else {
                                    console.log(" Tidak ada data di cloud");
                                    showAlert('addAssetAlert', ' Tidak ada data di cloud. Mulai dengan menambah item baru.', 'info');
                                }
                            } catch (syncError) {
                                console.error(" Gagal sync dari cloud:", syncError);
                                showAlert('addAssetAlert', ' Gagal mengambil data dari cloud. Refresh halaman dan coba sync manual.', 'danger');
                            }
                        } else {
                            showAlert('addAssetAlert', ' Anda offline. Data lokal kosong. Online kan untuk mengambil data dari cloud.', 'warning');
                        }
                        
                        resolve(true);
                        
                    } catch (error) {
                        console.error(" Error clearing local data:", error);
                        showAlert('addAssetAlert', ` Error menghapus data: ${error.message}`, 'danger');
                        resolve(false);
                    }
                });
            }
            
            const modal = document.getElementById('clearLocalModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('confirmClearLocal')?.click();
                    }
                });
                passwordInput.focus();
            }
        }, 100);
    });
}

// ==============================================
// AUTHENTICATION SYSTEM
// ==============================================

let currentUser = null;
let isOwner = false;
let authInitialized = false;

// Initialize Firebase Authentication
// Initialize Firebase Authentication
async function initFirebaseAuth() {
    try {
        console.log(" Initializing Firebase Auth...");
        
        // Pastikan Firebase Auth SDK sudah dimuat
        if (typeof firebase.auth !== 'function') {
            console.log(" Loading Firebase Auth SDK...");
            await loadFirebaseAuth();
        }
        
        // Set persistence ke LOCAL untuk auto-login
        try {
            await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            console.log(" Auth persistence set to LOCAL");
        } catch (persistenceError) {
            console.warn(" Could not set auth persistence:", persistenceError);
        }
        
        // Set up auth state listener
        firebase.auth().onAuthStateChanged(async (user) => {
            console.log(" Auth state changed:", user ? user.email : "null");
            
            if (user) {
                // User signed in
                console.log(" User signed in:", user.email);
                await handleUserSignedIn(user);
            } else {
                // User signed out
                console.log(" User signed out");
                handleUserSignedOut();
            }
        });
        
        authInitialized = true;
        console.log(" Firebase Auth initialized");
        
    } catch (error) {
        console.error(" Error initializing Firebase Auth:", error);
        authInitialized = false;
    }
}
// Show login overlay
// Show login overlay
function showLoginOverlay() {
    console.log(" Showing login overlay");
    
    // Hide main app first
    hideMainApp();
    
    // Show overlay dengan animasi
    const overlay = document.getElementById('loginOverlay');
    overlay.style.display = 'flex';
    
    // Reset forms
    document.getElementById('loginForm').reset();
    document.getElementById('registerForm').reset();
    
    // Clear error messages
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginSuccess').style.display = 'none';
    document.getElementById('registerError').style.display = 'none';
    document.getElementById('registerSuccess').style.display = 'none';
    
    // Set default tab to login
    document.querySelectorAll('.login-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector('.login-tab[data-form="login"]').classList.add('active');
    
    document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
    document.getElementById('loginForm').classList.add('active');
    
    // Trigger animation
    setTimeout(() => {
        overlay.style.opacity = '1';
    }, 10);
}

// Hide login overlay
function hideLoginOverlay() {
    console.log(" Hiding login overlay");
    
    const overlay = document.getElementById('loginOverlay');
    if (overlay.style.display !== 'none') {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);
    }
}

// Show loading overlay
function showLoadingOverlay(message = 'Memproses...') {
    document.getElementById('loadingText').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

// Hide loading overlay
function hideLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Switch between login/register forms
function setupAuthForms() {
    // Tab switching
    // Pastikan form bisa diakses bahkan jika Firebase Auth belum siap
document.querySelectorAll('.login-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const formType = this.getAttribute('data-form');
        
        // Update tabs
        document.querySelectorAll('.login-tab').forEach(t => {
            t.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update forms
        document.querySelectorAll('.login-form').forEach(form => {
            form.classList.remove('active');
        });
        document.getElementById(`${formType}Form`).classList.add('active');
        
        // Clear errors
        const errorElement = document.getElementById(`${formType}Error`);
        const successElement = document.getElementById(`${formType}Success`);
        if (errorElement) errorElement.style.display = 'none';
        if (successElement) successElement.style.display = 'none';
    });
});
    
    // Switch form links
    document.querySelectorAll('.switch-form a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const formType = this.getAttribute('data-form');
            
            // Trigger click on corresponding tab
            document.querySelector(`.login-tab[data-form="${formType}"]`).click();
        });
    });
    
  // Login form submission dengan offline support
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    await loginUser();
});

// Register form submission dengan offline support  
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    await registerUser();
});


    
    // Forgot password
    document.getElementById('forgotPassword').addEventListener('click', async function(e) {
        e.preventDefault();
        await forgotPassword();
    });
}
    // Fungsi helper untuk cek Firebase Auth availability
// Fungsi helper untuk cek Firebase Auth availability
function isFirebaseAuthAvailable() {
    return firebase && 
           typeof firebase.auth === 'function' && 
           firebase.auth !== null;
}
// Login user
async function loginUser() {
    if (!requireInternet('Login')) return;
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    const errorElement = document.getElementById('loginError');
    const successElement = document.getElementById('loginSuccess');
    const loginBtn = document.getElementById('btnLogin');
    
    // Validation
    if (!email || !password) {
        showError(errorElement, 'Harap isi email dan password');
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showError(errorElement, 'Format email tidak valid');
        return;
    }
    
    showLoadingOverlay('Login...');
    
    try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<div class="loading"></div> Login...';
        
        // Hash password untuk penyimpanan
        let passwordHash;
        try {
            passwordHash = await hashPassword(password);
        } catch (e) {
            console.warn("Using simple hash fallback");
            passwordHash = simpleHash(password);
        }
        
        // Cek jika Firebase Auth tersedia
        if (!isFirebaseAuthAvailable()) {
            // Offline mode: cek cached user
            const cachedUser = localStorage.getItem('cachedUser') || sessionStorage.getItem('cachedUser');
            if (cachedUser) {
                try {
                    const userData = JSON.parse(cachedUser);
                    
                    if (userData.email === email) {
                        // Verifikasi password dengan hash
                        const storedHash = localStorage.getItem('userPasswordHash') || '';
                        
                        if (storedHash === passwordHash) {
                            currentUser = userData;
                            
                            showSuccess(successElement, `Login berhasil (offline mode)! Selamat datang ${userData.nama}`);
                            
                            setTimeout(() => {
                                hideLoginOverlay();
                                showMainApp();
                                setupUserDropdown();
                                hideLoadingOverlay();
                                
                                document.getElementById('loginForm').reset();
                                errorElement.style.display = 'none';
                                successElement.style.display = 'none';
                            }, 1500);
                            
                            loginBtn.disabled = false;
                            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                            
                            return;
                        } else {
                            throw new Error('Password salah (offline mode)');
                        }
                    } else {
                        throw new Error('Email tidak cocok dengan user yang tersimpan');
                    }
                } catch (parseError) {
                    console.error("Error parsing cached user:", parseError);
                    throw new Error('Tidak bisa login saat offline. Data cache tidak valid.');
                }
            } else {
                throw new Error('Tidak bisa login saat offline. Tidak ada user yang tersimpan.');
            }
        }
        
        // Online mode: Sign in with Firebase Auth
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log(" Login successful:", user.email);
        
        // Get additional user data from Firestore
        let userData = null;
        
        if (db && typeof db.collection === 'function') {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        nama: email.split('@')[0],
                        jabatan: 'User',
                        nik: '',
                        role: 'user',
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        isActive: true,
                        profileComplete: false
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                }
            } catch (firestoreError) {
                console.warn(" Firestore error, using basic user data:", firestoreError);
                userData = {
                    uid: user.uid,
                    email: user.email,
                    nama: email.split('@')[0],
                    jabatan: 'User',
                    nik: '',
                    role: 'user',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    isActive: true,
                    profileComplete: false
                };
            }
        } else {
            userData = {
                uid: user.uid,
                email: user.email,
                nama: email.split('@')[0],
                jabatan: 'User',
                nik: '',
                role: 'user',
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                isActive: true,
                profileComplete: false
            };
        }
        
        // Cache user data
        currentUser = {
            uid: user.uid,
            email: user.email,
            ...userData
        };
        
        // =============================================
        // SAVE TO INDEXEDDB HANYA JIKA REMEMBER ME
        // =============================================
        if (rememberMe) {
            try {
                await saveUserToIndexedDB(currentUser);
                console.log(" User saved to IndexedDB (rememberMe=true)");
            } catch (indexedDBError) {
                console.warn(" Error saving user to IndexedDB:", indexedDBError);
            }
        } else {
            console.log(" Skip IndexedDB save (rememberMe=false)");
            
            // HAPUS SEMUA USER DARI INDEXEDDB
            if (indexedDBInstance) {
                try {
                    const transaction = indexedDBInstance.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    
                    const checkReq = store.getAll();
                    checkReq.onsuccess = () => {
                        if (checkReq.result.length > 0) {
                            store.clear();
                            console.log(" Existing users cleared from IndexedDB");
                        }
                    };
                } catch (e) {
                    console.warn(" Error clearing IndexedDB:", e);
                }
            }
        }
        
        // =============================================
        // SAVE PASSWORD HASH (BUKAN PLAINTEXT)
        // =============================================
        if (rememberMe) {
            localStorage.setItem('cachedUser', JSON.stringify(currentUser));
            localStorage.setItem('userToken', user.uid);
            localStorage.setItem('userPasswordHash', passwordHash); //  SIMPAN HASH
            localStorage.setItem('rememberMe', 'true');
            
            // HAPUS password plaintext jika ada
            localStorage.removeItem('userPassword');
        } else {
            sessionStorage.setItem('cachedUser', JSON.stringify(currentUser));
            sessionStorage.setItem('userToken', user.uid);
            localStorage.setItem('userPasswordHash', passwordHash); //  SIMPAN HASH
            localStorage.setItem('rememberMe', 'false');
            
            // HAPUS password plaintext jika ada
            localStorage.removeItem('userPassword');
        }
        
        // Check if user is owner
        await checkIfOwner(user.uid);
        
        // Show success message
        showSuccess(successElement, `Login berhasil! Selamat datang ${currentUser.nama}`);
        
        setTimeout(() => {
            hideLoginOverlay();
            showMainApp();
            hideLoadingOverlay();
            
            document.getElementById('loginForm').reset();
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            
            showToastNotification(
                ` Selamat datang, ${currentUser.nama}!`,
                'success'
            );
        }, 1500);
        
    } catch (error) {
        console.error(" Login error:", error);
        hideLoadingOverlay();
        
        let errorMessage = 'Login gagal. ';
        
        if (error.code) {
            switch (error.code) {
                case 'auth/user-not-found':
                    errorMessage = 'Email tidak terdaftar';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Password salah';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Terlalu banyak percobaan. Coba lagi nanti';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = 'Koneksi internet bermasalah';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'Akun ini dinonaktifkan';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Format email tidak valid';
                    break;
                default:
                    errorMessage += error.message || error.code;
            }
        } else {
            errorMessage += error.message || 'Terjadi kesalahan tidak diketahui';
        }
        
        showError(errorElement, errorMessage);
        
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
    }
}

// Register new user
// Register new user
// Register new user dengan hash password
async function registerUser() {
    if (!requireInternet('Registrasi')) return;
    
    const nama = document.getElementById('registerNama').value.trim();
    const jabatan = document.getElementById('registerJabatan').value.trim();
    const nik = document.getElementById('registerNIK').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    const rememberMe = document.getElementById('rememberMe')?.checked || false; // Tambah ini
    
    const errorElement = document.getElementById('registerError');
    const successElement = document.getElementById('registerSuccess');
    const registerBtn = document.getElementById('btnRegister');
    
    // Validation
    if (!nama || !jabatan || !nik || !email || !password || !confirmPassword) {
        showError(errorElement, 'Harap lengkapi semua field');
        return;
    }
    
    if (password !== confirmPassword) {
        showError(errorElement, 'Password dan konfirmasi password tidak cocok');
        return;
    }
    
    if (password.length < 6) {
        showError(errorElement, 'Password minimal 6 karakter');
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showError(errorElement, 'Format email tidak valid');
        return;
    }
    
    showLoadingOverlay('Mendaftarkan akun...');
    
    try {
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<div class="loading"></div> Mendaftar...';
        
        if (typeof firebase.auth !== 'function') {
            throw new Error('Sistem autentikasi belum siap. Silakan refresh halaman.');
        }
        
        console.log(" Creating user with email:", email);
        
        // 1. Buat user di Firebase Authentication
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log(" User created in Firebase Auth:", user.uid);
        
        // 2. Hash password untuk penyimpanan lokal
        const passwordHash = await hashPassword(password);
        
        // 3. Tentukan role (owner atau user)
        let isFirstUser = true;
        if (navigator.onLine) {
            try {
                const usersSnapshot = await db.collection('users').get();
                isFirstUser = usersSnapshot.empty;
                console.log(" Total users in Firestore:", usersSnapshot.size, "Is first user:", isFirstUser);
            } catch (firestoreError) {
                console.warn(" Could not check if first user:", firestoreError);
            }
        }
        
        // 4. Persiapkan data user untuk Firestore
        const userData = {
            uid: user.uid,
            email: email,
            nama: nama,
            jabatan: jabatan,
            nik: nik,
            role: isFirstUser ? 'owner' : 'user',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            isActive: true,
            profileComplete: true
        };
        
        console.log(" User data prepared:", userData);
        
        // 5. Simpan ke Firestore (jika online)
        if (navigator.onLine && db) {
            try {
                await db.collection('users').doc(user.uid).set(userData);
                console.log(" User data saved to Firestore");
            } catch (firestoreError) {
                console.error(" Error saving to Firestore:", firestoreError);
            }
        }
        
        // 6. Update currentUser
        currentUser = {
            ...userData,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
        };
        
        // =============================================
        // 7. SIMPAN KE INDEXEDDB HANYA JIKA REMEMBER ME
        // =============================================
        if (rememberMe) {
            try {
                await saveUserToIndexedDB(currentUser);
                console.log(" User saved to IndexedDB (rememberMe=true)");
            } catch (indexedDBError) {
                console.error(" Error saving to IndexedDB:", indexedDBError);
            }
        } else {
            console.log(" Skip IndexedDB save (rememberMe=false)");
            
            // Hapus semua user dari IndexedDB
            if (indexedDBInstance) {
                try {
                    const transaction = indexedDBInstance.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    store.clear();
                    console.log(" Existing users cleared from IndexedDB");
                } catch (e) {
                    console.warn(" Error clearing IndexedDB:", e);
                }
            }
        }
        
        // =============================================
        // 8. SIMPAN KE STORAGE DENGAN HASH
        // =============================================
        if (rememberMe) {
            localStorage.setItem('cachedUser', JSON.stringify(currentUser));
            localStorage.setItem('userToken', user.uid);
            localStorage.setItem('userPasswordHash', passwordHash); // SIMPAN HASH
            localStorage.setItem('rememberMe', 'true');
            
            // Hapus password plaintext jika ada
            localStorage.removeItem('userPassword');
        } else {
            sessionStorage.setItem('cachedUser', JSON.stringify(currentUser));
            sessionStorage.setItem('userToken', user.uid);
            localStorage.setItem('userPasswordHash', passwordHash); // SIMPAN HASH
            localStorage.setItem('rememberMe', 'false');
            
            // Hapus password plaintext jika ada
            localStorage.removeItem('userPassword');
        }
        
        // 9. Set owner status
        isOwner = isFirstUser;
        
        // 10. Auto login setelah register
        console.log(" Auto-login after registration...");
        await firebase.auth().signInWithEmailAndPassword(email, password);
        
        // 11. Show success message
        const roleMessage = isFirstUser ? ' (Sebagai Owner)' : '';
        showSuccess(successElement, `Pendaftaran berhasil!${roleMessage} Anda akan dialihkan...`);
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        hideLoadingOverlay();
        
        setTimeout(() => {
            hideLoginOverlay();
            showMainApp();
            
            document.getElementById('registerForm').reset();
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            
            showToastNotification(
                ` Selamat datang, ${currentUser.nama}! ${roleMessage}`,
                'success'
            );
            
            console.log(" Registration complete, user signed in:", currentUser.email);
        }, 2000);
        
    } catch (error) {
        console.error(" Registration error:", error);
        hideLoadingOverlay();
        
        let errorMessage = 'Pendaftaran gagal. ';
        
        if (error.code) {
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'Email sudah terdaftar';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Format email tidak valid';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password terlalu lemah. Minimal 6 karakter';
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage = 'Registrasi email/password tidak diizinkan. Hubungi admin';
                    break;
                case 'auth/network-request-failed':
                    errorMessage = 'Koneksi internet bermasalah. Coba lagi nanti';
                    break;
                default:
                    errorMessage += error.message || error.code;
            }
        } else {
            errorMessage += error.message || 'Terjadi kesalahan tidak diketahui';
        }
        
        showError(errorElement, errorMessage);
        
        try {
            await firebase.auth().signOut();
        } catch (signOutError) {
            console.log("Cleanup signout error:", signOutError);
        }
    } finally {
        registerBtn.disabled = false;
        registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Daftar Akun';
    }
}
// ==============================================
// FUNGSI SAVE USER TO INDEXEDDB - VERSI BARU
// ==============================================

async function saveUserToIndexedDB(userData) {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            console.warn("IndexedDB not initialized, skipping user save");
            resolve();
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['users'], 'readwrite');
            const store = transaction.objectStore('users');
            
            // Konversi semua tanggal ke string ISO untuk konsistensi
            const userToSave = {
                ...userData,
                // Konversi createdAt ke string jika berupa object
                createdAt: userData.createdAt && typeof userData.createdAt === 'object' && userData.createdAt.toDate 
                    ? userData.createdAt.toDate().toISOString() 
                    : (userData.createdAt || new Date().toISOString()),
                
                // Konversi lastLogin ke string jika berupa object
                lastLogin: userData.lastLogin && typeof userData.lastLogin === 'object' && userData.lastLogin.toDate 
                    ? userData.lastLogin.toDate().toISOString() 
                    : (userData.lastLogin || new Date().toISOString()),
                
                lastSaved: new Date().toISOString()
            };
            
            const request = store.put(userToSave);
            
            request.onsuccess = function() {
                console.log(" User saved to IndexedDB:", userData.email);
                resolve();
            };
            
            request.onerror = function(event) {
                console.error(" Error saving user to IndexedDB:", event.target.error);
                reject(event.target.error);
            };
            
        } catch (error) {
            console.error(" Exception saving user to IndexedDB:", error);
            reject(error);
        }
    });
}
// Forgot password
async function forgotPassword() {
  if (!requireInternet('Reset password')) return;
    const email = prompt('Masukkan email Anda untuk reset password:');
    
    if (!email) return;
    
    showLoadingOverlay('Mengirim email reset password...');
    
    try {
        await firebase.auth().sendPasswordResetEmail(email);
        alert(`Email reset password telah dikirim ke ${email}. Silakan cek inbox Anda.`);
    } catch (error) {
        console.error(" Password reset error:", error);
        alert('Gagal mengirim email reset password: ' + error.message);
    } finally {
        hideLoadingOverlay();
    }
}

// Check if user is owner
async function checkIfOwner(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            isOwner = userData.role === 'owner';
            return isOwner;
        }
        return false;
    } catch (error) {
        console.error("Error checking owner status:", error);
        return false;
    }
}

// ==============================================
// HANDLE USER SIGNED IN - VERSI BARU
// ==============================================

// ==============================================
// HANDLE USER SIGNED IN - VERSI FINAL (DENGAN SYNC METADATA)
// ==============================================

async function handleUserSignedIn(user) {
    try {
        console.log(" Handling signed in user:", user.email, user.uid);
        
        // Hide login overlay immediately
        hideLoginOverlay();
        
        let userData = null;
        
        // Coba ambil dari Firestore dulu
        if (navigator.onLine && db && typeof db.collection === 'function') {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log(" User data found in Firestore:", userData);
                    
                    // Convert timestamps
                    if (userData.createdAt && userData.createdAt.toDate) {
                        userData.createdAt = userData.createdAt.toDate().toISOString();
                    }
                    if (userData.lastLogin && userData.lastLogin.toDate) {
                        userData.lastLogin = userData.lastLogin.toDate().toISOString();
                    }
                    
                    // Update last login di Firestore
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                } else {
                    console.log(" User document not found in Firestore, creating basic data");
                    
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        nama: user.email.split('@')[0],
                        jabatan: 'User',
                        nik: '',
                        role: 'user',
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        isActive: true,
                        profileComplete: false
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                }
            } catch (firestoreError) {
                console.error(" Firestore error:", firestoreError);
                // Fallback ke data dasar
                userData = {
                    uid: user.uid,
                    email: user.email,
                    nama: user.email.split('@')[0],
                    jabatan: 'User',
                    nik: '',
                    role: 'user',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    isActive: true,
                    profileComplete: false
                };
            }
        } else {
            // Offline mode - cek apakah user ada di IndexedDB
            try {
                const savedUser = await loadUserFromIndexedDB(user.uid);
                if (savedUser) {
                    userData = savedUser;
                    console.log(" Using offline user data from IndexedDB");
                } else {
                    throw new Error("User not found in offline storage");
                }
            } catch (offlineError) {
                console.error(" Offline user data not found");
                throw new Error("Anda sedang offline dan data user tidak ditemukan");
            }
        }
        
        // Update currentUser
        currentUser = {
            uid: user.uid,
            email: user.email,
            ...userData
        };
        
        // Check if user is owner
        isOwner = currentUser.role === 'owner';
        
        // Simpan ke IndexedDB untuk offline access
        try {
            const userForIndexedDB = {
                ...currentUser,
                createdAt: currentUser.createdAt || new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                lastSaved: new Date().toISOString()
            };
            await saveUserToIndexedDB(userForIndexedDB);
            console.log(" User saved to IndexedDB for offline access");
        } catch (indexedDBError) {
            console.warn(" Error saving user to IndexedDB:", indexedDBError);
        }
        
        // Cache di localStorage
        localStorage.setItem('cachedUser', JSON.stringify(currentUser));
        localStorage.setItem('userToken', user.uid);
        
        // Show main app
        showMainApp();
        updateUserUI();
        
        // ============== LOAD DATA DENGAN STRATEGI BARU ==============
        
        // 1. Load settings dulu
        await loadSettings();
        
        // 2. PRIORITAS: Load dari IndexedDB dulu (cepat)
        await loadAssetsFromIndexedDBOnly();
        
        // 3. CEK APAKAH PERLU FIRST TIME SYNC?
        const lastPull = await getLastPullTimestamp();
        const cloudMeta = await getCloudSyncMetadata();
        
        if (lastPull === 0 || !cloudMeta) {
            // FIRST TIME SYNC - ambil semua dari cloud
            if (navigator.onLine && isFirebaseConnected) {
                showToastNotification(' Sinkronisasi awal...', 'info');
                try {
                    const cloudAssets = await firstTimeSyncFromCloud();
                    if (cloudAssets.length > 0) {
                        assets = cloudAssets;
                        // Update UI setelah first time sync
                        updateAssetSelects();
                        displayAssets();
                        updateDashboard();
                    }
                } catch (syncError) {
                    console.error("First time sync error:", syncError);
                    showToastNotification(' Gagal sinkronisasi awal, menggunakan data lokal', 'warning');
                }
            }
        } else {
            // BUKAN FIRST TIME - sync di background
            if (navigator.onLine && isFirebaseConnected && !isSyncRunning) {
                setTimeout(runSyncNow, 2000);
            }
        }
        
        // 4. Update UI (sudah dilakukan di loadAssetsFromIndexedDBOnly, 
        //    tapi kita panggil lagi untuk jaga-jaga)
        updateAssetSelects();
        displayAssets();
        updateDashboard();
        
        // 5. Load backup history
        await loadBackupHistory();
        
        // 6. Setup connection monitor (versi baru tanpa polling)
        setupConnectionMonitor();
        
        // 7. Update connection status
        updateConnectionStatus(isFirebaseConnected);
        
        console.log(" User signed in successfully");
        
        // Show welcome toast
        setTimeout(() => {
            showToastNotification(
                ` Selamat datang, ${currentUser.nama}!`,
                'success'
            );
        }, 1000);
        
    } catch (error) {
        console.error(" Error handling signed in user:", error);
        showLoginOverlay();
        showAlert('addAssetAlert', error.message || 'Login gagal', 'danger');
        
        try {
            await firebase.auth().signOut();
        } catch (signOutError) {
            console.error("Error signing out:", signOutError);
        }
    }
}
// Handle user signed out
function handleUserSignedOut() {
    currentUser = null;
    isOwner = false;
    
    // Clear cached data
    localStorage.removeItem('cachedUser');
    localStorage.removeItem('userToken');
    sessionStorage.removeItem('cachedUser');
    sessionStorage.removeItem('userToken');
    
    // Show login overlay
    showLoginOverlay();
    hideMainApp();
}

// Show main application
// Show main application
function showMainApp() {
    console.log(" Showing main app...");
    document.querySelector('.container').style.display = 'block';
    document.getElementById('userProfile').style.display = 'flex';
    updateUserUI();
    hideLoginOverlay(); // Pastikan login overlay disembunyikan
}

// Hide main application
function hideMainApp() {
    console.log(" Hiding main app...");
    document.querySelector('.container').style.display = 'none';
    document.getElementById('userProfile').style.display = 'none';
}

// Update user interface with user data
function updateUserUI() {
    if (!currentUser) {
        console.warn(" No current user to update UI");
        return;
    }
    
    console.log(" Updating UI for user:", currentUser.email);
    
    try {
        // Update header
        document.getElementById('userName').textContent = currentUser.nama || currentUser.email;
        document.getElementById('userRole').textContent = currentUser.role === 'owner' ? 'Owner' : 'User';
        
        // Update avatar
        const avatarElement = document.getElementById('userAvatar');
        const initials = currentUser.nama 
            ? currentUser.nama.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
            : currentUser.email.substring(0, 2).toUpperCase();
        avatarElement.textContent = initials;
        
        // Update dropdown
        document.getElementById('dropdownName').textContent = currentUser.nama || currentUser.email;
        document.getElementById('dropdownEmail').textContent = currentUser.email;
        document.getElementById('dropdownJabatan').textContent = currentUser.jabatan || '-';
        document.getElementById('dropdownNIK').textContent = currentUser.nik || '-';
        document.getElementById('dropdownRole').textContent = currentUser.role === 'owner' ? 'Owner' : 'User';
        
        // Update dropdown avatar
        const dropdownAvatar = document.getElementById('dropdownAvatar');
        dropdownAvatar.textContent = initials;
        
        // Set avatar background color based on role
        const avatarColor = currentUser.role === 'owner' ? '#ef4444' : '#3b82f6';
        avatarElement.style.backgroundColor = avatarColor;
        dropdownAvatar.style.backgroundColor = avatarColor;
        
        console.log(" UI updated successfully");
        
    } catch (error) {
        console.error(" Error updating UI:", error);
    }
}

// Setup user dropdown
function setupUserDropdown() {
    const userProfile = document.getElementById('userProfile');
    const userDropdown = document.getElementById('userDropdown');
    
    // Toggle dropdown
    userProfile.addEventListener('click', function(e) {
        e.stopPropagation();
        userDropdown.classList.toggle('active');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!userProfile.contains(e.target) && !userDropdown.contains(e.target)) {
            userDropdown.classList.remove('active');
        }
    });
    
// Ganti bagian ini (sekitar baris 8110-8120)
document.getElementById('btnLogout').addEventListener('click', async function(e) {
    e.preventDefault();
    
    if (confirm('Apakah Anda yakin ingin logout?')) {
        showLoadingOverlay('Logout...');
        
        try {
            // Firebase sign out
            await firebase.auth().signOut();
            
            // HAPUS SEMUA DATA USER DARI STORAGE
            // Hapus dari localStorage
            localStorage.removeItem('cachedUser');
            localStorage.removeItem('userToken');
            localStorage.removeItem('userPassword'); // HAPUS PASSWORD JUGA!
            localStorage.removeItem('rememberMe');
            
            // Hapus dari sessionStorage
            sessionStorage.removeItem('cachedUser');
            sessionStorage.removeItem('userToken');
            
// Hapus dari IndexedDB
if (indexedDBInstance) {
    try {
        const transaction = indexedDBInstance.transaction(['users'], 'readwrite');
        const store = transaction.objectStore('users');
        
        //  SELALU HAPUS SEMUA USER, APAPUN CONDITIONALNYA
        store.clear();
        console.log(" All users cleared from IndexedDB");
        
    } catch (indexedDBError) {
        console.warn(" Error clearing IndexedDB users:", indexedDBError);
    }
}
            
            
            // Reset currentUser
            currentUser = null;
            isOwner = false;
            
            // Tutup loading overlay
            hideLoadingOverlay();
            
            // Close dropdown
            userDropdown.classList.remove('active');
            
            // Tampilkan login overlay
            showLoginOverlay();
            hideMainApp();
            
            console.log(" Logout successful, all user data cleared");
            
        } catch (error) {
            console.error(" Logout error:", error);
            hideLoadingOverlay();
            alert('Logout gagal: ' + error.message);
        }
    }
});
    
    // Profile button
    document.getElementById('btnProfile').addEventListener('click', function(e) {
        e.preventDefault();
        userDropdown.classList.remove('active');
        showUserProfile();
    });
    
    // Change password button
    document.getElementById('btnChangePassword').addEventListener('click', function(e) {
        e.preventDefault();
        userDropdown.classList.remove('active');
        changePassword();
    });
}

// Show user profile modal - PERBAIKI fungsi ini
function showUserProfile() {
    if (!currentUser) {
        console.error(" No current user found");
        return;
    }
    
    console.log(" Showing profile for:", currentUser);
    
    // Format tanggal dengan aman - VERSI DIPERBAIKI
    const formatDate = (dateValue) => {
        if (!dateValue) return 'Tidak tersedia';
        
        try {
            let date;
            
            // CASE 1: Firestore Timestamp (paling umum untuk online mode)
            if (dateValue && typeof dateValue === 'object' && dateValue.toDate && typeof dateValue.toDate === 'function') {
                date = dateValue.toDate();
            }
            // CASE 2: String ISO (untuk offline mode atau data dari IndexedDB)
            else if (typeof dateValue === 'string') {
                date = new Date(dateValue);
                // Cek apakah valid
                if (isNaN(date.getTime())) {
                    console.warn("Invalid date string:", dateValue);
                    return 'Tanggal tidak valid';
                }
            }
            // CASE 3: Number (timestamp)
            else if (typeof dateValue === 'number') {
                date = new Date(dateValue);
            }
            // CASE 4: Date object
            else if (dateValue instanceof Date) {
                date = dateValue;
            }
            // CASE 5: Firestore FieldValue.serverTimestamp() yang belum di-resolve
            else if (dateValue && typeof dateValue === 'object' && dateValue.seconds) {
                date = new Date(dateValue.seconds * 1000);
            }
            // CASE 6: Object dengan _seconds (Firestore internal)
            else if (dateValue && typeof dateValue === 'object' && dateValue._seconds) {
                date = new Date(dateValue._seconds * 1000);
            }
            else {
                console.warn("Unknown date format:", dateValue);
                return 'Format tanggal tidak dikenali';
            }
            
            // Validasi final
            if (!date || isNaN(date.getTime())) {
                return 'Tanggal tidak valid';
            }
            
            // Format tanggal dengan aman
            try {
                return date.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (formatError) {
                console.error("Error formatting date:", formatError);
                return 'Error format tanggal';
            }
            
        } catch (error) {
            console.error("Error in formatDate:", error, dateValue);
            return 'Error format tanggal';
        }
    };
    
    // Format role display
    const roleDisplay = currentUser.role === 'owner' ? 'Owner (Admin)' : 'User';
    const roleClass = currentUser.role === 'owner' ? 'badge-danger' : 'badge-info';
    
    // Get user initials for avatar
    const initials = currentUser.nama 
        ? currentUser.nama.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
        : 'U';
    
    const modalHTML = `
        <div class="modal active" id="profileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-circle"></i> Profil Saya
                    </div>
                    <div class="close-modal" id="closeProfileModal">&times;</div>
                </div>
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: ${currentUser.role === 'owner' ? '#ef4444' : '#3b82f6'}; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            ${initials}
                        </div>
                        <h3 style="margin: 10px 0 5px 0; color: var(--text-color);">${currentUser.nama || currentUser.email}</h3>
                        <div class="badge ${roleClass}" style="display: inline-block; font-size: 14px; padding: 8px 16px;">
                            ${roleDisplay}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label><i class="fas fa-envelope"></i> Email</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${currentUser.email || 'Tidak tersedia'}
                            </div>
                        </div>
                        <div class="form-col">
                            <label><i class="fas fa-briefcase"></i> Jabatan</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${currentUser.jabatan || 'Tidak tersedia'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-col">
                            <label><i class="fas fa-id-card"></i> NIK</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${currentUser.nik || 'Tidak tersedia'}
                            </div>
                        </div>
                        <div class="form-col">
                            <label><i class="fas fa-user-tag"></i> Role</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${roleDisplay}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-col">
                            <label><i class="fas fa-calendar-plus"></i> Akun Dibuat</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${formatDate(currentUser.createdAt)}
                            </div>
                        </div>
                        <div class="form-col">
                            <label><i class="fas fa-clock"></i> Terakhir Login</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${formatDate(currentUser.lastLogin)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-col">
                            <label><i class="fas fa-user-check"></i> Status Akun</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color);">
                                ${currentUser.isActive ? ' Aktif' : ' Nonaktif'}
                                ${currentUser.profileComplete ? '   Profil Lengkap' : '   Profil Belum Lengkap'}
                            </div>
                        </div>
                        <div class="form-col">
                            <label><i class="fas fa-key"></i> User ID</label>
                            <div style="padding: 12px 15px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color); font-size: 12px; font-family: monospace;">
                                ${currentUser.uid || 'Tidak tersedia'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center;">
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-primary" id="btnEditProfile">
                                <i class="fas fa-edit"></i> Edit Profil
                            </button>
                            <button class="btn btn-outline" id="closeProfileBtn">
                                <i class="fas fa-times"></i> Tutup
                            </button>
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: var(--secondary);">
                            <i class="fas fa-info-circle"></i> Untuk mengubah email atau role, hubungi administrator
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Add event listeners
    document.getElementById('closeProfileModal').addEventListener('click', function() {
        document.getElementById('profileModal').remove();
    });
    
    document.getElementById('closeProfileBtn').addEventListener('click', function() {
        document.getElementById('profileModal').remove();
    });
    
    document.getElementById('btnEditProfile').addEventListener('click', function() {
        document.getElementById('profileModal').remove();
        showEditProfileModal();
    });
    
    // Close when clicking outside
    document.getElementById('profileModal').addEventListener('click', function(e) {
        if (e.target.id === 'profileModal') {
            this.remove();
        }
    });
    
    // Close with ESC key
    document.addEventListener('keydown', function closeModalOnEsc(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('profileModal');
            if (modal) modal.remove();
            document.removeEventListener('keydown', closeModalOnEsc);
        }
    });
}

// Fungsi untuk edit profil (optional)
function showEditProfileModal() {
    if (!currentUser) return;
    
    const modalHTML = `
        <div class="modal active" id="editProfileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-edit"></i> Edit Profil
                    </div>
                    <div class="close-modal" id="closeEditProfileModal">&times;</div>
                </div>
                <div style="padding: 20px;">
                    <form id="editProfileForm">
                        <div class="form-group">
                            <label for="editNama">Nama Lengkap</label>
                            <input type="text" id="editNama" value="${currentUser.nama || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editJabatan">Jabatan</label>
                            <input type="text" id="editJabatan" value="${currentUser.jabatan || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editNIK">NIK</label>
                            <input type="text" id="editNIK" value="${currentUser.nik || ''}">
                        </div>
                        
                        <div id="editProfileError" class="alert alert-danger" style="display: none;"></div>
                        <div id="editProfileSuccess" class="alert alert-success" style="display: none;"></div>
                        
                        <div class="form-group" style="margin-top: 30px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary" id="btnSaveProfile">
                                <i class="fas fa-save"></i> Simpan Perubahan
                            </button>
                            <button type="button" class="btn btn-outline" id="cancelEditProfile">
                                <i class="fas fa-times"></i> Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Add event listeners
    document.getElementById('closeEditProfileModal').addEventListener('click', function() {
        document.getElementById('editProfileModal').remove();
    });
    
    document.getElementById('cancelEditProfile').addEventListener('click', function() {
        document.getElementById('editProfileModal').remove();
    });
    
    // Form submission
    document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const nama = document.getElementById('editNama').value.trim();
        const jabatan = document.getElementById('editJabatan').value.trim();
        const nik = document.getElementById('editNIK').value.trim();
        
        const errorElement = document.getElementById('editProfileError');
        const successElement = document.getElementById('editProfileSuccess');
        const saveBtn = document.getElementById('btnSaveProfile');
        
        if (!nama || !jabatan) {
            showError(errorElement, 'Nama dan jabatan wajib diisi');
            return;
        }
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="loading"></div> Menyimpan...';
        
        try {
            // Update currentUser object
            currentUser.nama = nama;
            currentUser.jabatan = jabatan;
            currentUser.nik = nik;
            
            // Update di Firestore jika online
            if (navigator.onLine && db && isFirebaseConnected) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        nama: nama,
                        jabatan: jabatan,
                        nik: nik
                    });
                    console.log(" Profile updated in Firestore");
                } catch (firestoreError) {
                    console.error(" Error updating in Firestore:", firestoreError);
                }
            }
            
            // Update di IndexedDB
            try {
                await saveUserToIndexedDB(currentUser);
                console.log(" Profile updated in IndexedDB");
            } catch (indexedDBError) {
                console.error(" Error updating in IndexedDB:", indexedDBError);
            }
            
            // Update cache
            localStorage.setItem('cachedUser', JSON.stringify(currentUser));
            
            // Update UI
            updateUserUI();
            
            showSuccess(successElement, 'Profil berhasil diperbarui!');
            
            // Close modal after delay
            setTimeout(() => {
                document.getElementById('editProfileModal').remove();
                showUserProfile(); // Show updated profile
            }, 1500);
            
        } catch (error) {
            console.error(" Error updating profile:", error);
            showError(errorElement, 'Gagal memperbarui profil: ' + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Perubahan';
        }
    });
    
    // Close when clicking outside
    document.getElementById('editProfileModal').addEventListener('click', function(e) {
        if (e.target.id === 'editProfileModal') {
            this.remove();
        }
    });
    
    // Close with ESC key
    document.addEventListener('keydown', function closeModalOnEsc(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.remove();
            document.removeEventListener('keydown', closeModalOnEsc);
        }
    });
}

// Change password function
function changePassword() {
    const modalHTML = `
        <div class="modal active" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Ubah Password</div>
                    <div class="close-modal" id="closeChangePasswordModal">&times;</div>
                </div>
                <div style="padding: 20px;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Password baru minimal 6 karakter
                    </div>
                    
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Password Saat Ini</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">Password Baru</label>
                            <input type="password" id="newPassword" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmNewPassword">Konfirmasi Password Baru</label>
                            <input type="password" id="confirmNewPassword" required>
                        </div>
                        
                        <div id="changePasswordError" class="alert alert-danger" style="display: none;"></div>
                        <div id="changePasswordSuccess" class="alert alert-success" style="display: none;"></div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <button type="submit" class="btn btn-warning" id="btnChangePasswordSubmit">
                                <i class="fas fa-key"></i> Ubah Password
                            </button>
                            <button type="button" class="btn btn-outline" id="cancelChangePassword">
                                <i class="fas fa-times"></i> Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Add event listeners
    document.getElementById('closeChangePasswordModal').addEventListener('click', function() {
        document.getElementById('changePasswordModal').remove();
    });
    
    document.getElementById('cancelChangePassword').addEventListener('click', function() {
        document.getElementById('changePasswordModal').remove();
    });
    
    // Form submission
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        
        const errorElement = document.getElementById('changePasswordError');
        const successElement = document.getElementById('changePasswordSuccess');
        const submitBtn = document.getElementById('btnChangePasswordSubmit');
        
        // Validation
        if (newPassword !== confirmNewPassword) {
            showError(errorElement, 'Password baru dan konfirmasi tidak cocok');
            return;
        }
        
        if (newPassword.length < 6) {
            showError(errorElement, 'Password baru minimal 6 karakter');
            return;
        }
        
        showLoadingOverlay('Mengubah password...');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading"></div> Memproses...';
        
        try {
            const user = firebase.auth().currentUser;
            
            // Re-authenticate user
            const credential = firebase.auth.EmailAuthProvider.credential(
                user.email,
                currentPassword
            );
            
            await user.reauthenticateWithCredential(credential);
            
            // Update password
            await user.updatePassword(newPassword);
            
            hideLoadingOverlay();
            showSuccess(successElement, 'Password berhasil diubah!');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-key"></i> Ubah Password';
            
            // Clear form
            document.getElementById('changePasswordForm').reset();
            
            // Auto close after 2 seconds
            setTimeout(() => {
                document.getElementById('changePasswordModal').remove();
            }, 2000);
            
        } catch (error) {
            console.error("Change password error:", error);
            hideLoadingOverlay();
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-key"></i> Ubah Password';
            
            let errorMessage = 'Gagal mengubah password. ';
            switch (error.code) {
                case 'auth/wrong-password':
                    errorMessage = 'Password saat ini salah';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password baru terlalu lemah';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            showError(errorElement, errorMessage);
        }
    });
    
    // Close when clicking outside
    document.getElementById('changePasswordModal').addEventListener('click', function(e) {
        if (e.target.id === 'changePasswordModal') {
            this.remove();
        }
    });
    

document.addEventListener('touchmove', function (e) {
    if (e.scale !== 1) { e.preventDefault(); }
}, { passive: false });
    // Event listener untuk print
    
}

// Helper function to show error message
function showError(element, message) {
    element.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    element.style.display = 'flex';
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}

// Helper function to show success message
function showSuccess(element, message) {
    element.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    element.style.display = 'flex';
    setTimeout(() => {
        element.style.display = 'none';
    }, 5000);
}



// ==============================================
// FUNGSI CEK USER TERSIMPAN - TAMBAHKAN
// ==============================================
async function getAllUsersFromIndexedDB() {
    return new Promise((resolve, reject) => {
        if (!indexedDBInstance) {
            resolve([]);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['users'], 'readonly');
            const store = transaction.objectStore('users');
            const request = store.getAll();
            
            request.onsuccess = function() {
                resolve(request.result || []);
            };
            
            request.onerror = function(event) {
                console.error("Error getting users:", event.target.error);
                resolve([]);
            };
        } catch (error) {
            console.error("Exception getting users:", error);
            resolve([]);
        }
    });
}
async function checkSavedUser() {
    try {
        // CEK APAKAH USER INGIN DIINGAT
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        
        // Jika tidak rememberMe, jangan auto-login
        if (!rememberMe) {
            console.log(" Remember me not set, skipping auto-login");
            
            // Hapus data user yang mungkin masih tersisa
            localStorage.removeItem('cachedUser');
            localStorage.removeItem('userToken');
            localStorage.removeItem('userPassword');
            sessionStorage.removeItem('cachedUser');
            sessionStorage.removeItem('userToken');
            
            // Hapus dari IndexedDB juga
            if (indexedDBInstance) {
                try {
                    const transaction = indexedDBInstance.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    store.clear();
                } catch (e) {}
            }
            
            return null;
        }
        
        // Priority 1: Cek IndexedDB (hanya jika rememberMe)
        if (indexedDBInstance && rememberMe) {
            try {
                const users = await getAllUsersFromIndexedDB();
                if (users && users.length > 0) {
                    // Ambil user terakhir yang login
                    const lastUser = users.sort((a, b) => {
                        const aTime = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                        const bTime = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                        return bTime - aTime;
                    })[0];
                    
                    console.log(" Found user in IndexedDB:", lastUser.email);
                    return lastUser;
                }
            } catch (indexedDBError) {
                console.warn(" Error reading users from IndexedDB:", indexedDBError);
            }
        }
        
        // Priority 2: Cek localStorage (hanya jika rememberMe)
        if (rememberMe) {
            const cachedUser = localStorage.getItem('cachedUser');
            if (cachedUser) {
                try {
                    const userData = JSON.parse(cachedUser);
                    console.log(" Found user in localStorage:", userData.email);
                    
                    // Simpan ke IndexedDB untuk offline login
                    try {
                        if (indexedDBInstance) {
                            await saveUserToIndexedDB(userData);
                        }
                    } catch (saveError) {
                        console.warn("Could not save to IndexedDB:", saveError);
                    }
                    
                    return userData;
                } catch (parseError) {
                    console.error("Error parsing cached user:", parseError);
                }
            }
        }
        
        return null;
        
    } catch (error) {
        console.error("Error checking saved user:", error);
        return null;
    }
}

// ==============================================
// FUNGSI SYNC USER DATA DENGAN FIREBASE
// ==============================================

async function syncUserDataWithFirebase(firebaseUser) {
    if (!firebaseUser || !currentUser) return;
    
    try {
        if (db && typeof db.collection === 'function') {
            const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
            
            if (userDoc.exists) {
                const firestoreUser = userDoc.data();
                
                // Update currentUser dengan data terbaru dari Firestore
                currentUser = {
                    ...currentUser,
                    ...firestoreUser,
                    uid: firebaseUser.uid,
                    email: firebaseUser.email
                };
                
                // Simpan ke IndexedDB
                await saveUserToIndexedDB(currentUser);
                
                // Update localStorage
                localStorage.setItem('cachedUser', JSON.stringify(currentUser));
                
                // Update UI
                updateUserUI();
                
                console.log(" User data synced with Firebase");
            }
        }
    } catch (error) {
        console.error("Error syncing user data with Firebase:", error);
    }
}
        // ==============================================
        // INITIALIZE APP
        // =============================================
// ==============================================
// INIT APP - VERSION DENGAN OFFLINE-FIRST AUTH
// ==============================================

async function initApp() {
    try {
        console.log(" Initializing Asset Management System...");
        updateSplashStatus('Memulai aplikasi...');
        
        // 1. Initialize theme
        initTheme();
        updateSplashStatus('Menerapkan tema...');
        
        // 2. Initialize IndexedDB FIRST
        console.log(" Initializing IndexedDB...");
        updateSplashStatus('Inisialisasi database lokal...');
        
        try {
            indexedDBInstance = await initIndexedDB();
            console.log(" IndexedDB ready");
            updateSplashStatus('Database lokal siap');
        } catch (dbError) {
            console.error(" IndexedDB failed:", dbError);
            updateSplashStatus('Gagal inisialisasi database', 'Menggunakan mode darurat');
        }
        
        // 3. Setup UI dasar
        updateSplashStatus('Menyiapkan antarmuka...');
        setupEventListeners();
        setupAuthForms();
        setupUserDropdown();
        
        // 4. Cek status login
        updateSplashStatus('Memeriksa status login...');
        const savedUser = await checkSavedUser();
        
        if (savedUser) {
            // Auto-login dengan data offline
            console.log(" Found saved user, auto-login:", savedUser.email);
            currentUser = savedUser;
            isOwner = savedUser.role === 'owner';
            
            // Load data dari IndexedDB dulu
            await loadAssetsFromIndexedDBOnly();
            updateConnectionStatus(isFirebaseConnected);
            updateCloudinaryStatus();
            
            // Update UI
            showMainApp();
            updateUserUI();
            
            // Coba konek ke Firebase di background
            if (navigator.onLine) {
                updateSplashStatus('Menyambungkan ke cloud...');
                
                initFirebase().then(() => {
                    updateConnectionStatus(isFirebaseConnected);
                    
                    if (firebase.auth && typeof firebase.auth === 'function') {
                        firebase.auth().onAuthStateChanged(async (firebaseUser) => {
                            if (firebaseUser) {
                                console.log(" Firebase user verified:", firebaseUser.email);
                                await syncUserDataWithFirebase(firebaseUser);
                            }
                        });
                    }
                    
                    //  PASTIKAN INI DIPANGGIL
                    if (!window._backgroundInitialized) {
                        window._backgroundInitialized = true;
                        
                        setTimeout(() => {
                            initBackground();
                            startBackgroundScheduler();
                        }, 500);
                    }
                    
                    // Sync data
                    if (!isSyncRunning) {
                        setTimeout(runSyncNow, 2000);
                    }
                }).catch(err => {
                    console.warn("Firebase init background error:", err);
                });
            } else {
                updateSplashStatus('Mode offline', 'Menggunakan data lokal');
                setTimeout(() => {
                    showToastNotification(' Mode offline - data lokal digunakan', 'info');
                }, 1000);
            }
            
            setTimeout(() => {
                hideSplashScreen();
            }, 1000);
            
        } else {
            // Tidak ada user, tampilkan login
            console.log(" No saved user found");
            
            if (navigator.onLine) {
                updateSplashStatus('Menyiapkan koneksi cloud...');
                
                try {
                    await initFirebase();
                    console.log(" Firebase initialized for login");
                    
                    if (firebase.auth && typeof firebase.auth === 'function') {
                        firebase.auth().onAuthStateChanged(async (user) => {
                            if (user) {
                                console.log(" User signed in:", user.email);
                                await handleUserSignedIn(user);
                                hideSplashScreen();
                            }
                        });
                    }
                    
                    setTimeout(() => {
                        hideSplashScreen();
                        showLoginOverlay();
                    }, 500);
                    
                } catch (error) {
                    console.error(" Firebase init failed:", error);
                    hideSplashScreen();
                    showLoginOverlay();
                    showAlert('addAssetAlert', 
                        'Gagal terhubung ke server. Periksa koneksi internet Anda.', 
                        'danger');
                }
            } else {
                updateSplashStatus('Mode offline', 'Belum pernah login');
                
                setTimeout(() => {
                    hideSplashScreen();
                    showLoginOverlay();
                    const loginError = document.getElementById('loginError');
                    if (loginError) {
                        loginError.innerHTML = `
                            <i class="fas fa-exclamation-circle"></i> 
                            Anda sedang offline dan belum pernah login sebelumnya.<br>
                            <strong>Silakan online terlebih dahulu untuk login pertama kali.</strong>
                        `;
                        loginError.style.display = 'flex';
                    }
                }, 1500);
            }
        }
        
        console.log(" App initialization complete");
        
    } catch (error) {
        console.error(" Fatal error initializing app:", error);
        updateSplashStatus('Error', 'Memuat ulang...');
        
        setTimeout(() => {
            hideSplashScreen();
            showLoginOverlay();
            
            const loginError = document.getElementById('loginError');
            if (loginError) {
                loginError.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> 
                    Error: ${error.message}<br>
                    <small>Refresh halaman atau coba lagi.</small>
                `;
                loginError.style.display = 'flex';
            }
        }, 2000);
    }
}
    
  
    
// ==============================================
// DOM CONTENT LOADED
// ==============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log(" DOM Content Loaded");
    
    // Sembunyikan container dulu
    document.querySelector('.container').style.display = 'none';
    
    // Tampilkan splash screen
    showSplashScreen();
    
    // Inisialisasi app dengan delay kecil
    setTimeout(() => {
        initApp();
    }, 2000);
    
    // Setup settings tab listeners
    setTimeout(() => {
        const settingsTab = document.querySelector('.nav-tab[data-tab="settings"]');
        if (settingsTab) {
            settingsTab.addEventListener('click', async function() {
                setTimeout(async () => {
                    await updateStorageInfo();
                    updateSettingsUserInfo();
                    updateSettingsSyncInfo();
                }, 300);
            });
        }
    }, 2000);
});

// Error handler global
// ==============================================
// GLOBAL ERROR HANDLER UNTUK WEBVIEW
// ==============================================

// Cegah error dari nge-crash WebView
window.addEventListener('error', function(event) {
    console.error(' Global error caught:', event.error || event.message);
    
    // Cegah default handling (yang bisa cause crash)
    event.preventDefault();
    
    // Tampilkan notifikasi ke user (tapi jangan terlalu mengganggu)
    if (!event.message?.includes('ResizeObserver')) {
        showToastNotification('Terjadi kesalahan, tapi aplikasi tetap berjalan', 'warning');
    }
    
    return true;
});

window.addEventListener('unhandledrejection', function(event) {
    console.error(' Unhandled promise rejection:', event.reason);
    
    // Cegah crash
    event.preventDefault();
    
    if (event.reason?.message && !event.reason.message.includes('offline')) {
        showToastNotification('Promise error caught', 'warning');
    }
    
    return true;
});

// Khusus untuk WebIntoApp
if (typeof Android !== 'undefined' || window.navigator.userAgent.includes('WebIntoApp') || window.navigator.userAgent.includes('webintoapp')) {
    console.log(' WebIntoApp detected - enabling safe mode');
    
    // Set flag
    window.__isWebIntoApp = true;
    
    // Override fetch untuk cek online (cegah fetch ke cloudinary saat offline)
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        // Blokir fetch ke cloudinary saat offline
        if (!navigator.onLine && args[0] && typeof args[0] === 'string' && 
            (args[0].includes('cloudinary') || args[0].includes('res.cloudinary'))) {
            console.warn(' Blocked fetch to cloudinary while offline');
            return Promise.reject(new Error('Offline mode - fetch blocked'));
        }
        return originalFetch.apply(this, args);
    };
    
    // Nonaktifkan gesture zoom (sudah ada, tapi pastikan tidak error)
    try {
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
    } catch (e) {}
}
    </script>
  
<script>
// ==============================================
// BACKGROUND MANAGER - DENGAN FIRESTORE SYNC (UPDATE 24 JAM)
// ==============================================

let backgroundCache = null;
let lastCheckTimestamp = 0;
const CHECK_INTERVAL = 24 * 60 * 60 * 1000; // 24 jam dalam milliseconds

// 1. CEK DAN UPDATE BACKGROUND (DIPANGGIL SETIAP BUKA APP)
async function initBackground() {
    try {
        console.log(" Initializing background with Firestore sync...");
        
        // CEK APAKAH PERLU UPDATE (24 JAM SEKALI)
        const needsUpdate = await checkIfNeedUpdate();
        
        if (needsUpdate && navigator.onLine) {
            console.log(" 24 hours passed, checking for new background...");
            await syncBackgroundFromFirestore();
            return;
        }
        
        // CEK CACHE MEMORY DULU
        if (backgroundCache) {
            console.log(" Using memory cache");
            applyBackground(backgroundCache);
            return;
        }
        
        // CEK INDEXEDDB
        const savedBg = await getBackgroundFromDB();
        
        if (savedBg) {
            console.log(" Using saved background from IndexedDB");
            backgroundCache = savedBg;
            applyBackground(savedBg);
            return;
        }
        
        // JIKA TIDAK ADA, DOWNLOAD DARI FIRESTORE
        if (navigator.onLine) {
            console.log(" First time download from Firestore...");
            await syncBackgroundFromFirestore();
        } else {
            console.log(" Offline mode - using default gradient");
        }
        
    } catch (error) {
        console.error(" Background error:", error);
    }
}

// 2. CEK APAKAH PERLU UPDATE (24 JAM SEKALI)
async function checkIfNeedUpdate() {
    try {
        // Ambil timestamp terakhir check dari IndexedDB
        const lastCheck = await getLastCheckTimestamp();
        
        if (!lastCheck) return true; // Belum pernah check
        
        const now = Date.now();
        return (now - lastCheck) > CHECK_INTERVAL;
        
    } catch {
        return true;
    }
}

// 3. AMBIL TIMESTAMP TERAKHIR CHECK
function getLastCheckTimestamp() {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve(null);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.get('background_last_check');
            
            request.onsuccess = () => {
                resolve(request.result?.value || null);
            };
            
            request.onerror = () => {
                resolve(null);
            };
        } catch {
            resolve(null);
        }
    });
}

// 4. SIMPAN TIMESTAMP CHECK
function saveLastCheckTimestamp() {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve();
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            store.put({ key: 'background_last_check', value: Date.now() });
            transaction.oncomplete = resolve;
        } catch {
            resolve();
        }
    });
}

// 5. SYNC BACKGROUND DARI FIRESTORE
async function syncBackgroundFromFirestore() {
    try {
        if (!navigator.onLine) {
            console.log(" Cannot sync: offline");
            return;
        }
        
        if (!db || !isFirebaseConnected) {
            console.log(" Firebase not connected");
            return;
        }
        
        console.log(" Fetching background config from Firestore...");
        
        // Ambil dokumen background dari collection 'settings' atau 'background'
        let bgDoc;
        try {
            // Coba dari collection 'settings' dulu
            bgDoc = await db.collection('app_config').doc('background').get();
            
            
            
        } catch (e) {
            console.log("Trying alternative path...");
            
        }
        
        if (!bgDoc.exists) {
            console.log(" No background document found in Firestore");
            await saveLastCheckTimestamp();
            return;
        }
        
        const bgData = bgDoc.data();
        const imageUrl = bgData.url || bgData.imageUrl || bgData.image;
        
        if (!imageUrl) {
            console.log(" No image URL in background document");
            await saveLastCheckTimestamp();
            return;
        }
        
        console.log(" Found background URL:", imageUrl);
        
        // Download gambar
        await downloadAndSaveBackground(imageUrl);
        
        // Simpan timestamp check
        await saveLastCheckTimestamp();
        
    } catch (error) {
        console.error(" Firestore sync error:", error);
        // Tetap simpan timestamp agar tidak coba lagi dalam 24 jam
        await saveLastCheckTimestamp();
    }
}

// 6. DOWNLOAD DAN SIMPAN BACKGROUND
async function downloadAndSaveBackground(imageUrl) {
    try {
        console.log(" Downloading background...");
        
        const response = await fetch(imageUrl, {
            cache: 'force-cache',
            headers: {
                'Cache-Control': 'max-age=86400' // Cache 24 jam
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const blob = await response.blob();
        
        // Konversi ke base64
        const reader = new FileReader();
        reader.onloadend = async function() {
            const base64data = reader.result;
            
            // HAPUS BACKGROUND LAMA DARI INDEXEDDB
            await deleteOldBackground();
            
            // Simpan yang baru
            await saveBackgroundToDB(base64data);
            
            // Update memory cache
            backgroundCache = base64data;
            
            // Terapkan
            applyBackground(base64data);
            
            console.log(" New background saved and applied");
        };
        reader.readAsDataURL(blob);
        
    } catch (error) {
        console.error(" Download failed:", error);
        throw error;
    }
}

// 7. HAPUS BACKGROUND LAMA
function deleteOldBackground() {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve();
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            
            // Hapus background lama
            store.delete('background_image');
            
            console.log(" Old background deleted");
            
            transaction.oncomplete = resolve;
            transaction.onerror = resolve;
        } catch {
            resolve();
        }
    });
}

// 8. AMBIL BACKGROUND DARI INDEXEDDB
function getBackgroundFromDB() {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve(null);
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.get('background_image');
            
            request.onsuccess = () => {
                resolve(request.result?.value || null);
            };
            
            request.onerror = () => {
                resolve(null);
            };
        } catch {
            resolve(null);
        }
    });
}

// 9. SIMPAN BACKGROUND KE INDEXEDDB
function saveBackgroundToDB(base64) {
    return new Promise((resolve) => {
        if (!indexedDBInstance) {
            resolve();
            return;
        }
        
        try {
            const transaction = indexedDBInstance.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            store.put({ key: 'background_image', value: base64 });
            transaction.oncomplete = resolve;
            transaction.onerror = resolve;
        } catch {
            resolve();
        }
    });
}

// 10. TERAPKAN BACKGROUND
function applyBackground(base64) {
    const header = document.querySelector('.header');
    if (!header) return;
    
    requestAnimationFrame(() => {
        header.setAttribute('data-bg-ready', 'true');
        header.style.backgroundImage = `url('${base64}')`;
        header.style.backgroundSize = 'cover';
        header.style.backgroundPosition = 'center';
        console.log(" Background applied");
    });
}

// 11. CLEANUP
function cleanupBackground() {
    const header = document.querySelector('.header');
    if (header && document.hidden) {
        header.style.backgroundImage = 'none';
    }
}

// 12. EVENT LISTENERS
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        cleanupBackground();
    } else {
        if (backgroundCache) {
            applyBackground(backgroundCache);
        } else {
            initBackground();
        }
    }
});

// 13. SCHEDULED CHECK (SETIAP 24 JAM)
function startBackgroundScheduler() {
    setSafeInterval(async () => {
        console.log(" Running scheduled background check (24h)");
        if (navigator.onLine) {
            await syncBackgroundFromFirestore();
        }
    }, CHECK_INTERVAL);
}


</script>
</body>
</html>
